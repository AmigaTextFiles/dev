<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta http-equiv="content-type"
 content="text/html; charset=ISO-8859-1">
  <title>z88dk - The z88 Development Kit</title>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
<table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left; width: 90%; margin-left: auto; margin-right: auto;">
  <tbody>
    <tr>
      <td style="vertical-align: top;">
      <h1><span style="color: rgb(0, 0, 0);">z88dk - The z88
Development Kit - Retargetting</span><br>
      </h1>
      <br>
      <table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left;">
        <tbody>
          <tr>
            <td style="vertical-align: top; width: 15%;"><a
 href="http://www.z88dk.org">Home</a><br>
            <a href="index.html#news">News</a><br>
            <a href="index.html#downloads">Downloads</a><br>
            <a href="documentation.html">Documentation</a><br>
            <a href="index.html#contact">Contact</a><br>
            <a href="index.html#links">Links</a><br>
            </td>
            <td style="vertical-align: top;">
            <table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left; width: 100%;">
              <tbody>
                <tr>
                  <td
 style="vertical-align: top; background-color: rgb(51, 0, 153);"> <big><span
 style="color: rgb(255, 255, 255);">Introduction</span></big><br>
                  </td>
                </tr>
                <tr>
                  <td style="vertical-align: top;">
                  <p>As can be seen from the number of <a
 href="platforms.html">platforms</a> that z88dk can generate code for,
retargetting the kit for a new platform can be a trivial process.<br>
                  </p>
                  <p>This document is split into several sections, each
of which adds an added degree of functionality to the new target, if
you wish to retarget to a new machine then it is recommended that you
follow the directory structure mentioned in this document - this
permits easier integration and prevents the source tree from getting
overly messy, with over 1500 files and over 7MB of code this is a very
important thing to do!<br>
                  </p>
                  <ul>
                    <li><a href="#basic">Basic targetting</a></li>
                    <li><a href="#fileio">File I/O support</a></li>
                    <li><a href="#graphics">Graphics support</a></li>
                    <li>RS232 support</li>
                    <li>Machine specific routines<br>
                    </li>
                  </ul>
                  </td>
                </tr>
              </tbody>
            </table>
            <hr style="width: 100%; height: 2px;" noshade="noshade">
            <table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left; width: 100%;">
              <tbody>
                <tr style="color: rgb(255, 255, 255);">
                  <td
 style="vertical-align: top; background-color: rgb(51, 0, 153);"> <big><span
 style="color: rgb(255, 255, 255);"><a name="basic"></a>Basic
retargetting</span></big> </td>
                </tr>
                <tr>
                  <td style="vertical-align: top;">
                  <p><span style="font-weight: bold;">Initial Steps</span><br>
                  </p>
                  <p>The first thing to do is to create a crt0 file in
the z88dk/lib directory, this file is used for startup and should
initialise the stack, set the origin of the program, parse any command
line arguments (if supported), call the main function and then release
resources on program completion.<br>
                  <br>
There are a number of recommended starting places for these files,
dependent on whether the application is ROM based or RAM based. If,<br>
                  </p>
                  <dl>
                    <dt>The system is ROM based, base your startup file
on lib/rex_crt0.asm<br>
The system is RAM based, base your startup file on lib/cpc_crt0.asm<br>
                    </dt>
                  </dl>
The name of the file should be something along the lines of [3/4 letter
id]_crt0.asm. This 3/4 letter id should be the unique indentifier that
will be used throughout the source tree (Yes, the Spectrum is
different, but this was a mistake a long time ago!).<br>
                  <br>
In addition to the .asm file, you will also need to create a file with
the suffix .opt, this should include the .asm, each for the z88, this
file contains:<br>
                  <pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INCLUDE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "#z88_crt0.asm"</pre>
Whilst we're in the lib/ directory you should go to the lib/config
directory and create a .cfg file for your target. If you take a look at
the config file for the system you based your startup on it then you
should be able to work out what should go in it!<br>
                  <br>
                  <span style="font-weight: bold;">Library Routines<br>
                  <br>
                  </span>Create a directory z88dk/libsrc/stdio/[machine
id]. This is the directory that will contain the basic routines that
are needed for supporting a machine. Below is a list of functions that
you should implement:<br>
                  <br>
int fgetc_cons(void);<br>
Should read a key from the keyboard returning the ASCII key value in
hl. This routine should return 0 if no key is pressed, however unless
an error occurs it should wait for a keypress.<br>
                  <br>
void fputc_cons(char code)<br>
Should print code to the screen.<br>
                  <br>
int fgets_cons(char *buf, int maxlen)<br>
Should read a string from the keyboard. Done this way because some
computers (i.e. z88) have an OS call to do this which offers editing
facilities. There is a generic fgets_cons() in z88dk/libsrc/stdio which
might prove a useful skeleton for your implementation.<br>
                  <br>
void puts_cons(char *str)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [optional]<br>
Writes a NUL terminated string to the console, this call is provided so
that the application writer can call this directly should they not wish
to use any other stdio routines.<br>
                  <br>
int
getk(void)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[optional]<br>
Should read the current state of the keyboard, returning NUL if no key
is pressed<br>
                  <br>
Once you've written these files you should adjust/create Makefiles to
generate your machines library.<br>
                  </td>
                </tr>
              </tbody>
            </table>
            <hr style="width: 100%; height: 2px;" noshade="noshade">
            <table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left; width: 100%;">
              <tbody>
                <tr>
                  <td
 style="vertical-align: top; background-color: rgb(0, 0, 153);"> <big><span
 style="color: rgb(255, 255, 255);"><a name="fileio"></a>Implementing
file I/O</span></big></td>
                </tr>
                <tr>
                  <td style="vertical-align: top;">
                  <p><span style="font-weight: bold;"><span
 style="font-weight: bold;">Initial Steps</span></span><br>
                  </p>
                  <p>Create a directory libsrc/fcntl/machine_id<br>
                  </p>
                  <p><span style="font-weight: bold;">Required Functions</span><br>
                  </p>
                  <p>The following functions are required to be
implemented for full file I/O support.<br>
                  </p>
                  <p>int open(far char *name, int flags, mode_t mode);<br>
int creat(far char *name, mode_t mode);<br>
int close(int fd);<br>
size_t read(int fd, void *ptr, size_t len);<br>
size_t write(int fd, void *ptr, size_t len);<br>
long lseek(int fd,long posn, int whence);<br>
The purpose of these functions should be obvious, if your target
doesn't support far pointers then they can be cast to near pointers
inside the open/creat functions.<br>
                  </p>
                  <p>int open_z88(far char *name, int flags, mode_t
mode, char *explicit, size_t len);<br>
This is a non-standard routine and on most machines will probably just
call open() however this provides the facility to return the explicit
file name (which is placed in explicit, up to a maximum length len)<br>
                  </p>
                  <p>extern int __FASTCALL__ readbyte(int fd);<br>
This function reads a byte from filehandle fd (which is supplied in the
register pair hl), if an error occurred it should return EOF (-1) and
return with carry set. Otherwise it should return with carry reset and
hl holding the byte just read.</p>
                  <p>extern int writebyte(int fd, int c);<br>
This function writes byte c to filehandle fd, once more if an error
occurs it should return EOF and carry set, otherwise hl holds the byte
just written and carry is reset.</p>
                  <p>void fabandon(FILE *fp);<br>
Abandon file with the handle fd - this is called by the system on
program exit should it not be able to close a file. This function is a
dummy function on the many platforms but for example on the Spectrum +3
this function would be of use. NB. A dummy function is located in
z88dk/libsrc/stdio, but if it is implemented on your machine then it
should be placed in fcntl.</p>
                  <p>Once you have supplied the above functions the
entire z88dk stdio library is available to you (including printf etc)
in addition to all the ctype, string, assert, setjmp, near malloc, some
stdlib and the generic math<br>
routines - just a little work yields over 100 usable functions! </p>
                  </td>
                </tr>
              </tbody>
            </table>
            <hr style="width: 100%; height: 2px;" noshade="noshade">
            <table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left; width: 100%;">
              <tbody>
                <tr style="color: rgb(255, 255, 255);">
                  <td
 style="vertical-align: top; background-color: rgb(51, 0, 153);"> <big><span
 style="color: rgb(255, 255, 255);"><a name="graphics"></a>Graphics
Support</span></big> </td>
                </tr>
                <tr>
                  <td style="vertical-align: top;">Details to be
written - contact Stefano for more details<br>
                  </td>
                </tr>
              </tbody>
            </table>
            <hr style="width: 100%; height: 2px;" noshade="noshade"></td>
          </tr>
          <tr>
            <td style="vertical-align: top;"><br>
            </td>
            <td style="vertical-align: top;">
            <p>Last Modified by <a href="mailto:dom@z88dk.org">Dom</a>
on 11.10.2003</p>
            </td>
          </tr>
        </tbody>
      </table>
      </td>
    </tr>
  </tbody>
</table>
</body>
</html>
