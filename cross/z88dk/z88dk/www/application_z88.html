<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta http-equiv="content-type"
 content="text/html; charset=ISO-8859-1">
  <title>z88dk - The z88 Development Kit</title>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
<table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left; width: 90%; margin-left: auto; margin-right: auto;">
  <tbody>
    <tr>
      <td style="vertical-align: top;">
      <h1><span style="color: rgb(0, 0, 0);">z88dk - The z88
Development Kit - z88 Application Generation</span><br>
      </h1>
      <br>
      <table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left;">
        <tbody>
          <tr>
            <td style="vertical-align: top; width: 15%;"><a
 href="http://www.z88dk.org">Home</a><br>
            <a href="index.html#news">News</a><br>
            <a href="index.html#downloads">Downloads</a><br>
            <a href="documentation.html">Documentation</a><br>
            <a href="index.html#contact">Contact</a><br>
            <a href="index.html#links">Links</a><br>
            </td>
            <td style="vertical-align: top;">
            <table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left; width: 100%;">
              <tbody>
                <tr>
                  <td
 style="vertical-align: top; background-color: rgb(51, 0, 153);"> <big><span
 style="color: rgb(255, 255, 255);">Introduction </span></big> </td>
                </tr>
                <tr>
                  <td style="vertical-align: top;">
                  <p>One of the nastiest things about writing a z88
application is generating the DOR header - it's full of pointers around
the place and generally looks quite nasty. In fact, usually once you've
generated one, you just end up recycling it for numerous projects
without actually think what it does.<br>
                  </p>
                  <p>z88dk offers complete DOR generation, including
help texts so that
generating a DOR is as simple as a few #define statements and including
a couple of header files/<br>
                  </p>
                  </td>
                </tr>
              </tbody>
            </table>
            <hr style="width: 100%; height: 2px;" noshade="noshade">
            <table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left; width: 100%;">
              <tbody>
                <tr style="color: rgb(255, 255, 255);">
                  <td
 style="vertical-align: top; background-color: rgb(51, 0, 153);"> <big><span
 style="color: rgb(255, 255, 255);">How to generate a DOR</span></big> </td>
                </tr>
                <tr>
                  <td style="vertical-align: top;">
                  <p>For the creation of applications two header files
are important: &lt;dor.h&gt; and &lt;application.h&gt; - both of these
need to be included in order to construct the application DOR.</p>
                  <p>&lt;dor.h&gt; contains some constants for the
application type and application.h uses these constants to construct
the DOR, hence they should&nbsp; be included
in this order. However, it's not as simple as that - application.h
needs some information from you such as application name etc - there
are defaults, but I don't think you'd want to use those!</p>
                  <p>The information is given courtesy of #define in
between the including of dor.h and application.h, you should define the
following:<br>
                  </p>
                  <pre>#define HELP1   "..."<br>#define HELP2   "..."<br>#define HELP3   "..."<br>#define HELP4   "..."<br>#define HELP5   "..."<br>#define HELP6   "..."<br></pre>
                  <p>The information for the application help page, if
HELP1 is not defined then the standard HELP page is used, if any of the
others (HELP2 to HELP6) is not defined then "" is substituted. </p>
                  <pre>#define APP_NAME "..."<br></pre>
                  <p>The name of the application (as appears in the
Index)<br>
                  </p>
                  <pre>#define APP_KEY&nbsp; '[KEY]'<br></pre>
                  <p>The hotkey for the application. </p>
                  <pre>#define APP_INFO "..."<br></pre>
                  <p>The equivalent of *name from BASIC. </p>
                  <pre>#define APP_TYPE [constants or'd together as from dor.def]<br></pre>
                  <p>The application type, if you don't define this
then the default type is BAD with OZ preserving the screen (i.e. very,
very bad!)</p>
                  <pre>#define APP_TYPE2 [constants]<br></pre>
                  <p>The application type byte 2 - specifies whether
caps lock should be on or not. </p>
                  <p>All of the constants above are in z80asm format -
not C style, so insert Z88 control sequences in the form ".." &amp;blah
&amp;".." and not \[blah] or you might get a bit of surprise! </p>
                  </td>
                </tr>
              </tbody>
            </table>
            <hr style="width: 100%; height: 2px;" noshade="noshade">
            <table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left; width: 100%;">
              <tbody>
                <tr style="color: rgb(255, 255, 255);">
                  <td
 style="vertical-align: top; background-color: rgb(51, 0, 153);"> <big><span
 style="color: rgb(255, 255, 255);">Menus, Topics and Help</span></big>
                  </td>
                </tr>
                <tr>
                  <td style="vertical-align: top;">
                  <p>You are allowed up to 7 topics per application and
24 items within each topic (if you ever fit this many into an app
please let me know!) you define a topic with:<br>
                  </p>
                  <pre>#define TOPIC[num] "[name]". </pre>
                  <p>Each item under a topic is named via <br>
                  </p>
                  <pre>#define TOPIC[num]_[item], </pre>
                  <p>its hotkey by:<br>
                  </p>
                  <pre>#define TOP[num]_[item]KEY</pre>
                  <p>its code by:<br>
                  </p>
                  <pre>#define TOPIC(...)CODE</pre>
                  <p>its attribute (see dev notes and dor. h) by:<br>
                  </p>
                  <pre>#define TOPIC(...)ATTR. </pre>
                  <p>amd its help can be defined using:<br>
                  </p>
                  <pre>#define TOPIC(..)HELP(1-7)</pre>
                  <p>An example will probably clear up the confusion,
here's the DOR #defines for examples/z88/useless.c:<br>
                  </p>
                  <pre>#include &lt;dor.h&gt;<br><br>#define HELP1   "A pointless demo application made with z88dk"<br>#define HELP2   "Simply loops, points out menu selections and dies"<br>#define HELP3   "..eventually..see source for details"<br>#define HELP4   ""<br>#define HELP5   "v0.1 - 9.4.99 (djm)"<br>#define HELP6   ""<br><br>#define APP_INFO "Made by z88dk"<br>#define APP_KEY  'U'<br>#define APP_NAME "Useless"<br>#define APP_TYPE AT_Good<br><br>#define TOPIC1   "Action"<br>#define TOPIC1ATTR      TP_Help<br>#define TOPIC1HELP1     "Some help for the topic"<br>#define TOPIC1HELP2     "And another line of help"<br>#define TOPIC1_1         "Eat"<br>#define TOPIC1_1KEY      "AE"<br>#define TOPIC1_1CODE     $81<br>#define TOPIC1_1ATTR     MN_Help<br><br>#define TOPIC1_1HELP1    "Are you hungry?"<br><br>#define TOPIC1_2         "Drink"<br>#define TOPIC1_2KEY      "AD"<br>#define TOPIC1_2CODE     $82<br>#define TOPIC1_2ATTR     MN_Help<br>#define TOPIC1_2HELP1    "Why yes, if you're offering, mine's a"<br>#define TOPIC1_2HELP2    "pint of something nice"<br><br>#define TOPIC1_3         "Sleep"<br>#define TOPIC1_3KEY      "AS"<br>#define TOPIC1_3CODE     $83<br>#define TOPIC1_3ATTR     MN_Help<br>#define TOPIC1_3HELP1    "Yawn...."<br><br>#define TOPIC2           "Commands"<br>#define TOPIC2ATTR       TP_Help<br>#define TOPIC2HELP1      "From this menu you can quit this"<br>#define TOPIC2HELP2      "Completely useless application"<br><br>#define TOPIC2_1         "Quit"<br>#define TOPIC2_1KEY      "CQ"<br>#define TOPIC2_1CODE     $84<br>#define TOPIC2_1ATTR     MN_Help<br>#define TOPIC2_1HELP1    "Go on, leave me now!"<br><br><br>#include &lt;application.h<span
 style="font-family: sans-serif;">&gt;</span></pre>
                  </td>
                </tr>
              </tbody>
            </table>
            <hr style="width: 100%; height: 2px;" noshade="noshade">
            <table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left; width: 100%;">
              <tbody>
                <tr>
                  <td
 style="vertical-align: top; background-color: rgb(0, 0, 153);"><big
 style="font-weight: bold;">Application Types/Memory Management</big><br>
                  </td>
                </tr>
                <tr>
                  <td style="vertical-align: top;">If the amount of
static variables used by your application is less than 8k (the minimum
amount of bad memory that can be allocated) then give the flag
-reqpag=num to the frontend where num is the number of 256 byte pages
of bad memory required - the unused memory up to the 8k limit is given
back to OZ on pre-emption. To find out what num is for your application
look at the .opt/.asm file and search for DEFVARS and count the number
of bytes there. Sorry, there is no foolproof way to do this
automatically. For example the dstar.c program needs -reqpag=5 and
rpn.c needs -reqpag=1. Remember that the startup code (maybe
unnecessarily)&nbsp; reserves a byte at $2000 so add 1 to your variable
count before dividing by 256!<br>
                  <br>
It should in theory be possible to write good applicatons with the kit
- simply don't use any static variables, supply the flag -reqpag=0 to
the frontend and of course set the the appropriate APP_TYPE.<br>
                  <br>
I have placed all variables used by the startup code into safe
workspace area to allow this facility - I reserve 50 bytes which is
more than sufficient for our needs (we need 47 ATM) to allow for future
expansion.<br>
                  <br>
If you're feeling particularly lucky, you can write good apps that have
static variables...as long as you don't have too many of them that is.
You can specify the flag -safedata=[n bytes]
where n is the amount of static data that you want, this space is taken
from the safe workspace, which remember is also shared by the stack,
mail and other such things. A suppose a safe limit would be in the
region of 500 bytes or so, but experiment, if you don't have arrays of
local variables and no recursion you might be able to get away with
more, as the saying goes, your mileage may vary!<br>
                  <br>
The default origin for an application is 49152 - this should give you
plenty of space to do whatever you like, however, perhaps you want to
slot it in elsewhere in an eprom - in this case use the -zorg= flag.
NB. The application DOR created assumes that it is located in top bank
(63) of an EPROM cartridge, so unless you have a large application
don't relocate it to &lt; 49152 [This is to ensure that the application
entry point is in segment 3 - the DOR contains a dummy startup which
then jumps to the real start address.]</td>
                </tr>
              </tbody>
            </table>
            <hr style="width: 100%; height: 2px;" noshade="noshade">
            <table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left; width: 100%;">
              <tbody>
                <tr>
                  <td
 style="vertical-align: top; background-color: rgb(0, 0, 153);"><big>Near
Malloc routines</big><br>
                  </td>
                </tr>
                <tr>
                  <td style="vertical-align: top;">It is possible to to
use the near heap routines with applications, however, you should
should initialise the malloc pool as follows (otherwise strange things
may happen!):<br>
                  <pre>#include &lt;malloc.h&gt;<br><br>#define HPSIZE [size]<br>HEAPSIZE(HPSIZE)<br>#pragma set HEAPSIZE HPSIZE<br></pre>
                  <p>#pragma set is a synonym for #define that gets
passed through to the compiler (as opposed to being expanded out by the
preprocessor). When the time comes to write the zcc_opt.def file the
compiler looks for the #define HEAPSIZE divides by 256 (for the number
of pages) adds it to 32 (mininum size of bad memory) and writes this
value to the zcc_opt.def file, this allows the DOR to be created
requesting the correct amount of bad memory.<br>
                  </p>
                  <p>However, this can be a bit wasteful to say the
least, say you only had 50 bytes of static variables and an 8k heap,
the application would request 16k of bad memory when in fact it only
needs 8448 bytes (to the nearest 256 byte page), so in this case supply
the parameter -reqpag=33 and only 8448 bytes will be requested - smart
eh</p>
                  </td>
                </tr>
              </tbody>
            </table>
            <hr style="width: 100%; height: 2px;" noshade="noshade">
            <table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left; width: 100%;">
              <tbody>
                <tr>
                  <td
 style="vertical-align: top; background-color: rgb(0, 0, 153);"><big>Far
Malloc Routines</big><br>
                  </td>
                </tr>
                <tr>
                  <td style="vertical-align: top;">The z88 application
type supports the far memory allocation routines. These are detailed in
a separate <a href="far_z88.html">document</a>.</td>
                </tr>
              </tbody>
            </table>
            <hr style="width: 100%; height: 2px;" noshade="noshade">
            <table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left; width: 100%;">
              <tbody>
                <tr>
                  <td
 style="vertical-align: top; background-color: rgb(0, 0, 153);"><big><span
 style="color: rgb(255, 255, 255);">Advanced Application Techniques</span></big>
                  </td>
                </tr>
                <tr>
                  <td style="vertical-align: top;">
                  <p>As mentioned above, the default application type
is BAD to to let OZ redraw the screen. This isn't particularly friendly
towards OZ (or those with little free memory within their z88) and so
you can turn off the OZ screen redraw by setting #define APP_TYPE
appropriately. This does, leave you with a bit of problem though, how
do you redraw the screen? The solution is a function which you should
implement called redrawscreen. It should be defined as follows:<br>
                  </p>
                  <pre>void __APPFUNC__ redrawscreen() <br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Put some code here */<br>}<br></pre>
                  <p>The __APPFUNC__ flag causes the flag
DEFINED_[function] to be written to the zcc_opt.def file. This is then
picked up by the startup code and appropriate code is generated to call
this function.<br>
                  </p>
                  <p>To trap menu commands you should define a function
called handlecmds, which should have the following prototype:<br>
                  </p>
                  <pre>void __APPFUNC__ handlecmds(int cmd)<br>{<br>	/* Put some code here */<br>}<br></pre>
                  <p>The parameter cmd contains the key code that has
just been selected. You should check this against the menu options that
you have available.<br>
                  </p>
                  <p>Upon application quit it is possible to have one
of your functions called, it should be defined as follows:<br>
                  </p>
                  <pre>void __APPFUNC__ applicationquit()<br>{<br>	/* Put some code here */<br>}<br></pre>
                  <p>This allows you to release any resources that you
are using and prevent memory leaks and similar things. </p>
                  </td>
                </tr>
              </tbody>
            </table>
            <hr style="width: 100%; height: 2px;" noshade="noshade">
            <table cellpadding="2" cellspacing="2" border="0"
 style="text-align: left; width: 100%;">
              <tbody>
                <tr>
                  <td
 style="vertical-align: top; background-color: rgb(0, 0, 153);"><big>Writing
z88 Packages</big><br>
                  </td>
                </tr>
                <tr>
                  <td style="vertical-align: top;">A package is always
attached to a application eg. The Packege Package is
attached to Installer and the TCP Package is attached to the
application
ZSock, thus building a package with z88dk is tied to building an
application.
As result this documentation is written with the assumption that you
know
how to write and <br>
build applications with z88dk.
                  <h3>Constructing the Package DOR</h3>
                  <p>The package DOR is the structure which informs the
Package system about
your package. Creating the DOR with z88dk is incredibly simple.
Normally
to create an application DOR you would do the following:</p>
                  <pre>#include &lt;dor.h&gt;<br><br>/* Define application paramaters */<br><br>#include &lt;application.h&gt;</pre>
                  <p>In a similar manner, to build a package DOR you do
the following:</p>
                  <pre>#include &lt;dor.h&gt;<br><br>/* Define package parameters */<br><br>#include &lt;package.h&gt;<br>/* Define table of pointers to functions (jump table)*/<br><br>/* Define application parameters */<br>#include &lt;application.h&gt;</pre>
                  <p>The package parameters are as follows:<br>
                  </p>
                  <pre>#define MAKE_PACKAGE 1</pre>
                  <p>Say that you do want to create a package:<br>
                  </p>
                  <pre>#define PACK_VERSION&nbsp;&nbsp;&nbsp; $MMmm</pre>
                  <p>The version of the package you are creating -
MM=major, mm=minor<br>
                  </p>
                  <pre>#define PACK_NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "[name]"</pre>
                  <p>The name of the package (without the [] of course!)<br>
                  </p>
                  <pre>#define PACK_BOOT</pre>
                  <p>This should be set to either 0 or 1 depending on
whether the package should autoboot or not (This is of course bypassed
by holding down 'P' on reset)<br>
                  </p>
                  <pre>#define PACKAGE_ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $xx</pre>
                  <p>The package number as allocated by Garry Lancaster</p>
                  <pre>#define MAX_CALL_NUM $nn</pre>
                  <p>The maximum LSB of a call to your package.</p>
                  <h3>Setting up the Jump Table</h3>
                  <p>The jump table can be easily defined using the
following construct:</p>
                  <pre>package_str blahfishcakeblah[] = {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {Func1},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {Func2},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ....<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {FuncN}<br>};</pre>
                  <p>Remember to prototype as external to the file
Func1....FuncN</p>
                  <h3>Finally</h3>
                  <p>You have to supply 3 functions yourself to fully
define the package, these
are the pack_ayt, pack_bye and pack_dat functions.&nbsp; Due to the
complex
entry and exit parameters of these functions they are best written in
assembler.
For more details about these calls please see Garry's documentation.
These
functions must either be prototyped (to allow correct linking).</p>
                  <p>At a later date these 3 functions may be writable
in C if there's enough
demand for the ability.</p>
                  </td>
                </tr>
              </tbody>
            </table>
            <hr style="width: 100%; height: 2px;" noshade="noshade"></td>
          </tr>
          <tr>
            <td style="vertical-align: top;"><br>
            </td>
            <td style="vertical-align: top;">
            <p>Last Modified by <a href="mailto:dom@z88dk.org">Dom</a>
on 12.10.2003</p>
            </td>
          </tr>
        </tbody>
      </table>
      </td>
    </tr>
  </tbody>
</table>
<p><br>
</p>
</body>
</html>
