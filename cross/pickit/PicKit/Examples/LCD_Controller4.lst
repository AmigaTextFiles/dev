00002               ;DEVICE 16C84
00003               ;developer version 0.1
00004               ;****************************************
00005               ;*  ALFANUMERIC LCD DISPLAY CONTROLLER  *
00006               ;*             6bit version             *
00007               ;*                                      *
00008               ;*      (c)1.9.1997 Tomas Beyer         *
00009               ;****************************************
00010               ;use with X-Tal 3.2768 Mhz and
00011               ;TM162D (16x2 DOT MATRIX Display)
00012               ;
00013               ;comment or uncomment following lines to modify source
00014               
00015               ;ENGLISH     EQU     1  ; for english version of all messages
00016               
00017               
00018               
00019               
00020               ;*** ERROR CODES ***
00021               
00022               ;0-4 EEPROM routine errors
00023               
00024               
00026               ;*************************************
00027               ;**                                 **
00028               ;** Global definitions for PIC16C84 **
00029               ;**      (c)1995 Tomas Beyer        **
00030               ;**                                 **
00031               ;*************************************
00032               
00033               ;*** HARDWARE ***
00034               
00035               
00036               
00037               
00038               
00039               
00040               ;** bits associated with INTCON **
00041               
00042               
00043               ;** bits associated with OPTION **
00044               
00045               
00046               ;** bits associated with STATUS **
00047               
00048               
00049               ;** bits associated with EECON1 **
00050               
00053               ;********************************************************
00054               ;* Some useful instructions for PicAsm macro assembler  *
00055               ;*           (PicAsm version 1.1 and above)             *
00056               ;*                                                      *
00057               ;*  Copyright (c) 1997 Tomas Beyer all rights reserved  *
00058               ;********************************************************
00059               
00060               
00061               
00062               
00063               
00064               
00065               
00066               
00067               
00068               
00069               
00070               
00071               
00072               
00073               
00074               
00075               
00076               
00077               
00078               
00079               
00080               
00081               
00082               
00083               
00084               
00085               
00086               
00088               
00089               
00090               
00091               
00092               
00093               
00094               
00095               
00096               
00097               
00098               
00099               
00100               
00101               
00102               
00103               
00104               
00105               
00106               
00107               
00108               
00109               
00110               
00111               
00112               
00113               
00114               
00115               
00116               
00117               
00118               
00119               
00120               ;*** PORT A ***
00121               ;keyboard (needs external pull ups)
00122               
00123               
00124               
00125               
00126               ;*** PORT B ***
00127               
00128               
00129               ;*** FLAGS ***
00130               
00131               
00132               ;*** FLAGS2 ***
00133               
00134               
00135               
00136               
00137               
00138               
00139                           ID      0x0000
00140                           FUSE    CPOFF|PWRTE|XT
00141                           OUTPUT  INHX16
00142               
00143                           ORG     0x0000
00144               
00145   0000  01B0              clrf    STACK
00146   0001  2878              goto    Start
00147               
00148               ;********************************************
00149               ;*        Interrupt Service Routine         *
00150               ;********************************************
00151               
00152                           ORG     INTERRUPT
00153               
00154   0004  00AD              movwf   W_TEMP
00155   0005  0E03              swapf   STATUS,W
00156   0006  00AE              movwf   STATUS_TEMP
00157               
00158   0007  1283   bcf STATUS,b_RP0
00159               
00160               ;EM: calls INTCON,b_T0IF,Clock
00161   0008  190B   btfsc INTCON,b_T0IF
00162   0009  21BA   call Clock
00163               
00164   000A  0E2E  ISR_BACK    swapf   STATUS_TEMP,w
00165   000B  0083              movwf   STATUS
00166   000C  0EAD              swapf   W_TEMP
00167   000D  0E2D              swapf   W_TEMP,w
00168   000E  0009              retfie
00169               
00170               ;********************************************
00171               ;*                  Tables                  *
00172               ;********************************************
00173               
00174               
00175               
00176   000F  3450   retlw 'P'
00176   0010  346F   retlw 'o'
00176   0011  346E   retlw 'n'
00176   0012  3464   retlw 'd'
00176   0013  3465   retlw 'e'
00176   0014  346C   retlw 'l'
00176   0015  34E9   retlw 'i'
00176               T_po        deft    'Pondeli'
00177   0016  3455   retlw 'U'
00177   0017  3474   retlw 't'
00177   0018  3465   retlw 'e'
00177   0019  3472   retlw 'r'
00177   001A  34F9   retlw 'y'
00177               T_ut        deft    'Utery'
00178   001B  3453   retlw 'S'
00178   001C  3474   retlw 't'
00178   001D  3472   retlw 'r'
00178   001E  3465   retlw 'e'
00178   001F  3464   retlw 'd'
00178   0020  34E1   retlw 'a'
00178               T_st        deft    'Streda'
00179   0021  3443   retlw 'C'
00179   0022  3474   retlw 't'
00179   0023  3476   retlw 'v'
00179   0024  3472   retlw 'r'
00179   0025  3474   retlw 't'
00179   0026  3465   retlw 'e'
00179   0027  34EB   retlw 'k'
00179               T_ct        deft    'Ctvrtek'
00180   0028  3450   retlw 'P'
00180   0029  3461   retlw 'a'
00180   002A  3474   retlw 't'
00180   002B  3465   retlw 'e'
00180   002C  34EB   retlw 'k'
00180               T_pa        deft    'Patek'
00181   002D  3453   retlw 'S'
00181   002E  346F   retlw 'o'
00181   002F  3462   retlw 'b'
00181   0030  346F   retlw 'o'
00181   0031  3474   retlw 't'
00181   0032  34E1   retlw 'a'
00181               T_so        deft    'Sobota'
00182   0033  344E   retlw 'N'
00182   0034  3465   retlw 'e'
00182   0035  3464   retlw 'd'
00182   0036  3465   retlw 'e'
00182   0037  346C   retlw 'l'
00182   0038  34E5   retlw 'e'
00182               T_ne        deft    'Nedele'
00183   0039  344E   retlw 'N'
00183   003A  3461   retlw 'a'
00183   003B  3473   retlw 's'
00183   003C  3474   retlw 't'
00183   003D  3461   retlw 'a'
00183   003E  34F6   retlw 'v'
00183               T_nastav    deft    'Nastav'
00184   003F  3463   retlw 'c'
00184   0040  3461   retlw 'a'
00184   0041  34F3   retlw 's'
00184               M_cas       deft    'cas'
00185   0042  3464   retlw 'd'
00185   0043  3465   retlw 'e'
00185   0044  34EE   retlw 'n'
00185               M_datum     deft    'den'
00186               
00187               
00188   0045  3907  GetDay      andlw   0x7
00189   0046  0782              addwf   PCL
00190   0047  340F   retlw 0x0F
00190   0048  3416   retlw 0x16
00190   0049  341B   retlw 0x1B
00190   004A  3421   retlw 0x21
00190   004B  3428   retlw 0x28
00190   004C  342D   retlw 0x2D
00190   004D  3433   retlw 0x33
00190                           defb    T_po,T_ut,T_st,T_ct,T_pa,T_so,T_ne
00191               
00192   004E  0825  GetMode     movf    MODE,w
00193   004F  390F              andlw   0xF
00194   0050  0782              addwf   PCL
00195               
00196   0051  343F   retlw 0x3F
00196   0052  3442   retlw 0x42
00196   0053  340F   retlw 0x0F
00196   0054  3416   retlw 0x16
00196   0055  341B   retlw 0x1B
00196   0056  3421   retlw 0x21
00196   0057  3428   retlw 0x28
00196   0058  342D   retlw 0x2D
00196   0059  3433   retlw 0x33
00196                           defb    M_cas,M_datum,T_po,T_ut,T_st,T_ct,T_pa,T_so,T_ne
00197               
00198               
00199   005A  390F  HexDig      andlw   0xF
00200   005B  0782              addwf   PCL
00201               
00202   005C  3430   retlw 0x30
00202   005D  3431   retlw 0x31
00202   005E  3432   retlw 0x32
00202   005F  3433   retlw 0x33
00202   0060  3434   retlw 0x34
00202   0061  3435   retlw 0x35
00202   0062  3436   retlw 0x36
00202   0063  3437   retlw 0x37
00202                           defb    '0','1','2','3','4','5','6','7'
00203   0064  3438   retlw 0x38
00203   0065  3439   retlw 0x39
00203   0066  3441   retlw 0x41
00203   0067  3442   retlw 0x42
00203   0068  3443   retlw 0x43
00203   0069  3444   retlw 0x44
00203   006A  3445   retlw 0x45
00203   006B  3446   retlw 0x46
00203                           defb    '8','9','A','B','C','D','E','F'
00204               
00205               
00206   006C  0825  DoMode      movf    MODE,w
00207   006D  390F              andlw   0xF
00208   006E  0782              addwf   PCL
00209               
00210   006F  28F7              goto    SetTime
00211   0070  2914              goto    SetDay
00212               
00213   0071  28AA              goto    SetTemp
00214   0072  28AA              goto    SetTemp
00215   0073  28AA              goto    SetTemp
00216   0074  28AA              goto    SetTemp
00217   0075  28AA              goto    SetTemp
00218   0076  28AA              goto    SetTemp
00219   0077  28AA              goto    SetTemp
00220               
00221               ;*****************************************************************************
00222               ;**                                 Start                                   **
00223               ;*****************************************************************************
00224               
00225   0078  2198  Start       call    Setup
00226               
00227   0079  0803              movf    STATUS,w
00228   007A  3918              andlw   b'00011000'
00229   007B  3A18              xorlw   b'00011000'
00230   007C  3005              movlw   ERR_POR
00231               
00232               ;EM: skipnz 
00233   007D  1903   btfsc STATUS,b_ZERO
00234   007E  22FA              call    err
00235               
00236   007F  149C   bsf FLAGS,b_DAY
00237   0080  141C   bsf FLAGS,b_TIME
00238               
00239   0081  08A2  Main        movf    TIMER1
00240               ;EM: jpnz main_2
00241   0082  1D03   btfss STATUS,b_ZERO
00242   0083  2889   goto main_2
00243               
00244   0084  01A5              clrf    MODE
00245               
00246               ;EM: calls FLAGS,b_DAY,DisDay
00247   0085  189C   btfsc FLAGS,b_DAY
00248   0086  2262   call DisDay
00249               ;EM: calls FLAGS,b_TIME,DisClock
00250   0087  181C   btfsc FLAGS,b_TIME
00251   0088  21FB   call DisClock
00252               
00253   0089  2138  main_2      call    Keyboard
00254               
00255               ;EM: jpns KEYBUF,b_UP,SelUp
00256   008A  1DA4   btfss KEYBUF,b_UP
00257   008B  2893   goto SelUp
00258               ;EM: jpns KEYBUF,b_DOWN,SelDown
00259   008C  1D24   btfss KEYBUF,b_DOWN
00260   008D  289C   goto SelDown
00261               ;EM: jpns KEYBUF,b_SET,SelSet
00262   008E  1E24   btfss KEYBUF,b_SET
00263   008F  28A5   goto SelSet
00264               
00265               ;EM: calls FLAGS,b_MEN,DispMode
00266   0090  1B1C   btfsc FLAGS,b_MEN
00267   0091  212A   call DispMode
00268               
00269   0092  2881              goto    Main
00270               
00271   0093  3003  SelUp       movlw   3
00272   0094  00A2              movwf   TIMER1
00273   0095  0AA5              incf    MODE
00274   0096  0825              movf    MODE,w
00275   0097  3A09              xorlw   MAXPAR+1
00276               ;EM: skipnz 
00277   0098  1903   btfsc STATUS,b_ZERO
00278   0099  01A5              clrf    MODE
00279   009A  171C              bsf     FLAGS,b_MEN
00280   009B  2881              goto    Main
00281               
00282   009C  3003  SelDown     movlw   3
00283   009D  00A2              movwf   TIMER1
00284   009E  0825              movf    MODE,w
00285               ;EM: skipnz 
00286   009F  1903   btfsc STATUS,b_ZERO
00287   00A0  3009              movlw   MAXPAR+1
00288   00A1  00A5              movwf   MODE
00289   00A2  03A5              decf    MODE
00290   00A3  171C              bsf     FLAGS,b_MEN
00291   00A4  2881              goto    Main
00292               
00293   00A5  206C  SelSet      call    DoMode
00294   00A6  01A2              clrf    TIMER1
00295   00A7  149C              bsf     FLAGS,b_DAY
00296   00A8  141C              bsf     FLAGS,b_TIME
00297   00A9  2881              goto    Main
00298               
00299               ;********************************************
00300               ;*            Set Temperature               *
00301               ;********************************************
00302               
00303   00AA  01A7  SetTemp     clrf    MIN
00304   00AB  3017              movlw   23
00305   00AC  00A8              movwf   MAX
00306   00AD  01A9              clrf    VALUE
00307               
00308               ;EM: push FLAGS2
00309   00AE  082B   movf FLAGS2,w
00310   00AF  2340   call xpush
00312               
00313   00B0  3005              movlw   5
00314   00B1  00A2              movwf   TIMER1
00315   00B2  00B4              movwf   TTEMP
00316               
00317   00B3  28E0              goto    DispTemp
00318               
00319               
00320   00B4  2138  SetTemp2    call    Keyboard
00321               
00322               ;EM: callns KEYBUF,b_UP,Plus
00323   00B5  1DA4   btfss KEYBUF,b_UP
00324   00B6  222E   call Plus
00325               ;EM: callns KEYBUF,b_DOWN,Minus
00326   00B7  1D24   btfss KEYBUF,b_DOWN
00327   00B8  2238   call Minus
00328               
00329   00B9  0829              movf    VALUE,w
00330   00BA  00B3              movwf   ATEMP
00331               
00332               ;EM: jpns KEYBUF,b_SET,TempSet
00333   00BB  1E24   btfss KEYBUF,b_SET
00334   00BC  28C7   goto TempSet
00335               
00336               ;EM: jps FLAGS,b_MEN,DispTemp
00337   00BD  1B1C   btfsc FLAGS,b_MEN
00338   00BE  28E0   goto DispTemp
00339               
00340   00BF  08A2              movf    TIMER1
00341               ;EM: jpz back
00342   00C0  1903   btfsc STATUS,b_ZERO
00343   00C1  28C3   goto back
00344               
00345   00C2  28B4              goto    SetTemp2
00346               
00347               ;EM: pop FLAGS2
00349   00C3  302B   movlw FLAGS2
00350   00C4  2349   call xpop
00351   00C5  01B4              clrf    TTEMP
00352   00C6  28F5              goto    HrSet
00353               
00354               
00355               ;EM: push MIN
00357   00C7  0827   movf MIN,w
00358   00C8  2340   call xpush
00360               ;EM: push MAX
00361   00C9  0828   movf MAX,w
00362   00CA  2340   call xpush
00364               ;EM: push VALUE
00365   00CB  0829   movf VALUE,w
00366   00CC  2340   call xpush
00368               
00369   00CD  10AB   bcf FLAGS2,b_NOCURS
00370               
00371   00CE  3005              movlw   5
00372   00CF  00A7              movwf   MIN
00373   00D0  3032              movlw   50
00374   00D1  00A8              movwf   MAX
00375               
00376   00D2  230B              call    ReadTemp
00377   00D3  00A9              movwf   VALUE
00378               
00379   00D4  3043              movlw   0x43
00380   00D5  00AA              movwf   POS
00381   00D6  2220              call    GetNumber
00382               
00383   00D7  0829              movf    VALUE,w
00384   00D8  230D              call    WriteTemp
00385               
00386               ;EM: pop VALUE
00387   00D9  3029   movlw VALUE
00388   00DA  2349   call xpop
00389               ;EM: pop MAX
00390   00DB  3028   movlw MAX
00391   00DC  2349   call xpop
00392               ;EM: pop MIN
00393   00DD  3027   movlw MIN
00394   00DE  2349   call xpop
00395   00DF  28B4              goto    SetTemp2
00396               
00397               
00398   00E0  14AB  DispTemp bsf FLAGS2,b_NOCURS
00399   00E1  3040              movlw   0x40
00400   00E2  00AA              movwf   POS
00401   00E3  2242              call    DispNumber
00402   00E4  303D              movlw   '='
00403   00E5  216B              call    PutChar
00404               
00405               ;EM: push VALUE
00406   00E6  0829   movf VALUE,w
00407   00E7  2340   call xpush
00409   00E8  230B              call    ReadTemp
00410   00E9  00A9              movwf   VALUE
00411               
00412   00EA  3043              movlw   0x43
00413   00EB  00AA              movwf   POS
00414   00EC  2242              call    DispNumber
00415   00ED  30DF              movlw   0xDF
00416   00EE  216B              call    PutChar
00417   00EF  3043              movlw   'C'
00418   00F0  216B              call    PutChar
00419               
00420               ;EM: pop VALUE
00421   00F1  3029   movlw VALUE
00422   00F2  2349   call xpop
00423               
00424   00F3  131C              bcf     FLAGS,b_MEN
00425   00F4  28B4              goto    SetTemp2
00426               
00427   00F5  3040  HrSet       movlw   0x40
00428   00F6  29E1              goto    Clear
00429               
00430               ;********************************************
00431               ;*                 Set Time                 *
00432               ;********************************************
00433               
00434   00F7  179C  SetTime bsf FLAGS,b_SETTIM
00435   00F8  142B   bsf FLAGS2,b_NOSEC
00436   00F9  10AB   bcf FLAGS2,b_NOCURS
00437               
00438   00FA  0195              clrf    SECONDS
00439   00FB  3040              movlw   0x40
00440   00FC  21FD              call    DisClockX
00441   00FD  3040              movlw   0x40
00442   00FE  00AA              movwf   POS
00443   00FF  01A7              clrf    MIN
00444   0100  3017              movlw   23
00445   0101  00A8              movwf   MAX
00446   0102  0817              movf    HOURS,w
00447   0103  00A9              movwf   VALUE
00448   0104  2220              call    GetNumber
00449   0105  0829              movf    VALUE,w
00450   0106  0097              movwf   HOURS
00451   0107  3043              movlw   0x43
00452   0108  00AA              movwf   POS
00453   0109  01A7              clrf    MIN
00454   010A  303B              movlw   59
00455   010B  00A8              movwf   MAX
00456   010C  0816              movf    MINUTES,w
00457   010D  00A9              movwf   VALUE
00458   010E  2220              call    GetNumber
00459   010F  0829              movf    VALUE,w
00460   0110  0096              movwf   MINUTES
00461   0111  139C   bcf FLAGS,b_SETTIM
00462   0112  3040              movlw   0x40
00463   0113  29E1              goto    Clear
00464               
00465               
00466   0114  01A7  SetDay      clrf    MIN
00467   0115  3006              movlw   6
00468   0116  00A8              movwf   MAX
00469   0117  0818              movf    DAY,w
00470   0118  00A9              movwf   VALUE
00471               
00472   0119  30C0              movlw   0xC0
00473   011A  2A6B              goto    DispDay
00474               
00475   011B  2138  SetDay2     call    Keyboard
00476               
00477               ;EM: callns KEYBUF,b_UP,Plus
00478   011C  1DA4   btfss KEYBUF,b_UP
00479   011D  222E   call Plus
00480               ;EM: callns KEYBUF,b_DOWN,Minus
00481   011E  1D24   btfss KEYBUF,b_DOWN
00482   011F  2238   call Minus
00483               ;EM: jpns KEYBUF,b_SET,DaySet
00484   0120  1E24   btfss KEYBUF,b_SET
00485   0121  2925   goto DaySet
00486               
00487               ;EM: jps FLAGS,b_MEN,DispDay
00488   0122  1B1C   btfsc FLAGS,b_MEN
00489   0123  2A6B   goto DispDay
00490               
00491   0124  291B              goto     SetDay2
00492               
00493   0125  0829  DaySet      movf    VALUE,w
00494   0126  0098              movwf   DAY
00495               
00496   0127  3040              movlw   0x40
00497   0128  29E1              goto    Clear
00498   0129  0008              return
00499               
00500               
00501               ;********************************************
00502               ;*               Display mode               *
00503               ;********************************************
00504               
00505   012A  131C  DispMode    bcf     FLAGS,b_MEN
00506   012B  0100              clrw
00507   012C  21E1              call    Clear
00508   012D  3080              movlw   b'10000000'
00509   012E  2173              call    PutDATA
00510   012F  3039              movlw   T_nastav
00511   0130  2155              call    PutText
00512   0131  3020              movlw   32
00513   0132  216B              call    PutChar
00514   0133  204E              call    GetMode
00515   0134  2155              call    PutText
00516   0135  302E              movlw   '.'
00517   0136  216B              call    PutChar
00518   0137  0008              return
00519               
00520               ;********************************************
00521               ;*               Keyboard test              *
00522               ;********************************************
00523               
00524   0138  0805  Keyboard    movf    PORTA,w
00525   0139  391C              andlw   ALLKEYS
00526   013A  0090              movwf   TMP0
00527   013B  3A1C              xorlw   ALLKEYS
00528               ;EM: jpnz key2
00529   013C  1D03   btfss STATUS,b_ZERO
00530   013D  2944   goto key2
00531               
00532   013E  169C              bsf     FLAGS,b_KEN
00533   013F  301C              movlw   ALLKEYS
00534   0140  00A4              movwf   KEYBUF
00535               
00536   0141  3064              movlw   100
00537   0142  00A6              movwf   WAITK
00538   0143  0008              return
00539               
00540   0144  0834  key2        movf    TTEMP,w
00541               ;EM: skipz 
00542   0145  1D03   btfss STATUS,b_ZERO
00543   0146  00A2              movwf   TIMER1
00544               
00545   0147  0810              movf    TMP0,w
00546   0148  0624              xorwf   KEYBUF,w
00547               ;EM: jpnz key3
00548   0149  1D03   btfss STATUS,b_ZERO
00549   014A  294D   goto key3
00550               
00551   014B  301C              movlw   ALLKEYS
00552   014C  00A4              movwf   KEYBUF
00553               
00554   014D  0BA6  key3        decfsz  WAITK
00555   014E  0008              return
00556               
00557               ;EM: retns FLAGS,b_KEN
00558   014F  1E9C   btfss FLAGS,b_KEN
00559   0150  0008   return 
00560               
00561   0151  129C              bcf     FLAGS,b_KEN
00562   0152  0810              movf    TMP0,w
00563   0153  00A4              movwf   KEYBUF
00564   0154  0008              return
00565               
00566               ;********************************************
00567               ;*               Display Text               *
00568               ;********************************************
00569               
00570   0155  0092  PutText     movwf   TMP2
00571   0156  0812  PutText2    movf    TMP2,w
00572   0157  2161              call    GetChar
00573   0158  397F              andlw   0x7F
00574   0159  216B              call    PutChar
00575               
00576   015A  0812              movf    TMP2,w
00577   015B  2161              call    GetChar
00578   015C  3980              andlw   0x80
00579               ;EM: retnz 
00580   015D  1D03   btfss STATUS,b_ZERO
00581   015E  0008   return 
00582   015F  0A92              incf    TMP2
00583   0160  2956              goto    PutText2
00584               
00585   0161  0082  GetChar     movwf   PCL
00586               
00587               ;********************************************
00588               ;*              Execute Tick                *
00589               ;********************************************
00590               
00591   0162  0000  SendCMD     nop
00592   0163  1606              bsf     PORTB,b_EXE
00593   0164  0000              nop
00594   0165  0000              nop
00595   0166  1206              bcf     PORTB,b_EXE
00596   0167  0000              nop
00597   0168  0008              return
00598               
00599               ;********************************************
00600               ;*             Execute command              *
00601               ;********************************************
00602               
00603   0169  2173  DoCMD       call    PutDATA
00604   016A  0008              return
00605               
00606               ;********************************************
00607               ;*               Put one char               *
00608               ;********************************************
00609               
00610   016B  1686  PutChar     bsf     PORTB,b_RS
00611   016C  0090              movwf   TMP0
00612   016D  0810              movf    TMP0,w
00613               ;EM: skipnz 
00614   016E  1903   btfsc STATUS,b_ZERO
00615   016F  3020              movlw   32
00616   0170  2173              call    PutDATA
00617   0171  1286              bcf     PORTB,b_RS
00618   0172  0008              return
00619               
00620               ;********************************************
00621               ;*           Convert 8bit to 4bit           *
00622               ;********************************************
00623               
00624   0173  0090  PutDATA     movwf   TMP0
00625   0174  0E10              swapf   TMP0,w
00626   0175  390F              andlw   0xF
00627   0176  0091              movwf   TMP1
00628   0177  0806              movf    PORTB,w
00629   0178  39F0              andlw   0xF0
00630   0179  0411              iorwf   TMP1,w
00631   017A  0086              movwf   PORTB
00632   017B  1606              bsf     PORTB,b_EXE
00633   017C  0000              nop
00634   017D  0000              nop
00635   017E  1206              bcf     PORTB,b_EXE
00636   017F  300F              movlw   0xF
00637   0180  0590              andwf   TMP0
00638   0181  0806              movf    PORTB,w
00639   0182  39F0              andlw   0xF0
00640   0183  0410              iorwf   TMP0,w
00641   0184  0086              movwf   PORTB
00642   0185  1606              bsf     PORTB,b_EXE
00643   0186  0000              nop
00644   0187  0000              nop
00645   0188  1206              bcf     PORTB,b_EXE
00646   0189  2995              goto    Wait40us
00647               
00648               ;********************************************
00649               ;*          Cold initializing LCD           *
00650               ;********************************************
00651               
00652   018A  3002  InitComm    movlw   b'00000010'
00653   018B  0086              movwf   PORTB
00654   018C  2162              call    SendCMD
00655   018D  2195              call    Wait40us
00656   018E  0008              return
00657               
00658               ;********************************************
00659               ;*               Wait routines              *
00660               ;********************************************
00661               
00662   018F  0190  Wait2ms     clrf    TMP0
00663   0190  0000  wcmd        nop
00664   0191  0000              nop
00665   0192  0B90              decfsz  TMP0
00666   0193  2990              goto    wcmd
00667   0194  0008              return
00668               
00669   0195  300F  Wait40us    movlw   15
00670   0196  0090              movwf   TMP0
00671   0197  2990              goto    wcmd
00672               
00673               ;********************************************
00674               ;*               Setup device               *
00675               ;********************************************
00676               
00677   0198  018B  Setup       clrf    INTCON
00678               
00679   0199  0185              clrf    PORTA
00680   019A  0186              clrf    PORTB
00681               
00682   019B  3019              movlw   25
00683   019C  0094              movwf   R25
00684               
00685   019D  0195              clrf    SECONDS
00686   019E  0196              clrf    MINUTES
00687   019F  0197              clrf    HOURS
00688   01A0  0198              clrf    DAY
00689               
00690   01A1  019C              clrf    FLAGS
00691   01A2  01AB              clrf    FLAGS2
00692               
00693   01A3  01A2              clrf    TIMER1
00694   01A4  01A3              clrf    TIMER2
00695   01A5  01B4              clrf    TTEMP
00696               
00697   01A6  01A5              clrf    MODE
00698   01A7  01A4              clrf    KEYBUF
00699               
00700   01A8  301F              movlw   0x1F
00701   01A9  0065              tris    PORTA
00702   01AA  0100              clrw
00703   01AB  0066              tris    PORTB
00704               
00705   01AC  218F              call    Wait2ms
00706   01AD  218F              call    Wait2ms
00707               
00708   01AE  3006              movlw   b'00000110'
00709   01AF  0062              option
00710               
00711   01B0  218A              call    InitComm
00712               
00713   01B1  3001              movlw   1
00714   01B2  2169              call    DoCMD
00715   01B3  218F              call    Wait2ms
00716               
00717   01B4  300C              movlw   0xC
00718   01B5  2169              call    DoCMD
00719   01B6  2195              call    Wait40us
00720               
00721   01B7  168B              bsf     INTCON,b_T0IE
00722   01B8  178B   bsf INTCON,b_GIE
00723   01B9  0008              return
00724               
00725               ;********************************************
00726               ;*              Clock ticking               *
00727               ;********************************************
00728               
00729   01BA  110B  Clock       bcf     INTCON,b_T0IF
00730               
00731               ;EM: rets FLAGS,b_SETTIM
00732   01BB  1B9C   btfsc FLAGS,b_SETTIM
00733   01BC  0008   return 
00734               
00735   01BD  0B94              decfsz  R25
00736   01BE  0008              return
00737               
00738   01BF  3019              movlw   25
00739   01C0  0094              movwf   R25
00740               
00741   01C1  0822              movf    TIMER1,w
00742               ;EM: skipz 
00743   01C2  1D03   btfss STATUS,b_ZERO
00744   01C3  03A2              decf    TIMER1
00745               
00746   01C4  0823              movf    TIMER2,w
00747               ;EM: skipz 
00748   01C5  1D03   btfss STATUS,b_ZERO
00749   01C6  03A3              decf    TIMER2
00750               
00751   01C7  141C   bsf FLAGS,b_TIME
00752   01C8  149C   bsf FLAGS,b_DAY
00753               
00754   01C9  0A95              incf    SECONDS
00755   01CA  0815              movf    SECONDS,w
00756   01CB  3A3C              xorlw   60
00757               ;EM: retnz 
00758   01CC  1D03   btfss STATUS,b_ZERO
00759   01CD  0008   return 
00760               
00761   01CE  0195              clrf    SECONDS
00762               
00763   01CF  0A96              incf    MINUTES
00764   01D0  0816              movf    MINUTES,w
00765   01D1  3A3C              xorlw   60
00766               ;EM: retnz 
00767   01D2  1D03   btfss STATUS,b_ZERO
00768   01D3  0008   return 
00769               
00770   01D4  0196              clrf    MINUTES
00771               
00772   01D5  0A97              incf    HOURS
00773   01D6  0817              movf    HOURS,w
00774   01D7  3A18              xorlw   24
00775               ;EM: retnz 
00776   01D8  1D03   btfss STATUS,b_ZERO
00777   01D9  0008   return 
00778               
00779   01DA  0197              clrf    HOURS
00780               
00781   01DB  0A98              incf    DAY
00782   01DC  0818              movf    DAY,w
00783   01DD  3A07              xorlw   0x7
00784               ;EM: skipnz 
00785   01DE  1903   btfsc STATUS,b_ZERO
00786   01DF  0198              clrf    DAY
00787   01E0  0008              return
00788               
00789               ;********************************************
00790               ;*              Clock ticking               *
00791               ;********************************************
00792               
00793   01E1  3880  Clear       iorlw   0x80
00794   01E2  2173              call    PutDATA
00795   01E3  3010              movlw   16
00796   01E4  0093              movwf   TMP3
00797   01E5  3020  clr         movlw   32
00798   01E6  216B              call    PutChar
00799   01E7  0B93              decfsz  TMP3
00800   01E8  29E5              goto    clr
00801   01E9  0008              return
00802               
00803               ;********************************************************************
00804               ;**                  Binary To BCD Conversion Routine              **
00805               ;********************************************************************
00806               
00807   01EA  019B  BinBCD      clrf    HSD
00808   01EB  019A              clrf    MSD
00809   01EC  0099              movwf   LSD
00810   01ED  3064  binbcd_2    movlw   100
00811   01EE  0219              subwf   LSD,w
00812               ;EM: jpnc binbcd_3
00813   01EF  1C03   btfss STATUS,b_CARRY
00814   01F0  29F4   goto binbcd_3
00815   01F1  0099              movwf   LSD
00816   01F2  0A9B              incf    HSD
00817   01F3  29ED              goto    binbcd_2
00818   01F4  300A  binbcd_3    movlw   10
00819   01F5  0219              subwf   LSD,w
00820               ;EM: retnc 
00821   01F6  1C03   btfss STATUS,b_CARRY
00822   01F7  0008   return 
00823   01F8  0099              movwf   LSD
00824   01F9  0A9A              incf    MSD
00825   01FA  29F4              goto    binbcd_3
00826               
00827               ;********************************************************************
00828               ;**                          Display Time                          **
00829               ;********************************************************************
00830               
00831   01FB  3008  DisClock    movlw   8
00832   01FC  102B   bcf FLAGS2,b_NOSEC
00833   01FD  3880  DisClockX   iorlw   0x80
00834   01FE  2173              call    PutDATA
00835   01FF  101C   bcf FLAGS,b_TIME
00836   0200  0817              movf    HOURS,w
00837   0201  21EA              call    BinBCD
00838   0202  081A              movf    MSD,w
00839               ;EM: skipz 
00840   0203  1D03   btfss STATUS,b_ZERO
00841   0204  3E30              addlw   '0'
00842   0205  216B              call    PutChar
00843   0206  0819              movf    LSD,w
00844   0207  3E30              addlw   '0'
00845   0208  216B              call    PutChar
00846   0209  303A              movlw   ':'
00847   020A  216B              call    PutChar
00848   020B  0816              movf    MINUTES,w
00849   020C  21EA              call    BinBCD
00850   020D  081A              movf    MSD,w
00851   020E  3E30              addlw   '0'
00852   020F  216B              call    PutChar
00853   0210  0819              movf    LSD,w
00854   0211  3E30              addlw   '0'
00855   0212  216B              call    PutChar
00856               ;EM: rets FLAGS2,b_NOSEC
00857   0213  182B   btfsc FLAGS2,b_NOSEC
00858   0214  0008   return 
00859   0215  303A              movlw   ':'
00860   0216  216B              call    PutChar
00861   0217  0815              movf    SECONDS,w
00862   0218  21EA              call    BinBCD
00863   0219  081A              movf    MSD,w
00864   021A  3E30              addlw   '0'
00865   021B  216B              call    PutChar
00866   021C  0819              movf    LSD,w
00867   021D  3E30              addlw   '0'
00868   021E  216B              call    PutChar
00869   021F  0008              return
00870               
00871               ;********************************************************************
00872               ;**                          Display Day                            *
00873               ;********************************************************************
00874               
00875   0220  2242  GetNumber   call    DispNumber
00876   0221  2138  GetNumber2  call    Keyboard
00877               ;EM: callns KEYBUF,b_UP,Plus
00878   0222  1DA4   btfss KEYBUF,b_UP
00879   0223  222E   call Plus
00880               ;EM: callns KEYBUF,b_DOWN,Minus
00881   0224  1D24   btfss KEYBUF,b_DOWN
00882   0225  2238   call Minus
00883               ;EM: jpns KEYBUF,b_SET,Done
00884   0226  1E24   btfss KEYBUF,b_SET
00885   0227  2A2C   goto Done
00886               ;EM: calls FLAGS,b_MEN,DispNumber
00887   0228  1B1C   btfsc FLAGS,b_MEN
00888   0229  2242   call DispNumber
00889   022A  131C              bcf     FLAGS,b_MEN
00890   022B  2A21              goto    GetNumber2
00891               
00892   022C  300C  Done        movlw   b'00001100'             ;switch off blinking display
00893   022D  2973              goto    PutDATA
00894               
00895   022E  171C  Plus        bsf     FLAGS,b_MEN
00896   022F  0829              movf    VALUE,w
00897   0230  0628              xorwf   MAX,w
00898               ;EM: jpz Plus2
00899   0231  1903   btfsc STATUS,b_ZERO
00900   0232  2A35   goto Plus2
00901               
00902   0233  0AA9              incf    VALUE
00903   0234  0008              return
00904               
00905   0235  0827  Plus2       movf    MIN,w
00906   0236  00A9              movwf   VALUE
00907   0237  0008              return
00908               
00909   0238  171C  Minus       bsf     FLAGS,b_MEN
00910   0239  0829              movf    VALUE,w
00911   023A  0627              xorwf   MIN,w
00912               ;EM: jpz Minus2
00913   023B  1903   btfsc STATUS,b_ZERO
00914   023C  2A3F   goto Minus2
00915               
00916   023D  03A9              decf    VALUE
00917   023E  0008              return
00918               
00919   023F  0828  Minus2      movf    MAX,w
00920   0240  00A9              movwf   VALUE
00921   0241  0008              return
00922               
00923               ;********************************************************************
00924               ;**                    Display Decimal Number                       *
00925               ;********************************************************************
00926               
00927   0242  082A  DispNumber  movf    POS,w
00928   0243  3880              iorlw   0x80
00929   0244  2173              call    PutDATA
00930   0245  0829              movf    VALUE,w
00931   0246  21EA              call    BinBCD
00932   0247  081A              movf    MSD,w
00933               ;EM: skipnz 
00934   0248  1903   btfsc STATUS,b_ZERO
00935   0249  1D2B              btfss   FLAGS2,b_NOZERO
00936   024A  3E30              addlw   '0'
00937   024B  216B              call    PutChar
00938   024C  0819              movf    LSD,w
00939   024D  3E30              addlw   '0'
00940   024E  216B              call    PutChar
00941               ;EM: rets FLAGS2,b_NOCURS
00942   024F  18AB   btfsc FLAGS2,b_NOCURS
00943   0250  0008   return 
00944   0251  300F              movlw   b'00001111'
00945   0252  2173              call    PutDATA
00946   0253  3010              movlw   b'00010000'
00947   0254  2173              call    PutDATA
00948   0255  0008              return
00949               
00950               ;********************************************************************
00951               ;**                    Display Hex Number                           *
00952               ;********************************************************************
00953               
00954               
00955   0256  082A  DispHEX     movf    POS,w
00956   0257  3880              iorlw   0x80
00957   0258  2173              call    PutDATA
00958   0259  0E29              swapf   VALUE,w
00959   025A  390F              andlw   0xF
00960   025B  205A              call    HexDig
00961   025C  216B              call    PutChar
00962               
00963   025D  0829              movf    VALUE,w
00964   025E  390F              andlw   0xF
00965   025F  205A              call    HexDig
00966   0260  216B              call    PutChar
00967   0261  0008              return
00968               
00969               
00970               ;********************************************************************
00971               ;**                          Display Day                            *
00972               ;********************************************************************
00973               
00974   0262  0100  DisDay      clrw
00975   0263  21E1              call    Clear
00976   0264  3080              movlw   b'10000000'
00977   0265  2173              call    PutDATA
00978   0266  109C   bcf FLAGS,b_DAY
00979   0267  0818              movf    DAY,w
00980   0268  2045              call    GetDay
00981   0269  2155              call    PutText
00982   026A  0008              return
00983               
00984   026B  131C  DispDay     bcf     FLAGS,b_MEN
00985   026C  3040              movlw   0x40
00986   026D  21E1              call    Clear
00987   026E  30C0              movlw   0xC0
00988   026F  2173              call    PutDATA
00989   0270  0829              movf    VALUE,w
00990   0271  2045              call    GetDay
00991   0272  2155              call    PutText
00992   0273  291B              goto    SetDay2
00993               
00994               ;*****************************************************************************
00995               ;**                              Write byte                                 **
00996               ;*****************************************************************************
00997               
00998   0274  111C  wr_byte     bcf     FLAGS,b_ERROR
00999               
01000   0275  30A0              movlw   CWD_WR
01001   0276  009D              movwf   TXBUF
01002   0277  22B3              call    bstart
01003   0278  22A2              call    tx
01004   0279  081F              movf    ADR,w
01005   027A  009D              movwf   TXBUF
01006   027B  22A2              call    tx
01007   027C  0832              movf    DATAO,w
01008   027D  009D              movwf   TXBUF
01009   027E  22A2              call    tx
01010   027F  22C1              call    bstop
01011   0280  191C              btfsc   FLAGS,b_ERROR
01012   0281  22FA              call    err
01013   0282  0008              return
01014               
01015               ;*****************************************************************************
01016               ;**                               Read byte                                 **
01017               ;*****************************************************************************
01018               
01019   0283  111C  rd_byte     bcf     FLAGS,b_ERROR
01020               
01021   0284  30A0              movlw   CWD_WR
01022   0285  009D              movwf   TXBUF
01023               
01024   0286  22B3              call    bstart
01025   0287  22A2              call    tx
01026               
01027   0288  081F              movf    ADR,w
01028   0289  009D              movwf   TXBUF
01029   028A  22A2              call    tx
01030   028B  22B3              call    bstart
01031               
01032   028C  30A1              movlw   CWD_RD
01033   028D  009D              movwf   TXBUF
01034               
01035   028E  22A2              call    tx
01036   028F  2295              call    rx
01037   0290  22C1              call    bstop
01038   0291  081E              movf    RXBUF,w
01039               
01040   0292  191C              btfsc   FLAGS,b_ERROR
01041   0293  22FA              call    err
01042   0294  0008              return
01043               
01044               ;*****************************************************************************
01045               ;**                            Receive  byte                                **
01046               ;*****************************************************************************
01047               
01048   0295  3008  rx          movlw   8
01049   0296  00A0              movwf   TMPL
01050   0297  019E              clrf    RXBUF
01051               
01052   0298  1003  rxlp        bcf     STATUS,b_CARRY
01053   0299  0D9E              rlf     RXBUF
01054               
01055   029A  22D0              call    bitin
01056   029B  199C              btfsc   FLAGS,b_DI
01057   029C  141E              bsf     RXBUF,0
01058               
01059   029D  0BA0              decfsz  TMPL
01060   029E  2A98              goto    rxlp
01061               
01062   029F  161C              bsf     FLAGS,b_DO
01063   02A0  22E0              call    bitout
01064   02A1  0008              return
01065               
01066               ;*****************************************************************************
01067               ;**                            Transmit byte                                **
01068               ;*****************************************************************************
01069               
01070   02A2  3008  tx          movlw   8
01071   02A3  00A0              movwf   TMPL
01072               
01073   02A4  121C  txlp        bcf     FLAGS,b_DO
01074   02A5  1B9D              btfsc   TXBUF,7
01075   02A6  161C              bsf     FLAGS,b_DO
01076   02A7  22E0              call    bitout
01077   02A8  0D9D              rlf     TXBUF
01078               
01079   02A9  101D              bcf     TXBUF,0
01080   02AA  1803              btfsc   STATUS,b_CARRY
01081   02AB  141D              bsf     TXBUF,0
01082               
01083   02AC  0BA0              decfsz  TMPL
01084   02AD  2AA4              goto    txlp
01085               
01086   02AE  22D0              call    bitin
01087   02AF  3003              movlw   3
01088   02B0  199C              btfsc   FLAGS,b_DI
01089   02B1  22FA              call    err
01090   02B2  0008              return
01091               
01092               ;*****************************************************************************
01093               ;**                          Generates start bit                            **
01094               ;*****************************************************************************
01095               
01096   02B3  3000  bstart      movlw   b'00000000'
01097   02B4  0066              tris    PORTB
01098               
01099   02B5  1706   bsf PORTB,b_SDA
01100   02B6  1406   bsf PORTB,b_SCL
01101   02B7  3001              movlw   1
01102   02B8  1C06   btfss PORTB,b_SCL
01103   02B9  22FA              call    err
01104               
01105   02BA  1306   bcf PORTB,b_SDA
01106   02BB  0000              nop
01107   02BC  0000              nop
01108   02BD  0000              nop
01109   02BE  0000              nop
01110   02BF  1006   bcf PORTB,b_SCL
01111   02C0  0008              return
01112               
01113               ;*****************************************************************************
01114               ;**                      Generates stop bit                                 **
01115               ;*****************************************************************************
01116               
01117   02C1  3000  bstop       movlw   b'00000000'
01118   02C2  0066              tris    PORTB
01119               
01120   02C3  1306   bcf PORTB,b_SDA
01121   02C4  1406   bsf PORTB,b_SCL
01122   02C5  0000              nop
01123   02C6  0000              nop
01124   02C7  0000              nop
01125   02C8  3001              movlw   1
01126   02C9  1C06   btfss PORTB,b_SCL
01127   02CA  22FA              call    err
01128               
01129   02CB  1706   bsf PORTB,b_SDA
01130   02CC  3004              movlw   4
01131               
01132   02CD  1F06   btfss PORTB,b_SDA
01133   02CE  22FA              call    err
01134   02CF  0008              return
01135               
01136               ;*****************************************************************************
01137               ;**                           Receive one bit                               **
01138               ;*****************************************************************************
01139               
01140   02D0  3040  bitin       movlw   b'01000000'
01141   02D1  0066              tris    PORTB
01142               
01143   02D2  1706   bsf PORTB,b_SDA
01144   02D3  119C              bcf     FLAGS,b_DI
01145   02D4  1406   bsf PORTB,b_SCL
01146               
01147   02D5  3001              movlw   1
01148   02D6  1806   btfsc PORTB,b_SCL
01149   02D7  2ADB              goto    bit1
01150               
01151   02D8  1D1C              btfss   FLAGS,b_ERROR
01152   02D9  00A1              movwf   TMPH
01153   02DA  151C              bsf     FLAGS,b_ERROR
01154               
01155   02DB  1B06  bit1 btfsc PORTB,b_SDA
01156   02DC  159C              bsf     FLAGS,b_DI
01157   02DD  0000              nop
01158   02DE  1006   bcf PORTB,b_SCL
01159   02DF  0008              return
01160               
01161               ;*****************************************************************************
01162               ;**                           Transmit one bit                              **
01163               ;*****************************************************************************
01164               
01165   02E0  3000  bitout      movlw   b'00000000'
01166   02E1  0066              tris    PORTB
01167               
01168   02E2  1E1C              btfss   FLAGS,b_DO
01169   02E3  2AEC              goto    bit0
01170               
01171   02E4  1706   bsf PORTB,b_SDA
01172   02E5  3002              movlw   2
01173   02E6  1B06   btfsc PORTB,b_SDA
01174   02E7  2AEF              goto    clk1
01175               
01176   02E8  1D1C              btfss   FLAGS,b_ERROR
01177   02E9  00A1              movwf   TMPH
01178   02EA  151C              bsf     FLAGS,b_ERROR
01179   02EB  2AEF              goto    clk1
01180               
01181   02EC  1306  bit0 bcf PORTB,b_SDA
01182   02ED  0000              nop
01183   02EE  0000              nop
01184   02EF  1406  clk1 bsf PORTB,b_SCL
01185   02F0  3001              movlw   1
01186   02F1  1806   btfsc PORTB,b_SCL
01187   02F2  2AF6              goto    bit2
01188               
01189   02F3  1D1C              btfss   FLAGS,b_ERROR
01190   02F4  00A1              movwf   TMPH
01191   02F5  151C              bsf     FLAGS,b_ERROR
01192   02F6  0000  bit2        nop
01193   02F7  0000              nop
01194   02F8  1006   bcf PORTB,b_SCL
01195   02F9  0008              return
01196               
01197               
01198               
01199   02FA  00A0  err         movwf   TMPL
01200   02FB  3040              movlw   0x40
01201   02FC  3880              iorlw   0x80
01202   02FD  2173              call    PutDATA
01203   02FE  3043              movlw   'C'
01204   02FF  216B              call    PutChar
01205   0300  303A              movlw   ':'
01206   0301  216B              call    PutChar
01207   0302  3030              movlw   '0'
01208   0303  0720              addwf   TMPL,w
01209   0304  216B              call    PutChar
01210               
01211   0305  2138  loop        call    Keyboard
01212               ;EM: jps KEYBUF,b_SET,loop
01213   0306  1A24   btfsc KEYBUF,b_SET
01214   0307  2B05   goto loop
01215               
01216   0308  3040              movlw   0x40
01217   0309  21E1              call    Clear
01218   030A  0008              return
01219               
01220               
01221   030B  2310  ReadTemp    call    DoAdr
01222   030C  2A83              goto    rd_byte
01223               
01224   030D  00B2  WriteTemp   movwf   DATAO
01225   030E  2310              call    DoAdr
01226   030F  2A74              goto    wr_byte
01227               
01228   0310  0833  DoAdr       movf    ATEMP,w
01229   0311  0092              movwf   TMP2
01230   0312  0E18              swapf   DAY,w
01231   0313  0093              movwf   TMP3
01232   0314  1003   bcf STATUS,b_CARRY
01233   0315  0D93              rlf     TMP3
01234   0316  0812              movf    TMP2,w
01235   0317  0793              addwf   TMP3
01236               
01237   0318  0813              movf    TMP3,w
01238   0319  009F              movwf   ADR
01239   031A  0008              return
01240               
01241               
01242               ; *** Waits for keyboard to send code ***
01243               
01245   031B  01B5              clrf    ATchar
01246   031C  1485              bsf     PORTA,b_ATC              ; Kclk=1 Allow keyboard to talk
01247   031D  1683   bsf STATUS,b_RP0
01248   031E  1485              bsf     PORTA,b_ATC              ; Kclk is in input mode
01249   031F  1283   bcf STATUS,b_RP0
01250               
01251   0320  3000  skip1st     movlw   0
01252               ;EM: callns PORTA,b_SET,Clear
01253   0321  1E05   btfss PORTA,b_SET
01254   0322  21E1   call Clear
01255               ;EM: jps PORTA,b_ATC,skip1st
01256   0323  1885   btfsc PORTA,b_ATC
01257   0324  2B20   goto skip1st
01258               
01259               ;EM: jpns PORTA,b_ATC,skippy
01261   0325  1C85   btfss PORTA,b_ATC
01262   0326  2B25   goto skippy
01263               
01264   0327  3008              movlw   8
01265   0328  00A0              movwf   TMPL
01266               
01267               ;EM: jps PORTA,b_ATC,ATwait0
01269   0329  1885   btfsc PORTA,b_ATC
01270   032A  2B29   goto ATwait0
01271               
01272   032B  0CB5              rrf     ATchar
01273               
01274   032C  17B5              bsf     ATchar,7
01275   032D  1C05              btfss   PORTA,b_ATD
01276   032E  13B5              bcf     ATchar,7
01277               
01278               ;EM: jpns PORTA,b_ATC,ATwait1
01280   032F  1C85   btfss PORTA,b_ATC
01281   0330  2B2F   goto ATwait1
01282               
01283   0331  0BA0              decfsz  TMPL
01284   0332  2B29              goto    ATwait0             ; get all 8 bits of data
01285               
01286               ;EM: jps PORTA,b_ATC,parity0
01288   0333  1885   btfsc PORTA,b_ATC
01289   0334  2B33   goto parity0
01290               
01291               ;EM: jpns PORTA,b_ATC,parity1
01293   0335  1C85   btfss PORTA,b_ATC
01294   0336  2B35   goto parity1
01295               
01296               ;EM: jps PORTA,b_ATC,stop0
01298   0337  1885   btfsc PORTA,b_ATC
01299   0338  2B37   goto stop0
01300               
01301               ;EM: jpns PORTA,b_ATC,stop1
01303   0339  1C85   btfss PORTA,b_ATC
01304   033A  2B39   goto stop1
01305               
01306   033B  1085              bcf     PORTA,b_ATC              ; Kclk=0 Send handshake
01307   033C  1683   bsf STATUS,b_RP0
01308   033D  1085              bcf     PORTA,b_ATC              ; Kclk is in output mode
01309   033E  1283   bcf STATUS,b_RP0
01310   033F  0008              return
01311               
01312               
01313               
01314   0340  00AF  xpush       movwf   RTMP
01315   0341  0330              decf    STACK,w
01316   0342  3907              andlw   0x7
01317   0343  00B0              movwf   STACK
01318   0344  3E38              addlw   LSTACK
01319   0345  0084              movwf   FSR
01320   0346  082F              movf    RTMP,w
01321   0347  0080              movwf   INDF
01322   0348  0008              return
01323               
01324   0349  00AF  xpop        movwf   RTMP
01325   034A  0830              movf    STACK,w
01326   034B  3E38              addlw   LSTACK
01327   034C  0084              movwf   FSR
01328   034D  3E01              addlw   1
01329   034E  3907              andlw   0x7
01330   034F  00B0              movwf   STACK
01331   0350  0800              movf    INDF,w
01332   0351  00B1              movwf   RTMP2
01333   0352  082F              movf    RTMP,w
01334   0353  0084              movwf   FSR
01335   0354  0831              movf    RTMP2,w
01336   0355  0080              movwf   INDF
01337   0356  0008              return
01338               
01339               
ERR_POR EQU 0005 C
INTERRUPT EQU 0004 C
ISR EQU 0004 C
INDF EQU 0000 C
TMR0 EQU 0001 C
PCL EQU 0002 C
STATUS EQU 0003 C
FSR EQU 0004 C
PORTA EQU 0005 C
PORTB EQU 0006 C
TRISA EQU 0005 C
TRISB EQU 0006 C
OPTION EQU 0001 C
EEDATA EQU 0008 C
EEADR EQU 0009 C
EECON1 EQU 0008 C
EECON2 EQU 0009 C
PCLATH EQU 000A C
INTCON EQU 000B C
RC EQU 0003 C
HS EQU 0002 C
XT EQU 0001 C
LP EQU 0000 C
WDT EQU 0004 C
PWRTE EQU 0008 C
CPOFF EQU 0010 C
b_GIE EQU 0007 C
b_EEIE EQU 0006 C
b_T0IE EQU 0005 C
b_INTE EQU 0004 C
b_RBIE EQU 0003 C
b_T0IF EQU 0002 C
b_INTF EQU 0001 C
b_RBIF EQU 0000 C
b_RBPU EQU 0007 C
b_INTEDG EQU 0006 C
b_T0CS EQU 0005 C
b_T0SE EQU 0004 C
b_PSA EQU 0003 C
b_PS2 EQU 0002 C
b_PS1 EQU 0001 C
b_PS0 EQU 0000 C
b_IRP EQU 0007 C
b_RP1 EQU 0006 C
b_RP0 EQU 0005 C
b_TO EQU 0004 C
b_PD EQU 0003 C
b_ZERO EQU 0002 C
b_DC EQU 0001 C
b_CARRY EQU 0000 C
b_EEIF EQU 0004 C
b_WRERR EQU 0003 C
b_WREN EQU 0002 C
b_WR EQU 0001 C
b_RD EQU 0000 C
b_ATC EQU 0001 C
b_ATD EQU 0000 C
LCD_RESET EQU 0028 C
CWD_WR EQU 00A0 C
CWD_RD EQU 00A1 C
ALLKEYS EQU 001C C
MAXPAR EQU 0008 C
LSTACK EQU 0038 C
TMP0 EQU 0010 C
TMP1 EQU 0011 C
TMP2 EQU 0012 C
TMP3 EQU 0013 C
R25 EQU 0014 C
SECONDS EQU 0015 C
MINUTES EQU 0016 C
HOURS EQU 0017 C
DAY EQU 0018 C
LSD EQU 0019 C
MSD EQU 001A C
HSD EQU 001B C
FLAGS EQU 001C C
TXBUF EQU 001D C
RXBUF EQU 001E C
ADR EQU 001F C
TMPL EQU 0020 C
TMPH EQU 0021 C
TIMER1 EQU 0022 C
TIMER2 EQU 0023 C
KEYBUF EQU 0024 C
MODE EQU 0025 C
WAITK EQU 0026 C
MIN EQU 0027 C
MAX EQU 0028 C
VALUE EQU 0029 C
POS EQU 002A C
FLAGS2 EQU 002B C
W_TEMP EQU 002D C
STATUS_TEMP EQU 002E C
RTMP EQU 002F C
STACK EQU 0030 C
RTMP2 EQU 0031 C
DATAO EQU 0032 C
ATEMP EQU 0033 C
TTEMP EQU 0034 C
ATchar EQU 0035 C
b_DOWN EQU 0002 C
b_UP EQU 0003 C
b_SET EQU 0004 C
b_SCL EQU 0000 C
b_EXE EQU 0004 C
b_RS EQU 0005 C
b_SDA EQU 0006 C
b_TIME EQU 0000 C
b_DAY EQU 0001 C
b_ERROR EQU 0002 C
b_DI EQU 0003 C
b_DO EQU 0004 C
b_KEN EQU 0005 C
b_MEN EQU 0006 C
b_SETTIM EQU 0007 C
b_NOSEC EQU 0000 C
b_NOCURS EQU 0001 C
b_NOZERO EQU 0002 C
ISR_BACK EQU 000A L
T_po EQU 000F L
T_ut EQU 0016 L
T_st EQU 001B L
T_ct EQU 0021 L
T_pa EQU 0028 L
T_so EQU 002D L
T_ne EQU 0033 L
T_nastav EQU 0039 L
M_cas EQU 003F L
M_datum EQU 0042 L
GetDay EQU 0045 L
GetMode EQU 004E L
HexDig EQU 005A L
DoMode EQU 006C L
Start EQU 0078 L
Main EQU 0081 L
main_2 EQU 0089 L
SelUp EQU 0093 L
SelDown EQU 009C L
SelSet EQU 00A5 L
SetTemp EQU 00AA L
SetTemp2 EQU 00B4 L
back EQU 00C3 L
TempSet EQU 00C7 L
DispTemp EQU 00E0 L
HrSet EQU 00F5 L
SetTime EQU 00F7 L
SetDay EQU 0114 L
SetDay2 EQU 011B L
DaySet EQU 0125 L
DispMode EQU 012A L
Keyboard EQU 0138 L
key2 EQU 0144 L
key3 EQU 014D L
PutText EQU 0155 L
PutText2 EQU 0156 L
GetChar EQU 0161 L
SendCMD EQU 0162 L
DoCMD EQU 0169 L
PutChar EQU 016B L
PutDATA EQU 0173 L
InitComm EQU 018A L
Wait2ms EQU 018F L
wcmd EQU 0190 L
Wait40us EQU 0195 L
Setup EQU 0198 L
Clock EQU 01BA L
Clear EQU 01E1 L
clr EQU 01E5 L
BinBCD EQU 01EA L
binbcd_2 EQU 01ED L
binbcd_3 EQU 01F4 L
DisClock EQU 01FB L
DisClockX EQU 01FD L
GetNumber EQU 0220 L
GetNumber2 EQU 0221 L
Done EQU 022C L
Plus EQU 022E L
Plus2 EQU 0235 L
Minus EQU 0238 L
Minus2 EQU 023F L
DispNumber EQU 0242 L
DispHEX EQU 0256 L
DisDay EQU 0262 L
DispDay EQU 026B L
wr_byte EQU 0274 L
rd_byte EQU 0283 L
rx EQU 0295 L
rxlp EQU 0298 L
tx EQU 02A2 L
txlp EQU 02A4 L
bstart EQU 02B3 L
bstop EQU 02C1 L
bitin EQU 02D0 L
bit1 EQU 02DB L
bitout EQU 02E0 L
bit0 EQU 02EC L
clk1 EQU 02EF L
bit2 EQU 02F6 L
err EQU 02FA L
loop EQU 0305 L
ReadTemp EQU 030B L
WriteTemp EQU 030D L
DoAdr EQU 0310 L
ATgetkey EQU 031B L
skip1st EQU 0320 L
skippy EQU 0325 L
ATwait0 EQU 0329 L
ATwait1 EQU 032F L
parity0 EQU 0333 L
parity1 EQU 0335 L
stop0 EQU 0337 L
stop1 EQU 0339 L
xpush EQU 0340 L
xpop EQU 0349 L
