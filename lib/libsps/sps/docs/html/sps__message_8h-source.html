<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libSPS++: /Storage/projects/sps/include/sps/sps_message.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>/Storage/projects/sps/include/sps/sps_message.h</h1><a href="sps__message_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00051 <span class="preprocessor">#ifndef SPS_MESSAGE_H_</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#define SPS_MESSAGE_H_</span>
00053 <span class="preprocessor"></span>
00054 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00055 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00056 
00057 <span class="preprocessor">#include &lt;proto/exec.h&gt;</span>
00058 <span class="preprocessor">#include &lt;proto/utility.h&gt;</span>
00059 
00060 <span class="preprocessor">#include &lt;exec/types.h&gt;</span>
00061 <span class="preprocessor">#include &lt;exec/ports.h&gt;</span>
00062 
00063 <span class="preprocessor">#include &lt;dos/dos.h&gt;</span>
00064 
00065 <span class="comment">/* a message object */</span>
00066 <span class="keyword">class </span>SPS_Message : <span class="keyword">public</span> Message
00067 {
00068 <span class="keyword">public</span>:
00069     SPS_Message() 
00070     {
00071         IUtility-&gt;ClearMem( &amp;mn_Node, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Node) );
00072         mn_Node.ln_Type = NT_MESSAGE;
00073         mn_Length       = <span class="keyword">sizeof</span>( <span class="keyword">class </span>SPS_Message );
00074         mn_ReplyPort    = NULL;
00075     }
00076     <span class="keyword">virtual</span> ~SPS_Message() {}
00077            
00079     <span class="keyword">virtual</span> <span class="keywordtype">void</span> Send( <span class="keyword">struct</span> MsgPort* port )
00080     {
00081         <span class="comment">// an async message does not have reply port</span>
00082         IExec-&gt;SetSignal( 0, 0 );
00083         IExec-&gt;PutMsg( port, <span class="keyword">this</span> );
00084         <span class="comment">// if sync message, wait until we get reply (a CTRL-F flushes the wait)</span>
00085         <span class="keywordflow">if</span> ( mn_ReplyPort ) {
00086             IExec-&gt;Wait( 1 &lt;&lt; mn_ReplyPort-&gt;mp_SigBit | SIGBREAKF_CTRL_F );
00087         }
00088     }
00089     
00090     <span class="comment">/* default message is async */</span>
00091     <span class="keyword">virtual</span> <span class="keywordtype">void</span> Reply()
00092     {
00093         IExec-&gt;ReplyMsg( <span class="keyword">this</span> );
00094     }
00095 
00096     <span class="keywordtype">bool</span> IsSync() { <span class="keywordflow">return</span> mn_ReplyPort != NULL; }
00097 };
00098 
00099 <span class="comment">/* same as above, but a template which adds a reply and an abstract message body */</span>
00100 <span class="keyword">template</span>&lt; <span class="keyword">class</span> BODY &gt;
00101 <span class="keyword">class </span>SPS_SyncMessageT : <span class="keyword">public</span> SPS_Message
00102 {
00103 <span class="keyword">protected</span>:
00104     BODY m_Body;
00105 
00106 <span class="keyword">public</span>:
00107 
00108     SPS_SyncMessageT( BODY body )
00109         : SPS_Message()
00110         , m_Body(body)
00111     {
00112         <span class="comment">// sync message adds a reply port</span>
00113         mn_ReplyPort = static_cast&lt;struct MsgPort*&gt;(IExec-&gt;AllocSysObject(ASOT_PORT, NULL));
00114         <span class="comment">// correct size</span>
00115         mn_Length    = <span class="keyword">sizeof</span>(<span class="keyword">class </span>SPS_SyncMessageT&lt;BODY&gt;);
00116     }
00117     SPS_SyncMessageT() : SPS_Message()
00118     {
00119         <span class="comment">// sync message adds a reply port</span>
00120         mn_ReplyPort = static_cast&lt;struct MsgPort*&gt;(IExec-&gt;AllocSysObject(ASOT_PORT, NULL));
00121         <span class="comment">// correct size</span>
00122         mn_Length    = <span class="keyword">sizeof</span>(<span class="keyword">class </span>SPS_SyncMessageT&lt;BODY&gt;);
00123     }
00124     
00125     ~SPS_SyncMessageT()
00126     {
00127         <span class="keywordflow">if</span> (mn_ReplyPort) {
00128             IExec-&gt;FreeSysObject(ASOT_PORT, static_cast&lt;void*&gt;(mn_ReplyPort));
00129         }
00130     }
00131 
00133     <span class="keyword">inline</span> BODY&amp; GetBody() { <span class="keywordflow">return</span> m_Body; }   
00134 };
00135 
00136 <span class="keyword">template</span>&lt; <span class="keyword">class</span> BODY &gt;
00137 <span class="keyword">class </span>SPS_AsyncMessageT : <span class="keyword">public</span> SPS_Message
00138 {
00139 <span class="keyword">protected</span>:
00140     BODY m_Body;
00141 
00142 <span class="keyword">public</span>:
00143     SPS_AsyncMessageT( BODY body )
00144         : SPS_Message()
00145         , m_Body( body )
00146     {
00147         <span class="comment">// correct size</span>
00148         mn_Length    = <span class="keyword">sizeof</span>(<span class="keyword">class </span>SPS_AsyncMessageT&lt;BODY&gt;);
00149     }
00150 
00151     SPS_AsyncMessageT() : SPS_Message()
00152     {
00153         <span class="comment">// correct size</span>
00154         mn_Length    = <span class="keyword">sizeof</span>(<span class="keyword">class </span>SPS_AsyncMessageT&lt;BODY&gt;);
00155     }
00156     
00158     <span class="keyword">inline</span> BODY&amp; GetBody() { <span class="keywordflow">return</span> m_Body; }   
00159 };
00160 
00161 <span class="keyword">template</span>&lt;<span class="keyword">class</span> MESSAGE&gt;
00162 <span class="keyword">class </span>SPS_ExecMessageT
00163 {
00164 <span class="keyword">public</span>:
00165     MESSAGE m_Message; <span class="comment">// must be struct Message++</span>
00166 
00167     SPS_ExecMessageT()
00168     {
00169         IUtility-&gt;ClearMem( &amp;m_Message, <span class="keyword">sizeof</span>( MESSAGE ) );
00170         <span class="keyword">struct </span>Message *msg = reinterpret_cast&lt;struct Message*&gt;(&amp;m_Message);
00171         msg-&gt;mn_Node.ln_Type = NT_MESSAGE;
00172         msg-&gt;mn_Length       = <span class="keyword">sizeof</span>( <span class="keyword">class </span>SPS_Message );
00173         msg-&gt;mn_ReplyPort    = static_cast&lt;struct MsgPort*&gt;(IExec-&gt;AllocSysObject(ASOT_PORT, NULL));;
00174     }
00175 
00176     ~SPS_ExecMessageT()
00177     {
00178         <span class="keyword">struct </span>Message *msg = reinterpret_cast&lt;struct Message*&gt;(&amp;m_Message);
00179         <span class="keywordflow">if</span> ( msg-&gt;mn_ReplyPort ) {
00180             IExec-&gt;FreeSysObject(ASOT_PORT, static_cast&lt;void*&gt;(msg-&gt;mn_ReplyPort));
00181         }
00182     }
00183     <span class="keyword">virtual</span> <span class="keywordtype">void</span> Send( <span class="keyword">struct</span> MsgPort* port )
00184     {
00185         <span class="keyword">struct </span>Message *msg = reinterpret_cast&lt;struct Message*&gt;(&amp;m_Message);
00186 
00187         IExec-&gt;PutMsg( port, msg );
00188         <span class="keywordflow">if</span> ( msg-&gt;mn_ReplyPort ) {
00189             IExec-&gt;Wait( 1 &lt;&lt; msg-&gt;mn_ReplyPort-&gt;mp_SigBit );
00190         }
00191     }
00192 };
00193 
00194 <span class="preprocessor">#endif</span>
00195 <span class="preprocessor"></span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Sep 1 18:05:20 2006 for libSPS++ by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
