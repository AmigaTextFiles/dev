/*
 *  Source machine generated by GadToolsBox V2.0b
 *  which is (c) Copyright 1991-1993 Jaba Development
 *
 *  GUI Designed by : Mark Thomas
 */

#include <string.h>

#include <exec/types.h>
#include <intuition/intuition.h>
#include <intuition/classes.h>
#include <intuition/classusr.h>
#include <intuition/imageclass.h>
#include <intuition/gadgetclass.h>
#include <libraries/gadtools.h>
#include <graphics/displayinfo.h>
#include <graphics/gfxbase.h>

#include <proto/exec.h>
#include <proto/intuition.h>
#include <proto/gadtools.h>
#include <proto/graphics.h>
#include <proto/utility.h>
#include <proto/diskfont.h>

#include "editorprefs.h"

struct Screen         *Scr = NULL;
UBYTE                 *PubScreenName = NULL;
APTR                   VisualInfo = NULL;
struct Window         *EditorPrefsWnd = NULL;
struct Gadget         *EditorPrefsGList = NULL;
struct IntuiMessage    EditorPrefsMsg;
struct Gadget         *EditorPrefsGadgets[19];
UWORD                  EditorPrefsLeft = 0;
UWORD                  EditorPrefsTop = 222;
UWORD                  EditorPrefsWidth = 620;
UWORD                  EditorPrefsHeight = 200;
UBYTE                 *EditorPrefsWdt = (UBYTE *)"Editor Prefs (not particularly font sensitive)";
struct TextAttr       *Font, Attr;
UWORD                  FontX, FontY;
UWORD                  OffX, OffY;
struct TextFont       *EditorPrefsFont = NULL;

UBYTE *align_radio0Labels[] = {
	(UBYTE *)"Left",
	(UBYTE *)"Center",
	(UBYTE *)"Right",
	NULL };

UBYTE *blink_radio0Labels[] = {
	(UBYTE *)"Off",
	(UBYTE *)"Slow",
	(UBYTE *)"Medium",
	(UBYTE *)"Fast",
	NULL };

UBYTE *border_radio0Labels[] = {
	(UBYTE *)"None",
	(UBYTE *)"Bevel",
	(UBYTE *)"Double-bevel",
	NULL };

UWORD EditorPrefsGTypes[] = {
	CHECKBOX_KIND,
	CHECKBOX_KIND,
	CHECKBOX_KIND,
	CHECKBOX_KIND,
	CHECKBOX_KIND,
	CHECKBOX_KIND,
	MX_KIND,
	CHECKBOX_KIND,
	CHECKBOX_KIND,
	SLIDER_KIND,
	MX_KIND,
	MX_KIND,
	CHECKBOX_KIND,
	CHECKBOX_KIND,
	TEXT_KIND,
	TEXT_KIND,
	TEXT_KIND,
	TEXT_KIND,
	CHECKBOX_KIND
};

struct NewGadget EditorPrefsNGad[] = {
	9, 10, 26, 11, (UBYTE *)"Block Cursor", NULL, GD_block_cursor_check, PLACETEXT_RIGHT, NULL, (APTR)block_cursor_checkClicked,
	9, 34, 26, 11, (UBYTE *)"Disable", NULL, GD_disable_check, PLACETEXT_RIGHT, NULL, (APTR)disable_checkClicked,
	9, 59, 26, 11, (UBYTE *)"No Ghost", NULL, GD_no_ghost_check, PLACETEXT_RIGHT, NULL, (APTR)no_ghost_checkClicked,
	9, 116, 26, 11, (UBYTE *)"Italic", NULL, GD_italic_check, PLACETEXT_RIGHT, NULL, (APTR)italic_checkClicked,
	9, 141, 26, 11, (UBYTE *)"Underline", NULL, GD_underline_check, PLACETEXT_RIGHT, NULL, (APTR)underline_checkClicked,
	9, 166, 26, 11, (UBYTE *)"Bold", NULL, GD_bold_check, PLACETEXT_RIGHT, NULL, (APTR)bold_checkClicked,
	172, 116, 17, 9, NULL, NULL, GD_align_radio, PLACETEXT_RIGHT, NULL, (APTR)align_radioClicked,
	172, 10, 26, 11, (UBYTE *)"Vertical Center", NULL, GD_vcenter_check, PLACETEXT_RIGHT, NULL, (APTR)vcenter_checkClicked,
	172, 34, 26, 11, (UBYTE *)"Ruled Paper", NULL, GD_ruled_paper_check, PLACETEXT_RIGHT, NULL, (APTR)ruled_paper_checkClicked,
	371, 160, 102, 19, (UBYTE *)"Spacing:", NULL, GD_spacing_slider, PLACETEXT_LEFT, NULL, (APTR)spacing_sliderClicked,
	526, 33, 17, 9, NULL, NULL, GD_blink_radio, PLACETEXT_RIGHT, NULL, (APTR)blink_radioClicked,
	371, 33, 17, 9, NULL, NULL, GD_border_radio, PLACETEXT_RIGHT, NULL, (APTR)border_radioClicked,
	371, 96, 26, 11, (UBYTE *)"Inverted", NULL, GD_invert_check, PLACETEXT_RIGHT, NULL, (APTR)invert_checkClicked,
	172, 59, 26, 11, (UBYTE *)"Partial", NULL, GD_partial_check, PLACETEXT_RIGHT, NULL, (APTR)partial_checkClicked,
	371, 10, 88, 24, NULL, NULL, GD_border_text, 0, NULL, NULL,
	9, 87, 92, 26, NULL, NULL, GD_style_text, 0, NULL, NULL,
	172, 87, 112, 24, NULL, NULL, GD_align_text, 0, NULL, NULL,
	526, 10, 97, 21, NULL, NULL, GD_cursor_text, 0, NULL, NULL,
	371, 126, 26, 11, (UBYTE *)"Notepad Colors", NULL, GD_notepad_check, PLACETEXT_RIGHT, NULL, (APTR)notepad_checkClicked
};

ULONG EditorPrefsGTags[] = {
	(TAG_DONE),
	(TAG_DONE),
	(TAG_DONE),
	(TAG_DONE),
	(TAG_DONE),
	(TAG_DONE),
	(GTMX_Labels), (ULONG)&align_radio0Labels[ 0 ], (TAG_DONE),
	(TAG_DONE),
	(TAG_DONE),
	(GTSL_Max), 50, (GTSL_MaxLevelLen), 11, (GTSL_LevelFormat), (ULONG)"%ld pixels", (GTSL_LevelPlace), (PLACETEXT_RIGHT), (PGA_Freedom), LORIENT_HORIZ, (GA_RelVerify), TRUE, (TAG_DONE),
	(GTMX_Labels), (ULONG)&blink_radio0Labels[ 0 ], (TAG_DONE),
	(GTMX_Labels), (ULONG)&border_radio0Labels[ 0 ], (TAG_DONE),
	(TAG_DONE),
	(TAG_DONE),
	(GTTX_Text), (ULONG)"Border:", (GTTX_CopyText), TRUE, (TAG_DONE),
	(GTTX_Text), (ULONG)"Style:", (TAG_DONE),
	(GTTX_Text), (ULONG)"Align:", (TAG_DONE),
	(GTTX_Text), (ULONG)"Cursor:", (TAG_DONE),
	(TAG_DONE)
};

static UWORD ComputeX( UWORD value )
{
	return(( UWORD )((( FontX * value ) + 5 ) / 10 ));
}

static UWORD ComputeY( UWORD value )
{
	return(( UWORD )((( FontY * value ) + 9 ) / 18 ));
}

static void ComputeFont( UWORD width, UWORD height )
{
	Forbid();
	Font = &Attr;
	Font->ta_Name = (STRPTR)GfxBase->DefaultFont->tf_Message.mn_Node.ln_Name;
	Font->ta_YSize = FontY = GfxBase->DefaultFont->tf_YSize;
	FontX = GfxBase->DefaultFont->tf_XSize;
	Permit();

	OffX = Scr->WBorLeft;
	OffY = Scr->RastPort.TxHeight + Scr->WBorTop + 1;

	if ( width && height ) {
		if (( ComputeX( width ) + OffX + Scr->WBorRight ) > Scr->Width )
			goto UseTopaz;
		if (( ComputeY( height ) + OffY + Scr->WBorBottom ) > Scr->Height )
			goto UseTopaz;
	}
	return;

UseTopaz:
	Font->ta_Name = (STRPTR)"topaz.font";
	FontX = FontY = Font->ta_YSize = 8;
}

int SetupScreen( void )
{
	if ( ! ( Scr = LockPubScreen( PubScreenName )))
		return( 1L );

	ComputeFont( 0, 0 );

	if ( ! ( VisualInfo = GetVisualInfo( Scr, TAG_DONE )))
		return( 2L );

	return( 0L );
}

void CloseDownScreen( void )
{
	if ( VisualInfo ) {
		FreeVisualInfo( VisualInfo );
		VisualInfo = NULL;
	}

	if ( Scr        ) {
		UnlockPubScreen( NULL, Scr );
		Scr = NULL;
	}
}

int HandleEditorPrefsIDCMP( void )
{
	struct IntuiMessage	*m;
	int			(*func)(void);
	BOOL			running = TRUE;

	while( m = GT_GetIMsg( EditorPrefsWnd->UserPort )) {

		CopyMem(( char * )m, ( char * )&EditorPrefsMsg, (long)sizeof( struct IntuiMessage ));

		GT_ReplyIMsg( m );

		switch ( EditorPrefsMsg.Class ) {

			case	IDCMP_REFRESHWINDOW:
				GT_BeginRefresh( EditorPrefsWnd );
				GT_EndRefresh( EditorPrefsWnd, TRUE );
				break;

			case	IDCMP_GADGETUP:
			case	IDCMP_GADGETDOWN:
				func = ( int (*)() )(( struct Gadget * )EditorPrefsMsg.IAddress )->UserData;
				running = func();
				break;

			case	IDCMP_MOUSEMOVE:
				if (EditorPrefsMsg.IAddress == EditorPrefsGadgets[GDX_spacing_slider]) {
					func = ( int (*)() )(( struct Gadget * )EditorPrefsMsg.IAddress )->UserData;
					running = func();
				}
				break;
		}
	}
	return( running );
}

int OpenEditorPrefsWindow( void )
{
	struct NewGadget	ng;
	struct Gadget	*g;
	UWORD		lc, tc;
	UWORD		wleft = EditorPrefsLeft, wtop = EditorPrefsTop, ww, wh;

	ComputeFont( EditorPrefsWidth, EditorPrefsHeight );

	ww = ComputeX( EditorPrefsWidth );
	wh = ComputeY( EditorPrefsHeight );

	if (( wleft + ww + OffX + Scr->WBorRight ) > Scr->Width ) wleft = Scr->Width - ww;
	if (( wtop + wh + OffY + Scr->WBorBottom ) > Scr->Height ) wtop = Scr->Height - wh;

	if ( ! ( EditorPrefsFont = OpenDiskFont( Font )))
		return( 5L );

	if ( ! ( g = CreateContext( &EditorPrefsGList )))
		return( 1L );

	for( lc = 0, tc = 0; lc < EditorPrefs_CNT; lc++ ) {

		CopyMem((char * )&EditorPrefsNGad[ lc ], (char * )&ng, (long)sizeof( struct NewGadget ));

		ng.ng_VisualInfo = VisualInfo;
		ng.ng_TextAttr   = Font;
		ng.ng_LeftEdge   = OffX + ComputeX( ng.ng_LeftEdge );
		ng.ng_TopEdge    = OffY + ComputeY( ng.ng_TopEdge );
		ng.ng_Width      = ComputeX( ng.ng_Width );
		ng.ng_Height     = ComputeY( ng.ng_Height);

		EditorPrefsGadgets[ lc ] = g = CreateGadgetA((ULONG)EditorPrefsGTypes[ lc ], g, &ng, ( struct TagItem * )&EditorPrefsGTags[ tc ] );

		while( EditorPrefsGTags[ tc ] ) tc += 2;
		tc++;

		if ( NOT g )
			return( 2L );
	}

	if ( ! ( EditorPrefsWnd = OpenWindowTags( NULL,
				WA_Left,	wleft,
				WA_Top,		wtop,
				WA_Width,	ww + OffX + Scr->WBorRight,
				WA_Height,	wh + OffY + Scr->WBorBottom,
				WA_IDCMP,	CHECKBOXIDCMP|MXIDCMP|SLIDERIDCMP|TEXTIDCMP|IDCMP_INTUITICKS|IDCMP_REFRESHWINDOW,
				WA_Flags,	WFLG_DRAGBAR|WFLG_DEPTHGADGET|WFLG_SMART_REFRESH|WFLG_ACTIVATE,
				WA_Gadgets,	EditorPrefsGList,
				WA_Title,	EditorPrefsWdt,
				WA_ScreenTitle,	"Window created with GadToolsBox",
				WA_PubScreen,	Scr,
				TAG_DONE )))
	return( 4L );

	GT_RefreshWindow( EditorPrefsWnd, NULL );

	return( 0L );
}

void CloseEditorPrefsWindow( void )
{
	if ( EditorPrefsWnd        ) {
		CloseWindow( EditorPrefsWnd );
		EditorPrefsWnd = NULL;
	}

	if ( EditorPrefsGList      ) {
		FreeGadgets( EditorPrefsGList );
		EditorPrefsGList = NULL;
	}

	if ( EditorPrefsFont ) {
		CloseFont( EditorPrefsFont );
		EditorPrefsFont = NULL;
	}
}

