;
;
;     .........                                        .........
;     ::     ::          t  a  s  k  i  `  s           ::     ::
;     ::     ::       ______ ____  ___   ___ ____      ::     ::
;     ::  .. ::      ____  /    /__  /_ _\  \   /      :: ..  ::
;     ::..:: ::     |__   __  _   / __/ _|\___  |      :: ::..::
;            ::     |/    \/_(/   |     \|      |      ::
;            ::     /______\ /__________________\      ::
;         ____:______ __   ______________  ______ _____: ______
;      ___\  /   __ /  /__ \      /\    /|____  /   __ /      /
;     |__   _|  _ ,_|  __/_ \    _|/\  //|__   __  _ ,_|_    /|
;     |/    \|_(/  \|      |/    \|  \/  |/    \/_(/  \|/    /|
;     /______\ /________________________________\ /___________\
;            ::                                        ::az0!/l124
;
; PROJECT:       AntyDresiarz Issue 3
; VERSION:       3.1
; AUTHOR:        Paplo/Taski
; COMPLETE:      [#########|] 95%
; LAST CHANGE:   16.11.1997
;

;GLOWNY_TEMP_DIR$="RAM:"

; ---------------------- INICJALIZACJA TABLIC DLA MENU -----------
Dim PICTURE_START.l(255),PICTURE_LENGTH.l(255)
Dim ARTICLE_START.l(255),ARTICLE_LENGTH.l(255)
Dim ARTICLE_TYPE$(255),ARTICLE_TITLE$(255),ARTICLE_SOURCE$(255)
Dim ARTICLE_FILE$(255)
Dim SHORT_START.l(255),SHORT_LENGTH.l(255)
; ------------------------ OTHERS
NEWTYPE.lv : a.w : b.s : End NEWTYPE
Dim List Lista_Menu.lv(500),List Krotki_opis.lv(500),List Moduly.lv(30)

Dim Pozycja_strony.l(500)
Dim Kolor_strony(500)
Dim Czcionka_strony(500)
Dim Styl_czcionki(500)
; --------------------------- DEMO --------------------------------
Dim DEMO_START.l(15),DEMO_LENGTH.l(15),DEMO_FILE$(15)
Dim PATTERN_START.l(255),PATTERN_LENGTH.l(255),PATTERN_FILE$(255)
; --------------------------- MODULE ------------------------------
Dim MODULE_START.l(30),MODULE_LENGTH.l(30),MODULE_FILE$(30),MODULE_NAME$(30)

DEFTYPE.l START_DATA_START,START_DATA_LENGTH

x$="$VER: AntyDresiarz Issue 3 v3.0 by Taski (28.09.97)" : x$=""

._FUNKCJE

InitBank 11,1008,65536

Statement AddTag{NR.l,TAG.l,TAG_DATA.l}
  Poke.l Bank(11)+(NR.l*8),TAG.l
  Poke.l Bank(11)+(NR.l*8)+4,TAG_DATA.l
End Statement

Function MemLoad {plk.l,dest.l,from.l,leng.l}
  Seek_ plk.l,from.l,-1
  Read_ plk.l,dest.l,leng.l
End Function

Function CzcionkaY{NR,Y}
  SHARED INTERLACE_FONTS
  If NR=4 AND INTERLACE_FONTS=1 Then Y=Y*2
  If NR=6 AND INTERLACE_FONTS=1 Then Y=Y*2
Function Return Y
End Function

Function.b WBorTop{SCR}
  DEFTYPE .Screen scrdata
  *scrdata.Screen=Peek.l(Addr Screen(SCR))
Function Return *scrdata\WBorTop + *scrdata\_RastPort\TxHeight +1
End Function

Function.b WBorBottom{SCR}
  DEFTYPE .Screen scrdata
  *scrdata.Screen=Peek.l(Addr Screen(SCR))
Function Return *scrdata\WBorBottom
End Function

Function.b WBorLeft{SCR}
  DEFTYPE .Screen scrdata
  *scrdata.Screen=Peek.l(Addr Screen(SCR))
Function Return *scrdata\WBorLeft
End Function

Function.b WBorRight{SCR}
  DEFTYPE .Screen scrdata
  *scrdata.Screen=Peek.l(Addr Screen(SCR))
Function Return *scrdata\WBorRight
End Function


Function.w ScrWidth{SCR}
  DEFTYPE .Screen scrdata
  *scrdata.Screen=Peek.l(Addr Screen(SCR))
Function Return *scrdata\Width
End Function

Function.w ScrHeight{SCR}
  DEFTYPE .Screen scrdata
  *scrdata.Screen=Peek.l(Addr Screen(SCR))
Function Return *scrdata\Height
End Function

DEFTYPE.l catalog,katstr,locale
locale.l=OpenLocale_ ("AntyDresiarz.catalog") : catalog.l=OpenCatalogA_ (locale.l,"AntyDresiarz.catalog",0)

Function$ GetCatStr{katalog.l,STRN,DEF_STR$}
  katstr.l=GetCatalogStr_(katalog.l,STRN,DEF_STR$)
  Function Return Left$(Peeks$(katstr.l,256),Instr(Peeks$(katstr.l,256),Chr$(0))-1)
End Function

._DECRUNCH

Statement XpkError{XPK_ERROR.l}
    Select XPK_ERROR.l
      Case #XPKERR_IOERRIN
        Request "AD error","Can't open selected file!","ok"

      Case #XPKERR_CHECKSUM
        Request "AD error","Selected file has a bad checksum!","ok"
      Case #XPKERR_VERSION
        Request "AD error","Selected file packed with never version of XPK lib!","ok"
      Case #XPKERR_NOMEM
        Request "AD error","Out of memory!","ok"
      Case #XPKERR_NEEDPASSWD
        Request "AD error","Password needed for decoding!"+Chr$(10)+"I dont support password!","eeee.."
      Case #XPKERR_CORRUPTPKD
        Request "AD error","Selected file is corrupted!","ok"
      Case #XPKERR_MISSINGLIB
        Request "AD error","Required Xpk-sub-library is missing!","ok"
      Case #XPKERR_WRONGCPU
        Request "AD error","Better CPU is required to decrunch this file!","Install Xpk SubLib optimised for yours CPU"
      Case #XPKERR_NOTPACKED
        Request "AD error","File is not packed!","ok"
      Case #XPKERR_OLDMASTLIB
        Request "AD error","XPK Master library is too old!","ok"
      Case #XPKERR_OLDSUBLIB
        Request "AD error","XPK Sublibrary is too old!","ok"
      Case #XPKERR_WRONGPW
        Request "AD error","Password is wrong!","ok"
      Case #XPKERR_UNKNOWN
        Request "AD error","Unknown XPK error!","ok"
    End Select
End Statement

Function.l XpkUnpackMem{XPK_SOURCE.l,XPK_PACKEDLENGTH.l,OUTMEMTYPE.l}
  SHARED XPK_BUFFER.l,XPK_LENGTH.l,XPK_ERROR.l
  XPK_BUFFER.l=0 : XPK_LENGTH.l=0 : XPK_ERROR.l=0

  DEFTYPE.l xpkbase,XPK_BUFFER,XPK_LENGTH
  xpkbase.l=OpenLibrary_("xpkmaster.library",0)

  If xpkbase.l>0
    AddTag {0,#XPK_InBuf,XPK_SOURCE.l}          ; nazwa wejsciowa pliku do dekompresji
    AddTag {1,#XPK_InLen,XPK_PACKEDLENGTH.l}    ; ile ma wczytac przy decrunchingu!
    AddTag {2,#XPK_GetOutBuf,&XPK_ADDRES.l}     ; alokuje oamiec wstawia pod wpisany adres, adres rozpakowanych danych
    AddTag {3,#XPK_OutMemType,OUTMEMTYPE.l}     ; rodzaj pamieci uzytej do bufora
    AddTag {4,#XPK_GetOutBufLen,&XPK_BUFFER.l}  ; dlugosc bufora
    AddTag {5,#XPK_GetOutLen,&XPK_LENGTH.l}     ; ile zajmuje sam rozpakowany plik
    AddTag {6,#XPK_PassThru,1}                  ; jezeli 1 to jak nie spakowane to i tak przeladuje do bufora
    AddTag {7,$80005850+$42,1}
    AddTag {8,#TAG_END,1}

    MOVE.l a6,-(a7) ; save a6 on stack
    GetReg a6,xpkbase.l : GetReg a0,Bank(11)
    JSR -48(a6) ; XpkUnpack
    PutReg d0,XPK_ERROR.l
    MOVE.l (a7)+,a6
    CloseLibrary_ xpkbase.l

;     XPK_ERROR.l=XpkUnpack_ (Bank(11))

    XpkError{XPK_ERROR.l}
  Else
    Request "AD error","Can't open xpkmaster.library","ok"
  EndIf

Function Return XPK_ADDRES.l
End Function

Function StcFileDecrunch{STCDEC1$,STCDEC2$}

  source_size.l=FileSize(STCDEC1$)
  source_addr.l=AllocMem_(source_size.l,#MEMF_ANY)

  If source_addr.l<>0
    BLoad STCDEC1$,source_addr.l

    If Peeks$(source_addr.l,4)="S404"

      WYNIK=True
      STC_DECLEN.l=Peek.l (source_addr.l+8) : STC_SEC.l=Peek.l (source_addr.l+4)

      dest_size.l=STC_DECLEN.l+STC_SEC.l
      dest_addr.l=AllocMem_(dest_size.l,#MEMF_ANY)

      STC_BASE.l=OpenLibrary_("stc.library",0)
      If STC_BASE.l<>0 AND dest_addr.l<>0
        MOVE.l a6,-(a7) ; save a6 on stack
        GetReg a0,dest_addr.l : GetReg a1,source_addr.l : GetReg a6,STC_BASE.l
        JSR -36(a6)
        MOVE.l (a7)+,a6
        FreeMem_ source_addr.l,source_size.l
        BSave STCDEC2$,dest_addr.l,STC_DECLEN.l
        FreeMem_ dest_addr.l,dest_size.l

        CloseLibrary_ STC_BASE.l
        WYNIK=True
      Else
        If dest_addr.l<>0 Then FreeMem_ dest_addr.l,dest_size.l
        WYNIK=False
      EndIf

    Else
      FreeMem_ source_addr.l,source_size.l
      WYNIK=False
    EndIf

  Else
    WYNIK=False
  EndIf
Function Return WYNIK
End Function

Function PSTCDecrunch {ADRES.l,DESTBANK,OUTMEMTYPE.l}
SHARED STC_OUT.l,STC_BUF.l,STC_LEN.l

  STC_DECLEN.l=Peek.l (ADRES.l+8) : STC_SEC.l=Peek.l (ADRES.l+4)

  If AvailMem_(#MEMF_ANY)>STC_DECLEN.l+STC_SEC.l
    STC_OUT.l=AllocMem_ (STC_DECLEN.l+STC_SEC.l,OUTMEMTYPE.l)
    STC_BUF.l=STC_DECLEN.l+STC_SEC.l
    STC_LEN.l=STC_DECLEN.l

    If Peeks$(ADRES.l,4)="S404"
      WYNIK=True
      STC_BASE.l=OpenLibrary_("stc.library",0)

      If STC_BASE.l<>0
        MOVE.l a6,-(a7) ; save a6 on stack
        GetReg a0,STC_OUT.l : GetReg a1,ADRES.l : GetReg a6,STC_BASE.l
        JSR -36(a6)
        PutReg d0,WYNIK
        MOVE.l (a7)+,a6
        CloseLibrary_ STC_BASE.l
      Else
        WYNIK=False
      EndIf

    Else
      WYNIK=False
    EndIf

  Else
    WYNIK=False
  EndIf
Function Return WYNIK
End Function

Function StcCheck{ADRESS.l}
  If Peeks$(ADRESS.l,4)="S404" : WYNIK=True : Else : WYNIK=False : EndIf
Function Return WYNIK
End Function

._FILE_IO

DEFTYPE.l plk,LOKPLK,PLK_DLUGOSC,Dlugosc_tekstu
LOK$=Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)

Function$ Edit_{plk.l}
  SHARED LOK$
  EDIT_DANE$=String$(Chr$(0),255)

  x=FGets_ (plk.l,&EDIT_DANE$,250)
  DLUG=Instr(EDIT_DANE$,Chr$(10))

  If DLUG=0
    DLUG=Instr(EDIT_DANE$,Chr$(0))-1
    If DLUG<0 Then DLUG=0
  Else
    DLUG=DLUG-1
  EndIf

  EDIT_OUT$=Left$(EDIT_DANE$,DLUG)
  LOKPLK.l=Peek.l(&LOK$)+Len(EDIT_OUT$)+1
  Poke.l &LOK$,LOKPLK.l
Function Return EDIT_OUT$
End Function

Function.l Loc_{plk.l}
  SHARED LOK$
  Function Return Peek.l(&LOK$)
End Function

Function FSeek_{plk.l,LOKPLK.l}
  SHARED LOK$
  x=Seek_ (plk.l,LOKPLK.l,-1)
  Poke.l &LOK$,LOKPLK.l
End Function

Function Eof_{plk.l,PLK_DLUGOSC.l}
  SHARED LOK$
  If Loc_{plk.l}=>PLK_DLUGOSC.l : RT=True: Else : RT=False : EndIf
Function Return RT
End Function

._PALETTE

Function Greyscale{PAL_NR,OD,DO}

  Dim col1r(255),col1g(255),col1b(255)


  *pal.palette=Addr Palette(PAL_NR)
  For t = OD To DO
    R=Peek.b(&*pal\_pdata\_rgbs[t]\_red)
    G=Peek.b(&*pal\_pdata\_rgbs[t]\_green)
    B=Peek.b(&*pal\_pdata\_rgbs[t]\_blue)


    If R<0 Then R=255+R
    If G<0 Then G=255+G
    If B<0 Then B=255+B

    GRAY=(R+G+B)/3
    Poke.b &*pal\_pdata\_rgbs[t]\_red,GRAY
    Poke.b &*pal\_pdata\_rgbs[t]\_green,GRAY
    Poke.b &*pal\_pdata\_rgbs[t]\_blue,GRAY

  Next t
End Function

Function CopyPalette{Source,Dest,Source_OD,Source_DO,Dest_OD}
  Dim col1r(255),col1g(255),col1b(255)

  *pal.palette=Addr Palette(Source)
  *pal2.palette=Addr Palette(Dest)

  For t = Source_OD To Source_DO
    R=Peek.b(&*pal\_pdata\_rgbs[t]\_red)
    G=Peek.b(&*pal\_pdata\_rgbs[t]\_green)
    B=Peek.b(&*pal\_pdata\_rgbs[t]\_blue)

    If R<0 Then R=255+R
    If G<0 Then G=255+G
    If B<0 Then B=255+B

    Poke.b &*pal2\_pdata\_rgbs[Dest_OD+(t-Source_OD)]\_red,R
    Poke.b &*pal2\_pdata\_rgbs[Dest_OD+(t-Source_OD)]\_green,G
    Poke.b &*pal2\_pdata\_rgbs[Dest_OD+(t-Source_OD)]\_blue,B

  Next t
End Function

Function PaletteRed{PAL,KOL}
  *pal.palette=Addr Palette(PAL)
   R=Peek.b(&*pal\_pdata\_rgbs[KOL]\_red)
   If R<0 Then R=255+R
Function Return R
End Function

Function PaletteGreen{PAL,KOLOR}
  *pal.palette=Addr Palette(PAL)
   G=Peek.b(&*pal\_pdata\_rgbs[KOLOR]\_green)
   If G<0 Then G=255+G
Function Return G
End Function

Function PaletteBlue{PALETA,KOLOR}
  *pal.palette=Addr Palette(PALETA)
   B=Peek.b(&*pal\_pdata\_rgbs[KOLOR]\_blue)
   If B<0 Then B=255+B
Function Return B
End Function


Function PaletteRGB {PALETA,KOLOR,RE,GREE,BLU}
    *paleta.palette=Addr Palette(PALETA)
    Poke.b &*paleta\_pdata\_rgbs[KOLOR]\_red,RE
    Poke.b &*paleta\_pdata\_rgbs[KOLOR]\_green,GREE
    Poke.b &*paleta\_pdata\_rgbs[KOLOR]\_blue,BLU
End Function

._IFF_ILBM
Function.w IFFWidth {ADRES.l}
  DLUGOSC_IFF.l=Peek.l (ADRES.l+4) : SKOK.l=12
  Repeat
    FORMA$=Peeks$(ADRES.l+SKOK.l,4) : SKOK.l=SKOK.l+4
    If FORMA$<>"BMHD"
      SKOK2.l=Peek.l (ADRES.l+SKOK.l) : SKOK.l=SKOK.l+SKOK2.l+4
    Else
      WYNIK.w=Peek.w (ADRES.l+SKOK.l+4)
      SKOK.l=DLUGOSC_IFF.l+1
    EndIf
  Until SKOK.l>DLUGOSC_IFF.l

Function Return WYNIK.w
End Function

Function.w IFFHeight {ADRES.l}
  DLUGOSC_IFF.l=Peek.l (ADRES.l+4) : SKOK.l=12
  Repeat
    FORMA$=Peeks$(ADRES.l+SKOK.l,4) : SKOK.l=SKOK.l+4
    If FORMA$<>"BMHD"
      SKOK2.l=Peek.l (ADRES.l+SKOK.l) : SKOK.l=SKOK.l+SKOK2.l+4
    Else
      WYNIK.w=Peek.w (ADRES.l+SKOK.l+6)
      SKOK.l=DLUGOSC_IFF.l+1
    EndIf
  Until SKOK.l>DLUGOSC_IFF.l

Function Return WYNIK.w
End Function

Function.b IFFDepth {ADRES.l}
  DLUGOSC_IFF.l=Peek.l (ADRES.l+4) : SKOK.l=12
  Repeat
    FORMA$=Peeks$(ADRES.l+SKOK.l,4) : SKOK.l=SKOK.l+4
    If FORMA$<>"BMHD"
      SKOK2.l=Peek.l (ADRES.l+SKOK.l) : SKOK.l=SKOK.l+SKOK2.l+4
    Else
      WYNIK.b=Peek.b (ADRES.l+SKOK.l+12)
      SKOK.l=DLUGOSC_IFF.l+1
    EndIf
  Until SKOK.l>DLUGOSC_IFF.l
Function Return WYNIK.b
End Function

Function.b CheckIFF {ADRES.l}
  If Peeks$(ADRES.l,4)="FORM"
    If Peeks$(ADRES.l+8,4)="ILBM" : WYNIK=True : Else : WYNIK=False : EndIf
  Else
    WYNIK=False
  EndIf
Function Return WYNIK
End Function

Function DecodeIFFPalette{PALETA,ADRES.l,OD,DO,INIT}
  DLUGOSC_IFF.l=Peek.l (ADRES.l+4)
  SKOK.l=12
  WYNIK=False

  Repeat
    FORMA$=Peeks$(ADRES.l+SKOK.l,4) : SKOK.l=SKOK.l+4

    If FORMA$<>"CMAP"
      SKOK2.l=Peek.l (ADRES.l+SKOK.l) : SKOK.l=SKOK.l+SKOK2.l+4
    Else
      SKOK.l=SKOK.l+4
      DEPT=(Peek.l (ADRES.l+SKOK.l-4)/3)
      If OD=False Then OD=0
      If DO=False Then DO=DEPT-1

      If INIT=True Then InitPalette PALETA,DEPT

      For DODAC=OD To DO
        *paleta.palette=Addr Palette(PALETA)
        Poke.b &*paleta\_pdata\_rgbs[DODAC]\_red,Peek.b  (ADRES.l+SKOK.l+DODAC*3)
        Poke.b &*paleta\_pdata\_rgbs[DODAC]\_green,Peek.b(ADRES.l+SKOK.l+DODAC*3+1)
        Poke.b &*paleta\_pdata\_rgbs[DODAC]\_blue,Peek.b (ADRES.l+SKOK.l+DODAC*3+2)
      Next DODAC

      SKOK.l=DLUGOSC_IFF.l+1
      WYNIK=True
    EndIf


  Until SKOK.l>DLUGOSC_IFF.l

Function Return WYNIK
End Function

._OTHERS
Function SkokAnimki {LICZBA.l}
  A.l=LICZBA.l/2
  If (A.l*2)=LICZBA.l
    WYNIK=2
    A.l=LICZBA.l/4 : If (A.l*4)=LICZBA.l Then WYNIK=4
    A.l=LICZBA.l/8 : If (A.l*8)=LICZBA.l Then WYNIK=8
  Else
    WYNIK=1
  EndIf
Function Return WYNIK
End Function

Function CPU{}
  MOVE.l #$4,a0 : MOVE.l (a0),a1
  BTST #$07,$129(a1) : BNE CPU060
  BTST #$03,$129(a1) : BNE CPU040
  BTST #$02,$129(a1) : BNE CPU030
  BTST #$01,$129(a1) : BNE CPU020
  BTST #$00,$129(a1) : BNE CPU010
  PROC=0
  Goto KONIEC

CPU060:
  PROC=6 : Goto KONIEC
CPU040:
  PROC=4 : Goto KONIEC
CPU030:
  PROC=3 : Goto KONIEC
CPU020:
  PROC=2 : Goto KONIEC
CPU010:
  PROC=1 : Goto KONIEC
KONIEC:

Function Return PROC
End Function

Function$ ZZmiany{TXT$,STRT}
  KONIEC=Instr(TXT$,"]",STRT)+1
  RET$=Mid$(TXT$,STRT,KONIEC-STRT)
  Function Return RET$
End Function

Function.l FileLoad{NAZWA$,TYP$,PLK.l,OFFSET.l,LENG.l}
  SHARED XPK_BUFFER.l,XPK_LENGTH.l,XPK_ERROR.l
  SHARED STC_OUT.l,STC_LEN.l,STC_BUF.l
  SHARED WORK_DATA.l
  SHARED Krotki_opis()
  SHARED TEMP_DIR$

  SHARED LOK$

  If NAZWA$=""
    RODZAJ_DANYCH$="DANE"
  Else
    RODZAJ_DANYCH$="PLIK"
  EndIf

; -------------------------------------------------------------- START DATA

  If TYP$="START_DATA"
    DEST_NAZWA_PLIKU$=TEMP_DIR$+"START.DATA"

    If RODZAJ_DANYCH$="PLIK"
      NAZWA_PLIKU$="START.DATA"
      DLUGOSC_PLIKU.l=Exists(NAZWA_PLIKU$)
      DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)
      If DEST.l>0
        BLoad NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
      Else
        Request "AD Error","Not enough mem to load AD!","arghhh!"
      EndIf
    EndIf

    If RODZAJ_DANYCH$="DANE"
      DEST.l=AllocMem_(LENG.l,#MEMF_ANY)
      If DEST.l>0
        DLUGOSC_PLIKU.l=LENG.l
        x=MemLoad {PLK.l,DEST.l,OFFSET.l,DLUGOSC_PLIKU.l}
      Else
        Request "AD Error","Not enough mem to load AD!","arghhh!"
      EndIf
    EndIf

    If DEST.l>0
      ski.l=0
      For i.l=0 To DLUGOSC_PLIKU.l
        enc.b=Peek.b( DEST.l+ski.l )
        Poke.b (DEST.l+ski.l),255-enc.b
        ski.l=ski.l+1
      Next

      If Peeks$(DEST.l,4)="XPKF"
        OUT.l=XpkUnpackMem{DEST.l,DLUGOSC_PLIKU.l,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        BSave DEST_NAZWA_PLIKU$,OUT.l,XPK_LENGTH.l
        If OUT.l>0 AND XPK_BUFFER.l>0 Then FreeMem_ OUT.l,XPK_BUFFER.l
        DECR=True
      EndIf

      If StcCheck{DEST.l}=True
        x=PSTCDecrunch{DEST.l,5,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        BSave DEST_NAZWA_PLIKU$,STC_OUT.l,STC_LEN.l
        FreeMem_ STC_OUT.l,STC_BUF.l
        DECR=True
      EndIf

      If DECR<>True
        BSave DEST_NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
      EndIf
    EndIf

  EndIf

; -------------------------------------------------------------- TEXT

  If TYP$="LOAD_TEXT"
    DEST_NAZWA_PLIKU$=TEMP_DIR$+"ANTYDRESIARZ-ARTEK"

    If RODZAJ_DANYCH$="PLIK"
      NAZWA_PLIKU$="TEKSTY/"+NAZWA$+".TXT"
      DLUGOSC_PLIKU.l=Exists(NAZWA_PLIKU$)
      DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)
      If DEST.l>0
        BLoad NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
      Else
        Request "AD Error","Not enough mem to load text!","arghhh!"
      EndIf
    EndIf

    If RODZAJ_DANYCH$="DANE"
      DEST.l=AllocMem_(LENG.l,#MEMF_ANY)
      If DEST.l>0
        DLUGOSC_PLIKU.l=LENG.l
        x=MemLoad {PLK.l,DEST.l,OFFSET.l,DLUGOSC_PLIKU.l}
      Else
        Request "AD Error","Not enough mem to load text!","arghhh!"
      EndIf
    EndIf

    If DEST.l>0
      If Peeks$(DEST.l,4)="XPKF"
        OUT.l=XpkUnpackMem{DEST.l,DLUGOSC_PLIKU.l,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        BSave DEST_NAZWA_PLIKU$,OUT.l,XPK_LENGTH.l
        If OUT.l>0 AND XPK_BUFFER.l>0 Then FreeMem_ OUT.l,XPK_BUFFER.l
        DECR=True
      EndIf

      If StcCheck{DEST.l}=True
        x=PSTCDecrunch{DEST.l,5,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        BSave DEST_NAZWA_PLIKU$,STC_OUT.l,STC_LEN.l
        FreeMem_ STC_OUT.l,STC_BUF.l
        DECR=True
      EndIf

      If DECR<>True
        BSave DEST_NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
      EndIf
    EndIf

  EndIf

; --------------------------------------------------------- SHORT MSG

  If TYP$="LOAD_SHORT"
    DEST_NAZWA_PLIKU$=TEMP_DIR$+"ANTYDRESIARZ-SHRMSG"

    If RODZAJ_DANYCH$="PLIK"
      NAZWA_PLIKU$="TEKSTY/"+NAZWA$+".SHR"

      DLUGOSC_PLIKU.l=Exists(NAZWA_PLIKU$)
      DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)
      If DEST.l>0
        BLoad NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
      Else
        Request "AD Error","Not enough mem to load short msg!","arghhh!"
      EndIf
    EndIf

    If RODZAJ_DANYCH$="DANE"
      DEST.l=AllocMem_(LENG.l,#MEMF_ANY)
      If DEST.l>0
        DLUGOSC_PLIKU.l=LENG.l
        x=MemLoad {PLK.l,DEST.l,OFFSET.l,DLUGOSC_PLIKU.l}
      Else
        Request "AD Error","Not enough mem to load short msg!","arghhh!"
      EndIf
    EndIf

    If DEST.l>0
      If Peeks$(DEST.l,4)="XPKF"
        OUT.l=XpkUnpackMem{DEST.l,DLUGOSC_PLIKU.l,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        BSave DEST_NAZWA_PLIKU$,OUT.l,XPK_LENGTH.l
        If OUT.l>0 AND XPK_BUFFER.l>0 Then FreeMem_ OUT.l,XPK_BUFFER.l
        DECR=True
      EndIf

      If StcCheck{DEST.l}=True
        x=PSTCDecrunch {DEST.l,5,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        BSave DEST_NAZWA_PLIKU$,STC_OUT.l,STC_LEN.l
        FreeMem_ STC_OUT.l,STC_BUF.l
        DECR=True
      EndIf

      If DECR<>True
        BSave DEST_NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
      EndIf
    EndIf

    ClearList Krotki_opis()
    short_len.l=Exists(DEST_NAZWA_PLIKU$)
    short.l=Open_ (DEST_NAZWA_PLIKU$,#MODE_OLDFILE);#ACCESS_READ)

    x=FSeek_{short.l,0}

    If short.l>0

      Repeat
        AddItem Krotki_opis() : Krotki_opis()\b=Edit_{short.l}
      Until Eof_{short.l,short_len.l}=True

      Close_ short.l
      GTChangeList 1,11,Krotki_opis()
      DeleteFile_ DEST_NAZWA_PLIKU$
    EndIf

  EndIf

; ----------------------------------------------------------- PICTURE

  If TYP$="PIC_LOAD"

    If RODZAJ_DANYCH$="PLIK"
      NAZWA_PLIKU$="RYSUNKI/"+NAZWA$
      DLUGOSC_PLIKU.l=Exists(NAZWA_PLIKU$)
      DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)
      If DEST.l>0
        BLoad NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
        OUT.l=DEST.l
        WORK_DATA.l=DLUGOSC_PLIKU.l
      Else
        Request "AD Error","Not enough mem to load picture!","arghhh!"
        OUT.l=0 : WORK_DATA.l=0
      EndIf
    EndIf

    If RODZAJ_DANYCH$="DANE"
      DLUGOSC_PLIKU.l=LENG.l
      If LENG.l>0
        DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)
        If DEST.l>0
          x=MemLoad {PLK.l,DEST.l,OFFSET.l,DLUGOSC_PLIKU.l}
          OUT.l=DEST.l
          WORK_DATA.l=DLUGOSC_PLIKU.l
        Else
          Request "AD Error","Not enough mem to load picture!","arghhh!"
          OUT.l=0 : WORK_DATA.l=0
        EndIf
      EndIf
    EndIf

    If OUT.l>0
      If Peeks$(DEST.l,4)="XPKF"
        OUT.l=XpkUnpackMem{DEST.l,DLUGOSC_PLIKU.l,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        WORK_DATA.l=XPK_BUFFER.l
      EndIf

      If StcCheck{DEST.l}=True
        x=PSTCDecrunch {DEST.l,5,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        OUT.l=STC_OUT.l
        WORK_DATA.l=STC_BUF.l
      EndIf
    EndIf

  EndIf

; -------------------------------------------------------- ANIMATION

  If TYP$="ANIM_LOAD"

    If RODZAJ_DANYCH$="PLIK"
      NAZWA_PLIKU$="RYSUNKI/"+NAZWA$
      DLUGOSC_PLIKU.l=Exists(NAZWA_PLIKU$)
      DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)
      If DEST.l>0
        BLoad NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
        OUT.l=DEST.l
        WORK_DATA.l=DLUGOSC_PLIKU.l
      Else
        Request "AD Error","Not enough mem to load animation!","arghhh!"
        OUT.l=0 : WORK_DATA.l=0
      EndIf
    EndIf

    If RODZAJ_DANYCH$="DANE"
      DLUGOSC_PLIKU.l=LENG.l
      DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)
      If DEST.l>0
        x=MemLoad {PLK.l,DEST.l,OFFSET.l,DLUGOSC_PLIKU.l}
        OUT.l=DEST.l
        WORK_DATA.l=DLUGOSC_PLIKU.l
      Else
        Request "AD Error","Not enough mem to load animation!","arghhh!"
        OUT.l=0 : WORK_DATA.l=0
      EndIf
    EndIf


    If OUT.l>0
      If Peeks$(DEST.l,4)="XPKF"
        OUT.l=XpkUnpackMem{DEST.l,DLUGOSC_PLIKU.l,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        WORK_DATA.l=XPK_BUFFER.l
      EndIf

      If StcCheck{DEST.l}=True
        x=PSTCDecrunch{DEST.l,5,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        OUT.l=STC_OUT.l
        WORK_DATA.l=STC_BUF.l
      EndIf
    EndIf

  EndIf

; ------------------------------------------------------- MODULE

  If TYP$="MOD_LOAD"

    If RODZAJ_DANYCH$="PLIK"
      NAZWA_PLIKU$=NAZWA$
      DLUGOSC_PLIKU.l=Exists(NAZWA_PLIKU$)

      DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)
      If DEST.l>0
        BLoad NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
        OUT.l=DEST.l
        WORK_DATA.l=DLUGOSC_PLIKU.l
      Else
        Request "AD Error","Not enough mem to load module!","arghhh!"
        OUT.l=0 : WORK_DATA.l=0
      EndIf
    EndIf

    If RODZAJ_DANYCH$="DANE"
      DLUGOSC_PLIKU.l=LENG.l
      DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)
      If DEST.l>0
        x=MemLoad {PLK.l,DEST.l,OFFSET.l,DLUGOSC_PLIKU.l}
        OUT.l=DEST.l
        WORK_DATA.l=DLUGOSC_PLIKU.l
      Else
        Request "AD Error","Not enough mem to load module!","arghhh!"
        OUT.l=0 : WORK_DATA.l=0
      EndIf
    EndIf

    If OUT.l>0
      If Peeks$(DEST.l,4)="XPKF"
        OUT.l=XpkUnpackMem{DEST.l,DLUGOSC_PLIKU.l,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        WORK_DATA.l=XPK_BUFFER.l
      EndIf

      If StcCheck{DEST.l}=True
        x=PSTCDecrunch{DEST.l,5,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        OUT.l=STC_OUT.l
        WORK_DATA.l=STC_BUF.l
      EndIf
    EndIf

    BSave TEMP_DIR$+"MOD",OUT.l,WORK_DATA.l
    If OUT.l>0 Then FreeMem_ OUT.l,WORK_DATA.l

  EndIf


Function Return OUT.l
End Function

Function.l Potega{PODSTAWA.l,WYKL.l}
  WYNIK.l=PODSTAWA.l

  For i=1 To WYKL.l-1
    WYNIK.l=(WYNIK.l*PODSTAWA.l)
  Next

Function Return WYNIK.l
End Function


._KONIEC_FUNKCJI
.

DEFTYPE .IOAudio audio_req
DEFTYPE.l audio_req_,adport
DEFTYPE.l anim_addr,anim_size
DEFTYPE.l WORK_DATA


WBStartup
WbToScreen 0
Use Screen 0
WBenchToFront_
;NoCli


Dim Modul$(30)
Dim Czcionka$(10),CzcionkaY(10)

Gosub WCZYTAJ_PREFS
MakeDir GLOWNY_TEMP_DIR$+"AD_TMP" : TEMP_DIR$=GLOWNY_TEMP_DIR$+"AD_TMP/"

ILOSC_MODULOW=-1 : PATTERNED=-1
datafile.l=Open_ ("DATA_FILE",1005)

Gosub START_DATA
Gosub INIT_MODULE
Gosub INICJALIZACJA
Gosub OTWORZ_PANEL
Gosub INICJALIZUJ_MENU
Gosub INICJALIZUJ_GADGETY
Gosub MENU
Gosub WYSWIETL_TEKST

POCZATEK:
Repeat : ev = WaitEvent
  Gosub MENU
Until ev=$200 AND EventWindow = 1

Gosub WYJSCIE

.INICJALIZACJA
adport.l=FindPort_("AntyDresiarz_PORT")

If adport.l=0
  adport.l=CreateMsgPort ("AntyDresiarz_PORT")
Else
  X$=GetCatStr{catalog.l,102,"eeeee..."}
  Request GetCatStr{catalog.l,100,"Antydresiarz..."},GetCatStr{catalog.l,101,"Nie mozna odpalic 2 Antydresiarzy!"},X$ : X$=""
  End
EndIf

AddIDCMP #IDCMP_INTUITICKS+#IDCMP_MOUSEBUTTONS


  PIC=11
  PIC_ADDR.l=FileLoad{DEMO_FILE$(PIC),"PIC_LOAD",datafile.l,DEMO_START.l(PIC),DEMO_LENGTH.l(PIC)} : PIC_LEN.l=WORK_DATA.l

  If PIC_ADDR.l>0
    BSave TEMP_DIR$+"PALETA.CMA",PIC_ADDR.l,WORK_DATA.l
    FreeMem_ PIC_ADDR.l,WORK_DATA.l
    LoadPalette 1,TEMP_DIR$+"PALETA.CMA"
    DeleteFile_ TEMP_DIR$+"PALETA.CMA"
  EndIf

Bitplany=8 : MAG_Bitplany=Bitplany
Execute_ "C:SetPatch >NIL:",0,0

If OTWIERAC_NA_WB=0
NEWTYPE .pens : a.w : b.w : c.w : d.w : e.w : f.w : g.w : h.w : i.w : j.w : k.w : l.w : m.w : n.w : End NEWTYPE

pp.pens\c=1 ; Text on background
pp.pens\d=2 ; Bright edge on 3d objects
pp.pens\e=1 ; Dark edge on 3d objects
pp.pens\f=3 ; activew window/select gadgetfill
pp.pens\g=1 ; text over FILLPEN (filltextpen)
pp.pens\h=0 ; Backgroundpen
pp.pens\i=2 ; Special colour text
pp.pens\j=1 ; Text/deail in screen-bar/menus
pp.pens\k=2 ; Screenbar/menusfill
pp.pens\l=1 ; Trim under screenbar
pp.pens\m=12 ; Number of pens
pp.pens\n=1 ; Do I need it?

InitTagList 1,10
AddTags 1,#SA_Width,640,#SA_Height,256,#SA_DisplayID,ScrMode.l,#SA_Depth,Bitplany,#SA_Pens,&pp,#SA_Interleaved,True

SetErr
  If Request ("AD Error","Can't open screen!","Retry|End")=0 Then Gosub WYJSCIE
End SetErr

  ScreenTags 1,"Antydresiarz by Taski.",TagList(1)

ErrFail : ClrErr

  Wysokosc_Ekranu=256
  EKRAN_MAGA=1

Else
  WbToScreen 0
  Use Screen 0
  Wysokosc_Ekranu=ScrHeight{0}
  t$="Twoj WorkBench jest odpalony w malej liczbie kolorow !"+Chr$(10)
  t$=t$+"Jezeli chcesz ogladac AntyDresiarza w pelni jego uroku,"+Chr$(10)
  t$=t$+"to musisz odpalic WorkBencha w minimum 256 kolorach."+Chr$(10)
  t$=t$+"Jezeli tego nie zrobisz, to zobaczysz ...?... ."+Chr$(10)
  If WBDepth<8 Then malokol=Request ("AntyDresiarz informuje...",t$,"Zaladuj ScreenMode Preferences|Lubie szkaradna grafike")
  t$=""
  If malokol=1
    Execute_ "SYS:PREFS/SCREENMODE",0,0
    End
  EndIf

  Dim R(256),G(256),B(256)

  MAG_Bitplany=WBDepth

  Use Palette 0
  For x=0 To (Potega{2,WBDepth})-1
    R(x)=AGARed(x)
    G(x)=AGAGreen(x)
    B(x)=AGABlue(x)
  Next x
  OTWARTE_NA_WB=1
  EKRAN_MAGA=0
EndIf

Gosub OKNO_INITU
Gosub DEMO

If GRAYSCALE=1 Then x=Greyscale{1,8,23}
Use Palette 1

y=Wysokosc_Ekranu-(offt+offt+2+(Wysokosc_panelu/2)+1)
WSize 640,y

Return

.INICJALIZUJ_MENU
  ENGLISH_LANGUAGE=0 : Gosub LISTUJ_MENU

  Use IntuiFont 2
  ywin=Wysokosc_Ekranu-(offt+offt+2+(Wysokosc_panelu/2))-(offt-2)-20-11

  GTTags #GTLV_ShowSelected,0
  GTListView 1,10,15,20,450,ywin,"",#GACT_FOLLOWMOUSE,Lista_Menu()
  GTListView 1,11,465,20,150,ywin,"",32,Krotki_opis() ;y=170
  GTCycle 1,12,15,5,450,15,"",0,GetCatStr{catalog.l,5000,"Wybierz polski artykul|Wybierz angielski artykul"}
  GTButton 1,13,465,5,150,15,GetCatStr{catalog.l,5001,"Krotki opis"},0

Return

.INICJALIZUJ_GADGETY
; ---- PREFSY - MAIN WINDOW
PREFS_FONT=1
Use IntuiFont 0
x$=""
x$="Czcionka 1|Czcionka 2 (tekst w menu)|Czcionka 3 (tytuly artkow)|Czcionka 4"
x$=x$+"|Czcionka 5|Czcionka 6 (tekst w artkach)|Czcionka 7|Czcionka 8|Czcionka 9|Czcionka 10"
x$=GetCatStr{catalog.l,1102,x$}

GTCycle     2,20,8,14,412,14,"",0,x$ : x$=""
GTString    2,21,56,29,231,14,GetCatStr{catalog.l,1103,"Nazwa"},0,256,""
GTInteger   2,22,365,29,55,14,GetCatStr{catalog.l,1104,"Wielkosc"},0,0
GTCheckBox  2,23,8,59,26,11,GetCatStr{catalog.l,1105,"Otwieraj AD na ekranie Workbench'a"},34
GTCheckBox  2,24,8,83,26,11,GetCatStr{catalog.l,1106,"Powiekszaj (2x) czcionki (4,6) dla interlace"},34
GTCheckBox  2,25,8,95,26,11,GetCatStr{catalog.l,1107,"Skaluj obrazki dla interlace"},34
GTCheckBox  2,26,8,71,26,11,GetCatStr{catalog.l,1108,"Konwersja kolorow do Grayscale"},34
GTCheckBox  2,27,8,107,26,11,GetCatStr{catalog.l,1109,"Kopiuj obrazki do RAM'u"},34
GTButton    2,28,8,119,412,14,GetCatStr{catalog.l,1110,"Zmiana preferencji wlasnego ekranu"},0
GTButton    2,29,8,149,412,14,GetCatStr{catalog.l,1111,"Zmiana koloru napisow"},0

; ---- PREFSY - KOLORY
Use IntuiFont 0
f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
GTSlider    4,0,91,24,216,10,GetCatStr{catalog.l,3002,"Czerwony "},$80+33,1,16,Red(8)+1
f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
GTSlider    4,1,91,36,216,11,GetCatStr{catalog.l,3003,"Zielony  "},$80+33,1,16,Green(8)+1
f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
GTSlider    4,2,91,49,216,11,GetCatStr{catalog.l,3004,"Niebieski"},$80+33,1,16,Blue(8)+1
x$="" : For x=1 To 16 : x$=x$+GetCatStr{catalog.l,3001,"Kolor"}+" "+Str$(x)+"|" : Next x : x$=Left$(x$,Len(x$)-1)
GTCycle     4,3,11,5,317,16,"",0,x$

; ---- PREFSY - MUZA
  Use IntuiFont 0
  ILOSC_MODULOW=1

  For x=1 To 30
    If MODULE_NAME$(x)<>""
      ILOSC_MODULOW=ILOSC_MODULOW+1
    EndIf
  Next x

GTTags #GTLV_ShowSelected,0
GTListView  3,0,16,20,300,50,"",2,Moduly(),NR_MODULU-1

f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
GTSlider    3,1,97,74,190,12,GetCatStr{catalog.l,4002,"Glosnosc:"},$80+33,1,64,64
GTCheckBox  3,2,73,92,26,11,GetCatStr{catalog.l,4003,"Filter"},33
GTCheckBox  3,3,284,92,26,11,GetCatStr{catalog.l,4004,"Wylaczona"},33

Return

.INIT_MODULE



  DEMO_MODULE=-1

  i=1
  Repeat
      NAZWA$=MODULE_FILE$(i)
      AddItem Moduly() : Moduly()\b=MODULE_NAME$(i)
      If UCase$(MODULE_NAME$(i))=UCase$(DEMO_MODULE$) Then DEMO_MODULE=i
    i=i+1
  Until MODULE_NAME$(i)=""
  AddItem Moduly() : Moduly()\b="Wybierz z dysku..."


Return


.OKNO_INITU
  offt=WBorTop{EKRAN_MAGA}
  offl=WBorLeft{EKRAN_MAGA}
  offd=WBorBottom{EKRAN_MAGA}
  offr=WBorRight{EKRAN_MAGA}

  SetErr
    If Request ("AD Error","Can't open window!","Retry|End")=0 Then Gosub WYJSCIE
  End SetErr

  Window 4,50,50,450,100+offt,0,"AntyDresiarz",0,0
  ErrFail : ClrErr

  SetErr
    If Request ("AD Error","Can't open 'PL_Topaz.font' 8!","Retry|End")=0 Then Gosub WYJSCIE
  End SetErr

  LoadFont 0,"PL_topaz.font",8 : WindowFont 0
  ErrFail : ClrErr

  Use IntuiFont 0
  NPrint "Sprawdzam mozliwosci twojej maszynki..."
  NPrint ""

  NPrint "Procesor:    680",CPU{},0
  If CheckAGA=True : x$="AGA" : Else : x$="ECS" : EndIf
  If CheckAGA=False AND WBDepth>4 Then x$="Karta graficzna"
  NPrint "Kosci:       ",x$
  NPrint "Chip:        ",ChipFree
  NPrint "Fast:        ",FastFree
  NPrint ""

  If CPU{}<3 Then NPrint "Procesorek to masz slaby jak na dzisiejsze czasy."
  If CPU{}=3 Then NPrint "Procesor jest ok, ale przydalby sie lepszy..."
  If CPU{}=4 Then NPrint "Nareszcie jakas dopalona Amiga..."
  If CPU{}=6 Then NPrint "Nareszcie jakis porzadny dopal..."

  VWait 100

  CloseWindow 4
Return

.

.LISTUJ_MENU
 ClearList Lista_Menu()
  ILOSC_POZYCJI_W_MENU=0

  If ENGLISH_LANGUAGE=0 : x=OpenFile(1,"TEKSTY/DATA/MENU_POLSKI.TXT") : Else : x=OpenFile(1,"TEKSTY/DATA/MENU_ENGLISH.TXT")
  EndIf : FileInput 1

  Belka_ekranu$=Edit$(2000)
  Belka_okna$=Edit$(2000)

  Repeat

    ARTICLE_TITLE$(ILOSC_POZYCJI_W_MENU)=Edit$(256)
    AddItem Lista_Menu() : Lista_Menu()\b=ARTICLE_TITLE$(ILOSC_POZYCJI_W_MENU)

    ART$=Edit$(2000)
    ART_NAGLOWEK$=UCase$(Left$(ART$,Instr(ART$,";")-1)) : ART_DATA$=Right$(ART$, Len(ART$)-Instr(ART$,";") )

      ARTICLE_START.l(ILOSC_POZYCJI_W_MENU)=-1
      ARTICLE_LENGTH.l(ILOSC_POZYCJI_W_MENU)=-1
      ARTICLE_TYPE$(ILOSC_POZYCJI_W_MENU)=""
      ARTICLE_FILE$(ILOSC_POZYCJI_W_MENU)=""
      SHORT_START.l(ILOSC_POZYCJI_W_MENU)=-1
      SHORT_LENGTH.l(ILOSC_POZYCJI_W_MENU)=-1

    If ART_NAGLOWEK$="DATAFILE"
      OD=0
      ARTICLE_SOURCE$(ILOSC_POZYCJI_W_MENU)=ART_DATA$

      Repeat
        OD=Instr(ART_DATA$,";")

        If OD>0

          DFILE$=UCase$(Left$(ART_DATA$,OD-1))
          DFILE_NAGL$=UCase$(Left$(DFILE$,Instr(DFILE$,"=")))
          DFILE_DATA$=UCase$(  Right$(DFILE$,Len(DFILE$)-Instr(DFILE$,"=")  )  )
          ART_DATA$=Right$(ART_DATA$,Len(ART_DATA$)-OD)
          Select DFILE_NAGL$
            Case "ARTICLE="
              x=Instr(DFILE_DATA$,",")
              ARTICLE_START.l(ILOSC_POZYCJI_W_MENU)=Val(Left$(DFILE_DATA$,x-1))
              ARTICLE_LENGTH.l(ILOSC_POZYCJI_W_MENU)=Val(Right$(DFILE_DATA$,Len(DFILE_DATA$)-x))
              ARTICLE_TYPE$(ILOSC_POZYCJI_W_MENU)="ADDR"
              ARTICLE_FILE$(ILOSC_POZYCJI_W_MENU)=""
            Case "SHORT="
              x=Instr(DFILE_DATA$,",")
              SHORT_START.l(ILOSC_POZYCJI_W_MENU)=Val(Left$(DFILE_DATA$,x-1))
              SHORT_LENGTH.l(ILOSC_POZYCJI_W_MENU)=Val(Right$(DFILE_DATA$,Len(DFILE_DATA$)-x))
;            Case "PIC="
;              x=Instr(DFILE_DATA$,",")
;              x2=Instr(DFILE_DATA$,",",x+1)

;              PICTURE_NUMBER.b=Val(Left$(DFILE_DATA$,x-1))
;              PICTURE_START.l(PICTURE_NUMBER.b)=Val(Right$(DFILE_DATA$,Len(DFILE_DATA$)-x))
;              PICTURE_LENGTH.l(PICTURE_NUMBER.b)=Val(Right$(DFILE_DATA$,Len(DFILE_DATA$)-x2))

          End Select
        EndIf
      Until OD=0


    EndIf

    If ART_NAGLOWEK$="NORMFILE"
      ARTICLE_SOURCE$(ILOSC_POZYCJI_W_MENU)=""
      ARTICLE_FILE$(ILOSC_POZYCJI_W_MENU)=ART_DATA$
      ARTICLE_TYPE$(ILOSC_POZYCJI_W_MENU)="FILE"
      ARTICLE_START.l(ILOSC_POZYCJI_W_MENU)=0
      ARTICLE_LENGTH.l(ILOSC_POZYCJI_W_MENU)=0
    EndIf

    ILOSC_POZYCJI_W_MENU=ILOSC_POZYCJI_W_MENU+1
  Until Loc(1)=Lof(1)

  CloseFile 1

  ILOSC_POZYCJI_W_MENU=ILOSC_POZYCJI_W_MENU-1


  GTChangeList 1,10,Lista_Menu()
  WSKAZANY=0 : WSKAZANY_TEXT=0
Return

.MENU

  Activate 0
  MENU=1
  Use Window 1 : WTitle "Menu",Belka_ekranu$
  Use Window 0 : Use IntuiFont 2
  Gosub CZAS

  BitOkno=0 : Numer_tla=2 : Gosub PATTERN
  il_lini=(ywin-4)/CzcionkaY(2) : illi$=Str$(il_lini) : i=Instr(illi$,".") : il_lini=Val(Left$(illi$,i))

  WBox offl+15,offt+20,offl+614,offt+23+(il_lini*CzcionkaY(2)),0
  AttachGTList 1,0

  GTSetAttrs 1,10,#GTLV_Selected,WSKAZANY_TEXT

  GTBevelBox 1,offl,offt,InnerWidth,InnerHeight,0
  Gosub CZYSC_ZMIENNE : Tytul_artykulu$="Menu" : Aktualna_strona=1

; ---------------------  MODIFY IDCMP
;  DEFTYPE .Window www
;  *www.Window=Addr Window(0)


;  ModifyIDCMP_ &*www.Window,#IDCMP_MOUSEMOVE|#IDCMP_GADGETUP|#IDCMP_GADGETDOWN|#IDCMP_INTUITICKS|#IDCMP_MOUSEBUTTONS
;ModifyIDCMP_ Addr Window(0),#LISTVIEWIDCMP




  Repeat : ev = WaitEvent : Gosub CZAS
  If ev=$40
    Select GadgetHit
      Case 1 ; gora
        If WSKAZANY_TEXT<ILOSC_POZYCJI_W_MENU
          WSKAZANY_TEXT=WSKAZANY_TEXT+1
          GTSetAttrs 1,10,#GTLV_Selected,WSKAZANY_TEXT,#GTLV_MakeVisible,WSKAZANY_TEXT
          Wskazany_podstawa$=ARTICLE_FILE$(WSKAZANY_TEXT)
          Gosub KROTKI_OPIS_ART
        EndIf
      Case 2 ; dol
        If WSKAZANY_TEXT>0
          WSKAZANY_TEXT=WSKAZANY_TEXT-1
          GTSetAttrs 1,10,#GTLV_Selected,WSKAZANY_TEXT,#GTLV_MakeVisible,WSKAZANY_TEXT
          Wskazany_podstawa$=ARTICLE_FILE$(WSKAZANY_TEXT)
          Gosub KROTKI_OPIS_ART
        EndIf
;      Case 4 : WTitle "Bardziej w lewo sie nie da !!!",Belka_ekranu$
;      Case 5 : WTitle "Kliknij sobie w pysk !!!",Belka_ekranu$
;      Case 3 : WTitle "Przecierz jestes w indexie !!!",Belka_ekranu$
      Case 6 : Gosub MUZYKA_PREFS
      Case 7 : Gosub PREFS
      Case 10
        Wskazany_podstawa$=ARTICLE_FILE$(EventCode)

        If WSKAZANY_TEXT=EventCode AND Left$(Wskazany_podstawa$,2)<>"--" AND ARTICLE_START.l(EventCode)<>-1
          WSKAZANY=EventCode : WSKAZANY_TEXT=WSKAZANY : DetachGTList 1 : Gosub WYSWIETL_TEKST : Goto POCZATEK
        EndIf

        WSKAZANY=EventCode : WSKAZANY_TEXT=WSKAZANY
        Gosub KROTKI_OPIS_ART

      Case 12
        ENGLISH_LANGUAGE=EventCode : Gosub LISTUJ_MENU
        GTSetAttrs 1,10,#GTLV_Selected,WSKAZANY_TEXT,#GTLV_MakeVisible,WSKAZANY_TEXT
    End Select
  EndIf

  If ev=#IDCMP_RAWKEY
    Select EventCode
      Case 76 ; gora
        If WSKAZANY_TEXT>0
          WSKAZANY_TEXT=WSKAZANY_TEXT-1
          GTSetAttrs 1,10,#GTLV_Selected,WSKAZANY_TEXT,#GTLV_MakeVisible,WSKAZANY_TEXT
          Wskazany_podstawa$=ARTICLE_FILE$(WSKAZANY_TEXT)
          Gosub KROTKI_OPIS_ART
        EndIf
      Case 77 ; dol
        If WSKAZANY_TEXT<ILOSC_POZYCJI_W_MENU
          WSKAZANY_TEXT=WSKAZANY_TEXT+1
          GTSetAttrs 1,10,#GTLV_Selected,WSKAZANY_TEXT,#GTLV_MakeVisible,WSKAZANY_TEXT
          Wskazany_podstawa$=ARTICLE_FILE$(WSKAZANY_TEXT)
          Gosub KROTKI_OPIS_ART
        EndIf
      Case 68 ; enter
        Wskazany_podstawa$=ARTICLE_FILE$(WSKAZANY_TEXT)

        If Left$(Wskazany_podstawa$,2)<>"--" AND ARTICLE_START.l(WSKAZANY_TEXT)<>-1
          DetachGTList 1 : Gosub WYSWIETL_TEKST : Goto POCZATEK
        EndIf
    End Select
  EndIf
  Until ev=$200 AND EventWindow = 1
  Gosub WYJSCIE

Return

.KROTKI_OPIS_ART
  Krotki_opis_art_tmp$=Wskazany_podstawa$
  If (ARTICLE_START.l(WSKAZANY_TEKST)=-1) AND (ARTICLE_LENGTH.l(WSKAZANY_TEKST)=-1) Then Krotki_opis_art_tmp$=""

  x=FileLoad{Krotki_opis_art_tmp$,"LOAD_SHORT",datafile.l,SHORT_START.l(WSKAZANY_TEXT),SHORT_LENGTH.l(WSKAZANY_TEXT)}
Return
.
.WYSWIETL_TEKST
  Activate 1 : MENU=0

  If plk.l=>0 Then Close_ plk.l : plk.l=-1

  DeleteFile_ TEMP_DIR$+"ANTYDRESIARZ-ARTEK"

  Wskazany_tekst$=ARTICLE_FILE$(WSKAZANY_TEXT)
  x=FileLoad{Wskazany_tekst$,"LOAD_TEXT",datafile.l,ARTICLE_START.l(WSKAZANY_TEXT),ARTICLE_LENGTH.l(WSKAZANY_TEXT)}
  Wskazany_tekst$=TEMP_DIR$+"ANTYDRESIARZ-ARTEK"

  ART_DATA$=ARTICLE_SOURCE$(WSKAZANY_TEXT)

  If ART_DATA$<>""
  Repeat
    OD=Instr(ART_DATA$,";")

    If OD>0
      DFILE$=UCase$(Left$(ART_DATA$,OD-1))
      DFILE_NAGL$=UCase$(Left$(DFILE$,Instr(DFILE$,"=")))
      DFILE_DATA$=UCase$(  Right$(DFILE$,Len(DFILE$)-Instr(DFILE$,"=")  )  )
      ART_DATA$=Right$(ART_DATA$,Len(ART_DATA$)-OD)
      Select DFILE_NAGL$
        Case "PIC="
          x=Instr(DFILE_DATA$,",")
          x2=Instr(DFILE_DATA$,",",x+1)

          PICTURE_NUMBER.b=Val(Left$(DFILE_DATA$,x-1))
          PICTURE_START.l(PICTURE_NUMBER.b)=Val(Right$(DFILE_DATA$,Len(DFILE_DATA$)-x))
          PICTURE_LENGTH.l(PICTURE_NUMBER.b)=Val(Right$(DFILE_DATA$,Len(DFILE_DATA$)-x2))
      End Select
    EndIf
  Until OD=0
  EndIf


LOK$=Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)+Chr$(0)
plk.l=Open_ (Wskazany_tekst$,1005)
If plk.l=0
  Request GetCatStr{catalog.l,300,"Blad"},GetCatStr{catalog.l,301,"Nie moge odczytac artykulu !"},GetCatStr{catalog.l,302,"Ok"}
  Return
EndIf
x=FSeek_{plk.l,0}

  Dlugosc_tekstu.l=FileSize(Wskazany_tekst$)

  Tytul_artykulu$=Edit_ {plk.l}
  Numer_tla=1 : Znak_zmiany$=ZZmiany{Edit_{plk.l},0} : Gosub ZNAK_ZMIANY
  WindowFont 1 : NR_Czcionki=1 : STYL_Czcionki=0
  BitOkno=0 : Gosub PATTERN

  Pozycja_strony.l(Aktualna_strona)=Loc_{plk.l}
  Kolor_strony(Aktualna_strona)=Kolor_napisu
  Czcionka_strony(Aktualna_strona)=NR_Czcionki
  Styl_czcionki(Aktualna_strona)=STYL_Czcionki

POCZATEK_NOWEJ_STRONY:
  Gosub FREE_ANIM

  Use Window 1 : WTitle Tytul_artykulu$,Belka_ekranu$
  Use Window 0
  Gosub CZAS
  WLocate 0,0 : WJam 0

For i=0 To 1000
 Txt$=Edit_{plk.l} : Use Window 0 : Dlugosc_linii=Len(Txt$)

  A=0 : B=0 : POZ=0 : POZ_PETLA=0
  POCZATEK_WYSWIETLANIA:
  Repeat
    POZ=B
    A=Instr(Txt$,Chr$($1B),B)
    B=Instr(Txt$,Chr$($1B),A+1)

    If A=>1 AND B>1
      If POZ_PETLA=0 Then Print Left$(Txt$,A-1) : POZ_PETLA=1
      Znak_zmiany$=ZZmiany{Txt$,A} : Gosub ZNAK_ZMIANY : Print Mid$(Txt$,A+DLUG_ZZ,B-(A+DLUG_ZZ)) : Txt$=Mid$(Txt$,B) : B=1
      Goto POCZATEK_WYSWIETLANIA
    EndIf

    If A=>1 AND B=0 AND A+4<>Len(Txt$)
      If POZ_PETLA=0 Then Print Left$(Txt$,A-1) : POZ_PETLA=1
      Znak_zmiany$=ZZmiany{Txt$,A} : Gosub ZNAK_ZMIANY
        If WCursY+CzcionkaY{NR_Czcionki,CzcionkaY(NR_Czcionki)}<InnerHeight
          Print Mid$(Txt$,A+DLUG_ZZ,Len(Txt$)-A)
        Else
          x=FSeek_{plk.l,Loc_{plk.l}-Len(Mid$(Txt$,A+DLUG_ZZ,Len(Txt$)-A))-1}
        EndIf
      Goto KONIEC_WYSWIETLANIA
    EndIf

    If A=>1 AND B=0 AND A+Len(ZZmiany{Txt$,A})-1=Len(Txt$)
    Znak_zmiany$=ZZmiany{Txt$,A} : Print Left$(Txt$,Len(Txt$)-Len(Znak_zmiany$)) : Gosub ZNAK_ZMIANY : Goto KONIEC_WYSWIETLANIA
    EndIf

    If A=0 AND B=0
       Print Mid$(Txt$,POZ,Len(Txt$)-POZ) : Goto KONIEC_WYSWIETLANIA
    EndIf

  Until B=0
  KONIEC_WYSWIETLANIA:
  NPrint ""
  If WCursY+CzcionkaY{NR_Czcionki,CzcionkaY(NR_Czcionki)}>InnerHeight Then Gosub PETLA_WYSWIETLANIA
Next i
  Gosub PETLA_WYSWIETLANIA
  x=Close_(plk.l) : plk.l=-1
Return

.PETLA_WYSWIETLANIA

  Aktualna_strona=Aktualna_strona+1
  Pozycja_strony.l(Aktualna_strona)=Loc_{plk.l}
  Kolor_strony(Aktualna_strona)=Kolor_napisu
  Czcionka_strony(Aktualna_strona)=NR_Czcionki
  Styl_czcionki(Aktualna_strona)=STYL_Czcionki

  Repeat
  Gosub DISPLAY_ANIM
  Aktualna_strona=Aktualna_strona-1 : Gosub CZAS : Aktualna_strona=Aktualna_strona+1
  VWait

  ev = Event

  If ev = 1024
    Select EventCode
      Case 78 ; prawo
        If Eof_{plk.l,Dlugosc_tekstu.l}=0
          BitOkno=0 : Gosub PATTERN
          Goto POCZATEK_NOWEJ_STRONY
        EndIf
      Case 79 ; lewo
        If Aktualna_strona>2
          BitOkno=0 : Gosub PATTERN
          Aktualna_strona=Aktualna_strona-2
          x=FSeek_{plk.l,Pozycja_strony.l(Aktualna_strona)}
          WColour Kolor_strony(Aktualna_strona)
          WindowFont Czcionka_strony(Aktualna_strona),Styl_czcionki(Aktualna_strona)
          Goto POCZATEK_NOWEJ_STRONY
        EndIf
      Case 76 ; gora
        WSKAZANY_TEXT=WSKAZANY_TEXT-1
        If WSKAZANY_TEXT=0 Then WSKAZANY_TEXT=ILOSC_POZYCJI_W_MENU
        Wskazany_podstawa$=ARTICLE_FILE$(WSKAZANY_TEXT)

        If NOT Left$(Wskazany_podstawa$,2)="--"
          Aktualna_strona=1 : Gosub WYSWIETL_TEKST
        Else
          WSKAZANY_TEXT=WSKAZANY_TEXT-1 : If WSKAZANY_TEXT=-1 Then WSKAZANY_TEXT=ILOSC_POZYCJI_W_MENU-1
          Wskazany_podstawa$=ARTICLE_FILE$(WSKAZANY_TEXT)
          Aktualna_strona=1 : Gosub WYSWIETL_TEKST
        EndIf
      Case 77 ; dol
        WSKAZANY_TEXT=WSKAZANY_TEXT+1
        If WSKAZANY_TEXT=ILOSC_POZYCJI_W_MENU+1 Then WSKAZANY_TEXT=0
        Wskazany_podstawa$=ARTICLE_FILE$(WSKAZANY_TEXT)

        If NOT Left$(Wskazany_podstawa$,2)="--"
          Aktualna_strona=1 : Gosub WYSWIETL_TEKST
        Else
          WSKAZANY_TEXT=WSKAZANY_TEXT+1
          Wskazany_podstawa$=ARTICLE_FILE$(WSKAZANY_TEXT)
          Aktualna_strona=1 : Gosub WYSWIETL_TEKST
        EndIf
      Case 64
        x=Close_(plk.l) : plk.l=-1
        Goto POCZATEK
    End Select
  EndIf

  If ev=$40
    Select GadgetHit
      Case 1 ; dol
        WSKAZANY_TEXT=WSKAZANY_TEXT+1
        If WSKAZANY_TEXT=ILOSC_POZYCJI_W_MENU+1 Then WSKAZANY_TEXT=0
        Wskazany_podstawa$=ARTICLE_FILE$(WSKAZANY_TEXT)

        If NOT Left$(Wskazany_podstawa$,2)="--"
          Aktualna_strona=1 : Gosub WYSWIETL_TEKST
        Else
          WSKAZANY_TEXT=WSKAZANY_TEXT+1
          Wskazany_podstawa$=ARTICLE_FILE$(WSKAZANY_TEXT)
          Aktualna_strona=1 : Gosub WYSWIETL_TEKST
        EndIf
      Case 2 ; gora
        WSKAZANY_TEXT=WSKAZANY_TEXT-1
        If WSKAZANY_TEXT=0 Then WSKAZANY_TEXT=ILOSC_POZYCJI_W_MENU

        Wskazany_podstawa$=ARTICLE_FILE$(WSKAZANY_TEXT)

        If NOT Left$(Wskazany_podstawa$,2)="--"
          Aktualna_strona=1 : Gosub WYSWIETL_TEKST
        Else
          WSKAZANY_TEXT=WSKAZANY_TEXT-1
          If WSKAZANY_TEXT=-1 Then WSKAZANY_TEXT=ILOSC_POZYCJI_W_MENU-1
          Wskazany_podstawa$=ARTICLE_FILE$(WSKAZANY_TEXT)
          Aktualna_strona=1 : Gosub WYSWIETL_TEKST
        EndIf
      Case 4
      If Aktualna_strona>2
        BitOkno=0 : Gosub PATTERN
        Aktualna_strona=Aktualna_strona-2
        x=FSeek_{plk.l,Pozycja_strony.l(Aktualna_strona)}
        WColour Kolor_strony(Aktualna_strona)
        WindowFont Czcionka_strony(Aktualna_strona),Styl_czcionki(Aktualna_strona)
        Goto POCZATEK_NOWEJ_STRONY
      EndIf
      Case 5
      If Eof_{plk.l,Dlugosc_tekstu.l}=0
        BitOkno=0 : Gosub PATTERN
        Goto POCZATEK_NOWEJ_STRONY
      EndIf
      Case 3
        x=Close_(plk.l) : plk.l=-1 : Goto POCZATEK
      Case 6
        Gosub MUZYKA_PREFS
      Case 7
        Gosub PREFS
    End Select
  EndIf

  If ev=#IDCMP_MOUSEBUTTONS
    Select EventCode
      Case 105
        x=Close_(plk.l) : plk.l=-1
        Goto POCZATEK
    End Select
  EndIf

  Until ev=$200 AND EventWindow = 1
  x=Close_(plk.l) : plk.l=-1 : Gosub WYJSCIE
Return

.ZNAK_ZMIANY
  DLUG_ZZ=Len(Znak_zmiany$)
  Litera$=Mid$(Znak_zmiany$,DLUG_ZZ-1,1)

  If Litera$="m"
    Kod=Val(Mid$(Znak_zmiany$,3,2))
    Kod$=Mid$(Znak_zmiany$,3,2)

    If Kod=>30 AND Kod<50
      Kolor_napisu=Kod-30
      WColour Kod-30
    EndIf

    If Kod=>20 AND Kod<30
      WindowFont (Kod-20)+1 : NR_Czcionki=(Kod-20)+1
    EndIf

    ;1-podkresl,2-Bold,3-podkbold,4-kursywa,5-podkkurs,6-Boldkurs,7-podboldkur
    If Kod=0 Then WindowFont NR_Czcionki,0 : STYL_Czcionki=0
    If Kod=1 Then WindowFont NR_Czcionki,1 : STYL_Czcionki=1
    If Kod=2 Then WindowFont NR_Czcionki,2 : STYL_Czcionki=2
    If Kod=3 Then WindowFont NR_Czcionki,4 : STYL_Czcionki=4
    If Kod=4 Then WindowFont NR_Czcionki,3 : STYL_Czcionki=3
    If Kod=5 Then WindowFont NR_Czcionki,5 : STYL_Czcionki=5
    If Kod=6 Then WindowFont NR_Czcionki,6 : STYL_Czcionki=6
    If Kod=7 Then WindowFont NR_Czcionki,7 : STYL_Czcionki=7
    If WCursY+CzcionkaY(NR_Czcionki)>InnerHeight Then x=FSeek_{plk.l,Loc_{plk.l}-Len(Txt$)-1} : Gosub PETLA_WYSWIETLANIA
EndIf


  If Litera$="P"
    Kod$=Mid$(Znak_zmiany$,3,2) : Pozycja$=Mid$(Znak_zmiany$,5,1)

    Rysunek=Val("$"+Kod$) : Rysunek$=Left$("000",3-Len(Str$(Rysunek)))+Str$(Rysunek)

    If ENGLISH_LANGUAGE=1 Then WP$=Left$(Wskazany_podstawa$,Len(Wskazany_podstawa$)-2)+"/"
    If ENGLISH_LANGUAGE=0 Then WP$=Wskazany_podstawa$+"/"
    Rysunek$=WP$+Rysunek$
    WP$=""

    If ARTICLE_TYPE$(WSKAZANY_TEXT)="ADDR" Then Rysunek$=""

    PIC_ADDR.l=FileLoad{Rysunek$,"PIC_LOAD",datafile.l,PICTURE_START.l(Rysunek),PICTURE_LENGTH.l(Rysunek)}
    PIC_LEN.l=WORK_DATA.l

    If PIC_LEN.l>0

      If Peeks$(PIC_ADDR.l,4)="FORM" AND Peeks$(PIC_ADDR.l+8,4)="ILBM"

        Szerokosc=IFFWidth {PIC_ADDR.l}
        Wysokosc=IFFHeight {PIC_ADDR.l}
        Bitplany=IFFDepth  {PIC_ADDR.l}

        If Bitplany<=5 Then Bitplany=6

        If SKALUJ_OBRAZKI=1
          If WCursY+(Wysokosc*2)>InnerHeight Then x=FSeek_{plk.l,Loc_{plk.l}-Dlugosc_linii-1} : Gosub PETLA_WYSWIETLANIA
        Else
          If WCursY+Wysokosc>InnerHeight Then x=FSeek_{plk.l,Loc_{plk.l}-Dlugosc_linii-1} : Gosub PETLA_WYSWIETLANIA
        EndIf

        If PIC_ADDR.l>0

          x=DecodeIFFPalette{1,PIC_ADDR.l,96,False,False}
          BitMap 1,Szerokosc,Wysokosc,Bitplany : DecodeILBM 1,PIC_ADDR.l
          FreeMem_ PIC_ADDR.l,PIC_LEN.l

          If GRAYSCALE=1 Then x=Greyscale{1,95,(Potega{2,Bitplany}-1)}
          Use Palette 1

          If SKALUJ_OBRAZKI=1
            For i=0 To (Wysokosc*2)-2 Step 2
              BitMaptoWindow 1,0,0,i/2,WCursX+offl,WCursY+offt+i,Szerokosc,1
              BitMaptoWindow 1,0,0,i/2,WCursX+offl,WCursY+offt+i+1,Szerokosc,1
            Next i
          Else
            BitMaptoWindow 1,0,0,0,WCursX+offl,WCursY+offt,Szerokosc,Wysokosc
          EndIf
          Free BitMap 1
        Else
          Request "AD error","Cant allocate enough mem!","ok!"
        EndIf

      Else
        FreeMem_ PIC_ADDR.l,PIC_LEN.l
        Request "AD error","This is no an IFF-ILBM file!","Huuu aaa!"
      EndIf

    Else
      Request "AD error","Picture not found!","ok!"
    EndIf

    If Pozycja$="b" Then WLocate WCursX+Szerokosc,WCursY

    If INTERLACE_FONTS=1
      If Pozycja$="c" Then WLocate WCursX+Szerokosc,WCursY+Wysokosc*2
      If Pozycja$="d" Then WLocate WCursX,WCursY+Wysokosc*2
    Else
      If Pozycja$="c" Then WLocate WCursX+Szerokosc,WCursY+Wysokosc
      If Pozycja$="d" Then WLocate WCursX,WCursY+Wysokosc
    EndIf

  EndIf

  If Litera$="S"
    Kod$=Mid$(Znak_zmiany$,3,2) : Pozycja$=Mid$(Znak_zmiany$,5,1)

    Rysunek=Val("$"+Kod$) : Rysunek$=Left$("000",3-Len(Str$(Rysunek)))+Str$(Rysunek)

    If ENGLISH_LANGUAGE=1 Then WP$=Left$(Wskazany_podstawa$,Len(Wskazany_podstawa$)-2)+"/"
    If ENGLISH_LANGUAGE=0 Then WP$=Wskazany_podstawa$+"/"
    Rysunek$=WP$+Rysunek$
    WP$=""

    If ARTICLE_TYPE$(WSKAZANY_TEXT)="ADDR" Then Rysunek$=""

    PIC_ADDR.l=FileLoad{Rysunek$,"PIC_LOAD",datafile.l,PICTURE_START.l(Rysunek),PICTURE_LENGTH.l(Rysunek)}
    PIC_LEN.l=WORK_DATA.l

    If PIC_ADDR.l>0

      If Peeks$(PIC_ADDR.l,4)="FORM" AND Peeks$(PIC_ADDR.l+8,4)="ILBM"
        Szerokosc=IFFWidth {PIC_ADDR.l}
        Wysokosc=IFFHeight {PIC_ADDR.l}
        Bitplany=IFFDepth  {PIC_ADDR.l}

        If Bitplany<=5 Then Bitplany=6

        If SKALUJ_OBRAZKI=1
          If WCursY+(Wysokosc*2)>InnerHeight Then x=FSeek_{plk.l,Loc_{plk.l}-Dlugosc_linii-1} : Gosub PETLA_WYSWIETLANIA
        Else
          If WCursY+Wysokosc>InnerHeight Then x=FSeek_{plk.l,Loc_{plk.l}-Dlugosc_linii-1} : Gosub PETLA_WYSWIETLANIA
        EndIf

        x=DecodeIFFPalette{1,PIC_ADDR.l,96,False,False}
        BitMap 1,Szerokosc,Wysokosc,Bitplany : DecodeILBM 1,PIC_ADDR.l
      EndIf

      FreeMem_ PIC_ADDR.l,PIC_LEN.l

      If GRAYSCALE=1 Then x=Greyscale{1,95,Potega{2,Bitplany}-1}
      Use Palette 1

      If SKALUJ_OBRAZKI=1
        InitShape 50,Szerokosc,1,Bitplany
        For i=0 To (Wysokosc*2)-2 Step 2
          Use BitMap 1 : GetaShape 50,0,i/2,Szerokosc,1
          WBlit 50,WCursX+offl,WCursY+offt+i
          WBlit 50,WCursX+offl,WCursY+offt+i+1
        Next i
        Free BitMap 1 : Free Shape 50
      Else
        InitShape 50,Szerokosc,Wysokosc,Bitplany
        Use BitMap 1 : GetaShape 50,0,0,Szerokosc,Wysokosc
        Free BitMap 1 : WBlit 50,WCursX+offl,WCursY+offt
      EndIf

      Free Shape 50

    If Pozycja$="b" Then WLocate WCursX+Szerokosc,WCursY

      If INTERLACE_FONTS=1
        If Pozycja$="c" Then WLocate WCursX+Szerokosc,WCursY+Wysokosc*2
        If Pozycja$="d" Then WLocate WCursX,WCursY+Wysokosc*2
      Else
        If Pozycja$="c" Then WLocate WCursX+Szerokosc,WCursY+Wysokosc
        If Pozycja$="d" Then WLocate WCursX,WCursY+Wysokosc
      EndIf

    EndIf
  EndIf



  If Litera$="x"
    Kod=Val(Mid$(Znak_zmiany$,3,2))
    Kod$=Mid$(Znak_zmiany$,3,2)

    WLocate Val("$"+Kod$),WCursY
  EndIf

  If Litera$="y"
    Kod$=Mid$(Znak_zmiany$,3,2)

    If Kod$="NP"
      WLocate WCursX,InnerHeight+CzcionkaY(NR_Czcionki)
    Else
      WLocate WCursX,Val("$"+Kod$)
    EndIf
  EndIf

  If Litera$="X"
    Kod$=Mid$(Znak_zmiany$,3,2)

    WLocate Val("$"+Kod$)*5,WCursY
  EndIf

  If Litera$="Y"
    Kod$=Mid$(Znak_zmiany$,3,2)

    WLocate WCursX,Val("$"+Kod$)*5
  EndIf

  If Litera$="z"
    Kod=Val(Mid$(Znak_zmiany$,3,2))

    Ladowany_modul$=Str$(Kod) : Gosub LADUJ_MODUL
  EndIf

  If Litera$="b"
    Kod$=Mid$(Znak_zmiany$,3,2)
    Numer_tla=Val("$"+Kod$)
  EndIf

  If Litera$="l"
    Kod$=Mid$(Znak_zmiany$,3,2)
    If Kod$="HR"
      WBox offl+5,WCursY+offt+4,640-offl-offl-5,WCursY+offt+4,1
      WBox offl+5,WCursY+offt+5,640-offl-offl-5,WCursY+offt+5,2
      WLocate WCursX,WCursY+6
    EndIf
  EndIf

  If Litera$="R"
    Kod$=Mid$(Znak_zmiany$,3,DLUG_ZZ-3)
    If Kod$="CENTER"
      TxtDlug$=Right$(Txt$,Len(Txt$)-DLUG_ZZ)
      WLocate (InnerWidth-TextLength_(RastPort(0),&TxtDlug$,Len(TxtDlug$)))/2,WCursY : TxtDlug$=""
    EndIf
  EndIf

  If Litera$="h"
    If Mid$(Znak_zmiany$,3,5)="LINE="
      x=Val("$"+Mid$(Znak_zmiany$,8,2))
      Wline WCursX+offl,WCursY+offt+3,WCursX+offl+x*8,WCursY+offt+3,1
      Wline WCursX+offl,WCursY+offt+4,WCursX+offl+x*8,WCursY+offt+4,2
    EndIf
  EndIf

  If Litera$="A"

    DEFTYPE.b dbuffer

    Kod$=Mid$(Znak_zmiany$,3,2)
    ALoop$=Mid$(Znak_zmiany$,5,2)
    AWait=Val("$"+Mid$(Znak_zmiany$,7,2))
    Kursor$=Mid$(Znak_zmiany$,9,1)

    Rysunek=Val("$"+Kod$)
    Rysunek$=Left$("000",3-Len(Str$(Rysunek)))+Str$(Rysunek)

    If ENGLISH_LANGUAGE=1 Then WP$=Left$(Wskazany_podstawa$,Len(Wskazany_podstawa$)-2)+"/"
    If ENGLISH_LANGUAGE=0 Then WP$=Wskazany_podstawa$+"/"
    Rysunek$=WP$+Rysunek$
    WP$=""

    If ARTICLE_TYPE$(WSKAZANY_TEXT)="ADDR" Then Rysunek$=""

    anim_addr.l=FileLoad{Rysunek$,"PIC_LOAD",datafile.l,PICTURE_START.l(Rysunek),PICTURE_LENGTH.l(Rysunek)}
    anim_size.l=WORK_DATA.l

  If anim_size.l<>0

    If Peeks$(anim_addr.l,4)="FORM" AND Peeks$(anim_addr.l+8,4)="ANIM"

        Szerokosc=IFFWidth {anim_addr.l+12}
        Wysokosc=IFFHeight {anim_addr.l+12}
        Bitplany=IFFDepth  {anim_addr.l+12} : If Bitplany<=5 Then Bitplany=6

      If SKALUJ_OBRAZKI=1
        If WCursY+(Wysokosc*2)>InnerHeight Then x=FSeek_{plk.l,Loc_{plk.l}-Dlugosc_linii-1} : Gosub PETLA_WYSWIETLANIA
      Else
        If WCursY+Wysokosc>InnerHeight Then x=FSeek_{plk.l,Loc_{plk.l}-Dlugosc_linii-1} : Gosub PETLA_WYSWIETLANIA
      EndIf

      If anim_addr.l<>0

        BitMap 10,Szerokosc,Wysokosc,Bitplany : BitMap 11,Szerokosc,Wysokosc,Bitplany
        anm=RIAnimInit (anim_addr.l,10,2)

        If anm
          If Bitplany>5 Then x=CopyPalette{2,1,96,(Potega{2,MAG_Bitplany})-1,96}
          If GRAYSCALE=1 Then x=Greyscale{1,95,(Potega{2,Bitplany})-1}
          Use Palette 1

          ANIMX=WCursX+offl : ANIMY=WCursY+offt : ANIM_WIDTH=Szerokosc : ANIM_HEIGHT=Wysokosc
          ANIM_FRAMES=RIAnimFrameCount : ANIM_PLAY=True : ANIM_SKOK=SkokAnimki {ANIM_HEIGHT}

          CopyBitMap 10,11 : dbuffer.b=11


          If SKALUJ_OBRAZKI=1
            For i=0 To (ANIM_HEIGHT*2)-2 Step 2
              BitMaptoWindow 10,0,0,i/2,ANIMX,ANIMY+i,ANIM_WIDTH,1
              BitMaptoWindow 10,0,0,i/2,ANIMX,ANIMY+i+1,ANIM_WIDTH,1
            Next i
            Free BitMap 1
          Else
            BitMaptoWindow 10,0,0,0,ANIMX,ANIMY,ANIM_WIDTH,ANIM_HEIGHT
            Free BitMap 1
          EndIf

          If ALoop$="LP" Then AnimLoop On
          If ALoop$="NL" Then AnimLoop Off
        Else
          Request "AD error","Can't init anim!","ok"
          Free BitMap 10 : Free BitMap 11
          If anim_addr.l<>0 Then FreeMem_ anim_addr.l,anim_size.l : anim_addr.l=0
        EndIf
      Else
        Request "AD error","Can't allocate enough mem!","ok!"
      EndIf
    EndIf

  Else
    Request "AD error","Anim does not exists!","ok!"
  EndIf

      If Kursor$="b" Then WLocate WCursX+ANIM_WIDTH,WCursY

      If INTERLACE_FONTS=1
        If Kursor$="c" Then WLocate WCursX+ANIM_WIDTH,WCursY+ANIM_HEIGHT*2
        If Kursor$="d" Then WLocate WCursX,WCursY+ANIM_HEIGHT*2
      Else
        If Kursor$="c" Then WLocate WCursX+ANIM_WIDTH,WCursY+ANIM_HEIGHT
        If Kursor$="d" Then WLocate WCursX,WCursY+ANIM_HEIGHT
      EndIf


  EndIf

  If Litera$="x"

  EndIf
Return
.
.DISPLAY_ANIM
If ANIM_PLAY=True

  x=RINextAnimFrame(dbuffer) : ANIM_KLATKA=ANIM_KLATKA+1

  If SKALUJ_OBRAZKI=1
    For i=0 To (ANIM_HEIGHT*2)-2 Step 2
      BitMaptoWindow dbuffer,0,0,i/2,ANIMX,ANIMY+i,ANIM_WIDTH,1
      BitMaptoWindow dbuffer,0,0,i/2,ANIMX,ANIMY+i+1,ANIM_WIDTH,1
    Next i
  Else

;    BitMaptoWindow dbuffer,0,0,0,ANIMX,ANIMY,ANIM_WIDTH,ANIM_HEIGHT
    For i=0 To ANIM_HEIGHT-ANIM_SKOK Step ANIM_SKOK
      BitMaptoWindow dbuffer,0,0,i,ANIMX,ANIMY+i,ANIM_WIDTH,ANIM_SKOK
    Next i
  EndIf

  dbuffer=21-dbuffer

  If AWait>0 Then ResetTimer : Repeat : VWait : Until Timer=>AWait
  If ALoop$="NL" AND ANIM_KLATKA=ANIM_FRAMES-3 Then Gosub FREE_ANIM

EndIf
Return

.FREE_ANIM
  If anim_addr.l<>0 Then FreeMem_ anim_addr.l,anim_size.l : anim_addr.l=0
  ANIMX=0 : ANIMY=0 : ANIM_WIDTH=0: ANIM_HEIGHT=0 : ANIM_FRAMES=0 : ANIM_PLAY=False
  ANIM_KLATKA=0 : ANIM_SKOK=0
  ALoop$="" : AWait=0
  Free BitMap 10 : Free BitMap 11
Return
.

.PATTERN
  Background$=TEMP_DIR$+"TLO"+Str$(Numer_tla)+".IFF"

  If PATTERNED<>Numer_tla

    Free BitMap 12

    If Exists(Background$)=0
      Use Window BitOkno
      BitMap 12,50,50,8
    Else
    Use Window BitOkno
    InitBank 1,FileSize(Background$),0
    x=BLoad (Background$,Bank(1))
    x=DecodeIFFPalette{2,Bank(1),False,False,True} : ; LoadPalette 2,Background$

    x=ILBMInfo (Background$)
    Bitplany_tla=ILBMDepth
    Szerokosc_tla=ILBMWidth
    Wysokosc_tla=ILBMHeight
    If Bitplany_tla<=8 Then Bitplany_tla=8
    BitMap 12,Szerokosc_tla,Wysokosc_tla,Bitplany_tla
    DecodeILBM 12,Bank(1)

    x=CopyPalette{2,1,24,31,24}
    If GRAYSCALE=1 Then x=Greyscale{1,24,31}

    Use Palette 1
    Use BitMap 12

    EndIf

  EndIf

  PATTERNED=Numer_tla


  Ilosc_tel_x=InnerWidth/Szerokosc_tla
  x=Instr(Str$(Ilosc_tel_x),".") : If x>0 Then Ilosc_tel_x=Val(Left$(Str$(Ilosc_tel_x),x))
  Ilosc_tel_y=InnerHeight/Wysokosc_tla
  x=Instr(Str$(Ilosc_tel_y),".") : If x>0 Then Ilosc_tel_y=Val(Left$(Str$(Ilosc_tel_y),x))
 For y=1 To Ilosc_tel_y
    For x=1 To Ilosc_tel_x
      BitMaptoWindow 12,BitOkno,0,0,offl+((x-1)*Szerokosc_tla),offt+((y-1)*Wysokosc_tla),Szerokosc_tla,Wysokosc_tla
    Next x
    Pozostalosc_x=InnerWidth-(Szerokosc_tla*Ilosc_tel_x)
    BitMaptoWindow 12,BitOkno,0,0,offl+Ilosc_tel_x*Szerokosc_tla,offt+((y-1)*Wysokosc_tla),Pozostalosc_x,Wysokosc_tla
 Next y
    Pozostalosc_y=InnerHeight-(Wysokosc_tla*Ilosc_tel_y)
    For x=1 To Ilosc_tel_x
      BitMaptoWindow 12,BitOkno,0,0,offl+((x-1)*Szerokosc_tla),offt+Ilosc_tel_y*Wysokosc_tla,Szerokosc_tla,Pozostalosc_y
    Next x
    BitMaptoWindow 12,BitOkno,0,0,offl+Ilosc_tel_x*Szerokosc_tla,offt+Ilosc_tel_y*Wysokosc_tla,Pozostalosc_x,Pozostalosc_y
Return

.CZYSC_ZMIENNE
  If plk.l=>0 Then Close_ plk.l : plk.l=-1
  Wskazany_tekst$=""
  Aktualna_strona=1
  Tytul_artykulu$=""
Return
.
.POKAZ_PANEL

  PIC=10
  PIC_ADDR.l=FileLoad{DEMO_FILE$(PIC),"PIC_LOAD",datafile.l,DEMO_START.l(PIC),DEMO_LENGTH.l(PIC)} : PIC_LEN.l=WORK_DATA.l

  If CheckIFF {PIC_ADDR.l}
    Szerokosc_panelu = IFFWidth{PIC_ADDR.l}
    Wysokosc_panelu  = IFFHeight{PIC_ADDR.l}
    Bitplany_panelu  = IFFDepth{PIC_ADDR.l}

    x=DecodeIFFPalette{4,PIC_ADDR.l,False,False,True}

    BitMap 5,Szerokosc_panelu,Wysokosc_panelu,Bitplany_panelu
    DecodeILBM 5,PIC_ADDR.l
  EndIf

  If PIC_ADDR.l>0 Then FreeMem_ PIC_ADDR.l,PIC_LEN.l

  Szerokosc_ikony=Szerokosc_panelu/5 : Wysokosc_ikony=Wysokosc_panelu/2

  Use BitMap 5
  GetaShape 1,35,12,35,14
  GetaShape 2,121,2,34,16
  GetaShape 3,206,1,27,26
  GetaShape 4,276,11,35,15
  GetaShape 5,386,6,31,16
  GetaShape 6,496,1,33,26
  GetaShape 7,570,3,41,24

  GetaShape 08,035,40,35,14
  GetaShape 09,121,30,34,16
  GetaShape 10,206,29,27,26
  GetaShape 11,276,39,35,15
  GetaShape 12,386,34,31,16
  GetaShape 13,496,29,33,26
  GetaShape 14,570,31,41,24

  ShapeGadget 0,offl+35,offt+12,0,1,1,8
  ShapeGadget 0,offl+121,offt+2,0,2,2,9
  ShapeGadget 0,offl+206,offt+1,0,3,3,10
  ShapeGadget 0,offl+276,offt+11,0,4,4,11
  ShapeGadget 0,offl+386,offt+6,0,5,5,12
  ShapeGadget 0,offl+496,offt+1,0,6,6,13
  ShapeGadget 0,offl+570,offt+3,0,7,7,14
Return

.OTWORZ_PANEL
x=CopyPalette{4,1,32,95,32}

  If GRAYSCALE=1 Then x=Greyscale{1,32,95}
  Use Palette 1

  x=(640-Szerokosc_panelu-offl-offr)/2
  y=Wysokosc_Ekranu-(offt+2+(Wysokosc_panelu/2))

  Window 1,x,y,Szerokosc_panelu+offl+offr,Wysokosc_ikony+offt+offd,$4+$2+$8+#WFLG_RMBTRAP,"Panel",0,0,0
  BitMaptoWindow 5,1,0,0,offl,offt,Szerokosc_panelu,Wysokosc_ikony
  Free BitMap 5
  AttachGTList 0,1

  Activate 1
Return
.
.WCZYTAJ_CZCIONKI
SetErr
  If Request ("AD Error","Can't open font!","Retry|End")=0 Then Gosub WYJSCIE
End SetErr


For x=1 To 10
    If INTERLACE_FONTS=1 AND x=4 Then LoadFont x,Czcionka$(x),CzcionkaY(x)*2 : Goto CZ_INT
    If INTERLACE_FONTS=1 AND x=6 Then LoadFont x,Czcionka$(x),CzcionkaY(x)*2 : Goto CZ_INT
    If Czcionka$(x)<>"" Then LoadFont x,Czcionka$(x),CzcionkaY(x)
CZ_INT:
Next x

ClrErr : ErrFail

Return

.PREFS
Use IntuiFont 1

Window 2,105,11,434,167 + offt,14,GetCatStr{catalog.l,1101,"Preferencje"},0,1
Use Window 2 : Activate 2 : WindowFont 0 : BitOkno=2 : Gosub PATTERN : AttachGTList 2,2

If OTWIERAC_NA_WB=1 Then GTToggle 2,23,On : Redraw 2,23
If INTERLACE_FONTS=1 Then GTToggle 2,24,On : Redraw 2,24
If SKALUJ_OBRAZKI=1 Then GTToggle 2,25,On : Redraw 2,25
If GRAYSCALE=1 Then GTToggle 2,26,On : Redraw 2,26
If OBRAZKI_RAM=1 Then GTToggle 2,27,On : Redraw 2,27
GTSetString 2,21,Czcionka$(PREFS_FONT)
GTSetInteger 2,22,CzcionkaY(PREFS_FONT)

GTBevelBox 2,offl,0+offt,426,12,0
GTBevelBox 2,offl,45+offt,426,12,0
GTBevelBox 2,offl,135+offt,426,12,0
GTBevelBox 2,offl,147+offt,426,18,0
GTBevelBox 2,offl,12+offt,426,33,0
GTBevelBox 2,offl,57+offt,426,78,0

WJam 0 : WColour 2,0
WLocate 115,47  : Print GetCatStr{catalog.l,1200,"Preferencje wyswietlania"}
WLocate 132,2   : Print GetCatStr{catalog.l,1201,"Preferencje czcionek"}
WLocate 137,137 : Print GetCatStr{catalog.l,1202,"Preferencje kolorow"}

  Repeat : ev = WaitEvent AND EventWindow=2 : Gosub CZAS

  If ev=$40
    Select GadgetHit

    Case 20
      PREFS_FONT=EventCode+1
      GTSetString 2,21,Czcionka$(PREFS_FONT)
      GTSetInteger 2,22,CzcionkaY(PREFS_FONT)
    Case 21
      Czcionka$(PREFS_FONT)=GTGetString(2,21) : PREFS_CZC=1
    Case 22
      CzcionkaY(PREFS_FONT)=GTGetInteger(2,22) : PREFS_CZC=1
    Case 23
      OTWIERAC_NA_WB=EventCode : PREFS_RUN=1
    Case 24
      INTERLACE_FONTS=EventCode : PREFS_CZC=1
    Case 25
      SKALUJ_OBRAZKI=EventCode
    Case 26
      GRAYSCALE=EventCode
    Case 27
      OBRAZKI_RAM=EventCode
    Case 28
      DEFTYPE.l ScrReq.l
      ScrReq.l= RTEZScreenModeRequest(GetCatStr{catalog.l,2000,"Wybierz tryb ekranu"},$80000051)
      If ScrReq.l<>0 Then ScrMode.l= Peek.l (ScrReq.l)
      PREFS_RUN=1
    Case 29
      Gosub PREFS_KOLORY
    End Select
  EndIf

  If ev=$200 AND EventWindow=1 Then CloseWindow2 : Gosub WYJSCIE
  Until ev=$200 AND EventWindow=2
  DetachGTList 2
  CloseWindow 2


  Gosub ZAPISZ_PREFS

 WColour Kolor_napisu
 If PREFS_CZC=1 Then Gosub WCZYTAJ_CZCIONKI : WindowFont NR_Czcionki,STYL_Czcionki
 If PREFS_RUN=1 Then Request "AD","Zmiany beda widoczne po ponownym uruchomieniu magazynu!","Ok"

 PREFS_CZC=0 : PREFS_RUN=0
Return

.PREFS_KOLORY
LoadPalette 4,"RYSUNKI/DATA/PALETA.CMA"
x=CopyPalette{4,1,8,23,8} : Use Palette 1
Free Palette 4

AddIDCMP #IDCMP_INTUITICKS+#IDCMP_MOUSEMOVE
AddIDCMP $10

Window 4,143,11,351,79 + offt,14,GetCatStr{catalog.l,3000,"Ustawianie kolorow tekstu"},0,1
BitOkno=4 : Gosub PATTERN
WindowFont 0
AttachGTList 4,4

GTBevelBox 4,offl,offt,343,77,0

WJam 0
WColour 8,0
WLocate 6,64 : Print GetCatStr{catalog.l,3005,"Przyklad napisu w kolorze kolorowym"}
RGB_KOLOR=8 : R=Red(RGB_KOLOR) : B=Blue(RGB_KOLOR) : G=Green(RGB_KOLOR)

  Repeat
    ev=0 : ev=WaitEvent

    If ev=$20
      Repeat
        Select GadgetHit
          Case 0
            If EventCode>0 Then R=EventCode-1
          Case 1
            If EventCode>0 Then G=EventCode-1
          Case 2
            If EventCode>0 Then B=EventCode-1
        End Select
        PalRGB 1,RGB_KOLOR,R,G,B : Use Palette 1
      Until WaitEvent=$40
    EndIf


    If ev=$40
    Select GadgetHit
      Case 3
        RGB_KOLOR=EventCode+8
        WColour RGB_KOLOR,0 : WLocate 6,64 : Print GetCatStr{catalog.l,3005,"Przyklad napisu w kolorze kolorowym"}
        GTSetAttrs 4,0,#GTSL_Level,Red(RGB_KOLOR)+1 : R=Red(RGB_KOLOR)
        GTSetAttrs 4,1,#GTSL_Level,Green(RGB_KOLOR)+1 : G=Green(RGB_KOLOR)
        GTSetAttrs 4,2,#GTSL_Level,Blue(RGB_KOLOR)+1 : B=Blue(RGB_KOLOR)
    End Select
    EndIf
  Until ev=$200 AND EventWindow=4
  ev=0

CloseWindow 4
SavePalette 1,"RYSUNKI/DATA/PALETA.CMA"
If GRAYSCALE=1 Then x=Greyscale{1,8,23}

Return

.WCZYTAJ_PREFS
  DEFTYPE.l ScrMode

  x=OpenFile(2,"PREFS.PRE")
  FileInput 2

  Repeat

  a$=Edit$(256)
  PREFS_KLUCZ$=UCase$(Left$(a$,Instr(a$,"=")))
  PREFS_DATA$=Right$(a$,Len(a$)-Instr(a$,"="))

  Select PREFS_KLUCZ$
    Case "FONT="
      nr=Val(Left$(PREFS_DATA$,Instr(PREFS_DATA$,",")-1))
      Czcionka$(nr)= Right$(PREFS_DATA$,Len(PREFS_DATA$)-Instr(PREFS_DATA$,","))
    Case "FONTSIZE="
      nr=Val(Left$(PREFS_DATA$,Instr(PREFS_DATA$,",")-1))
      CzcionkaY(nr)=Val(Right$(PREFS_DATA$,Len(PREFS_DATA$)-Instr(PREFS_DATA$,",")))
    Case "OPEN_ON_WB="
      OTWIERAC_NA_WB=Val(PREFS_DATA$)
    Case "SCALE_FONTS="
      INTERLACE_FONTS=Val(PREFS_DATA$)
    Case "SCALE_PICTURES="
      SKALUJ_OBRAZKI=Val(PREFS_DATA$)
    Case "GRAYSCALE="
      GRAYSCALE=Val(PREFS_DATA$)
    Case "COPY_PICS_INTO_RAM="
      OBRAZKI_RAM=Val(PREFS_DATA$)
    Case "MODE_ID="
      ScrMode.l=Val(PREFS_DATA$)
    Case "DEMO_MODULE="
      DEMO_MODULE$=PREFS_DATA$
    Case "START_DATA="
      START_DATA_START.l=Val(Left$(PREFS_DATA$,Instr(PREFS_DATA$,",")-1))
      START_DATA_LENGTH.l=Val(Right$(PREFS_DATA$,Len(PREFS_DATA$)-Instr(PREFS_DATA$,",")))
      If START_DATA_LENGTH.l>0
        START_DATA_FILE$=""
      Else
        START_DATA_FILE$="PLIK"
      EndIf
    Case "TEMPDIR="
      GLOWNY_TEMP_DIR$=PREFS_DATA$
      TEMP_DIR$=GLOWNY_TEMP_DIR$+"AD_TMP/"
  End Select

  Until Lof(2)=Loc(2)

 CloseFile 2
Return

.ZAPISZ_PREFS
  If Exists("PREFS.PRE") Then DeleteFile_ "PREFS.PRE"
    x=OpenFile(2,"PREFS.PRE")
    FileOutput 2
    For x=1 To 10
      NPrint "FONT=",x,",",Czcionka$(x) : NPrint "FONTSIZE=",x,",",CzcionkaY(x)
    Next x
    NPrint "OPEN_ON_WB="         ,OTWIERAC_NA_WB
    NPrint "SCALE_FONTS="       ,INTERLACE_FONTS
    NPrint "SCALE_PICTURES="    ,SKALUJ_OBRAZKI
    NPrint "GRAYSCALE="         ,GRAYSCALE
    NPrint "COPY_PICS_INTO_RAM=",OBRAZKI_RAM
    NPrint "MODE_ID=$"          ,Hex$(ScrMode.l)
    NPrint "TEMPDIR="           ,GLOWNY_TEMP_DIR$
    NPrint "DEMO_MODULE="       ,DEMO_MODULE$
    NPrint "START_DATA="        ,START_DATA_START.l,",",START_DATA_LENGTH.l

    CloseFile 2
Return

.

.MUZYKA_PREFS
If ODGRYWAM_MODUL=-1 : GTToggle 3,3,On : Else : GTToggle 3,3,Off : EndIf

AddIDCMP $10
Window 3,46,34,334,108 + offt,14,GetCatStr{catalog.l,4000,"Preferencje muzyki"},0,1
WindowFont 0 : BitOkno=3 :; Gosub PATTERN
AttachGTList 3,3

GTBevelBox 3,offl,89+offt,326,17,0
GTBevelBox 3,offl,00+offt,326,14,0
GTBevelBox 3,offl,71+offt,326,18,0
GTBevelBox 3,offl,14+offt,326,57,0

WJam 0 : WColour 2,0 : WLocate 141,3 : Print GetCatStr{catalog.l,4001,"Muzyka"}

Repeat : ev=0 : ev = WaitEvent AND EventWindow=3 : Gosub CZAS

  If ev=$40
    Select GadgetHit
      Case 0
        NR_MODULU=EventCode+1
        If CHANNELS_ALOCATED=True Then Gosub DEALLOC_CH
        If NR_MODULU<ILOSC_MODULOW
          If NR_MODULU<>ODGRYWAM_MODUL Then Gosub LADUJ_MODUL
        Else
          DEFTYPE .Screen scrdata
          *scrdata.Screen=Peek.l(Addr Screen(EKRAN_MAGA))
          AddTag {0,#RT_Screen,*scrdata}
          AddTag {1,#RTFI_Flags,#FREQF_PATGAD}
          AddTag {2,#TAG_END,1}

          x$=RTFileRequest("Wybierz modul ProTrackera...","",Bank(11))
          If x$<>"" AND Exists(x$)
            MODULE_FILE$(ILOSC_MODULOW)=x$
            Gosub LADUJ_MODUL
          EndIf
        EndIf
        If ODGRYWAM_MODUL=-1 : GTToggle 3,3,On : Else : GTToggle 3,3,Off : EndIf
        Redraw 3,3
      Case 2
        If EventCode=1 : Filter Off : Else : Filter On : EndIf
      Case 3
        If EventCode=1
          If CHANNELS_ALOCATED=True
            StopTracker : FreeTrackerModule 1
            Gosub DEALLOC_CH
          EndIf
        Else
          If ODGRYWAM_MODUL>-1
            NR_MODULU=ODGRYWAM_MODUL
            Gosub LADUJ_MODUL
          EndIf
        EndIf
    End Select
  EndIf

  If ev=$20
    Repeat
    Select GadgetHit
      Case 1
        vol=EventCode
        If vol>0 AND vol<65 : TrackerVolume vol : EndIf
    End Select
    Until WaitEvent=$40
  EndIf

Until ev=$200 AND EventWindow=3
DetachGTList 3
CloseWindow 3
WColour Kolor_napisu
Return

.LADUJ_MODUL  ;  na wejsciu NR_MODULU

Gosub ALLOC_CH

If CHANNELS_ALOCATED=True

    NAZWA_MODULU$=MODULE_FILE$(NR_MODULU)

    If Exists(NAZWA_MODULU$)<>0

      StopTracker
      FreeTrackerModule 1

      x=FileLoad{NAZWA_MODULU$,"MOD_LOAD",datafile.l,MODULE_START.l(NR_MODULU),MODULE_LENGTH.l(NR_MODULU)}
      If Exists (TEMP_DIR$+"MOD")

        If AvailMem_ (#MEMF_CHIP|#MEMF_LARGEST)>Exists(TEMP_DIR$+"MOD")
          x=LoadTrackerModule (1,TEMP_DIR$+"MOD")
        Else
          x=0 : ODGRYWAM_MODUL=-1
          Gosub DEALLOC_CH
        EndIf
        DeleteFile_ TEMP_DIR$+"MOD"

        If x<>0
          x=StartTracker (1) : ODGRYWAM_MODUL=NR_MODULU
        Else
          X$=GetCatStr{catalog.l,401,"Brak CHIP'u na zaladowanie modulu."+Chr$(10)+"Rozszerz pamiec lub pozamykaj programy!"}
          Request GetCatStr{catalog.l,400,"Blad w ladowaniu modulu"},X$,GetCatStr{catalog.l,402,"oK"} : X$=""
          ODGRYWAM_MODUL=-1
        EndIf
      EndIf
    Else
       X$=GetCatStr{catalog.l,402,"Ok"}
       Request GetCatStr{catalog.l,501,"Blad w ladowaniu modulu"},GetCatStr{catalog.l,502,"Brak modulu na dysku !"},X$:X$=""
    EndIf
Else
  ODGRYWAM_MODUL=-1
EndIf

Return

.
.DEMO
  Use Palette 1
  Window 0,0,offt,640,Wysokosc_Ekranu-offt,6+#WFLG_RMBTRAP,"Antydresiarz",0,1 : Activate 0 : InnerCls 1

  NR_MODULU=DEMO_MODULE : Gosub LADUJ_MODUL

  For PIC=1 To 4
    PIC_ADDR.l=FileLoad{DEMO_FILE$(PIC),"PIC_LOAD",datafile.l,DEMO_START.l(PIC),DEMO_LENGTH.l(PIC)} : PIC_LEN.l=WORK_DATA.l
    If CheckIFF {PIC_ADDR.l}
      Szerokosc=IFFWidth{PIC_ADDR.l} : Wysokosc=IFFHeight{PIC_ADDR.l} : Bitplany=IFFDepth{PIC_ADDR.l}
      x=DecodeIFFPalette{3,PIC_ADDR.l,False,False,True}
      BitMap 1,Szerokosc,Wysokosc,Bitplany
      DecodeILBM 1,PIC_ADDR.l
    EndIf
    If PIC_ADDR.l>0 Then FreeMem_ PIC_ADDR.l,PIC_LEN.l
    If GRAYSCALE=1 Then x=Greyscale{3,0,(Potega{2,Bitplany})-1}
    Use Palette 3

    Gosub WYSWIETL_LINIAMI
    OKRES=Timer : Repeat : VWait 1 : Until Timer>OKRES+300 OR MButtons=1
    Gosub ZAMALUJ_LINIAMI
  Next PIC

;------------------------------------------
  Gosub POKAZ_PANEL


  For PAT=1 To 10

    PIC_ADDR.l=FileLoad{PATTERN_FILE$(PAT),"PIC_LOAD",datafile.l,PATTERN_START.l(PAT),PATTERN_LENGTH.l(PAT)}
    PIC_LEN.l=WORK_DATA.l

    If PIC_ADDR.l>0
      BSave TEMP_DIR$+"TLO"+Str$(PAT)+".IFF",PIC_ADDR.l,PIC_LEN.l
      FreeMem_ PIC_ADDR.l,PIC_LEN.l
    EndIf

  Next PAT
  Gosub WCZYTAJ_CZCIONKI

Return

.WYSWIETL_LINIAMI
  If InnerHeight=>Wysokosc
    For y=0 To Wysokosc-1 Step 2
      BitMaptoWindow 1,0,0,y,offl,offt+y,Szerokosc,1
      BitMaptoWindow 1,0,0,Wysokosc-y-1,offl,(Wysokosc+offt)-y-1,Szerokosc,1
      VWait 1
    Next y
  ZAMALUJ=1
  EndIf

  If InnerHeight=Wysokosc*2
    For y=0 To InnerHeight-1 Step 4
      BitMaptoWindow 1,0,0,y,offl,offt+y,Szerokosc,1
      BitMaptoWindow 1,0,0,Wysokosc-y-1,offl,(InnerHeight+offt)-y-1,Szerokosc,1
      VWait 1
    Next y
  ZAMALUJ=0
  EndIf

  If InnerHeight>Wysokosc*2
    odstep=(InnerHeight-Wysokosc*2)
    For y=1 To InnerHeight-odstep Step 4
      BitMaptoWindow 1,0,0,y/2,offl,offt+y,Szerokosc,1
      BitMaptoWindow 1,0,0,y/2,offl,offt+y+1,Szerokosc,1

      BitMaptoWindow 1,0,0,Wysokosc-(y/2),offl,(InnerHeight+offt)-y-odstep,Szerokosc,1
      BitMaptoWindow 1,0,0,Wysokosc-(y/2),offl,(InnerHeight+offt)-y-odstep+1,Szerokosc,1
      VWait 1
    Next y
  ZAMALUJ=0
  EndIf

  Free BitMap 1

Return

.ZAMALUJ_LINIAMI
  WYS=InnerHeight
  SZE=InnerWidth
  If WYS/2<>WYS Then WYS=WYS-1

  If ZAMALUJ=1
    For i=0 To WYS Step 2
      WBox offl,offt+i    ,offl+SZE-1,offt+i    ,1
      WBox offl,offt+WYS-i,offl+SZE-1,offt+WYS-i,1
      VWait
    Next i
  Else
    For i=0 To WYS Step 4
      WBox offl,offt+i      ,offl+SZE-1,offt+i+1  ,1
      WBox offl,offt+WYS-i-1,offl+SZE-1,offt+WYS-i,1
      VWait
    Next i
  EndIf

Return

.
.CZAS
DEFTYPE.l Procent
x=Hours
 Sek=Secs
  If Sekunda<>Sek
  Sekundy$=Str$(Secs) : If Len(Sekundy$)=1 Then Sekundy$="0"+Sekundy$
  Minuty$=Str$(Mins) : If Len(Minuty$)=1 Then Minuty$="0"+Minuty$
  Godziny$=Str$(Hours) : If Len(Godziny$)=1 Then Godziny$="0"+Godziny$

  If plk.l>0
    Procent.l=(Loc_{plk.l}*100)/Dlugosc_tekstu.l
  Else
    Procent.l=00
  EndIf

  Use Window 0
  If MENU=0
    x$=Belka_okna$+" - "+GetCatStr{catalog.l,6000,"Strona:"}+" "+Str$(Aktualna_strona)+" ("+Str$(Procent.l)+"%)"
    x$=x$+"   Czas: "+Godziny$+":"+Minuty$+":"+Sekundy$
  Else
    x$=Belka_okna$+" - Menu"
    x$=x$+"   Czas: "+Godziny$+":"+Minuty$+":"+Sekundy$
  EndIf

  WTitle x$,Belka_ekranu$ : x$=""

  Sekunda=Sek
  EndIf
Return

.WYJSCIE
If datafile.l<>0 Then Close_ datafile.l

CloseCatalog_ (catalog.l)
CloseLocale_ (locale.l)

StopPTModule

CloseWindow 0
CloseWindow 1

  If OTWARTE_NA_WB=0
    CloseScreen 1
  Else
    For x=0 To (Potega{2,WBDepth})-1
      ;s=PaletteRGB {0,x,R(x),G(x),B(x)}
      AGAPalRGB 0,x,R(x),G(x),B(x)
    Next x
    Use Palette 0
  EndIf
  Gosub KASUJ_TMP
  Gosub DEALLOC_CH
End
Return

.KASUJ_TMP
If Exists(TEMP_DIR$)

DEFTYPE .FileInfoBlock myfib

  p$=TEMP_DIR$
  lock.l=Lock_(&p$,-2)

If Examine_(lock,myfib)<>0
  While ExNext_(lock,myfib)<>0
    USEPATH myfib

    If \fib_DirEntryType<0             ;jezeli nie katalog to...
      Nazwa_pliku$=LSet$(Peek$(&\fib_FileName),30)
      Nazwa_pliku$=Left$(Nazwa_pliku$,Instr(Nazwa_pliku$,"  ")-1)

         DeleteFile_(TEMP_DIR$+Nazwa_pliku$)
    EndIf
  Wend
EndIf

UnLock_ lock

DeleteFile_ (TEMP_DIR$)

EndIf
Return

.

.ALLOC_CH

  LONG.l=$01020408

  If adport.l<>0

       audio_req\ioa_Data=&LONG.l
       audio_req\ioa_Length=4
       audio_req\ioa_AllocKey=0
       audio_req\ioa_Request\io_Message\mn_Node\ln_Pri=-127
       audio_req\ioa_Request\io_Command=#ADCMD_ALLOCATE
       audio_req\ioa_Request\io_Flags=#ADIOF_NOWAIT

       If OpenDevice_("audio.device", 0, &audio_req, 0)=0
         audio_req\ioa_Data=&LONG.l
         audio_req\ioa_Length=4
         audio_req\ioa_AllocKey=0
         audio_req\ioa_Request\io_Message\mn_Node\ln_Pri=127
         audio_req\ioa_Request\io_Command=#ADCMD_ALLOCATE
         audio_req\ioa_Request\io_Flags=#ADIOF_NOWAIT

           If OpenDevice_("audio.device", 0, &audio_req, 0)=0
             CHANNELS_ALOCATED=True
              Else
             CHANNELS_ALOCATED=False
           EndIf

       Else
        CHANNELS_ALOCATED=False
       EndIf
  Else
    CHANNELS_ALOCATED=False
  EndIf

If CHANNELS_ALOCATED=False
 If Request ("AD","Can't allocate audio channels!","Retry|Cancel")=1 Then Goto ALLOC_CH
EndIf

Return

.DEALLOC_CH
  If adport.l<>0
      x=CloseDevice_ (&audio_req)
      CHANNELS_ALOCATED=False
  EndIf
Return

.

.START_DATA

  x=FileLoad{START_DATA_FILE$,"START_DATA",datafile.l,START_DATA_START.l,START_DATA_LENGTH.l}

  x=OpenFile(2,TEMP_DIR$+"START.DATA")
  FileInput 2

  Repeat

    ART$=Edit$(256)
    ART_NAGLOWEK$=UCase$(Left$(ART$,Instr(ART$,";")-1)) : ART_DATA$=Right$(ART$, Len(ART$)-Instr(ART$,";") )

    If ART_NAGLOWEK$="DATAFILE"
      OD=0
      Repeat
        OD=Instr(ART_DATA$,";")

        If OD>0
          DFILE$=Left$(ART_DATA$,OD-1)
          DFILE_NAGL$=UCase$(Left$(DFILE$,Instr(DFILE$,"=")))
          DFILE_DATA$=Right$(DFILE$,Len(DFILE$)-Instr(DFILE$,"="))
          ART_DATA$=Right$(ART_DATA$,Len(ART_DATA$)-OD)
          Select DFILE_NAGL$
            Case "MODULE="
              x=Instr(DFILE_DATA$,",")
              x2=Instr(DFILE_DATA$,",",x+1)
              x3=Instr(DFILE_DATA$,",",x2+1)
              MODULIK=Val(Left$(DFILE_DATA$,x-1))
              MODULE_START.l (MODULIK)=Val(Right$(DFILE_DATA$,Len(DFILE_DATA$)-x))
              MODULE_LENGTH.l(MODULIK)=Val(Right$(DFILE_DATA$,Len(DFILE_DATA$)-x2))
              MODULE_NAME$   (MODULIK)=Right$(DFILE_DATA$,Len(DFILE_DATA$)-x3)
              MODULE_FILE$   (MODULIK)=""
            Case "DEMO_PIC="
              x=Instr(DFILE_DATA$,",")
              x2=Instr(DFILE_DATA$,",",x+1)
              PICTURE_NUMBER.b=Val(Left$(DFILE_DATA$,x-1))
              DEMO_START.l(PICTURE_NUMBER.b)=Val(Right$(DFILE_DATA$,Len(DFILE_DATA$)-x))
              DEMO_LENGTH.l(PICTURE_NUMBER.b)=Val(Right$(DFILE_DATA$,Len(DFILE_DATA$)-x2))
              DEMO_FILE$(PICTURE_NUMBER.b)=""
            Case "PATTERN="
              x=Instr(DFILE_DATA$,",")
              x2=Instr(DFILE_DATA$,",",x+1)
              PICTURE_NUMBER.b=Val(Left$(DFILE_DATA$,x-1))
              PATTERN_START.l(PICTURE_NUMBER.b)=Val(Right$(DFILE_DATA$,Len(DFILE_DATA$)-x))
              PATTERN_LENGTH.l(PICTURE_NUMBER.b)=Val(Right$(DFILE_DATA$,Len(DFILE_DATA$)-x2))
              PATTERN_FILE$(PICTURE_NUMBER.b)=""

          End Select
        EndIf
      Until OD=0
    EndIf


    If ART_NAGLOWEK$="NORMFILE"
      OD=0
      Repeat
        OD=Instr(ART_DATA$,";")

        If OD>0
          DFILE$=Left$(ART_DATA$,OD-1)
          DFILE_NAGL$=UCase$(Left$(DFILE$,Instr(DFILE$,"=")))
          DFILE_DATA$=Right$(DFILE$,Len(DFILE$)-Instr(DFILE$,"=")  )
          ART_DATA$=Right$(ART_DATA$,Len(ART_DATA$)-OD)
          Select DFILE_NAGL$
            Case "MODULE="
              x=Instr(DFILE_DATA$,",")
              MODULIK=Val(Left$(DFILE_DATA$,x-1))
              MODULE_FILE$(MODULIK)="MUZYKA/"+Right$(DFILE_DATA$,Len(DFILE_DATA$)-x)
              MODULE_NAME$(MODULIK)=Right$(DFILE_DATA$,Len(DFILE_DATA$)-x)
            Case "DEMO_PIC="
              x=Instr(DFILE_DATA$,",")
              PICTURE_NUMBER.b=Val(Left$(DFILE_DATA$,x-1))
              DEMO_FILE$(PICTURE_NUMBER.b)=Right$(DFILE_DATA$,Len(DFILE_DATA$)-x)
            Case "PATTERN="
              x=Instr(DFILE_DATA$,",")
              PICTURE_NUMBER.b=Val(Left$(DFILE_DATA$,x-1))
              PATTERN_FILE$(PICTURE_NUMBER.b)=Right$(DFILE_DATA$,Len(DFILE_DATA$)-x)
          End Select
        EndIf
      Until OD=0


    EndIf

  Until Loc(2)=Lof(2)
  CloseFile 2
  DeleteFile_ TEMP_DIR$+"START.DATA"
Return



; ---- NIGDY NIE DOTYKAC BITMAPY 10,11 !!! ---- ANIMKA W ARCIE !
; ---- NIGDY NIE DOTYKAC BITMAPY 12 !!! ---- BACKGROUND
