;
;
;     .........                                        .........
;     ::     ::          t  a  s  k  i  `  s           ::     ::
;     ::     ::       ______ ____  ___   ___ ____      ::     ::
;     ::  .. ::      ____  /    /__  /_ _\  \   /      :: ..  ::
;     ::..:: ::     |__   __  _   / __/ _|\___  |      :: ::..::
;            ::     |/    \/_(/   |     \|      |      ::
;            ::     /______\ /__________________\      ::
;         ____:______ __   ______________  ______ _____: ______
;      ___\  /   __ /  /__ \      /\    /|____  /   __ /      /
;     |__   _|  _ ,_|  __/_ \    _|/\  //|__   __  _ ,_|_    /|
;     |/    \|_(/  \|      |/    \|  \/  |/    \/_(/  \|/    /|
;     /______\ /________________________________\ /___________\
;            ::                                        ::az0!/l124
;
; PROJECT:       AntyDresiarz Issue #4 New Generation
; VERSION:       4.3
; AUTHOR:        Paplo/Taski
; COMPLETE:      [#########=] 97%
; LAST CHANGE:   11.06.1998
;

d$="AntyDresiarz by Pawel 'Paplo/Taski' Filipczak. All Rights Reserved."
d$="Every changes in the code will be charged by copyright law, Polish 'Policja' and FBI."
d$=""


INCLUDE "BlitzLibs:AHI.bb2"

WBStartup
NoCli

NEWTYPE .lview : dummy.w : name.s : End NEWTYPE

.__STALE__
; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- STALE -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

DEFTYPE.l cgxbase


#PRI_HIGH=0  ; Task priorities
#PRI_LOW=0

#MENU_ZONES=20   ; dane stref
#ILOSC_STREF=100

#CZAS_FONT=1
#STRONA_FONT=1

#AD_WINDOW=1   ; Numery, definicje okien
#AD_WINDOW_PREFS=2
#AD_WINDOW_PREFS_KEYS=4
#AD_WINDOW_MUSIC=3
#AD_WINDOW_PALETTE=0
#AD_WINDOW_PREFS_MUSIC=5
#AD_HEIGHT=256

#AD_GT_MUSIC=2
#AD_GT_PREFS=1
#AD_GT_KEYS=3
#AD_GT_PALETTE=4
#AD_GT_PREFS_MUSIC=5

#AD_MENU=1  ; Numery plikow, ktore beda otwierane
#AD_TEXT=2
#AD_DATA=3
#AD_PREFS=4



#PANEL_BITMAP=5 ; Numery bitmap przyporzadkowane danemu rodzajowi danych
#CLIP_BITMAP=6
#PICTURE_BITMAP=6
#PICTURE_SHAPE=6
#GADGET_BITMAP=6
#ANIM_BITMAP=9
#PATTERN_BITMAP=7

#SHAPE_POINTER1=1
#SHAPE_POINTER2=2

#ANIM_PALETTE=6
#AD_PALETTE=3    ; Numery palety
#CLIP_PALETTE=6
#PICTURE_PALETTE=6

#TAGLIST_BANK=20 ; numer banku na tagliste

#KOLOR_CZAS=110
#KOLOR_SHORT=10
#KOLOR_STRONA=10

#SOUND_CLICK=1
#SOUND_UNCLICK=2

Dim LINK_HISTORY(1001)


Dim LINK_TITLE$(1001),LINK_SHORT$(1001)
Dim LINK_COLOR(1001),LINK_FONT(1001)
Dim LINK_X(1001),LINK_Y(1001),LINK_W(1001),LINK_H(1001)
Dim STREFA_LINK(1001)


Dim FONT_Y(10)
; **********
Dim SZPALTA_X(10),SZPALTA_Y(10),SZPALTA_W(10),SZPALTA_H(10)
; ******************************* MENU & TEKST *******************************
Dim MENU_STRONA_START.l(200),TEKST_STRONA_START.l(200)
Dim TEKST_FONT(200),TEKST_KOLOR(200)
Dim MENU_FONT(200),MENU_KOLOR(200)
; -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-* FILE I/O *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
Dim FILE_LOCATE.l(10),FILE_ADDRES.l(10),FILE_LENGTH.l(10),FILE_LOCK.l(10)
; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- PREFS -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
Dim PREFS_AD_KEY(20),PREFS_FONT$(10),PREFS_FONT_SIZE(10) ; use
Dim AD_KEY(20),PRE_FONT$(10),PRE_FONT_SIZE(10),PRE_R(255),PRE_G(255),PRE_B(255) ; save
Dim PREFS_R(255),PREFS_G(255),PREFS_B(255),PREFSY_R(255),PREFSY_G(255),PREFSY_B(255)
DEFTYPE.l PRE_MODE_ID
; -------------------------
DEFTYPE.l adport
; ---------------------- INICJALIZACJA TABLIC DLA MENU -----------
Dim PICTURE_START.l(1001),PICTURE_LENGTH.l(1001),CHUNKY_START.l(1001),CHUNKY_LENGTH.l(1001)
Dim ARTICLE_START.l(1001),ARTICLE_LENGTH.l(1001)
Dim ARTICLE_FILE$(1001),ARTICLE_SHORT$(1001),ARTICLE_TITLE$(1001),ARTICLE_PICTURES$(1001),ARTICLE_CHUNKY$(1001)
Dim MENU_FILE$(10),MENU_START.l(10),MENU_LENGTH.l(10)
AKTYWNE_MENU=0
; --------------------------- DEMO --------------------------------
Dim DEMO_START.l(60),DEMO_LENGTH.l(60),DEMO_FILE$(60)
Dim PATTERN_START.l(255),PATTERN_LENGTH.l(255),PATTERN_FILE$(255)
; --------------------------- GADGETS -----------------------------
Dim GADGET_START.l(#MENU_ZONES*2),GADGET_LENGTH.l(#MENU_ZONES*2),GADGET_FILE$(#MENU_ZONES*2)
Dim GADGET_FRAMES(#MENU_ZONES*2)
; --------------------------- MODULE ------------------------------
Dim MODULE_START.l(90),MODULE_LENGTH.l(90),MODULE_FILE$(90),MODULE_NAME$(90)
;Dim MODUL$(90)
Dim List GT_LISTA_MODULOW.lview(92)
; ---------------------------- DEFINICJE TYPOW ----------------------
DEFTYPE .IOAudio audio_req
DEFTYPE.l adport
DEFTYPE.l WORK_DATA
DEFTYPE.l START_DATA_START,START_DATA_LENGTH
DEFTYPE.l XPK_BUFFER,XPK_LENGTH,XPK_ERROR

; ----------------------------- VERSION STRING -----------------------
x$="$VER: AntyDresiarz Issue #4 NG v4.3 by Taski (15.06.98)" : x$=""



._FUNKCJE

Statement dbg{l.l}
  Request "AD Debugger by Paplo/Taski","Line: "+Str$(l)+" debugged","Ok!"
End Statement

Function.w ScrWidth{SCR}
  DEFTYPE .Screen scrdata
  *scrdata.Screen=Peek.l(Addr Screen(SCR))
Function Return *scrdata\Width
End Function

Function.w ScrHeight{SCR}
  DEFTYPE .Screen scrdata
  *scrdata.Screen=Peek.l(Addr Screen(SCR))
Function Return *scrdata\Height
End Function


Function.b WBorAbove{SCR}
  DEFTYPE .Screen scrdata
  *scrdata.Screen=Peek.l(Addr Screen(SCR))
Function Return *scrdata\WBorTop
End Function

Function.b WBorTop{SCR}
  DEFTYPE .Screen scrdata
  *scrdata.Screen=Peek.l(Addr Screen(SCR))
Function Return *scrdata\WBorTop + *scrdata\_RastPort\TxHeight +1
End Function

Function.b WBorBottom{SCR}
  DEFTYPE .Screen scrdata
  *scrdata.Screen=Peek.l(Addr Screen(SCR))
Function Return *scrdata\WBorBottom
End Function

Function.b WBorLeft{SCR}
  DEFTYPE .Screen scrdata
  *scrdata.Screen=Peek.l(Addr Screen(SCR))
Function Return *scrdata\WBorLeft
End Function

Function.b WBorRight{SCR}
  DEFTYPE .Screen scrdata
  *scrdata.Screen=Peek.l(Addr Screen(SCR))
Function Return *scrdata\WBorRight
End Function


Function$ GetCatStr{katalog.l,STRN,DEF_STR$}
  katstr.l=GetCatalogStr_(katalog.l,STRN,DEF_STR$)

Function Return PeekTo$(katstr.l,0)
;  Function Return Left$(Peeks$(katstr.l,256),Instr(Peeks$(katstr.l,256),Chr$(0))-1)
End Function

Statement AddTag{NR.l,TAG.l,TAG_DATA.l}
  If NR.l=0 Then InitBank #TAGLIST_BANK,2016,65536
; TAG
  Poke.l Bank(#TAGLIST_BANK)+(NR.l*8),TAG.l
  Poke.l Bank(#TAGLIST_BANK)+(NR.l*8)+4,TAG_DATA.l
; TAG_END
  Poke.l Bank(#TAGLIST_BANK)+(NR.l*8)+8,#TAG_END
  Poke.l Bank(#TAGLIST_BANK)+(NR.l*8)+12,0
End Statement

._DECRUNCH

Statement XpkError{XPK_ERROR.l}
  SHARED catalog.l
    Select XPK_ERROR.l
      Case #XPKERR_IOERRIN
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,8000,"Nie moge otworzyc wskazanego pliku!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      Case #XPKERR_CHECKSUM
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,8001,"Wskazany plik ma blad sumy kontrolnej!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      Case #XPKERR_VERSION
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,8002,"Wskazany plik zostal spakowany nowsza wersja biblioteki XPK!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      Case #XPKERR_NOMEM
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,8003,"Brak pamieci!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      Case #XPKERR_NEEDPASSWD
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,8004,"Do zdekodowania wymagane jest haslo!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      Case #XPKERR_CORRUPTPKD
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,8005,"Wskazany plik jest uszkodzony!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      Case #XPKERR_MISSINGLIB
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,8006,"Brak w Twoim systemie wymaganej pod-biblioteki Xpk!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      Case #XPKERR_WRONGCPU
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        x$=   "Do rozpakowania tego pliku wymagany jest lepszy procesor!"+Chr$(10)+"Zainstaluj "
        x$=x$+"pod-biblioteke Xpk napisana dla Twojego procesora."
        xb$=GetCatStr{catalog.l,8007,xx$} : xx$=""
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      Case #XPKERR_NOTPACKED
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,8008,"Plik nie jest spakowany!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      Case #XPKERR_OLDMASTLIB
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,8009,"Biblioteka xpkmaster.library jest za stara!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      Case #XPKERR_OLDSUBLIB
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,8010,"Pod-biblioteka XPK jest za stara!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      Case #XPKERR_WRONGPW
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,8011,"Haslo jest nieodpowiednie!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      Case #XPKERR_UNKNOWN
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,8012,"Nieznany blad XPK!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
    End Select
End Statement

Function.l XpkUnpackMem{XPK_SOURCE.l,XPK_PACKEDLENGTH.l,OUTMEMTYPE.l}
  SHARED XPK_BUFFER.l,XPK_LENGTH.l,XPK_ERROR.l
  SHARED catalog.l
  XPK_BUFFER.l=0 : XPK_LENGTH.l=0 : XPK_ERROR.l=0

  DEFTYPE.l xpkbase,XPK_BUFFER,XPK_LENGTH
  xpkbase.l=OpenLibrary_("xpkmaster.library",0)

  If xpkbase.l>0
    AddTag {0,#XPK_InBuf,XPK_SOURCE.l}          ; nazwa wejsciowa pliku do dekompresji
    AddTag {1,#XPK_InLen,XPK_PACKEDLENGTH.l}    ; ile ma wczytac przy decrunchingu!
    AddTag {2,#XPK_GetOutBuf,&XPK_ADDRES.l}     ; alokuje oamiec wstawia pod wpisany adres, adres rozpakowanych danych
    AddTag {3,#XPK_OutMemType,OUTMEMTYPE.l}     ; rodzaj pamieci uzytej do bufora
    AddTag {4,#XPK_GetOutBufLen,&XPK_BUFFER.l}  ; dlugosc bufora
    AddTag {5,#XPK_GetOutLen,&XPK_LENGTH.l}     ; ile zajmuje sam rozpakowany plik
    AddTag {6,#XPK_PassThru,1}                  ; jezeli 1 to jak nie spakowane to i tak przeladuje do bufora
    AddTag {7,$80005850+$42,1}

    MOVE.l a6,-(a7) ; save a6 on stack
    GetReg a6,xpkbase.l : GetReg a0,Bank(#TAGLIST_BANK)
    JSR -48(a6) ; XpkUnpack
    PutReg d0,XPK_ERROR.l
    MOVE.l (a7)+,a6
    CloseLibrary_ xpkbase.l

;     XPK_ERROR.l=XpkUnpack_ (Bank(11))

    XpkError{XPK_ERROR.l}
  Else
    xb$=GetCatStr{catalog.l,8099,"Nie moge otworzyc biblioteki xpkmaster.library"}
    Request GetCatStr{catalog.l,110000,"AD Blad..."},xb$,GetCatStr{catalog.l,100000,"Ok!"} : xb$=""
  EndIf

Function Return XPK_ADDRES.l
End Function

Function PSTCDecrunch {ADRES.l,DESTBANK,OUTMEMTYPE.l}
SHARED STC_OUT.l,STC_BUF.l,STC_LEN.l

  STC_DECLEN.l=Peek.l (ADRES.l+8) : STC_SEC.l=Peek.l (ADRES.l+4)

  If AvailMem_(#MEMF_ANY)>STC_DECLEN.l+STC_SEC.l
    STC_OUT.l=AllocMem_ (STC_DECLEN.l+STC_SEC.l,OUTMEMTYPE.l)
    STC_BUF.l=STC_DECLEN.l+STC_SEC.l
    STC_LEN.l=STC_DECLEN.l

    If Peeks$(ADRES.l,4)="S404"
      WYNIK=True
      STC_BASE.l=OpenLibrary_("stc.library",0)

      If STC_BASE.l<>0
        MOVE.l a6,-(a7) ; save a6 on stack
        GetReg a0,STC_OUT.l : GetReg a1,ADRES.l : GetReg a6,STC_BASE.l
        JSR -36(a6)
        PutReg d0,WYNIK
        MOVE.l (a7)+,a6
        CloseLibrary_ STC_BASE.l
      Else
        WYNIK=False
      EndIf

    Else
      WYNIK=False
    EndIf

  Else
    WYNIK=False
  EndIf
Function Return WYNIK
End Function

Function StcCheck{ADRESS.l}
  If Peeks$(ADRESS.l,4)="S404" : WYNIK=True : Else : WYNIK=False : EndIf
Function Return WYNIK
End Function

._PALETTE

Statement UsePalette{PAL}
SHARED PRE_TRUE_COLOR
  If PRE_TRUE_COLOR<>1 Then Use Palette PAL
End Statement

Function Greyscale{PAL_NR,OD,DO}

  Dim col1r(255),col1g(255),col1b(255)


  *pal.palette=Addr Palette(PAL_NR)
  For t = OD To DO
    R=Peek.b(&*pal\_pdata\_rgbs[t]\_red)
    G=Peek.b(&*pal\_pdata\_rgbs[t]\_green)
    B=Peek.b(&*pal\_pdata\_rgbs[t]\_blue)


    If R<0 Then R=255+R
    If G<0 Then G=255+G
    If B<0 Then B=255+B

    GRAY=(R+G+B)/3
    Poke.b &*pal\_pdata\_rgbs[t]\_red,GRAY
    Poke.b &*pal\_pdata\_rgbs[t]\_green,GRAY
    Poke.b &*pal\_pdata\_rgbs[t]\_blue,GRAY

  Next t
End Function

Function CopyPalette{Source,Dest,Source_OD,Source_DO,Dest_OD}
  Dim col1r(255),col1g(255),col1b(255)

  *pal.palette=Addr Palette(Source)
  *pal2.palette=Addr Palette(Dest)

  For t = Source_OD To Source_DO
    R=Peek.b(&*pal\_pdata\_rgbs[t]\_red)
    G=Peek.b(&*pal\_pdata\_rgbs[t]\_green)
    B=Peek.b(&*pal\_pdata\_rgbs[t]\_blue)

    If R<0 Then R=255+R
    If G<0 Then G=255+G
    If B<0 Then B=255+B

    Poke.b &*pal2\_pdata\_rgbs[Dest_OD+(t-Source_OD)]\_red,R
    Poke.b &*pal2\_pdata\_rgbs[Dest_OD+(t-Source_OD)]\_green,G
    Poke.b &*pal2\_pdata\_rgbs[Dest_OD+(t-Source_OD)]\_blue,B

  Next t
End Function

Function PaletteRed{PAL,KOL}
  *pal.palette=Addr Palette(PAL)
   R=Peek.b(&*pal\_pdata\_rgbs[KOL]\_red)
   If R<0 Then R=255+R
Function Return R
End Function

Function PaletteGreen{PAL,KOLOR}
  *pal.palette=Addr Palette(PAL)
   G=Peek.b(&*pal\_pdata\_rgbs[KOLOR]\_green)
   If G<0 Then G=255+G
Function Return G
End Function

Function PaletteBlue{PALETA,KOLOR}
  *pal.palette=Addr Palette(PALETA)
   B=Peek.b(&*pal\_pdata\_rgbs[KOLOR]\_blue)
   If B<0 Then B=255+B
Function Return B
End Function


Function PaletteRGB {PALETA,KOLOR,RE,GREE,BLU}
    *paleta.palette=Addr Palette(PALETA)
    Poke.b &*paleta\_pdata\_rgbs[KOLOR]\_red,RE
    Poke.b &*paleta\_pdata\_rgbs[KOLOR]\_green,GREE
    Poke.b &*paleta\_pdata\_rgbs[KOLOR]\_blue,BLU
End Function

._IFF_ILBM
Function.w IFF_Width {ADRES.l}
  DLUGOSC_IFF.l=Peek.l (ADRES.l+4) : SKOK.l=12
  Repeat
    FORMA$=Peeks$(ADRES.l+SKOK.l,4) : SKOK.l=SKOK.l+4
    If FORMA$<>"BMHD"
      SKOK2.l=Peek.l (ADRES.l+SKOK.l) : SKOK.l=SKOK.l+SKOK2.l+4
    Else
      WYNIK.w=Peek.w (ADRES.l+SKOK.l+4)
      SKOK.l=DLUGOSC_IFF.l+1
    EndIf
  Until SKOK.l>DLUGOSC_IFF.l

Function Return WYNIK.w
End Function

Function.w IFF_Height {ADRES.l}
  DLUGOSC_IFF.l=Peek.l (ADRES.l+4) : SKOK.l=12
  Repeat
    FORMA$=Peeks$(ADRES.l+SKOK.l,4) : SKOK.l=SKOK.l+4
    If FORMA$<>"BMHD"
      SKOK2.l=Peek.l (ADRES.l+SKOK.l) : SKOK.l=SKOK.l+SKOK2.l+4
    Else
      WYNIK.w=Peek.w (ADRES.l+SKOK.l+6)
      SKOK.l=DLUGOSC_IFF.l+1
    EndIf
  Until SKOK.l>DLUGOSC_IFF.l

Function Return WYNIK.w
End Function

Function.b IFF_Depth {ADRES.l}
  DLUGOSC_IFF.l=Peek.l (ADRES.l+4) : SKOK.l=12
  Repeat
    FORMA$=Peeks$(ADRES.l+SKOK.l,4) : SKOK.l=SKOK.l+4
    If FORMA$<>"BMHD"
      SKOK2.l=Peek.l (ADRES.l+SKOK.l) : SKOK.l=SKOK.l+SKOK2.l+4
    Else
      WYNIK.b=Peek.b (ADRES.l+SKOK.l+12)
      SKOK.l=DLUGOSC_IFF.l+1
    EndIf
  Until SKOK.l>DLUGOSC_IFF.l
Function Return WYNIK.b
End Function

Function.b CheckIFF {ADRES.l}
  If Peeks$(ADRES.l,4)="FORM"
    If Peeks$(ADRES.l+8,4)="ILBM" : WYNIK=True : Else : WYNIK=False : EndIf
  Else
    WYNIK=False
  EndIf
Function Return WYNIK
End Function

Function DecodeIFFPalette{PALETA,ADRES.l,OD,DO,INIT}
  DLUGOSC_IFF.l=Peek.l (ADRES.l+4)
  SKOK.l=12
  WYNIK=False

  Repeat
    FORMA$=Peeks$(ADRES.l+SKOK.l,4) : SKOK.l=SKOK.l+4

    If FORMA$<>"CMAP"
      SKOK2.l=Peek.l (ADRES.l+SKOK.l) : SKOK.l=SKOK.l+SKOK2.l+4
    Else
      SKOK.l=SKOK.l+4
      DEPT=(Peek.l (ADRES.l+SKOK.l-4)/3)
      If OD=False Then OD=0
      If DO=False Then DO=DEPT-1

      If INIT=True Then InitPalette PALETA,DEPT

      For DODAC=OD To DO
        *paleta.palette=Addr Palette(PALETA)
        Poke.b &*paleta\_pdata\_rgbs[DODAC]\_red,Peek.b  (ADRES.l+SKOK.l+DODAC*3)
        Poke.b &*paleta\_pdata\_rgbs[DODAC]\_green,Peek.b(ADRES.l+SKOK.l+DODAC*3+1)
        Poke.b &*paleta\_pdata\_rgbs[DODAC]\_blue,Peek.b (ADRES.l+SKOK.l+DODAC*3+2)
      Next DODAC

      SKOK.l=DLUGOSC_IFF.l+1
      WYNIK=True
    EndIf


  Until SKOK.l>DLUGOSC_IFF.l

Function Return WYNIK
End Function

._FILE_IO

Statement FClose_ {FILE_NR}
  SHARED FILE_ADDRES.l(),FILE_LOCK()
  If FILE_ADDRES.l(FILE_NR)>0 Then Close_ FILE_ADDRES.l(FILE_NR) : FILE_ADDRES.l(FILE_NR)=0
;  If FILE_LOCK.l(FILE_NR)>0 Then UnLock_ FILE_LOCK.l(FILE_NR) : FILE_LOCK.l(FILE_NR)=0
End Statement

Statement FSeek_{FILE_NR,LOKPLK.l}
  SHARED FILE_LOCATE.l(),FILE_ADDRES.l()
  x=Seek_ (FILE_ADDRES.l(FILE_NR),LOKPLK.l,-1)
  FILE_LOCATE.l(FILE_NR)=LOKPLK.l
End Statement


Statement FOpen_ {FILE_NR,FNAME$,MODE.l}
  SHARED FILE_ADDRES.l(),FILE_LOCK.l(),FILE_LENGTH.l(),FILE_LOCATE.l()

  FILE_LENGTH.l(FILE_NR)=Exists(FNAME$)
  FILE_LOCATE.l(FILE_NR)=0

  FClose_ {FILE_NR}

;  FILE_LOCK.l(FILE_NR)=Lock_(FNAME$,MODE.l)
;  FILE_ADDRES.l(FILE_NR)=OpenFromLock_(FILE_LOCK.l(FILE_NR))

  FILE_ADDRES.l(FILE_NR)=Open_(FNAME$,MODE.l)
  FSeek_{FILE_NR,0}

End Statement


Function$ Edit_{FILE_NR}
  SHARED FILE_ADDRES.l(),FILE_LOCATE.l()


  EDIT_DANE$=String$(Chr$(0),255)

  x=FGets_ (FILE_ADDRES.l(FILE_NR),&EDIT_DANE$,250)
  DLUG=Instr(EDIT_DANE$,Chr$(10))

  If DLUG=0
    DLUG=Instr(EDIT_DANE$,Chr$(0))-1
    If DLUG<0 Then DLUG=0
  Else
    DLUG=DLUG-1
  EndIf

  EDIT_OUT$=Left$(EDIT_DANE$,DLUG)
  FILE_LOCATE.l(FILE_NR)=FILE_LOCATE.l(FILE_NR)+Len(EDIT_OUT$)+1

Function Return EDIT_OUT$
End Function

Function.l Loc_{FILE_NR}
  SHARED FILE_LOCATE.l()
  Function Return FILE_LOCATE.l(FILE_NR)
End Function

Function.l Lof_{FILE_NR}
  SHARED FILE_LENGTH.l()
  Function Return FILE_LENGTH.l(FILE_NR)
End Function


Function Eof_{FILE_NR}
  SHARED FILE_LOCATE.l(),FILE_ADDRES.l(),FILE_LENGTH.l()
  If Loc_{FILE_NR}=>Lof_{FILE_NR} : RT=True: Else : RT=False : EndIf
Function Return RT
End Function


._FILELOAD

Function MemLoad {PLIK,dest.l,from.l,leng.l}
  SHARED FILE_ADDRES.l()
  Seek_ FILE_ADDRES.l(PLIK),from.l,-1
  Read_ FILE_ADDRES.l(PLIK),dest.l,leng.l
End Function

Function.l FileLoad{NAZWA$,TYP$,PLIK,OFFSET.l,LENG.l}
  SHARED XPK_BUFFER.l,XPK_LENGTH.l,XPK_ERROR.l
  SHARED STC_OUT.l,STC_LEN.l,STC_BUF.l
  SHARED WORK_DATA.l
  SHARED Krotki_opis()
  SHARED TEMP_DIR$
  SHARED catalog.l
  SHARED FILE_ADDRES.l()
  SHARED LOK$

  WORK_DATA.l=0

  If NAZWA$=""
    RODZAJ_DANYCH$="DANE"
  Else
    RODZAJ_DANYCH$="PLIK"
  EndIf

; -------------------------------------------------------------- START DATA

  If TYP$="START_DATA"
    DEST_NAZWA_PLIKU$=TEMP_DIR$+"START.DATA"

    If RODZAJ_DANYCH$="PLIK"
      NAZWA_PLIKU$="START.DATA" : DLUGOSC_PLIKU.l=Exists(NAZWA_PLIKU$)

      If DLUGOSC_PLIKU.l>0
        DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)
        If DEST.l>0
          BLoad NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
        Else
          xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
          xc$=GetCatStr{catalog.l,100000,"Ok!"}
          xb$=GetCatStr{catalog.l,10000,"Brak pamieci na zaladowanie AntyDresiarza!"}
          Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
        EndIf
      Else
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,10001,"Wystapil blad podczas inicjalizacji AntyDresiarza!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      EndIf
    EndIf

    If RODZAJ_DANYCH$="DANE"
      DLUGOSC_PLIKU.l=LENG.l

      If DLUGOSC_PLIKU.l>0
        DEST.l=AllocMem_(LENG.l,#MEMF_ANY)
        If DEST.l>0 AND LENG.l>0
          DLUGOSC_PLIKU.l=LENG.l
          x=MemLoad {PLIK,DEST.l,OFFSET.l,DLUGOSC_PLIKU.l}
        Else
          xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
          xc$=GetCatStr{catalog.l,100000,"Ok!"}
          xb$=GetCatStr{catalog.l,10000,"Brak pamieci na zaladowanie AntyDresiarza!"}
          Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
        EndIf
      Else
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,10001,"Wystapil blad podczas inicjalizacji AntyDresiarza!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      EndIf
    EndIf

    If DEST.l>0
      ski.l=0
;      For i.l=0 To DLUGOSC_PLIKU.l
;        enc.b=Peek.b( DEST.l+ski.l )
;        Poke.b (DEST.l+ski.l),255-enc.b
;        ski.l=ski.l+1
;      Next

      If Peeks$(DEST.l,4)="XPKF"
        OUT.l=XpkUnpackMem{DEST.l,DLUGOSC_PLIKU.l,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        BSave DEST_NAZWA_PLIKU$,OUT.l,XPK_LENGTH.l
        If OUT.l>0 AND XPK_BUFFER.l>0 Then FreeMem_ OUT.l,XPK_BUFFER.l
        DECR=True
      EndIf

      If StcCheck{DEST.l}=True
        x=PSTCDecrunch{DEST.l,5,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        BSave DEST_NAZWA_PLIKU$,STC_OUT.l,STC_LEN.l
        FreeMem_ STC_OUT.l,STC_BUF.l
        DECR=True
      EndIf

      If DECR<>True
        BSave DEST_NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
      EndIf
    EndIf

  EndIf

; ----------------------------------------------------------MENU TEXT

  If TYP$="LOAD_MENU"
    DEST_NAZWA_PLIKU$=TEMP_DIR$+"MENU"

    If RODZAJ_DANYCH$="PLIK"
      NAZWA_PLIKU$="TEKSTY/DATA/"+NAZWA$
      DLUGOSC_PLIKU.l=Exists(NAZWA_PLIKU$)

      If DLUGOSC_PLIKU.l>0
        DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)

        If DEST.l>0
          BLoad NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
        Else
          xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
          xc$=GetCatStr{catalog.l,100000,"Ok!"}
          xb$=GetCatStr{catalog.l,10100,"Brak pamieci na zaladowanie danych z menu!"}
          Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
        EndIf
      Else
          xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
          xc$=GetCatStr{catalog.l,100000,"Ok!"}
          xb$=GetCatStr{catalog.l,10101,"Plik z danymi do menu nie istnieje!"}
          Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      EndIf
    EndIf

    If RODZAJ_DANYCH$="DANE"
      DLUGOSC_PLIKU.l=LENG.l

      If DLUGOSC_PLIKU.l>0
        DEST.l=AllocMem_(LENG.l,#MEMF_ANY)
        If DEST.l>0
          DLUGOSC_PLIKU.l=LENG.l
          x=MemLoad {PLIK,DEST.l,OFFSET.l,DLUGOSC_PLIKU.l}
        Else
          xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
          xc$=GetCatStr{catalog.l,100000,"Ok!"}
          xb$=GetCatStr{catalog.l,10100,"Brak pamieci na zaladowanie danych z menu!"}
          Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
        EndIf
      Else
        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xb$=GetCatStr{catalog.l,10101,"Plik z danymi do menu nie istnieje!"}
        Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
      EndIf
    EndIf

    If DEST.l>0
      If Peeks$(DEST.l,4)="XPKF"
        OUT.l=XpkUnpackMem{DEST.l,DLUGOSC_PLIKU.l,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        BSave DEST_NAZWA_PLIKU$,OUT.l,XPK_LENGTH.l
        If OUT.l>0 AND XPK_BUFFER.l>0 Then FreeMem_ OUT.l,XPK_BUFFER.l
        DECR=True
      EndIf

      If StcCheck{DEST.l}=True
        x=PSTCDecrunch{DEST.l,5,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        BSave DEST_NAZWA_PLIKU$,STC_OUT.l,STC_LEN.l
        FreeMem_ STC_OUT.l,STC_BUF.l
        DECR=True
      EndIf

      If DECR<>True
        BSave DEST_NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
      EndIf
    EndIf

  EndIf


; -------------------------------------------------------------- TEXT

  If TYP$="LOAD_TEXT"
    DEST_NAZWA_PLIKU$=TEMP_DIR$+"ANTYDRESIARZ-ARTEK"

    If RODZAJ_DANYCH$="PLIK"
      NAZWA_PLIKU$="TEKSTY/"+NAZWA$+".TXT"
      DLUGOSC_PLIKU.l=Exists(NAZWA_PLIKU$)

      If DLUGOSC_PLIKU.l>0
        DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)
        If DEST.l>0
          BLoad NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
        Else
          xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
          xc$=GetCatStr{catalog.l,100000,"Ok!"}
          xb$=GetCatStr{catalog.l,10200,"Brak pamieci na zaladowanie tekstu!"}
          Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
        EndIf
      EndIf

    EndIf

    If RODZAJ_DANYCH$="DANE"
      DLUGOSC_PLIKU.l=LENG.l

      If DLUGOSC_PLIKU.l>0
        DEST.l=AllocMem_(LENG.l,#MEMF_ANY)

        If DEST.l>0
          DLUGOSC_PLIKU.l=LENG.l
          x=MemLoad {PLIK,DEST.l,OFFSET.l,DLUGOSC_PLIKU.l}
        Else
          xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
          xc$=GetCatStr{catalog.l,100000,"Ok!"}
          xb$=GetCatStr{catalog.l,10200,"Brak pamieci na zaladowanie tekstu!"}
          Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
        EndIf
      EndIf

    EndIf

    If DEST.l>0
      If Peeks$(DEST.l,4)="XPKF"
        OUT.l=XpkUnpackMem{DEST.l,DLUGOSC_PLIKU.l,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        BSave DEST_NAZWA_PLIKU$,OUT.l,XPK_LENGTH.l
        If OUT.l>0 AND XPK_BUFFER.l>0 Then FreeMem_ OUT.l,XPK_BUFFER.l
        DECR=True
      EndIf

      If StcCheck{DEST.l}=True
        x=PSTCDecrunch{DEST.l,5,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        BSave DEST_NAZWA_PLIKU$,STC_OUT.l,STC_LEN.l
        FreeMem_ STC_OUT.l,STC_BUF.l
        DECR=True
      EndIf

      If DECR<>True
        BSave DEST_NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
      EndIf
    EndIf

  EndIf

; ----------------------------------------------------------- PICTURE

  If TYP$="PIC_LOAD"

    If RODZAJ_DANYCH$="PLIK"
      NAZWA_PLIKU$="RYSUNKI/"+NAZWA$
      DLUGOSC_PLIKU.l=Exists(NAZWA_PLIKU$)

      If DLUGOSC_PLIKU.l>0
        DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)
        If DEST.l>0
          BLoad NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
          OUT.l=DEST.l
          WORK_DATA.l=DLUGOSC_PLIKU.l
        Else
          xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
          xc$=GetCatStr{catalog.l,100000,"Ok!"}
          xb$=GetCatStr{catalog.l,10400,"Brak pamieci na zaladowanie obrazka!"}
          Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
          OUT.l=0 : WORK_DATA.l=0
        EndIf
      EndIf
    EndIf

    If RODZAJ_DANYCH$="DANE"
      DLUGOSC_PLIKU.l=LENG.l

      If DLUGOSC_PLIKU.l>0
        DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)
        If DEST.l>0
          x=MemLoad {PLIK,DEST.l,OFFSET.l,DLUGOSC_PLIKU.l}
          OUT.l=DEST.l
          WORK_DATA.l=DLUGOSC_PLIKU.l
        Else
          xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
          xc$=GetCatStr{catalog.l,100000,"Ok!"}
          xb$=GetCatStr{catalog.l,10400,"Brak pamieci na zaladowanie obrazka!"}
          Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
          OUT.l=0 : WORK_DATA.l=0
        EndIf
      EndIf
    EndIf

    If OUT.l>0
      If Peeks$(DEST.l,4)="XPKF"
        OUT.l=XpkUnpackMem{DEST.l,DLUGOSC_PLIKU.l,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        WORK_DATA.l=XPK_BUFFER.l
      EndIf

      If StcCheck{DEST.l}=True
        x=PSTCDecrunch {DEST.l,5,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        OUT.l=STC_OUT.l
        WORK_DATA.l=STC_BUF.l
      EndIf
    EndIf

  EndIf

; ------------------------------------------------------- MODULE

  If TYP$="MOD_LOAD"

    If RODZAJ_DANYCH$="PLIK"
      NAZWA_PLIKU$=NAZWA$
      DLUGOSC_PLIKU.l=Exists(NAZWA_PLIKU$)

      If DLUGOSC_PLIKU.l>0
        DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)

        If DEST.l>0
          BLoad NAZWA_PLIKU$,DEST.l,DLUGOSC_PLIKU.l
          OUT.l=DEST.l
          WORK_DATA.l=DLUGOSC_PLIKU.l
        Else
          xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
          xc$=GetCatStr{catalog.l,100000,"Ok!"}
          xb$=GetCatStr{catalog.l,10600,"Brak pamieci na zaladowanie modulu!"}
          Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
          OUT.l=0 : WORK_DATA.l=0
        EndIf
      EndIf
    EndIf

    If RODZAJ_DANYCH$="DANE"
      DLUGOSC_PLIKU.l=LENG.l

      If DLUGOSC_PLIKU.l>0
        DEST.l=AllocMem_(DLUGOSC_PLIKU.l,#MEMF_ANY)
        If DEST.l>0 AND DLUGOSC_PLIKU.l>0
          x=MemLoad {PLIK,DEST.l,OFFSET.l,DLUGOSC_PLIKU.l}
          OUT.l=DEST.l
          WORK_DATA.l=DLUGOSC_PLIKU.l
        Else
          xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
          xc$=GetCatStr{catalog.l,100000,"Ok!"}
          xb$=GetCatStr{catalog.l,10600,"Brak pamieci na zaladowanie modulu!"}
          Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
          OUT.l=0 : WORK_DATA.l=0
        EndIf
      EndIf
    EndIf

    If OUT.l>0
      If Peeks$(DEST.l,4)="XPKF"
        OUT.l=XpkUnpackMem{DEST.l,DLUGOSC_PLIKU.l,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        WORK_DATA.l=XPK_BUFFER.l
      EndIf

      If StcCheck{DEST.l}=True
        x=PSTCDecrunch{DEST.l,5,#MEMF_ANY}
        FreeMem_ DEST.l,DLUGOSC_PLIKU.l
        OUT.l=STC_OUT.l
        WORK_DATA.l=STC_BUF.l
      EndIf
    EndIf

  EndIf


Function Return OUT.l
End Function

._HARDWARE

Function CPU{}
  MOVE.l #$4,a0 : MOVE.l (a0),a1
  BTST #$07,$129(a1) : BNE CPU060
  BTST #$03,$129(a1) : BNE CPU040
  BTST #$02,$129(a1) : BNE CPU030
  BTST #$01,$129(a1) : BNE CPU020
  BTST #$00,$129(a1) : BNE CPU010
  PROC=0
  Goto KONIEC

CPU060:
  PROC=6 : Goto KONIEC
CPU040:
  PROC=4 : Goto KONIEC
CPU030:
  PROC=3 : Goto KONIEC
CPU020:
  PROC=2 : Goto KONIEC
CPU010:
  PROC=1 : Goto KONIEC
KONIEC:

Function Return PROC
End Function

._CHUNKY_GRAFIKA

Function CheckCH{ADR.l}
  If Peeks$(ADR.l,8)="CHUNKY24" : RET=True : Else : RET=False :EndIf
Function Return RET
End Function

Function CH_Width{ADR.l}
Function Return Peek.w(ADR.l+8)
End Function

Function CH_Height{ADR.l}
Function Return Peek.w(ADR.l+10)
End Function

Statement WPA{SRCRECT.l,RP.l,DESTX.w,DESTY.w,SIZEX.w,SIZEY.w}
SHARED CX_SRCX.w,CX_SRCY.w,CX_SRCMOD.l,cgxbase.l
SRCFORMAT.b=0
;  cgxbase.l=OpenLibrary_("cybergraphics.library",0)

  If cgxbase.l>0
    GetReg a6,cgxbase.l
    GetReg a0,SRCRECT.l
    GetReg d0,CX_SRCX.w
    GetReg d1,CX_SRCY.w
    GetReg d2,CX_SRCMOD.l
    GetReg a1,RP.l
    GetReg d3,DESTX.w
    GetReg d4,DESTY.w
    GetReg d5,SIZEX.w
    GetReg d6,SIZEY.w
    GetReg d7,SRCFORMAT.b
    JSR -$7e(a6) ; WritePixelArray
  EndIf

;  CloseLibrary_ cgxbase.l
End Statement

Statement SPA{SRCRECT.l,RP.l,DESTX.w,DESTY.w,DESTW.w,DESTH.w}
SHARED CX_SRCW.w,CX_SRCH.w,CX_SRCMOD.l,cgxbase.l
SRCFORMAT.b=0
;  cgxbase.l=OpenLibrary_("cybergraphics.library",0)

  If cgxbase.l>0
    MOVE.l a6,-(a7) ; save a6 on stack
    GetReg a6,cgxbase.l
    GetReg a0,SRCRECT.l
    GetReg d0,CX_SRCW.w
    GetReg d1,CX_SRCH.w
    GetReg d2,CX_SRCMOD.l
    GetReg a1,RP.l
    GetReg d3,DESTX.w
    GetReg d4,DESTY.w
    GetReg d5,DESTW.w
    GetReg d6,DESTH.w
    GetReg d7,SRCFORMAT.b
    JSR -$5a(a6) ; WritePixelArray
    MOVE.l (a7)+,a6
  EndIf
;  CloseLibrary_ cgxbase.l
End Statement

Statement FPA{RP.l,DESTX.w,DESTY.w,SIZEX.w,SIZEY.w,kol.l}
SHARED cgxbase.l
SRCFORMAT.b=0

  If cgxbase.l>0
    GetReg a6,cgxbase.l
    GetReg a1,RP.l
    GetReg d0,DESTX.w
    GetReg d1,DESTY.w
    GetReg d2,SIZEX.w
    GetReg d3,SIZEY.w
    GetReg d4,kol.l
    JSR -$96(a6) ; FillPixelArray
  EndIf

End Statement

Statement ChunkyDrawLineImage{ARRAY.l,DRAW_WINDOW,DRAW_SZEROKOSC,DRAW_WYSOKOSC,DRAW_SCALE}
SHARED CX_SRCX.w,CX_SRCY.w,CX_SRCMOD.l,cgxbase.l

  If DRAW_SCALE=0
    For y=1 To DRAW_WYSOKOSC Step 2
      CX_SRCX.w=0 : CX_SRCY.w=y
      WPA{ARRAY.l,RastPort(DRAW_WINDOW),0,y,DRAW_SZEROKOSC,1}
      CX_SRCX.w=0 : CX_SRCY.w=DRAW_WYSOKOSC-y-1
      WPA{ARRAY.l,RastPort(DRAW_WINDOW),0,DRAW_WYSOKOSC-y-1,DRAW_SZEROKOSC,1}
      VWait
    Next y
  Else
    For y=2 To DRAW_WYSOKOSC*2 Step 4
      CX_SRCX.w=0 : CX_SRCY.w=y/2
      WPA{ARRAY.l,RastPort(DRAW_WINDOW),0,y  ,DRAW_SZEROKOSC,1}
      WPA{ARRAY.l,RastPort(DRAW_WINDOW),0,y+1,DRAW_SZEROKOSC,1}
      CX_SRCX.w=0 : CX_SRCY.w=DRAW_WYSOKOSC-(y/2)-1
      WPA{ARRAY.l,RastPort(DRAW_WINDOW),0,DRAW_WYSOKOSC*2-y-1,DRAW_SZEROKOSC,1}
      WPA{ARRAY.l,RastPort(DRAW_WINDOW),0,DRAW_WYSOKOSC*2-y-2,DRAW_SZEROKOSC,1}
      VWait
    Next y
  EndIf
End Function



._GRAFIKA

Function.l FindColor{re.b,gr.b,bl.b}
  SHARED AD_SCREEN
  vport.l=ViewPort(AD_SCREEN) : cmap.l=Peek.l(vport+$4)
  r.l=0 : g.l=0 : b.l=0
  Poke.b &r.l,re.b : Poke.b &g.l,gr.b : Poke.b &b.l,bl.b
  wyn.l=FindColor_ (cmap.l,r.l,g.l,b.l,255)
Function Return wyn.l
End Function

Statement WColour_{KOLOR}
  SHARED PRE_TRUE_COLOR,PRE_R(),PRE_G(),PRE_B()

  If PRE_TRUE_COLOR=1
    KOL=FindColor{PRE_R(KOLOR),PRE_G(KOLOR),PRE_B(KOLOR)}
  Else
    KOL=KOLOR
  EndIf
  WColour KOL

End Statement

Statement Short{SHORT$}

  SHARED CX_SRCX.w,CX_SRCY.w,CX_SRCMOD.l
  SHARED OLD_SHORT.w,NEW_SHORT.w
  SHARED PRE_TRUE_COLOR,PRE_SCALE,PRE_SHORT_X,PRE_SHORT_Y,PRE_SHORT_W,PRE_SHORT_H
  SHARED PRE_PEN_SHORT
  SHARED AKTYWNY_KOLOR,AKTYWNY_JAM
  SHARED PRE_R(),PRE_G(),PRE_B(),AD_SCREEN

    If OLD_SHORT.w<>NEW_SHORT.w

      WColour_{PRE_PEN_SHORT}

      SHH=PRE_SHORT_H : SHY=PRE_SHORT_Y : If PRE_SCALE=1 Then SHY=SHY*2 : SHH=SHH*2+2
      If PRE_TRUE_COLOR
        chlen.l=PRE_SHORT_W*SHH*3
        chbox.l=AllocMem_ (chlen.l,#MEMF_ANY|#MEMF_CLEAR)
        CX_SRCX.w=0 : CX_SRCY.w=0 : CX_SRCMOD.l=PRE_SHORT_W*3
        WPA{chbox.l,RastPort(#AD_WINDOW),PRE_SHORT_X,SHY,PRE_SHORT_W,SHH}
        FreeMem_ chbox.l,chlen.l
      Else
        WBox PRE_SHORT_X,SHY,PRE_SHORT_X+PRE_SHORT_W,SHY+SHH,32
      EndIf
      WLocate PRE_SHORT_X,SHY : NPrint SHORT$
    EndIf

    WColour_{AKTYWNY_KOLOR}
    WJam AKTYWNY_JAM
End Statement

Statement BMToWin{BITM,WIND,X,Y,W,H}
  SHARED PRE_SMART_REFRESH,PRE_SCALE,SCX,SCY

  If SCX=True Then SCX=0
  If SCY=True Then SCY=0

  If PRE_SCALE=0
    If PRE_SMART_REFRESH=1
      For POSY=0 To H-1
        BitMaptoWindow BITM,WIND,SCX,SCY+POSY,X,Y+POSY,W,1
      Next POSY
    Else
      BitMaptoWindow BITM,WIND,SCX,SCY,X,Y,W,H
    EndIf
  Else
    For POSY=0 To H*2-1 Step 2
      BitMaptoWindow BITM,WIND,SCX,SCY+POSY/2,X,Y+POSY,W,1
      BitMaptoWindow BITM,WIND,SCX,SCY+POSY/2,X,Y+POSY+1,W,1
    Next POSY
  EndIf

  SCX=True
  SCY=True

End Statement

Statement Pattern{WIN,X,Y,W,H}
  SHARED PRE_SCALE,PATT_WIDTH,PATT_HEIGHT,PRE_TRUE_COLOR,PATT_ADDR.l,CX_SRCMOD.l
  SHARED PATT_MODE$
  SHARED CX_SRCW.w,CX_SRCH.w,CX_SRCX.w,CX_SRCY.w,cgxbase.l

  Use Window WIN
  If PRE_SCALE=1 Then Y=Y*2 : H=H*2

  WIDTH=PATT_WIDTH
  HEIGHT=PATT_HEIGHT : If PRE_SCALE=1 Then HEIGHT=HEIGHT*2

  ILE_X=W/WIDTH
  ILE_Y=H/HEIGHT

  ILE_ZOST_X=W-(ILE_X*WIDTH)
  ILE_ZOST_Y=H-(ILE_Y*HEIGHT)

  If PRE_TRUE_COLOR=1 AND PATT_MODE$="CHUNKY"
    For POZ_Y=0 To ILE_Y-1
      For POZ_X=0 To ILE_X-1

        CX_SRCX.w=0 : CX_SRCY.w=0 : CX_SRCMOD.l=PATT_WIDTH*3

        If PRE_SCALE<>1
          WPA{PATT_ADDR.l+12,RastPort(WIN),X+(POZ_X*WIDTH),Y+(POZ_Y*HEIGHT),WIDTH,PATT_HEIGHT}
        Else
          CX_SRCW.w=PATT_WIDTH : CX_SRCH.w=PATT_HEIGHT : CX_SRCMOD.l=PATT_WIDTH*3
          SPA{PATT_ADDR.l+12,RastPort(WIN),X,Y,640,169*2}
        EndIf


      Next POZ_X
    Next POZ_Y

  Else
    For POZ_Y=0 To ILE_Y-1
      For POZ_X=0 To ILE_X-1
        BMToWin{#PATTERN_BITMAP,WIN,X+(POZ_X*WIDTH),Y+(POZ_Y*HEIGHT),WIDTH,PATT_HEIGHT}
      Next POZ_X
    Next POZ_Y
  EndIf

End Statement

Function.l DlugoscTekstu{OKNO,TXT$}
  rp.l=RastPort(OKNO)
  Function Return TextLength_(rp.l,&TXT$,Len(TXT$))
End Function

Statement DrawLineImage{DRAW_BITMAP,DRAW_WINDOW,DRAW_SZEROKOSC,DRAW_WYSOKOSC,DRAW_SCALE}

  If DRAW_SCALE=0
    For y=1 To DRAW_WYSOKOSC Step 2
      BitMaptoWindow DRAW_BITMAP,DRAW_WINDOW,0,y,0,y,DRAW_SZEROKOSC,1
      BitMaptoWindow DRAW_BITMAP,DRAW_WINDOW,0,DRAW_WYSOKOSC-y-1,0,DRAW_WYSOKOSC-y-1,DRAW_SZEROKOSC,1
      VWait
    Next y
  Else
    For y=2 To DRAW_WYSOKOSC*2 Step 4
      BitMaptoWindow DRAW_BITMAP,DRAW_WINDOW,0,y/2,0,y  ,DRAW_SZEROKOSC,1
      BitMaptoWindow DRAW_BITMAP,DRAW_WINDOW,0,y/2,0,y+1,DRAW_SZEROKOSC,1

      BitMaptoWindow DRAW_BITMAP,DRAW_WINDOW,0,DRAW_WYSOKOSC-(y/2)-1,0,DRAW_WYSOKOSC*2-y-1  ,DRAW_SZEROKOSC,1
      BitMaptoWindow DRAW_BITMAP,DRAW_WINDOW,0,DRAW_WYSOKOSC-(y/2)-1,0,DRAW_WYSOKOSC*2-y-2,DRAW_SZEROKOSC,1
      VWait
    Next y
  EndIf
End Function

Statement ClearLineImage{DRAW_WINDOW,DRAW_SZEROKOSC,DRAW_WYSOKOSC,DRAW_SCALE,DRAW_COLOUR}
  SHARED PRE_TRUE_COLOR,AD_SCREEN
  SHARED PRE_R(),PRE_G(),PRE_B()

  Use Window DRAW_WINDOW

  If PRE_TRUE_COLOR=1
    KOL=FindColor{PRE_R(DRAW_COLOR),PRE_G(DRAW_COLOR),PRE_B(DRAW_COLOR)}
  Else
    KOL=DRAW_COLOR
  EndIf


  If DRAW_SCALE=0
    For y=1 To DRAW_WYSOKOSC Step 2
      Wline 0,y                ,DRAW_SZEROKOSC,y      ,KOL
      Wline 0,DRAW_WYSOKOSC-y-1,DRAW_SZEROKOSC,DRAW_WYSOKOSC-y-1,KOL
      VWait 1
    Next y
  Else
    For y=1 To DRAW_WYSOKOSC*2 Step 4
      Wline 0,y-1                  ,DRAW_SZEROKOSC,y-1      ,KOL
      Wline 0,y                    ,DRAW_SZEROKOSC,y        ,KOL

      Wline 0,DRAW_WYSOKOSC*2-y-1,DRAW_SZEROKOSC,DRAW_WYSOKOSC*2-y-1,KOL
      Wline 0,DRAW_WYSOKOSC*2-y  ,DRAW_SZEROKOSC,DRAW_WYSOKOSC*2-y  ,KOL
      VWait 1
    Next y
  EndIf
End Statement

._MUZYKA

Function.l MP_LoadModule_Fast{NAME$}
  SHARED ASM_OUT.l : ASM_OUT.l=-1
  mpbase.l=OpenLibrary_("medplayer.library",7)
  If mpbase.l>0
    GetReg a0,&NAME$
    GetReg a6,mpbase.l
    JSR -$78(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ mpbase.l
  EndIf
  Function Return ASM_OUT.l ; pointer to the module
End Function

Function.l MP_GetPlayer{MIDI}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  mpbase.l=OpenLibrary_("medplayer.library",7)
  If mpbase.l>0
    GetReg d0,MIDI
    GetReg a6,mpbase.l
    JSR -$1e(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ mpbase.l
  EndIf
  Function Return ASM_OUT.l ; 0 - all ok, 0<> - something wrong!
End Function

Function.l MP_SetFastMemPlay{STATE,BUFFSIZE}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  mpbase.l=OpenLibrary_("medplayer.library",7)
  If mpbase.l>0
    GetReg d0,STATE
    GetReg d1,BUFFSIZE
    GetReg a6,mpbase.l
    JSR -$7e(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ mpbase.l
  EndIf
  Function Return ASM_OUT.l
End Function

Function.l MP_RequiredPlayRoutine{MODUL.l}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  mpbase.l=OpenLibrary_("medplayer.library",7)
  If mpbase.l>0
    GetReg a0,MODUL.l
    GetReg a6,mpbase.l
    JSR -$6c(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ mpbase.l
  EndIf
  Function Return ASM_OUT.l ; 0-normal(4chn), 1-(5-8chn), 2(octamix -64chn)
End Function

Function.l MP_PlayModule{MODUL.l}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  mpbase.l=OpenLibrary_("medplayer.library",7)
  If mpbase.l>0
    GetReg a0,MODUL.l
    GetReg a6,mpbase.l
    JSR -$2a(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ mpbase.l
  EndIf
  Function Return ASM_OUT.l ;
End Function

Function.l MP_FreePlayer{}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  mpbase.l=OpenLibrary_("medplayer.library",7)
  If mpbase.l>0
    GetReg a6,mpbase.l
    JSR -$24(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ mpbase.l
  EndIf
  Function Return ASM_OUT.l ;
End Function

Function.l MP_UnLoadModule{MODUL.l}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  mpbase.l=OpenLibrary_("medplayer.library",7)
  If mpbase.l>0
    GetReg a0,MODUL.l
    GetReg a6,mpbase.l
    JSR -$4e(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ mpbase.l
  EndIf
  Function Return ASM_OUT.l ;
End Function

Function.l OP_LoadModule_Fast8{NAME$}
  SHARED ASM_OUT.l : ASM_OUT.l=-1
  opbase.l=OpenLibrary_("octaplayer.library",0)
  If opbase.l>0
    GetReg a0,&NAME$
    GetReg a6,opbase.l
    JSR -$66(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ opbase.l
  EndIf
  Function Return ASM_OUT.l ; pointer to the module
End Function

Function.l OP_GetPlayer8{}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  opbase.l=OpenLibrary_("octaplayer.library",0)
  If opbase.l>0
    GetReg a6,opbase.l
    JSR -$1e(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ opbase.l
  EndIf
  Function Return ASM_OUT.l ; 0 - all ok, 0<> - something wrong!
End Function

Function.l OP_SetFastMemPlay8{STATE,BUFFSIZE}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  opbase.l=OpenLibrary_("octaplayer.library",0)
  If opbase.l>0
    GetReg d0,STATE
    GetReg d1,BUFFSIZE
    GetReg a6,opbase.l
    JSR -$6c(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ opbase.l
  EndIf
  Function Return ASM_OUT.l
End Function

Function.l OP_RequiredPlayRoutine8{MODUL.l}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  opbase.l=OpenLibrary_("octaplayer.library",0)
  If opbase.l>0
    GetReg a0,MODUL.l
    GetReg a6,opbase.l
    JSR -$5a(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ opbase.l
  EndIf
  Function Return ASM_OUT.l ; 0-normal(4chn), 1-(5-8chn), 2(octamix -64chn)
End Function

Function.l OP_PlayModule8{MODUL.l}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  opbase.l=OpenLibrary_("octaplayer.library",0)
  If opbase.l>0
    GetReg a0,MODUL.l
    GetReg a6,opbase.l
    JSR -$2a(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ opbase.l
  EndIf
  Function Return ASM_OUT.l ;
End Function

Function.l OP_FreePlayer8{}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  opbase.l=OpenLibrary_("octaplayer.library",0)
  If opbase.l>0
    GetReg a6,opbase.l
    JSR -$24(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ opbase.l
  EndIf
  Function Return ASM_OUT.l ;
End Function

Function.l OP_UnLoadModule8{MODUL.l}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  opbase.l=OpenLibrary_("octaplayer.library",0)
  If opbase.l>0
    GetReg a0,MODUL.l
    GetReg a6,opbase.l
    JSR -$42(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ opbase.l
  EndIf
  Function Return ASM_OUT.l ;
End Function

Function.l OP_SetHQ8{HQ}
  SHARED ASM_OUT.l : ASM_OUT.l=-1
  opbase.l=OpenLibrary_("octaplayer.library",0)
  If opbase.l>0
    GetReg d0,HQ
    GetReg a6,opbase.l
    JSR -$54(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ opbase.l
  EndIf
  Function Return ASM_OUT.l ; pointer to the module
End Function


; octamix

Function.l OMX_LoadModule_FastM{NAME$}
  SHARED ASM_OUT.l : ASM_OUT.l=-1
  omxbase.l=OpenLibrary_("octamixplayer.library",0)
  If omxbase.l>0
    GetReg a0,&NAME$
    GetReg a6,omxbase.l
    JSR -$3c(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ omxbase.l
  EndIf
  Function Return ASM_OUT.l ; pointer to the module
End Function

Function.l OMX_GetPlayerM{}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  omxbase.l=OpenLibrary_("octamixplayer.library",0)
  If omxbase.l>0
    GetReg a6,omxbase.l
    JSR -$1e(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ omxbase.l
  EndIf
  Function Return ASM_OUT.l ; 0 - all ok, 0<> - something wrong!
End Function

Function.l OMX_Set14BitMode{NEWMODE}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  omxbase.l=OpenLibrary_("octamixplayer.library",0)
  If omxbase.l>0
    GetReg d0,NEWMODE
    GetReg a6,omxbase.l
    JSR -$5a(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ omxbase.l
  EndIf
  Function Return ASM_OUT.l
End Function

Function.l OMX_SetMixingFrequency{FR.w}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  omxbase.l=OpenLibrary_("octamixplayer.library",0)
  If omxbase.l>0
    GetReg d0,FR.w
    GetReg a6,omxbase.l
    JSR -$60(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ omxbase.l
  EndIf
  Function Return ASM_OUT.l
End Function

Function.l OMX_SetMixBufferSize{BUFF.w}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  omxbase.l=OpenLibrary_("octamixplayer.library",0)
  If omxbase.l>0
    GetReg d0,BUFF.w
    GetReg a6,omxbase.l
    JSR -$66(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ omxbase.l
  EndIf
  Function Return ASM_OUT.l
End Function


Function.l OMX_RequiredPlayRoutineM{MODUL.l}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  omxbase.l=OpenLibrary_("octamixplayer.library",0)
  If omxbase.l>0
    GetReg a0,MODUL.l
    GetReg a6,omxbase.l
    JSR -$54(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ omxbase.l
  EndIf
  Function Return ASM_OUT.l ; 0-normal(4chn), 1-(5-8chn), 2(octamix -64chn)
End Function

Function.l OMX_PlayModuleM{MODUL.l}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  omxbase.l=OpenLibrary_("octamixplayer.library",0)
  If omxbase.l>0
    GetReg a0,MODUL.l
    GetReg a6,omxbase.l
    JSR -$2a(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ omxbase.l
  EndIf
  Function Return ASM_OUT.l ;
End Function

Function.l OMX_FreePlayerM{}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  omxbase.l=OpenLibrary_("octamixplayer.library",0)
  If omxbase.l>0
    GetReg a6,omxbase.l
    JSR -$24(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ omxbase.l
  EndIf
  Function Return ASM_OUT.l ;
End Function

Function.l OMX_UnLoadModuleM{MODUL.l}
  SHARED ASM_OUT.l : ASM_OUT.l=0
  omxbase.l=OpenLibrary_("octamixplayer.library",0)
  If omxbase.l>0
    GetReg a0,MODUL.l
    GetReg a6,omxbase.l
    JSR -$2a(a6)
    PutReg d0,ASM_OUT.l
    CloseLibrary_ omxbase.l
  EndIf
  Function Return ASM_OUT.l ;
End Function

Function.l DBM_StartModule {MODULE_ADR.l,MODULE_LEN.l,AHI_MODEID.l,AHI_FREQ.l,FLAGS.l}

  SHARED dbbase.l,catalog.l,DBM_ERROR.l

  If dbbase.l<=0 Then dbbase.l=OpenLibrary_("dbplayer.library",0)

  If dbbase.l>0
    GetReg a6,dbbase.l
    GetReg a0,MODULE_ADR.l
    GetReg d0,MODULE_LEN.l
    GetReg d1,AHI_MODEID.l
    GetReg d2,AHI_FREQ.l
    GetReg d3,FLAGS.l
    JSR -$1e(a6) ; DBM_StartModule
    PutReg d0,DBM_ERROR.l
  Else
    xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
    xc$=GetCatStr{catalog.l,100000,"Ok!"}
    xb$=GetCatStr{catalog.l,41000,"Nie moge otworzyc biblioteki dbplayer.library"}
    Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
  EndIf

Function Return DBM_ERROR.l
End Function

Function DBM_StopModule {}
  SHARED catalog.l,dbbase.l
;  dbbase.l=OpenLibrary_("dbplayer.library",0)
  If dbbase.l>0
    MOVE.l a6,-(a7) ; save a6 on stack
    GetReg a6,dbbase.l
    JSR -$24(a6) ; DBM_StopModule
    MOVE.l (a7)+,a6
    CloseLibrary_ dbbase.l : dbbase.l=0
    x=AllocMem_ ($07FFFFFFF,#MEMF_ANY)
  Else
    xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
    xc$=GetCatStr{catalog.l,100000,"Ok!"}
    xb$=GetCatStr{catalog.l,41000,"Nie moge otworzyc biblioteki dbplayer.library"}
    Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
  EndIf
End Function

Function DBM_SetVolume {VOL.w}
  SHARED catalog.l,dbbase.l
;  dbbase.l=OpenLibrary_("dbplayer.library",0)
  If dbbase.l>0
    MOVE.l a6,-(a7) ; save a6 on stack
    GetReg a6,dbbase.l
    GetReg d0,VOL.w
    JSR -$30(a6) ; DBM_SetVolume
    MOVE.l (a7)+,a6
;    CloseLibrary_ dbbase.l
  Else
    xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
    xc$=GetCatStr{catalog.l,100000,"Ok!"}
    xb$=GetCatStr{catalog.l,41000,"Nie moge otworzyc biblioteki dbplayer.library"}
    Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
  EndIf
End Function

Function.l pl61_Play {MODULE_ADR.l}
  p61base.l=OpenLibrary_("player61.library",0)
  If p61base.l>0
    MOVE.l a6,-(a7) ; save a6 on stack
    GetReg a6,p61base.l
    GetReg a0,MODULE_ADR.l
    JSR -$1e(a6) ; pl61_Play
    PutReg d0,P61_ERROR.l
    MOVE.l (a7)+,a6
    CloseLibrary_ p61base.l
  Else
    xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
    xc$=GetCatStr{catalog.l,100000,"Ok!"}
    xb$=GetCatStr{catalog.l,42000,"Nie moge otworzyc biblioteki player61.library"}
    Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
  EndIf
Function Return P61_ERROR.l
End Function

Function pl61_Stop {}
  p61base.l=OpenLibrary_("player61.library",0)
  If p61base.l>0
    MOVE.l a6,-(a7) ; save a6 on stack
    GetReg a6,p61base.l
    JSR -$24(a6) ; pl61_Stop
    MOVE.l (a7)+,a6
    CloseLibrary_ p61base.l
  Else
    xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
    xc$=GetCatStr{catalog.l,100000,"Ok!"}
    xb$=GetCatStr{catalog.l,42000,"Nie moge otworzyc biblioteki player61.library"}
    Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
  EndIf
End Function

Function.l pl61_SetVol {VOL.w}
  p61base.l=OpenLibrary_("player61.library",0)
  If p61base.l>0
    MOVE.l a6,-(a7) ; save a6 on stack
    GetReg a6,p61base.l
    GetReg a0,VOL.w
    JSR -$1e(a6) ; pl61_SetVol
    MOVE.l (a7)+,a6
    CloseLibrary_ p61base.l
  Else
    xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
    xc$=GetCatStr{catalog.l,100000,"Ok!"}
    xb$=GetCatStr{catalog.l,42000,"Nie moge otworzyc biblioteki player61.library"}
    Request xa$,xb$,xc$ : xa$="" : xb$="" : xc$=""
  EndIf
End Function


._GADGETS

Function.w CheckGadget{}
  SHARED LOADED_GADGET_START.l(),GADGET_FRAMES(),GADGET_START.l(),GADGET_LENGTH.l()
  SHARED ARTICLE_TITLE$(),ARTICLE_SHORT$()
  SHARED OLD_STREFA.w,OLD_SHORT.w,NEW_SHORT.w
  SHARED PRE_SCALE
  SHARED GADGET_FILE$()
  SHARED SCX,SCY
  SHARED MODULE_PLAYING
  SHARED PRE_SHORT_X,PRE_SHORT_Y,PRE_SHORT_W,PRE_SHORT_H,PRE_PEN_SHORT
  SHARED PRE_PEN_MENU,PRE_PEN_MENU_INV,PRE_PEN_LINK_INV

  SHARED PRE_TRUE_COLOR,CX_SRCX.w,CX_SRCY.w,CX_SRCMOD.l,cgxbase.l

  SHARED LINK_TITLE$(),LINK_SHORT$(),STREFA_LINK(),LINK_COLOR(),LINK_FONT()
  SHARED AKTYWNY_FONT,AKTYWNY_KOLOR,AKTYWNY_JAM
  SHARED WPOINT.b
  SHARED PRE_R(),PRE_G(),PRE_B(),AD_SCREEN
  SHARED PRE_OPEN_ON_WB

  GADGET.w=-1

  STREFA.w=Zone(WMouseX,WMouseY)

  If PRE_OPEN_ON_WB=1
    vp_ad.l=RastPort(#AD_WINDOW)
    *win_aktywny.Window=ActiveWindow
    vp_ak.l=*win_aktywny.Window\RPort
  Else
    vp_ad.l=ViewPort(AD_SCREEN)
    *scr_aktywny.Screen=ActiveScreen
    vp_ak.l=*scr_aktywny.Screen\_ViewPort
  EndIf

  If vp_ad.l<>vp_ak.l Then STREFA.w=-1

    If OLD_STREFA.w<>STREFA.w
      If OLD_STREFA.w=>#MENU_ZONES

        WLocate GetZoneX1(OLD_STREFA.w),GetZoneY1(OLD_STREFA.w)
        WindowFont LINK_FONT(OLD_STREFA.w-#MENU_ZONES)

        WColour_{LINK_COLOR(OLD_STREFA.w-#MENU_ZONES)}
        WJam 0

        NPrint LINK_TITLE$(OLD_STREFA.w-#MENU_ZONES)
        WindowFont AKTYWNY_FONT
        WColour_{AKTYWNY_KOLOR}
      EndIf
      OLD_STREFA.w=STREFA.w
    EndIf

  If STREFA.w=-1
    If WPOINT.b<>1 Then WPointer 1 : WPOINT.b=1
  Else
    If WPOINT.b<>2 Then WPointer 2 : WPOINT.b=2
  EndIf

; ---------------------------------------------------------------- ARTYKULY W MENU -
  If STREFA.w=>#MENU_ZONES


    LNK=STREFA_LINK(STREFA.w-#MENU_ZONES)

    WLocate GetZoneX1(STREFA.w),GetZoneY1(STREFA.w)
    WJam 0

    WColour_{PRE_PEN_LINK_INV}

    NPrint LINK_TITLE$(STREFA.w-#MENU_ZONES)

    NEW_SHORT.w=STREFA.w-#MENU_ZONES
    Short{LINK_SHORT$(STREFA.w-#MENU_ZONES)}
    OLD_SHORT.w=STREFA.w-#MENU_ZONES

; short


    OLD_STREFA.w=STREFA.w
    If Joyb(0)=1 Then GADGET.w=STREFA.w : WPointer 3 : WPOINT.b=3
  EndIf
; ------------------------------------------------------------------------ GADGETY -

  If STREFA.w=>0 AND STREFA.w<#MENU_ZONES
    If Joyb(0)=1

      WPointer 3 : WPOINT.b=3

;      If MODULE_PLAYING=False Then Sound #SOUND_CLICK,%1111

      If PRE_TRUE_COLOR=1
        GAD.w=STREFA.w+10
      Else
        GAD.w=STREFA.w
      EndIf

      If GAD_ADDR.l>0 Then FreeMem_ GAD_ADDR.l,GAD_LEN.l : GAD_ADDR.l=0 : GAD_LEN.l=0
      GAD_ADDR.l=FileLoad{GADGET_FILE$(GAD.w),"PIC_LOAD",#AD_DATA,GADGET_START.l(GAD.w),GADGET_LENGTH.l(GAD.w)}
      GAD_LEN.l=WORK_DATA.l

      If GAD_ADDR.l>0
        If CheckIFF{GAD_ADDR.l}
          PSZER=IFF_Width{GAD_ADDR.l} : PWYS=IFF_Height{GAD_ADDR.l} : PDEPTH=IFF_Depth{GAD_ADDR.l}
          BitMap #GADGET_BITMAP,PSZER,PWYS,8
          DecodeILBM #GADGET_BITMAP,GAD_ADDR.l
          FreeMem_ GAD_ADDR.l,GAD_LEN.l : GAD_ADDR.l=0 : GAD_LEN.l=0
          GUZIK=1
        EndIf

        If CheckCH{GAD_ADDR.l}
          PSZER=CH_Width{GAD_ADDR.l} : PWYS=CH_Height{GAD_ADDR.l}
          CX_SRCMOD.l=PSZER*3
          GUZIK=1
        EndIf
      EndIf

      ILOSC_KLATEK=GADGET_FRAMES(STREFA.w)

      If GUZIK=1
        For KL=0 To ILOSC_KLATEK-1
          SCX=(PSZER/ILOSC_KLATEK)*KL
          If PRE_TRUE_COLOR<>1
            BMToWin{#GADGET_BITMAP,#AD_WINDOW,GetZoneX1(STREFA.w),GetZoneY1(STREFA.w),(PSZER/ILOSC_KLATEK),PWYS}
          Else
            CX_SRCX.w=SCX : CX_SRCY.w=0
            WPA{GAD_ADDR.l+12,RastPort(#AD_WINDOW),GetZoneX1(STREFA.w),GetZoneY1(STREFA.w),(PSZER/ILOSC_KLATEK),PWYS}
          EndIf


          VWait 1
        Next KL
      EndIf

      WC=1

      Repeat
        ; ---------- WCISNIECIE GADGETU

        If STREFA.w=Zone(WMouseX,WMouseY)
          If WC=0
          If GUZIK=1
            For KL=0 To ILOSC_KLATEK-1
              SCX=(PSZER/ILOSC_KLATEK)*KL
              If PRE_TRUE_COLOR<>1
                BMToWin{#GADGET_BITMAP,#AD_WINDOW,GetZoneX1(STREFA.w),GetZoneY1(STREFA.w),(PSZER/ILOSC_KLATEK),PWYS}
              Else
                CX_SRCX.w=SCX : CX_SRCY.w=0
                WPA{GAD_ADDR.l+12,RastPort(#AD_WINDOW),GetZoneX1(STREFA.w),GetZoneY1(STREFA.w),(PSZER/ILOSC_KLATEK),PWYS}
              EndIf
              VWait 1
            Next KL
            WC=1
          EndIf
          EndIf
        EndIf


        If STREFA.w<>Zone(WMouseX,WMouseY)
          If WC=1
          If GUZIK=1
            For KL=ILOSC_KLATEK-1 To 0 Step -1
              SCX=(PSZER/ILOSC_KLATEK)*KL
              If PRE_TRUE_COLOR<>1
                BMToWin{#GADGET_BITMAP,#AD_WINDOW,GetZoneX1(STREFA.w),GetZoneY1(STREFA.w),(PSZER/ILOSC_KLATEK),PWYS}
              Else
                CX_SRCX.w=SCX : CX_SRCY.w=0
                WPA{GAD_ADDR.l+12,RastPort(#AD_WINDOW),GetZoneX1(STREFA.w),GetZoneY1(STREFA.w),(PSZER/ILOSC_KLATEK),PWYS}
              EndIf
              VWait 1
            Next KL
            WC=0
          EndIf
          EndIf
        EndIf

        VWait
      Until Joyb(0)=0

      If STREFA.w=Zone(WMouseX,WMouseY) Then GADGET.w=STREFA.w

      ; ---------- WYCISNIECIE GADGETU


      If GUZIK=1
        If WC=1
        For KL=ILOSC_KLATEK-1 To 0 Step -1
          SCX=(PSZER/ILOSC_KLATEK)*KL
          If PRE_TRUE_COLOR<>1
            BMToWin{#GADGET_BITMAP,#AD_WINDOW,GetZoneX1(STREFA.w),GetZoneY1(STREFA.w),(PSZER/ILOSC_KLATEK),PWYS}
          Else
            CX_SRCX.w=SCX : CX_SRCY.w=0
            WPA{GAD_ADDR.l+12,RastPort(#AD_WINDOW),GetZoneX1(STREFA.w),GetZoneY1(STREFA.w),(PSZER/ILOSC_KLATEK),PWYS}
          EndIf
          VWait 1
        Next KL
        EndIf


        Free BitMap #GADGET_BITMAP
        If GAD_ADDR.l>0 Then FreeMem_ GAD_ADDR.l,GAD_LEN.l : GAD_ADDR.l=0 : GAD_LEN.l=0

      EndIf

;      If MODULE_PLAYING=False Then Sound #SOUND_UNCLICK,%1111

    EndIf
  EndIf


Function Return GADGET.w
End Function

._TEXT

Statement UstawSzpalty {ILOSC_SZPALT}
  SHARED SZPALTA_X(),SZPALTA_Y(),SZPALTA_W(),SZPALTA_H(),PRE_SCALE

  If ILOSC_SZPALT=2
    SZPALTA_X(0)=024 : SZPALTA_Y(0)=14 : SZPALTA_W(0)=285 : SZPALTA_H(0)=191
    SZPALTA_X(1)=331   : SZPALTA_Y(1)=14 : SZPALTA_W(1)=285 : SZPALTA_H(1)=191
  EndIf

  If ILOSC_SZPALT=3
    SZPALTA_X(0)=015 : SZPALTA_Y(0)=019 : SZPALTA_W(0)=296 : SZPALTA_H(0)=107
    SZPALTA_X(1)=111 : SZPALTA_Y(1)=123 : SZPALTA_W(1)=200 : SZPALTA_H(1)=060
    SZPALTA_X(2)=328 : SZPALTA_Y(2)=019 : SZPALTA_W(2)=296 : SZPALTA_H(2)=164
  EndIf


  If PRE_SCALE=1
    For I=0 To 10
      SZPALTA_Y(I)=SZPALTA_Y(I)*2
      SZPALTA_H(I)=SZPALTA_H(I)*2
    Next I
  EndIf

End Statement

Statement Strona{STRONA,POS.l,LGH.l}
  SHARED PRE_SCALE,AKTYWNY_FONT,AKTYWNY_KOLOR,AKTYWNY_JAM,PRE_PAGE_X,PRE_PAGE_Y,PRE_PAGE_W,PRE_PAGE_H,PRE_PEN_PAGE
  SHARED PRE_TRUE_COLOR,CX_SRCX.w,CX_SRCY.w,CX_SRCMOD.l,cgxbase.l
  SHARED AD_SCREEN,PRE_R(),PRE_G(),PRE_B()

  PAH=PRE_PAGE_H : PAY=PRE_PAGE_Y : If PRE_SCALE=1 Then PAY=PAY*2 : PAH=PAH*2

  If PRE_TRUE_COLOR
    chlen.l=PRE_PAGE_W*PAH*3
    chbox.l=AllocMem_ (chlen.l,#MEMF_ANY|#MEMF_CLEAR)
    CX_SRCX.w=0 : CX_SRCY.w=0 : CX_SRCMOD.l=PRE_PAGE_W*3
    WPA{chbox.l,RastPort(#AD_WINDOW),PRE_PAGE_X,PAY,PRE_PAGE_W,PAH}
    FreeMem_ chbox.l,chlen.l
  Else
    WBox PRE_PAGE_X,PAY,PRE_PAGE_X+PRE_PAGE_W,PAY+PAH,32
  EndIf

  X=WCursX : Y=WCursY
  WJam 0

  WColour_{PRE_PEN_PAGE}

  WindowFont #STRONA_FONT
  STY=PRE_PAGE_Y : If PRE_SCALE=1 Then STY=STY*2
  WLocate PRE_PAGE_X,STY
  PRC.l=POS.l*100 : P.b=PRC.l/LGH.l
  Print STRONA,"(",P.b,"%)"
  WLocate X,Y
  WindowFont AKTYWNY_FONT
  WColour_{AKTYWNY_KOLOR}
  WJam AKTYWNY_JAM

End Statement

._MATH_STRING

Function.l Potega{PODSTAWA.l,WYKL.l}
  If WYKL.l<>0
    WYNIK.l=PODSTAWA.l
    If WYKL.l<>1
      For i=1 To WYKL.l-1
        WYNIK.l=(WYNIK.l*PODSTAWA.l)
      Next
    EndIf
  Else
    WYNIK.l=1
  EndIf
Function Return WYNIK.l
End Function

Function.l ValLong_{l$}
VALSTART:
  For p=0 To Len(l$)
    znak.b=Peek.b(&l$+p+deltap)
    If (p=0) AND (znak=$24) Then HEXMODE=1 : l$=Right$(l$,Len(l$)-1) : Goto VALSTART
    If HEXMODE=0
      If (znak<48) OR (znak>57) Then l$=Left$(l$,p)
    Else
      If (znak<48) OR (znak>70) OR ((znak>57)AND(znak<65)) Then l$=Left$(l$,p+deltap)
    EndIf
  Next p
  dl=Len(l$)
  If HEXMODE=0
    For pos=1 To dl
      a$=Mid$(l$,pos,1)
      k.b=Peek.b(&a$)
      If (k.b=>48) AND (k.b<=57) Then x.b=k.b-48
      ilezer.l=Potega{10,(dl-pos)}
      dodac.l=x.b*ilezer.l
      out.l=out.l+dodac.l
    Next pos
  Else
    For pos=1 To dl
      a$=Mid$(l$,pos,1)
      k.b=Peek.b(&a$)
      If (k.b=>48) AND (k.b<=57) Then x.b=k.b-48
      If (k.b=>65) AND (k.b<=70) Then x.b=(k.b-65)+10
      ilezer.l=Potega{16,(dl-pos)}
      dodac.l=x.b*ilezer.l
      out.l=out.l+dodac.l
    Next pos
  EndIf

  Function Return out.l
End Function

Function.l rtFontRequestA{TITLE$,NAZWA$,WYSOKOSC}
  SHARED rtFR_Name$,rtFR_Size.w

  DEFTYPE .rtFontRequester *fontreq
  *fontreq=rtAllocRequestA_(#RT_FONTREQ,0)
  If *fontreq>0
    AddTag {0,#RTFO_Flags,#FREQF_FIXEDWIDTH}

    Poke.w *fontreq+20,WYSOKOSC
    Poke.s *fontreq+92,NAZWA$+Chr$(0)

    SEL.b=rtFontRequestA_(*fontreq,TITLE$,Bank(#TAGLIST_BANK))
    If SEL.b=1
      rtFR_Name$=PeekTo$(*fontreq+92,0) : rtFR_Size.w=Peek.w (*fontreq+20)
    Else
      rtFR_Name$="" : rtFR_Size.w=0
    EndIf
    rtFreeRequest_ *fontreq
  Else
    Request "AD","Can't create requester!","heh..."
    wzr.l=0
  EndIf
Function Return SEL.b
End Function

._END_FUNKCJE

.


; -=-=-=-=-=-=-=-=-=-=-=

ANTY_DRESIARZ_START_HERE:

WbToScreen 0
Use Screen 0

  CHANGE_POINTER=False
  PATTERNED=-1 : CHANNELS_ALLOCATED=False
  PRE_SMART_REFRESH=0
  cgxbase.l=OpenLibrary_("cybergraphics.library",0)

Gosub INIT_SCREEN
Gosub INIT_MODULE
Gosub DEMO
CHANGE_POINTER=True
Gosub INIT_PANEL
Gosub INIT_GADLIST

Gosub LINK_FILE
Gosub LOAD_HISTORY



.POCZATEK

Gosub SET_FONTS_PALETTE
Gosub MENU

  Repeat
    GADG.w=CheckGadget{}

    Gosub CZAS
    VWait
  Until GADG.w=0


Gosub DEINIT


End

.

.____INIT____
.
.INIT_SCREEN   ; --- otwiera locale,ekran i okna --- WCZYTAJ_PREFS, START_DATA, LOAD_FONT

  If AvailMem_(#MEMF_FAST)=0 Then ONLYCHIP_MODE=True

  Gosub OPEN_ADPORT

  DEFTYPE.l catalog,katstr,locale
  ;locale.l=OpenLocale_ ("ENVARC:Sys/locale.prefs")
  catalog.l=OpenCatalogA_ (0,"AntyDresiarz.catalog",0)

  Gosub HARD_CONFIG

  FOpen_ {#AD_DATA,"DATA_FILE",#MODE_READWRITE}

  If PREFS_HARDCHANGE<>1 Then Gosub WCZYTAJ_PREFS

  MakeDir GLOWNY_TEMP_DIR$+"AD_TMP" : TEMP_DIR$=GLOWNY_TEMP_DIR$+"AD_TMP/"

  ZoneInit 0,#MENU_ZONES

  Gosub START_DATA

  If PRE_OPEN_ON_WB=0

    AD_SCREEN=0

    If PRE_TRUE_COLOR=1
      PDARK=FindColor{PRE_R(PRE_PEN_DARK),PRE_G(PRE_PEN_DARK),PRE_B(PRE_PEN_DARK)}
      PBRIGHT=FindColor{PRE_R(PRE_PEN_BRIGHT),PRE_G(PRE_PEN_BRIGHT),PRE_B(PRE_PEN_BRIGHT)}
      PTEXT=FindColor{PRE_R(PRE_PEN_TEXT),PRE_G(PRE_PEN_TEXT),PRE_B(PRE_PEN_TEXT)}
      PSEL=FindColor{PRE_R(PRE_PEN_SELECTED),PRE_G(PRE_PEN_SELECTED),PRE_B(PRE_PEN_SELECTED)}
      PFIL=FindColor{PRE_R(PRE_PEN_FILLPEN),PRE_G(PRE_PEN_FILLPEN),PRE_B(PRE_PEN_FILLPEN)}
      PBACK=FindColor{PRE_R(PRE_PEN_BACKGROUND),PRE_G(PRE_PEN_BACKGROUND),PRE_B(PRE_PEN_BACKGROUND)}
      PHIGH=FindColor{PRE_R(2),PRE_G(2),PRE_B(2)}
    Else
      PTEXT=PRE_PEN_TEXT     ; 1 Text on background
      PBRIGHT=PRE_PEN_BRIGHT   ; 2 Bright edge on 3d objects
      PDARK=PRE_PEN_DARK     ; 1 Dark edge on 3d objects
      PSEL=PRE_PEN_SELECTED ; 3 activew window/select gadgetfill
      PFIL=PRE_PEN_FILLPEN  ; 1 text over FILLPEN (filltextpen)
      PBACK=PRE_PEN_BACKGROUND    ; 0 Backgroundpen
      PHIGH=2  ; 2 Special colour text
    EndIf

    AD_SCREEN=1

    SCR_HEIGHT=256
    SCR_DEPTH=8
    If PRE_TRUE_COLOR=1 Then SCR_DEPTH=24
    If PRE_SCALE=1 Then SCR_HEIGHT=512

    NEWTYPE .pens : a.w : b.w : c.w : d.w : e.w : f.w : g.w : h.w : i.w : j.w : k.w : l.w : m.w : n.w : End NEWTYPE
    pp.pens\c=PTEXT     ; 1 Text on background
    pp.pens\d=PBRIGHT   ; 2 Bright edge on 3d objects
    pp.pens\e=PDARK     ; 1 Dark edge on 3d objects
    pp.pens\f=PSEL      ; 3 activew window/select gadgetfill
    pp.pens\g=PFIL      ; 1 text over FILLPEN (filltextpen)
    pp.pens\h=PBACK     ; 0 Backgroundpen
    pp.pens\i=PHIGH  ; 2 Special colour text
    pp.pens\j=1  ; 1 Text/deail in screen-bar/menus
    pp.pens\k=2  ; 2 Screenbar/menusfill
    pp.pens\l=1  ; 1 Trim under screenbar
    pp.pens\m=12 ;12 Number of pens
    pp.pens\n=1  ; 1 Do I need it?

    AddTag{0,#SA_Width     ,640}
    AddTag{1,#SA_Height    ,SCR_HEIGHT}
    AddTag{2,#SA_Depth     ,SCR_DEPTH}
    AddTag{3,#SA_Title     ,"Antydresiarz. (C) by Taski 1998"}
    AddTag{4,#SA_DisplayID ,PRE_MODE_ID.l}
    AddTag{5,#SA_ShowTitle ,0}
    AddTag{6,#SA_Pens,&pp}

    SetErr
      xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
      xc$=GetCatStr{catalog.l,100010,"Ponow probe|Wyjdz z AntyDresiarza"}
      xb$=GetCatStr{catalog.l,20000,"Nie moge otworzyc ekranu!"}
      If Request(xa$,xb$,xc$)=0 Then Gosub DEINIT : End
      xa$="" : xb$="" : xc$=""
    End SetErr

    ScreenTags AD_SCREEN,"Antydresiarz Issue #4",Bank(#TAGLIST_BANK)
    ErrFail : ClrErr

    If PRE_TRUE_COLOR<>1
      InitPalette 1,256
      AGAPalRGB 1,1,000,000,000
      AGAPalRGB 1,2,255,255,255
      AGAPalRGB 1,3,000,000,255
    EndIf
    UsePalette{1}

    AddTag{0,#WA_Width,          640}
    AddTag{1,#WA_Height,         SCR_HEIGHT}
    AddTag{2,#WA_IDCMP,          #IDCMP_MOUSEMOVE|#IDCMP_INTUITICKS}
    AddTag{3,#WA_Flags,          0}
    AddTag{4,#WA_Title,          "Antydresiarz Issue 4. (C) by Taski 1997."}
    AddTag{5,#WA_ScreenTitle,    "AntyDresiarz Issue 4."}
    AddTag{6,#WA_WindowName,     "AntyDresiarz Main Window"}
    AddTag{7,#WA_DragBar,        0} ; change prefs
    AddTag{8,#WA_DepthGadget,    0} ; change prefs
    AddTag{9,#WA_CloseGadget,    0} ; change prefs
    AddTag{10,#WA_Backdrop,      1} ; change prefs
    AddTag{11,#WA_Borderless,    1} ; change prefs
    AddTag{12,#WA_Activate,      1}
    AddTag{13,#WA_RMBTrap,       1}
    AddTag{14,#WA_GimmeZeroZero, 1}
    AddTag{15,#WA_Left,          0}
    AddTag{16,#WA_Top,           0}

    SetErr
      xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
      xc$=GetCatStr{catalog.l,100010,"Ponow probe|Wyjdz z AntyDresiarza"}
      xb$=GetCatStr{catalog.l,20001,"Nie moge otworzyc okna!"}
      If Request(xa$,xb$,xc$)=0 Then Gosub DEINIT : End
      xa$="" : xb$="" : xc$=""
    End SetErr
    WindowTags #AD_WINDOW,0,"",Bank(#TAGLIST_BANK)
    ErrFail : ClrErr

    AD_BITPLANY=SCR_DEPTH
  Else

    AD_SCREEN=0

    If PRE_SCALE=1
      INNER_HEIGHT=#AD_HEIGHT*2
    Else
      INNER_HEIGHT=#AD_HEIGHT
    EndIf

    AddTag{0,#WA_InnerWidth,     640}
    AddTag{1,#WA_InnerHeight,    INNER_HEIGHT}
    AddTag{2,#WA_IDCMP,          #IDCMP_MOUSEMOVE|#IDCMP_INTUITICKS}
    AddTag{3,#WA_Flags,          #WA_GimmeZeroZero}
    AddTag{4,#WA_Title,          "Antydresiarz Issue 4. (C) by Taski 1997."}
    AddTag{5,#WA_ScreenTitle,    "AntyDresiarz Issue 4."}
    AddTag{6,#WA_WindowName,     "AntyDresiarz Main Window"}
    AddTag{7,#WA_DragBar,        1} ; change prefs
    AddTag{8,#WA_DepthGadget,    1} ; change prefs
    AddTag{9,#WA_CloseGadget,    0} ; change prefs
    AddTag{10,#WA_Backdrop,      0} ; change prefs
    AddTag{11,#WA_Borderless,    0} ; change prefs
    AddTag{12,#WA_Activate,      1}
    AddTag{13,#WA_RMBTrap,       1}
    AddTag{14,#WA_GimmeZeroZero, 1}

    WT$="AntyDresiarz Issue #4 Workbench Emulator"
    If PRE_TRUE_COLOR=1 Then WT$=WT$+" in TrueColor Mode"
    WindowTags #AD_WINDOW,0,WT$,Bank(#TAGLIST_BANK)
    WTitle WT$,"AntyDresiarz by Taski. (C) by Taski 1998."
    WT$=""
    AD_BITPLANY=WBDepth

  EndIf

  If PRE_TRUE_COLOR=1
    KOL=FindColor{PRE_R(0),PRE_G(0),PRE_B(0)}
  Else
    KOL=0
  EndIf
  WCls KOL


  Gosub LOAD_FONT : WindowFont 0

  CludgeShapes 1,4,?_POINTER
  WPointer 1 : WPOINT.b=1

  offl=WBorLeft{AD_SCREEN}
  offr=WBorRight{AD_SCEEN}
  offb=WBorTop{AD_SCREEN}
  offy=WBorAbove{AD_SCREEN} ; bez fontu
  offd=WBorBottom{AD_SCREEN}
Return

.INIT_MODULE
  DEMO_MODULE=-1
  MODULE_PLAYING=True
  MUSIC_GLOSNOSC=64
  MUSIC_WYBRANY_MODUL=-1

  ClearList GT_LISTA_MODULOW()

  m=1
  Repeat
      NAZWA$=MODULE_NAME$(m)
      If NAZWA$<>""
        AddItem GT_LISTA_MODULOW() : GT_LISTA_MODULOW()\name=MODULE_NAME$(m)
        If UCase$(MODULE_NAME$(m))=UCase$(PRE_DEMO_MODULE$) Then DEMO_MODULE=m
      EndIf
    m=m+1
  Until MODULE_NAME$(m)=""
  AddItem GT_LISTA_MODULOW() : GT_LISTA_MODULOW()\name="Wybierz z dysku..."

  GT_ILOSC_MODULOW=m-1

Return

.INIT_GADLIST

  GTGimmeCludge On

If PRE_SCALE=0

; - PREFERENCJE
  GTCheckBox  #AD_GT_PREFS,00,7,3,26,11,"Otwierac AD na ekranie Workbencha?",#PLACETEXT_RIGHT
  GTCheckBox  #AD_GT_PREFS,01,7,15,26,11,"Powiekszac czcionki i obrazki w pionie?",#PLACETEXT_RIGHT
  GTButton    #AD_GT_PREFS,02,7,78,243,14,"Zmiana kolorow czcionek",#PLACETEXT_IN
  GTButton    #AD_GT_PREFS,03,7,93,344,14,"Zmiana trybu wyswietlania ekranu",#PLACETEXT_IN
  GTButton    #AD_GT_PREFS,04,7,108,344,14,"Preferencje dzwieku",#PLACETEXT_IN
  GTButton    #AD_GT_PREFS,05,7,155,100,14,"Zapisz",#PLACETEXT_IN
  GTButton    #AD_GT_PREFS,06,130,155,100,14,"Uzyj",#PLACETEXT_IN
  GTButton    #AD_GT_PREFS,07,251,155,100,14,"Poniechaj",#PLACETEXT_IN
  GTButton    #AD_GT_PREFS,8,250,78,101,14,"Standartowa",#PLACETEXT_IN
  GTCycle     #AD_GT_PREFS,9,7,138,324,14,"",0,"Czionka w artykulach|Czcionka tytulowa|"
  GTButton    #AD_GT_PREFS,10,331,138,20,14,"/\",0
  GTButton    #AD_GT_PREFS,11,7,123,344,14,"Preferencje klawiatury",#PLACETEXT_IN
  GTCheckBox  #AD_GT_PREFS,12,7,39,26,11,"Grayscale?",#PLACETEXT_RIGHT
  GTCheckBox  #AD_GT_PREFS,13,7,51,26,11,"Sprytne odswiezanie grafiki?",#PLACETEXT_RIGHT
  GTString    #AD_GT_PREFS,14,135,63,196,14,"Katalog wymiany",#PLACETEXT_LEFT,256,""
  GTButton    #AD_GT_PREFS,15,331,63,20,14,"/\",0
  GTCheckBox  #AD_GT_PREFS,16,7,27,26,11,"TrueColor na kartach CyberGraphX?",#PLACETEXT_RIGHT
; - MUSIC MENU
  GTTags      #GTLV_ShowSelected,0
  GTListView  #AD_GT_MUSIC,20,10,15,282,72,"Wybierz modul",#PLACETEXT_ABOVE,GT_LISTA_MODULOW(),DEMO_MODULE-1
  f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
  GTSlider    #AD_GT_MUSIC,21,83,84,186,12,"Glosnosc",$80|#PLACETEXT_LEFT,1,64,64
  GTButton    #AD_GT_MUSIC,22,11,109,283,12,"Zamknij okno",#PLACETEXT_IN
  GTCheckBox  #AD_GT_MUSIC,23,267,97,26,11,"Filtr",#PLACETEXT_LEFT
  GTCheckBox  #AD_GT_MUSIC,24,124,97,26,11,"Wylacz muzyke",#PLACETEXT_LEFT
; - KEYS MENU
  GTButton    #AD_GT_KEYS,30,9,4,158,14,"Nastepna strona",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,31,169,4,174,14,"",0,""
  GTButton    #AD_GT_KEYS,32,9,19,158,14,"Poprzednia strona",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,33,169,19,174,14,"",0,""
  GTButton    #AD_GT_KEYS,34,9,34,158,14,"Nastepny artykul",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,35,169,34,174,14,"",0,""
  GTButton    #AD_GT_KEYS,36,9,49,158,14,"Poprzedni artykul",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,37,169,49,174,14,"",0,""
  GTButton    #AD_GT_KEYS,38,9,64,158,14,"Przejdz do menu",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,39,169,64,174,14,"",0,""
  GTButton    #AD_GT_KEYS,40,9,79,158,14,"Preferencje muzyki",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,41,169,79,174,14,"",0,""
  GTButton    #AD_GT_KEYS,42,9,94,158,14,"Preferencje",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,43,169,94,174,14,"",0,""
  GTButton    #AD_GT_KEYS,44,9,109,158,14,"Wyjscie do AmigaOS",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,45,169,109,174,14,"",0,""
  GTButton    #AD_GT_KEYS,46,9,124,334,14,"Uzyj",#PLACETEXT_IN
; - PALETTE
  f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
  GTSlider    #AD_GT_PALETTE,50,24,17,235,12,"R",$80|#PLACETEXT_LEFT,0,255
  f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
  GTSlider    #AD_GT_PALETTE,51,24,30,235,12,"G",$80|#PLACETEXT_LEFT,0,255
  f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
  GTSlider    #AD_GT_PALETTE,52,24,43,235,12,"B",$80|#PLACETEXT_LEFT,0,255
  f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
  GTSlider    #AD_GT_PALETTE,53,72,5,187,11,"Kolor: ",#PLACETEXT_LEFT,0,23
  f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
  GTButton    #AD_GT_PALETTE,54,8,73,139,12,"Uzyj",#PLACETEXT_IN
  GTButton    #AD_GT_PALETTE,55,152,73,139,12,"Poniechaj",#PLACETEXT_IN
; - MUSIC PREFS
  GTButton    #AD_GT_PREFS_MUSIC,60,008,12,318,15,"Zmien tryb i czestotliwosc AHI",#PLACETEXT_IN
  GTCheckBox  #AD_GT_PREFS_MUSIC,61,175,50,26,11,"Tryb wyzszej jakosci",#PLACETEXT_LEFT
  GTCheckBox  #AD_GT_PREFS_MUSIC,62,184,84,26,11,"Mixowanie w 14 bitach",#PLACETEXT_LEFT
  ff$="%2ld0Hz" : GTTags #GTSL_LevelFormat,&ff$,#GTSL_MaxLevelLen,8,#GTSL_LevelPlace,2
  GTSlider    #AD_GT_PREFS_MUSIC,63,120,72,144,11,"Czestotliwosc",#PLACETEXT_LEFT,100,6553
  GTButton    #AD_GT_PREFS_MUSIC,64,008,100,318,15,"Ok",#PLACETEXT_IN
  GTCheckBox  #AD_GT_PREFS_MUSIC,65,224,28,26,11,"Automatyczne podglasnianie",#PLACETEXT_LEFT
Else

; - PREFERENCJE
  GTCheckBox  #AD_GT_PREFS,00,7,3*2,26,11*2,"Otwierac AD na ekranie Workbencha?",#PLACETEXT_RIGHT
  GTCheckBox  #AD_GT_PREFS,01,7,15*2,26,11*2,"Powiekszac czcionki i obrazki w pionie?",#PLACETEXT_RIGHT
  GTButton    #AD_GT_PREFS,02,7,78*2,243,14*2,"Zmiana kolorow czcionek",#PLACETEXT_IN
  GTButton    #AD_GT_PREFS,03,7,93*2,344,14*2,"Zmiana trybu wyswietlania ekranu",#PLACETEXT_IN
  GTButton    #AD_GT_PREFS,04,7,108*2,344,14*2,"Preferencje dzwieku",#PLACETEXT_IN
  GTButton    #AD_GT_PREFS,05,7,155*2,100,14*2,"Zapisz",#PLACETEXT_IN
  GTButton    #AD_GT_PREFS,06,130,155*2,100,14*2,"Uzyj",#PLACETEXT_IN
  GTButton    #AD_GT_PREFS,07,251,155*2,100,14*2,"Poniechaj",#PLACETEXT_IN
  GTButton    #AD_GT_PREFS,8,250,78*2,101,14*2,"Standartowa",#PLACETEXT_IN
  GTCycle     #AD_GT_PREFS,9,7,138*2,324,14*2,"",0,"Czionka w artykulach|Czcionka tytulowa|"
  GTButton    #AD_GT_PREFS,10,331,138*2,20,14*2,"/\",0
  GTButton    #AD_GT_PREFS,11,7,123*2,344,14*2,"Preferencje klawiatury",#PLACETEXT_IN
  GTCheckBox  #AD_GT_PREFS,12,7,39*2,26,11*2,"Grayscale?",#PLACETEXT_RIGHT
  GTCheckBox  #AD_GT_PREFS,13,7,51*2,26,11*2,"Sprytne odswiezanie grafiki?",#PLACETEXT_RIGHT
  GTString    #AD_GT_PREFS,14,135,63*2,196,14*2,"Katalog wymiany",#PLACETEXT_LEFT,256,""
  GTButton    #AD_GT_PREFS,15,331,63*2,20,14*2,"/\",0
  GTCheckBox  #AD_GT_PREFS,16,7,27*2,26,11*2,"TrueColor na kartach CyberGraphX?",#PLACETEXT_RIGHT
; - MUSIC MENU
  GTTags      #GTLV_ShowSelected,0
  GTListView  #AD_GT_MUSIC,20,10,15*2,282,72*2,"Wybierz modul",#PLACETEXT_ABOVE,GT_LISTA_MODULOW(),DEMO_MODULE-1
  f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
  GTSlider    #AD_GT_MUSIC,21,83,84*2,186,12*2,"Glosnosc",$80|#PLACETEXT_LEFT,1,64,64
  GTButton    #AD_GT_MUSIC,22,11,109*2,283,12*2,"Zamknij okno",#PLACETEXT_IN
  GTCheckBox  #AD_GT_MUSIC,23,267,97*2,26,11*2,"Filtr",#PLACETEXT_LEFT
  GTCheckBox  #AD_GT_MUSIC,24,124,97*2,26,11*2,"Wylacz muzyke",#PLACETEXT_LEFT
; - KEYS MENU
  GTButton    #AD_GT_KEYS,30,9,4*2,158,14*2,"Nastepna strona",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,31,169,4*2,174,14*2,"",0,""
  GTButton    #AD_GT_KEYS,32,9,19*2,158,14*2,"Poprzednia strona",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,33,169,19*2,174,14*2,"",0,""
  GTButton    #AD_GT_KEYS,34,9,34*2,158,14*2,"Nastepny artykul",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,35,169,34*2,174,14*2,"",0,""
  GTButton    #AD_GT_KEYS,36,9,49*2,158,14*2,"Poprzedni artykul",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,37,169,49*2,174,14*2,"",0,""
  GTButton    #AD_GT_KEYS,38,9,64*2,158,14*2,"Przejdz do menu",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,39,169,64*2,174,14*2,"",0,""
  GTButton    #AD_GT_KEYS,40,9,79*2,158,14*2,"Preferencje muzyki",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,41,169,79*2,174,14*2,"",0,""
  GTButton    #AD_GT_KEYS,42,9,94*2,158,14*2,"Preferencje",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,43,169,94*2,174,14*2,"",0,""
  GTButton    #AD_GT_KEYS,44,9,109*2,158,14*2,"Wyjscie do AmigaOS",#PLACETEXT_IN
  GTText      #AD_GT_KEYS,45,169,109*2,174,14*2,"",0,""
  GTButton    #AD_GT_KEYS,46,9,124*2,334,14*2,"Uzyj",#PLACETEXT_IN
; - PALETTE
  f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
  GTSlider    #AD_GT_PALETTE,50,24,17*2,235,12*2,"R",$80|#PLACETEXT_LEFT,0,255
  f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
  GTSlider    #AD_GT_PALETTE,51,24,30*2,235,12*2,"G",$80|#PLACETEXT_LEFT,0,255
  f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
  GTSlider    #AD_GT_PALETTE,52,24,43*2,235,12*2,"B",$80|#PLACETEXT_LEFT,0,255
  f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
  GTSlider    #AD_GT_PALETTE,53,72,5*2,187,11*2,"Kolor: ",#PLACETEXT_LEFT,0,23
  f$="%2ld" : GTTags #GTSL_LevelFormat,&f$,#GTSL_MaxLevelLen,3,#GTSL_LevelPlace,2
  GTButton    #AD_GT_PALETTE,54,8,73*2,139,12*2,"Uzyj",#PLACETEXT_IN
  GTButton    #AD_GT_PALETTE,55,152,73*2,139,12*2,"Poniechaj",#PLACETEXT_IN
; - MUSIC PREFS
  GTButton    #AD_GT_PREFS_MUSIC,60,008,12*2,318,15*2,"Zmien tryb i czestotliwosc AHI",#PLACETEXT_IN
  GTCheckBox  #AD_GT_PREFS_MUSIC,61,175,50*2,26,11*2,"Tryb wyzszej jakosci",#PLACETEXT_LEFT
  GTCheckBox  #AD_GT_PREFS_MUSIC,62,184,84*2,26,11*2,"Mixowanie w 14 bitach",#PLACETEXT_LEFT
  ff$="%2ld0Hz" : GTTags #GTSL_LevelFormat,&ff$,#GTSL_MaxLevelLen,8,#GTSL_LevelPlace,2
  GTSlider    #AD_GT_PREFS_MUSIC,63,120,72*2,144,11*2,"Czestotliwosc",#PLACETEXT_LEFT,100,6553
  GTButton    #AD_GT_PREFS_MUSIC,64,008,100*2,318,15*2,"Ok",#PLACETEXT_IN
  GTCheckBox  #AD_GT_PREFS_MUSIC,65,224,28*2,26,11*2,"Automatyczne podglasnianie",#PLACETEXT_LEFT


EndIf

Return


.OPEN_ADPORT
  adport.l=FindPort_("AntyDresiarz_PORT")
  If adport.l=0

    adport.l=CreateMsgPort ("AntyDresiarz_PORT")
  Else
    X$=GetCatStr{catalog.l,100000,"Ok!"}
    Request GetCatStr{catalog.l,110001,"AD Informuje..."},GetCatStr{catalog.l,20200,"Nie mozna odpalic 2 Antydresiarzy!"},X$
    X$=""
    End
  EndIf
Return

.DEMO   ; --- pokazuje poczatkowe obrazki na oknie

  SetTaskPri_ FindTask_(0),#PRI_HIGH

  If ONLYCHIP_MODE=False
    If DEMO_MODULE>0
      MUSIC_WYBRANY_MODUL=DEMO_MODULE
      Gosub MODUL_START
    EndIf
  Else
    If ONLYCHIP_DEMO_MODULE>0
      MUSIC_WYBRANY_MODUL=DEMO_MODULE
      Gosub MODUL_START
    EndIf
  EndIf

  For DMPIC=1 To DEMO_PICS
    PIC=DMPIC
    If PRE_TRUE_COLOR=1 Then PIC=PIC+10

    PIC_ADDR.l=FileLoad{DEMO_FILE$(PIC),"PIC_LOAD",#AD_DATA,DEMO_START.l(PIC),DEMO_LENGTH.l(PIC)} : PIC_LEN.l=WORK_DATA.l

    If CheckIFF {PIC_ADDR.l}
      DEMO_SZEROKOSC=IFF_Width{PIC_ADDR.l} : DEMO_WYSOKOSC=IFF_Height{PIC_ADDR.l} : DEMO_BITPLANY=IFF_Depth{PIC_ADDR.l}
      x=DecodeIFFPalette{#AD_PALETTE,PIC_ADDR.l,False,False,True}
      BitMap 1,DEMO_SZEROKOSC,DEMO_WYSOKOSC,DEMO_BITPLANY
      DecodeILBM 1,PIC_ADDR.l
      If PIC_ADDR.l>0 Then FreeMem_ PIC_ADDR.l,PIC_LEN.l : PIC_ADDR.l=0 : PIC_LEN.l=0
      If PRE_GRAYSCALE=1 Then x=Greyscale{#AD_PALETTE,0,(Potega{2,AD_BITPLANY})-1}
      UsePalette{#AD_PALETTE}
      DrawLineImage{1,#AD_WINDOW,DEMO_SZEROKOSC,DEMO_WYSOKOSC,PRE_SCALE}
      OKRES=Timer : Repeat : VWait 1 : Until Timer>OKRES+300 OR MButtons=1
      ClearLineImage{#AD_WINDOW,DEMO_SZEROKOSC,DEMO_WYSOKOSC,PRE_SCALE,DRAW_COLOUR}
    EndIf

    If CheckCH{PIC_ADDR.l}
      DEMO_SZEROKOSC = CH_Width{PIC_ADDR.l} : DEMO_WYSOKOSC  = CH_Height{PIC_ADDR.l}
      CX_SRCMOD.l=DEMO_SZEROKOSC*3
      ChunkyDrawLineImage{PIC_ADDR.l+12,#AD_WINDOW,DEMO_SZEROKOSC,DEMO_WYSOKOSC,PRE_SCALE}
      OKRES=Timer : Repeat : VWait 1 : Until Timer>OKRES+300 OR MButtons=1
      ClearLineImage{#AD_WINDOW,DEMO_SZEROKOSC,DEMO_WYSOKOSC,PRE_SCALE,DRAW_COLOUR}
      If PIC_ADDR.l>0 Then FreeMem_ PIC_ADDR.l,PIC_LEN.l : PIC_ADDR.l=0 : PIC_LEN.l=0
    EndIf

    If PIC_ADDR.l>0 Then FreeMem_ PIC_ADDR.l,PIC_LEN.l : PIC_ADDR.l=0 : PIC_LEN.l=0
    If PRE_GRAYSCALE=1 Then x=Greyscale{#AD_PALETTE,0,(Potega{2,AD_BITPLANY})-1}
    UsePalette{#AD_PALETTE}


  Next DMPIC

Return



.INIT_PANEL
  If ONLYCHIP_MODE<>True
    PIC=21
  Else
    PIC=41
  EndIf

  If PRE_TRUE_COLOR=1 Then PIC=PIC+10

  PIC_ADDR.l=FileLoad{DEMO_FILE$(PIC),"PIC_LOAD",#AD_DATA,DEMO_START.l(PIC),DEMO_LENGTH.l(PIC)} : PIC_LEN.l=WORK_DATA.l


  If ONLYCHIP_MODE=True
    If Peeks$(PIC_ADDR.l,4)="FORM" AND Peeks$(PIC_ADDR.l+8,4)="ANIM"
      PAN_SZER=IFF_Width{PIC_ADDR.l+12}
      PAN_WYS=IFF_Height{PIC_ADDR.l+12}
      PAN_DEPTH=IFF_Depth{PIC_ADDR.l+12}
      BitMap #ANIM_BITMAP  ,PAN_SZER,PAN_WYS,8
      BitMap #ANIM_BITMAP+1,PAN_SZER,PAN_WYS,8
      ANM=RIAnimInit (PIC_ADDR.l,#ANIM_BITMAP,#ANIM_PALETTE)
      If ANM
        x=CopyPalette{#ANIM_PALETTE,#AD_PALETTE,32,95,32}
        Use Palette #AD_PALETTE
        PAN_FR=RIAnimFrameCount
        BitMaptoWindow #ANIM_BITMAP,#AD_WINDOW,0,0,0,0,PAN_SZER,PAN_WYS
        ANM_DBUFF.b=#ANIM_BITMAP+1
        CopyBitMap #ANIM_BITMAP,#ANIM_BITMAP+1
        For y=1 To PAN_FR
          x=RINextAnimFrame (ANM_DBUFF)
          BitMaptoWindow ANM_DBUFF,#AD_WINDOW,0,0,0,y*PAN_WYS,PAN_SZER,PAN_WYS
          If ANM_DBUFF=#ANIM_BITMAP
            ANM_DBUFF=#ANIM_BITMAP+1
          Else
            ANM_DBUFF=#ANIM_BITMAP
          EndIf
        Next y
      EndIf
      Free BitMap #ANIM_BITMAP : Free BitMap #ANIM_BITMAP+1

    EndIf
    If PIC_ADDR.l>0 Then FreeMem_ PIC_ADDR.l,PIC_LEN.l : PIC_ADDR.l=0 : PIC_LEN.l=0
  EndIf


  If ONLYCHIP_MODE=False
    If CheckIFF {PIC_ADDR.l}
      PANEL_SZEROKOSC = IFF_Width{PIC_ADDR.l}
      PANEL_WYSOKOSC  = IFF_Height{PIC_ADDR.l}
      PANEL_BITPLANY  = IFF_Depth{PIC_ADDR.l}
      x=DecodeIFFPalette{#AD_PALETTE,PIC_ADDR.l,0,95,False}
      If PRE_GRAYSCALE=1 Then x=Greyscale{#AD_PALETTE,32,95}
      UsePalette{#AD_PALETTE}

      BitMap     #PANEL_BITMAP,PANEL_SZEROKOSC,PANEL_WYSOKOSC,PANEL_BITPLANY
      DecodeILBM #PANEL_BITMAP,PIC_ADDR.l
      If PIC_ADDR.l>0 Then FreeMem_ PIC_ADDR.l,PIC_LEN.l : PIC_ADDR.l=0 : PIC_LEN.l=0

      DrawLineImage{#PANEL_BITMAP,#AD_WINDOW,PANEL_SZEROKOSC,PANEL_WYSOKOSC,PRE_SCALE}
      Free BitMap (#PANEL_BITMAP)
    EndIf
  EndIf

  If CheckCH{PIC_ADDR.l}
    PANEL_SZEROKOSC = CH_Width{PIC_ADDR.l}
    PANEL_WYSOKOSC  = CH_Height{PIC_ADDR.l}
    CX_SRCMOD.l=PANEL_SZEROKOSC*3
    ChunkyDrawLineImage{PIC_ADDR.l+12,#AD_WINDOW,PANEL_SZEROKOSC,PANEL_WYSOKOSC,PRE_SCALE}
    If PIC_ADDR.l>0 Then FreeMem_ PIC_ADDR.l,PIC_LEN.l : PIC_ADDR.l=0 : PIC_LEN.l=0
  EndIf

  If PIC_ADDR.l>0 Then FreeMem_ PIC_ADDR.l,PIC_LEN.l : PIC_ADDR.l=0 : PIC_LEN.l=0

Return

.LOAD_FONT
  LoadFont 0,"PL_Topaz.font",8 : FONT_Y(0)=8

  For x=1 To 10
    If PRE_SCALE=1 : FONT_Y(x)=PRE_FONT_SIZE(x)*2 : Else : FONT_Y(x)=PRE_FONT_SIZE(x) : EndIf
    LoadFont x,PRE_FONT$(x),FONT_Y(x)
  Next x
Return


.


.DEINIT

  Gosub SAVE_HISTORY

  SetTaskPri_ FindTask_(0),#PRI_LOW

; --------------------------------- PATTERN
  AKTYWNY_PATTERN=-2
  If PATT_ADDR.l>0 Then FreeMem_ PATT_ADDR.l,PATT_LEN.l : PATT_ADDR.l=0 : PATT_LEN.l=0
; --------------------------------- ANIMATION
  Gosub FREE_ANIM
; --------------------------------- PLIK DATA
    FClose_{#AD_DATA}
; --------------------------------- PLIKI
  For i=0 To 10
    FClose_ {i}
  Next i
  Gosub KASUJ_TMP
; --------------------------------- INNE
  CloseCatalog_ catalog.l
  CloseWindow #AD_WINDOW

  If AD_SCREEN<>0 Then  CloseScreen AD_SCREEN

  If adport.l<>0 Then DeleteMsgPort adport.l
; --------------------------------- FLUSH
  If cgxbase.l>0 Then CloseLibrary_ cgxbase.l
  Gosub MODUL_STOP
  If dbbase.l>0 Then CloseLibrary_ dbbase.l

  Free GTList #AD_GT_PREFS
  Free GTList #AD_GT_MUSIC
  Free GTList #AD_GT_KEYS
  Free GTList #AD_GT_PALETTE

  x=AllocMem_ ($07FFFFFFF,#MEMF_ANY)

Return

.

.___TEKST____
.

.MENU
  If Exists(TEMP_DIR$+"ANTYDRESIARZ-ARTEK") Then DeleteFile_ TEMP_DIR$+"ANTYDRESIARZ-ARTEK"
  STEROWNIK_PLIK=#AD_MENU

  ILOSC_SZPALT=3
  UstawSzpalty{ILOSC_SZPALT}
  FONT_Y=8

  Dim PICTURE_START.l(1001),PICTURE_LENGTH.l(1001),CHUNKY_START.l(1001),CHUNKY_LENGTH.l(1001)

  PICS$=MENU_PICTURES$
  Repeat
    X1=Instr(PICS$,",") : X2=Instr(PICS$,",",X1+1) : X3=Instr(PICS$,",",X2+1)
    Pnr=ValLong_{ Left$(PICS$,X1-1) }
    If X3=0 AND X2<>0 Then X3=Len(PICS$)
    PICTURE_START.l(Pnr)= ValLong_{ Mid$(PICS$,X1+1,X2-X1) }
    PICTURE_LENGTH.l(Pnr)=ValLong_{ Mid$(PICS$,X2+1,X3-X2 ) }
    If X3=0 Then PICS$=""
    PICS$=Right$(PICS$,Len(PICS$)-X3)
  Until PICS$=""
  PICS$=MENU_CHUNKY$
  Repeat
    X1=Instr(PICS$,",") : X2=Instr(PICS$,",",X1+1) : X3=Instr(PICS$,",",X2+1)
    Pnr=ValLong_{ Left$(PICS$,X1-1) }
    If X3=0 AND X2<>0 Then X3=Len(PICS$)
    CHUNKY_START.l(Pnr)= ValLong_{ Mid$(PICS$,X1+1,X2-X1) }
    CHUNKY_LENGTH.l(Pnr)=ValLong_{ Mid$(PICS$,X2+1,X3-X2 ) }
    If X3=0 Then PICS$=""
    PICS$=Right$(PICS$,Len(PICS$)-X3)
  Until PICS$=""

x=FileLoad{MENU_FILE$(AKTYWNE_MENU),"LOAD_MENU",#AD_DATA,MENU_START.l(AKTYWNE_MENU),MENU_LENGTH.l(AKTYWNE_MENU)}
  FOpen_ {#AD_MENU,TEMP_DIR$+"MENU",#MODE_READWRITE}
  TXT$=Edit_{#AD_MENU}
  TA=Instr(TXT$,Chr$($1B))
  TX=Instr(TXT$,"[",TA) : TY=Instr(TXT$,"]",TX)
  ZNAK$=Mid$(TXT$,TX+1,TY-TX-1)

  Gosub STEROWNIK

  Use Window #AD_WINDOW
  WColour_{PRE_PEN_ARTICLE}
  WJam 0

  AKTYWNY_JAM=0
  AKTYWNY_KOLOR=PRE_PEN_ARTICLE
  AKTYWNY_FONT=1
  WindowFont AKTYWNY_FONT

  MENU_STRONA=0
  MENU_STRONA_START.l(MENU_STRONA)=Loc_{#AD_MENU}

  WSKAZANY_TEKST=1001
  ARTICLE_FILE$(1001)="MENU"

  MENU_STRONA:
  TA=0
  STR_STRONA=1
  SZPALTA=0
  OLD_STREFA.w=-1 : OLD_SHORT.w=-1
  MENU_FONT(MENU_STRONA)=AKTYWNY_FONT
  MENU_KOLOR(MENU_STRONA)=AKTYWNY_KOLOR

  ZoneInit 20,#ILOSC_STREF
  Gosub FREE_ANIM
  Pattern{#AD_WINDOW,PRE_TEXT_WINDOW_X,PRE_TEXT_WINDOW_Y,PRE_TEXT_WINDOW_W,PRE_TEXT_WINDOW_H}
  WLocate SZPALTA_X(SZPALTA),SZPALTA_Y(SZPALTA)

  Repeat
    TXT$=Edit_{#AD_MENU} : TA=0 : TB=0
    LINIA_TEKSTU$=TXT$
    WLocate SZPALTA_X(SZPALTA),WCursY

    Repeat
      TA=Instr(TXT$,Chr$($1B))
      If TA>0
        TX=Instr(TXT$,"[",TA) : TY=Instr(TXT$,"]",TX)
        Print Left$(TXT$,TA-1)
        ZNAK$=Mid$(TXT$,TX+1,TY-TX-1)
        Gosub STEROWNIK
        TXT$=Right$(TXT$,Len(TXT$)-TY)
      EndIf
      If TA=0
        Print TXT$ : TXT$=""
      EndIf
    Until TXT$=""

    NPrint ""

    If WCursY+FONT_Y(AKTYWNY_FONT)>SZPALTA_Y(SZPALTA)+SZPALTA_H(SZPALTA)
      If SZPALTA=>ILOSC_SZPALT-1
        Gosub PETLA_MENU
      Else
        SZPALTA=SZPALTA+1
         WLocate SZPALTA_X(SZPALTA),SZPALTA_Y(SZPALTA)
      EndIf
    EndIf


  Until Eof_ {#AD_MENU}

  Gosub PETLA_MENU
  Gosub DEINIT
  End



Return

.PETLA_MENU


  Strona{MENU_STRONA+1,Loc_{#AD_MENU},Lof_{#AD_MENU}}

  Repeat
    Gosub CZAS
    Gosub DISPLAY_ANIM

  gad = CheckGadget{}

  Select gad
    Case PRE_GADGET_SCREEN
      HideScreen AD_SCREEN
    Case PRE_GADGET_EXIT
      Gosub DEINIT
      End
    Case PRE_GADGET_LEFT
      If MENU_STRONA>0
        MENU_STRONA=MENU_STRONA-1
        FSeek_ {#AD_MENU,MENU_STRONA_START.l(MENU_STRONA)}
        AKTYWNY_FONT=MENU_FONT(MENU_STRONA)
        AKTYWNY_KOLOR=MENU_KOLOR(MENU_STRONA)
        WindowFont AKTYWNY_FONT
        WColour_{AKTYWNY_KOLOR}
        Goto MENU_STRONA
      EndIf
    Case PRE_GADGET_RIGHT
      If Eof_{#AD_MENU}=False
        MENU_STRONA=MENU_STRONA+1
        MENU_STRONA_START.l(MENU_STRONA)=Loc_{#AD_MENU}
        Goto MENU_STRONA
      EndIf
    Case PRE_GADGET_UP
    Case PRE_GADGET_DOWN
    Case PRE_GADGET_MUSIC
      Gosub MUZYKA_PREFS
    Case PRE_GADGET_PREFS
      Gosub PREFERENCJE
    Case PRE_GADGET_MENU
  End Select

  If (gad=>0) AND (gad<#MENU_ZONES)
  EndIf

  If (gad=>#MENU_ZONES)
    FClose_ {#AD_MENU}
    If Exists(TEMP_DIR$+"MENU") Then DeleteFile_ TEMP_DIR$+"MENU"
    If Exists(TEMP_DIR$+"ANTYDRESIARZ-ARTEK") Then DeleteFile_ TEMP_DIR$+"ANTYDRESIARZ-ARTEK"
    WSKAZANY_TEKST=STREFA_LINK(gad-#MENU_ZONES)
    Gosub TEKST
  EndIf

  ev = Event

  If ev = 1024
    ec=-1 : ec=EventCode
    Select ec
      Case AD_KEY(1) ; prawo
        If Eof_{#AD_MENU}=False
          MENU_STRONA=MENU_STRONA+1
          MENU_STRONA_START.l(MENU_STRONA)=Loc_{#AD_MENU}
          Goto MENU_STRONA
        EndIf
      Case AD_KEY(2) ; lewo
        If MENU_STRONA>0
          MENU_STRONA=MENU_STRONA-1
          FSeek_ {#AD_MENU,MENU_STRONA_START.l(MENU_STRONA)}
          AKTYWNY_FONT=MENU_FONT(MENU_STRONA)
          AKTYWNY_KOLOR=MENU_KOLOR(MENU_STRONA)
          WindowFont AKTYWNY_FONT
          WColour_{AKTYWNY_KOLOR}
          Goto MENU_STRONA
        EndIf
      Case AD_KEY(5) ; spacja
      Case AD_KEY(4) ; gora
      Case AD_KEY(3) ; dol
      Case AD_KEY(6) ; M - jak MUSIC!
        Gosub MUZYKA_PREFS
      Case AD_KEY(7) ; P - jak PREFS!
        Gosub PREFERENCJE
      Case AD_KEY(8) ; esc
        Gosub DEINIT
        End
      Case 95
        Gosub HELP
    End Select

    If ec=>80 AND ec<=89
      MUSIC_WYBRANY_MODUL=ec+1-80
      If MUSIC_WYBRANY_MODUL=GT_ILOSC_MODULOW+1
    MODULE_FILE$(GT_ILOSC_MODULOW+1)=RTFileRequest(GetCatStr{catalog.l,2020,"Wskaz modul w formacie DBM lub PT lub P601"},"",0)
      EndIf
      Gosub MODUL_START

      Repeat
        Gosub CZAS : Gosub DISPLAY_ANIM
      Until (Event<>1024) OR (EventCode<>ec)

    EndIf

  EndIf

  Until gad=0
  Gosub DEINIT
  End

Return


.TEKST

  Dim PICTURE_START.l(1001),PICTURE_LENGTH.l(1001),CHUNKY_START.l(1001),CHUNKY_LENGTH.l(1001)
  FClose_{#AD_TEXT}
  If Exists(TEMP_DIR$+"ANTYDRESIARZ-ARTEK") Then DeleteFile_ TEMP_DIR$+"ANTYDRESIARZ-ARTEK"

  STEROWNIK_PLIK=#AD_TEXT

  PICS$=ARTICLE_PICTURES$(WSKAZANY_TEKST)

  Repeat
    X1=Instr(PICS$,",") : X2=Instr(PICS$,",",X1+1) : X3=Instr(PICS$,",",X2+1)
    Pnr=ValLong_{ Left$(PICS$,X1-1) }
    If X3=0 AND X2<>0 Then X3=Len(PICS$)
    PICTURE_START.l(Pnr)= ValLong_{ Mid$(PICS$,X1+1,X2-X1) }
    PICTURE_LENGTH.l(Pnr)=ValLong_{ Mid$(PICS$,X2+1,X3-X2 ) }
    If X3=0 Then PICS$=""
    PICS$=Right$(PICS$,Len(PICS$)-X3)
  Until PICS$=""
  PICS$=ARTICLE_CHUNKY$(WSKAZANY_TEKST)
  Repeat
    X1=Instr(PICS$,",") : X2=Instr(PICS$,",",X1+1) : X3=Instr(PICS$,",",X2+1)
    Pnr=ValLong_{ Left$(PICS$,X1-1) }
    If X3=0 AND X2<>0 Then X3=Len(PICS$)
    CHUNKY_START.l(Pnr)= ValLong_{ Mid$(PICS$,X1+1,X2-X1) }
    CHUNKY_LENGTH.l(Pnr)=ValLong_{ Mid$(PICS$,X2+1,X3-X2 ) }
    If X3=0 Then PICS$=""
    PICS$=Right$(PICS$,Len(PICS$)-X3)
  Until PICS$=""

  ILOSC_SZPALT=3
  UstawSzpalty{ILOSC_SZPALT}
  TEKST_STRONA=0 : FONT_Y=8

  LINK_HISTORY(WSKAZANY_TEKST)=1

x=FileLoad{ARTICLE_FILE$(WSKAZANY_TEKST),"LOAD_TEXT",#AD_DATA,ARTICLE_START.l(WSKAZANY_TEKST),ARTICLE_LENGTH.l(WSKAZANY_TEKST)}

  If Exists(TEMP_DIR$+"ANTYDRESIARZ-ARTEK")>0
  Else
    If Exists(TEMP_DIR$+"ANTYDRESIARZ-ARTEK") Then DeleteFile_ TEMP_DIR$+"ANTYDRESIARZ-ARTEK"
    Goto POCZATEK
  EndIf

  FOpen_ {#AD_TEXT,TEMP_DIR$+"ANTYDRESIARZ-ARTEK",#MODE_READWRITE}
  TXT$=Edit_{#AD_TEXT}
  TA=Instr(TXT$,Chr$($1B))
  TX=Instr(TXT$,"[",TA) : TY=Instr(TXT$,"]",TX)
  ZNAK$=Mid$(TXT$,TX+1,TY-TX-1)

  Gosub STEROWNIK

  Use Window #AD_WINDOW
  WColour_{PRE_PEN_ARTICLE}
  WJam 0
  AKTYWNY_JAM=0
  AKTYWNY_KOLOR=PRE_PEN_ARTICLE
  AKTYWNY_FONT=1
  WindowFont AKTYWNY_FONT
  TEKST_STRONA_START.l(TEKST_STRONA)=Loc_{#AD_TEXT}

  TEKST_STRONA:
  TA=0
  ZoneInit 20,#ILOSC_STREF
  OLD_STREFA.w=-1 : OLD_SHORT.w=-1
  STR_STRONA=1 : SZPALTA=0
  WLocate SZPALTA_X(SZPALTA),SZPALTA_Y(SZPALTA)

  Gosub FREE_ANIM
  Pattern{#AD_WINDOW,PRE_TEXT_WINDOW_X,PRE_TEXT_WINDOW_Y,PRE_TEXT_WINDOW_W,PRE_TEXT_WINDOW_H}

  TEKST_FONT(TEKST_STRONA)=AKTYWNY_FONT
  TEKST_KOLOR(TEKST_STRONA)=AKTYWNY_KOLOR


  Repeat
    TXT$=Edit_{#AD_TEXT} : TA=0 : TB=0
    LINIA_TEKSTU$=TXT$
    WLocate SZPALTA_X(SZPALTA),WCursY

    Repeat
      TA=Instr(TXT$,Chr$($1B))
      If TA>0
        TX=Instr(TXT$,"[",TA) : TY=Instr(TXT$,"]",TX)
        Print Left$(TXT$,TA-1)
        ZNAK$=Mid$(TXT$,TX+1,TY-TX-1)
        Gosub STEROWNIK
        TXT$=Right$(TXT$,Len(TXT$)-TY)
      EndIf
      If TA=0
        Print TXT$ : TXT$=""
      EndIf
    Until TXT$=""

    NPrint ""

    If WCursY+FONT_Y(AKTYWNY_FONT)>SZPALTA_Y(SZPALTA)+SZPALTA_H(SZPALTA)
      If SZPALTA=>ILOSC_SZPALT-1
        Gosub PETLA_TEKSTU
      Else
        SZPALTA=SZPALTA+1
        WLocate SZPALTA_X(SZPALTA),SZPALTA_Y(SZPALTA)
      EndIf
    EndIf


  Until Eof_ {#AD_TEXT}

  Gosub PETLA_TEKSTU
  Gosub DEINIT
  End
Return

.PETLA_TEKSTU

  Strona{TEKST_STRONA+1,Loc_{#AD_TEXT},Lof_{#AD_TEXT}}

  Repeat
    Gosub CZAS
    Gosub DISPLAY_ANIM


  gad = CheckGadget{}

  Select gad
    Case PRE_GADGET_SCREEN
      HideScreen AD_SCREEN
    Case PRE_GADGET_EXIT
      Gosub DEINIT
      End
    Case PRE_GADGET_LEFT
      If TEKST_STRONA>0
        TEKST_STRONA=TEKST_STRONA-1
        FSeek_ {#AD_TEXT,TEKST_STRONA_START.l(TEKST_STRONA)}
        AKTYWNY_FONT=TEKST_FONT(TEKST_STRONA)
        AKTYWNY_KOLOR=TEKST_KOLOR(TEKST_STRONA)
        WindowFont AKTYWNY_FONT
        WColour_{AKTYWNY_KOLOR}
        Goto TEKST_STRONA
      EndIf
    Case PRE_GADGET_RIGHT
      If Eof_{#AD_TEXT}=False
        TEKST_STRONA=TEKST_STRONA+1
        TEKST_STRONA_START.l(TEKST_STRONA)=Loc_{#AD_TEXT}
        Goto TEKST_STRONA
      EndIf
    Case PRE_GADGET_UP
        WSKAZANY_TEKST=WSKAZANY_TEKST-1
        Gosub TEKST
    Case PRE_GADGET_DOWN
        WSKAZANY_TEKST=WSKAZANY_TEKST+1
        Gosub TEKST
    Case PRE_GADGET_MUSIC
      Gosub MUZYKA_PREFS
    Case PRE_GADGET_PREFS
      Gosub PREFERENCJE
    Case PRE_GADGET_MENU
      FClose_{#AD_TEXT} : Goto POCZATEK
    Case PRE_GADGET_SPEAK
      Gosub WYMOWA
  End Select


  If (gad=>0) AND (gad<#MENU_ZONES)

  EndIf

  If (gad=>#MENU_ZONES)
    WSKAZANY_TEKST=STREFA_LINK(gad-#MENU_ZONES)
    Gosub TEKST
  EndIf

  ev = Event

  If ev = 1024
    ec=-1 : ec=EventCode
    Select ec
      Case AD_KEY(1) ; prawo
        If Eof_{#AD_TEXT}=False
          TEKST_STRONA=TEKST_STRONA+1
          TEKST_STRONA_START.l(TEKST_STRONA)=Loc_{#AD_TEXT}
          Goto TEKST_STRONA
        EndIf
      Case AD_KEY(2) ; lewo
        If TEKST_STRONA>0
          TEKST_STRONA=TEKST_STRONA-1
          FSeek_ {#AD_TEXT,TEKST_STRONA_START.l(TEKST_STRONA)}
          AKTYWNY_FONT=TEKST_FONT(TEKST_STRONA)
          AKTYWNY_KOLOR=TEKST_KOLOR(TEKST_STRONA)
          WindowFont AKTYWNY_FONT
          WColour_{AKTYWNY_KOLOR}
          Goto TEKST_STRONA
        EndIf
      Case AD_KEY(5) ; spacja
        FClose_{#AD_TEXT} : Goto POCZATEK
      Case AD_KEY(4) ; gora
        WSKAZANY_TEKST=WSKAZANY_TEKST-1
        Gosub TEKST
      Case AD_KEY(3) ; dol
        WSKAZANY_TEKST=WSKAZANY_TEKST+1
        Gosub TEKST
      Case AD_KEY(6) ; M - jak MUSIC!
        Gosub MUZYKA_PREFS
      Case AD_KEY(7) ; P - jak PREFS!
        Gosub PREFERENCJE
      Case AD_KEY(8) ; esc
        Gosub DEINIT
        End
      Case 95
        Gosub HELP
    End Select

    If ec=>80 AND ec<=89
      MUSIC_WYBRANY_MODUL=ec+1-80
      If MUSIC_WYBRANY_MODUL=GT_ILOSC_MODULOW+1
    MODULE_FILE$(GT_ILOSC_MODULOW+1)=RTFileRequest(GetCatStr{catalog.l,2020,"Wskaz modul w formacie DBM lub PT lub P601"},"",0)
      EndIf
      Gosub MODUL_START

      Repeat
        Gosub CZAS : Gosub DISPLAY_ANIM
      Until (Event<>1024) OR (EventCode<>ec)

    EndIf

  EndIf

  Until gad=0
  Gosub DEINIT
  End

Return

.

.STEROWNIK
  KONFIG$=Right$(ZNAK$,1)
  KDANE$=Left$(ZNAK$,Len(ZNAK$)-1)

  Select KONFIG$
    Case "N" ; Center
      If KDANE$="CE"
        T$=Right$(TXT$,Len(TXT$)-TY)
        TY=Len(TXT$)
        D.l=DlugoscTekstu{#AD_WINDOW,T$}
        WLocate SZPALTA_X(SZPALTA)+((SZPALTA_W(SZPALTA)-D.l)/2),WCursY
        Print T$
      EndIf
    Case "L" ; Link
      x1=Instr(KDANE$,";") : x2=Instr(KDANE$,";",x1+1) : x3=Instr(KDANE$,";",x2+1)
      LNR=ValLong_{ Left$(KDANE$,x1-1) }
      LINK_TITLE$(STR_STRONA)=Mid$(KDANE$,x1+1,x2-x1-1)
      LINK_SHORT$(STR_STRONA)=Mid$(KDANE$,x2+1,x3-x2-1)

      LINK_COLOR(STR_STRONA)=AKTYWNY_KOLOR
      LINK_FONT(STR_STRONA)=AKTYWNY_FONT
      LINK_X(STR_STRONA)=WCursX
      LINK_Y(STR_STRONA)=WCursY
      LINK_W(STR_STRONA)=DlugoscTekstu{#AD_WINDOW,LINK_TITLE$(LNR)}
      LINK_H(STR_STRONA)=FONT_Y(AKTYWNY_FONT)

      STREFA_LINK(STR_STRONA)=LNR
      SetZone 20+STR_STRONA,WCursX,WCursY,WCursX+DlugoscTekstu{#AD_WINDOW,LINK_TITLE$(STR_STRONA)},WCursY+FONT_Y(AKTYWNY_FONT)

      If LINK_HISTORY(LNR)=1
        WColour_{PRE_PEN_LINK_READED}
        LINK_COLOR(STR_STRONA)=PRE_PEN_LINK_READED
      EndIf

      Print LINK_TITLE$(STR_STRONA)
      WColour_{AKTYWNY_KOLOR}

      STR_STRONA=STR_STRONA+1

    Case "x" ; MoveX
      WLocate WCursX+ValLong_{"$"+DANE$},WCursY
    Case "y" ; MoveY
      WLocate WCursX,WCursY+ValLong_{"$"+DANE$}
    Case "X" ; LocateX
      WLocate ValLong_{"$"+DANE$},WCursY
    Case "Y" ; LocateY
      WLocate WCursX,ValLong_{"$"+DANE$}
    Case "E" ; LINE
      If KDANE$="LIN"
        LY=(FONT_Y(AKTYWNY_FONT)/2)-1

        If PRE_TRUE_COLOR=1
          PD=FindColor{PRE_R(PRE_PEN_DARK),PRE_G(PRE_PEN_DARK),PRE_B(PRE_PEN_DARK)}
          PB=FindColor{PRE_R(PRE_PEN_BRIGHT),PRE_G(PRE_PEN_BRIGHT),PRE_B(PRE_PEN_BRIGHT)}
        Else
          PD=PRE_PEN_DARK
          PB=PRE_PEN_BRIGHT
        EndIf

        If PRE_SCALE=1
          Wline WCursX,WCursY+LY-1,SZPALTA_X(SZPALTA)+SZPALTA_W(SZPALTA),WCursY+LY-1,PD
          Wline WCursX,WCursY+LY,SZPALTA_X(SZPALTA)+SZPALTA_W(SZPALTA),WCursY+LY,PD
          Wline WCursX,WCursY+LY+1,SZPALTA_X(SZPALTA)+SZPALTA_W(SZPALTA),WCursY+LY+1,PB
          Wline WCursX,WCursY+LY+2,SZPALTA_X(SZPALTA)+SZPALTA_W(SZPALTA),WCursY+LY+2,PB
        Else
          Wline WCursX,WCursY+LY,SZPALTA_X(SZPALTA)+SZPALTA_W(SZPALTA),WCursY+LY,PD
          Wline WCursX,WCursY+LY+1,SZPALTA_X(SZPALTA)+SZPALTA_W(SZPALTA),WCursY+LY+1,PB
        EndIf
      EndIf
    Case "K" ; kolumny/szpalty
      ILOSC_SZPALT=ValLong_{"$"+KDANE$}
    Case "k" ; zmiana koloru czcionki
      AKTYWNY_KOLOR=ValLong_{KDANE$}+8
      WColour_{AKTYWNY_KOLOR}
    Case "f" ; zmiana czcionki
      AKTYWNY_FONT=ValLong_{KDANE$}
      WindowFont AKTYWNY_FONT
    Case "P" ; obrazek
      PROG$=Right$(KDANE$,1)
      PICT=ValLong_{ Left$(KDANE$,Len(KDANE$)-1) }

      PIC$="RYSUNKI/"+ARTICLE_FILE$(WSKAZANY_TEKST)+"/"+Str$(PICT)
      If PRE_TRUE_COLOR=1
        PIC$=PIC$+".CHK"
        STRT.l=CHUNKY_START.l(PICT)
        LENG.l=CHUNKY_LENGTH.l(PICT)
      Else
        PIC$=PIC$+".IFF"
        STRT.l=PICTURE_START.l(PICT)
        LENG.l=PICTURE_LENGTH.l(PICT)
      EndIf

      If Exists(PIC$)
        PIC$=ARTICLE_FILE$(WSKAZANY_TEKST)+"/"+Str$(PICT)
        If PRE_TRUE_COLOR=1 : PIC$=PIC$+".CHK" : Else : PIC$=PIC$+".IFF" : EndIf
      Else
        PIC$=""
      EndIf


      PIC_ADDR.l=FileLoad{PIC$,"PIC_LOAD",#AD_DATA,STRT.l,LENG.l}
      PIC_LEN.l=WORK_DATA.l

      If PIC_ADDR.l>0
        If CheckIFF{PIC_ADDR.l}
          PSZER=IFF_Width{PIC_ADDR.l} : PWYS=IFF_Height{PIC_ADDR.l} : PDEPTH=IFF_Depth{PIC_ADDR.l}

          If PRE_SCALE=1 : PPWYS=PWYS*2 : Else : PPWYS=PWYS : EndIf

          If (WCursY+PPWYS>SZPALTA_Y(SZPALTA)+SZPALTA_H(SZPALTA)) AND (PROG$<>"e")AND(PROG$<>"f")AND(PROG$<>"g")AND(PROG$<>"h")
            FreeMem_ PIC_ADDR.l,PIC_LEN.l : PIC_ADDR.l=0 : PIC_LEN.l=0
            FSeek_ {STEROWNIK_PLIK,Loc_{STEROWNIK_PLIK}-Len(LINIA_TEKSTU$)-1} : TXT$=""
            WLocate WCursX,SZPALTA_Y(SZPALTA)+SZPALTA_H(SZPALTA)
          Else
            BitMap #PICTURE_BITMAP,PSZER,PWYS,8
            x=DecodeIFFPalette{#AD_PALETTE,PIC_ADDR.l,96,255,False}
            DecodeILBM #PICTURE_BITMAP,PIC_ADDR.l
            FreeMem_ PIC_ADDR.l,PIC_LEN.l : PIC_ADDR.l=0 : PEN_LEN.l=0
            UsePalette{#AD_PALETTE}
            BMToWin {#PICTURE_BITMAP,#AD_WINDOW,WCursX,WCursY,PSZER,PWYS}
            Free BitMap #PICTURE_BITMAP
            PWYS=PPWYS
            If PROG$="b" Then WLocate WCursX+PSZER,WCursY
            If PROG$="c" Then WLocate WCursX+PSZER,WCursY+PWYS
            If PROG$="d" Then WLocate WCursX,WCursY+PWYS
          EndIf
        EndIf

        If CheckCH{PIC_ADDR.l} AND PRE_TRUE_COLOR=1
          PSZER=CH_Width{PIC_ADDR.l} : PWYS=CH_Height{PIC_ADDR.l}

          If (WCursY+PWYS>SZPALTA_Y(SZPALTA)+SZPALTA_H(SZPALTA)) AND (PROG$<>"e")AND(PROG$<>"f")AND(PROG$<>"g")AND(PROG$<>"h")
            FreeMem_ PIC_ADDR.l,PIC_LEN.l : PIC_ADDR.l=0 : PIC_LEN.l=0
            FSeek_ {STEROWNIK_PLIK,Loc_{STEROWNIK_PLIK}-Len(LINIA_TEKSTU$)-1} : TXT$=""
            WLocate WCursX,SZPALTA_Y(SZPALTA)+SZPALTA_H(SZPALTA)
          Else
            CX_SRCX.w=0 : CX_SRCY.w=0 : CX_SRCMOD.l=PSZER*3
            WPA{PIC_ADDR.l+12,RastPort(#AD_WINDOW),WCursX,WCursY,PSZER,PWYS}
            FreeMem_ PIC_ADDR.l,PIC_LEN.l : PIC_ADDR.l=0 : PIC_LEN.l=0
            If PROG$="b" OR PROG$="f" Then WLocate WCursX+PSZER,WCursY
            If PROG$="c" OR PROG$="g" Then WLocate WCursX+PSZER,WCursY+PWYS
            If PROG$="d" OR PROG$="h" Then WLocate WCursX,WCursY+PWYS
          EndIf
        EndIf

        If PIC_ADDR.l>0 Then FreeMem_ PIC_ADDR.l,PIC_LEN.l



      EndIf

    Case "A" ; animacja

      ANM_TYPE$=""
      PROG$=Right$(KDANE$,1)
      ANM=ValLong_{ Left$(KDANE$,Len(KDANE$)-1) }

      ANM$="RYSUNKI/"+ARTICLE_FILE$(WSKAZANY_TEKST)+"/"+Str$(ANM)
      If PRE_TRUE_COLOR=1
        ANM$=ANM$+".CHK"
        STRT.l=CHUNKY_START.l(ANM)
        LENG.l=CHUNKY_LENGTH.l(ANM)
      Else
        ANM$=ANM$+".IFF"
        STRT.l=PICTURE_START.l(ANM)
        LENG.l=PICTURE_LENGTH.l(ANM)
      EndIf

      If Exists(ANM$)
        ANM$=ARTICLE_FILE$(WSKAZANY_TEKST)+"/"+Str$(ANM)
        If PRE_TRUE_COLOR=1 : ANM$=ANM$+".CHK" : Else : ANM$=ANM$+".IFF" : EndIf
      Else
        ANM$=""
      EndIf

      If ANM_ADDR.l>0 Then FreeMem_ ANM_ADDR.l,ANM_LEN.l : ANM_ADDR.l=0 : ANM_LEN.l=0

      ANM_ADDR.l=FileLoad{ANM$,"PIC_LOAD",#AD_DATA,STRT.l,LENG.l}
      ANM_LEN.l=WORK_DATA.l

      DEFTYPE.b ANM_DBUFF

      If ANM_ADDR.l>0

        If Peeks$(ANM_ADDR.l,12)="CHUNKYANIM24"
          ANM_SZER   = Peek.w(ANM_ADDR.l+12)
          ANM_WYS    = Peek.w(ANM_ADDR.l+14)
          ANM_FRAMES = Peek.w(ANM_ADDR.l+16)
          ANM_TYPE$  = "CHUNKY"

          If (WCursY+ANM_WYS>SZPALTA_Y(SZPALTA)+SZPALTA_H(SZPALTA))AND(PROG$<>"e")AND(PROG$<>"f")AND(PROG$<>"g")AND(PROG$<>"h")
            FreeMem_ ANM_ADDR.l,ANM_LEN.l : ANM_ADDR.l=0 : ANM_LEN.l=0
            FSeek_ {STEROWNIK_PLIK,Loc_{STEROWNIK_PLIK}-Len(LINIA_TEKSTU$)-1} : TXT$=""
            WLocate WCursX,SZPALTA_Y(SZPALTA)+SZPALTA_H(SZPALTA)
          Else
            ANM_X=WCursX : ANM_Y=WCursY : ANM_W=ANM_SZER : ANM_H=ANM_WYS
            If PROG$="b" OR PROG$="f" Then WLocate WCursX+ANM_SZER,WCursY
            If PROG$="c" OR PROG$="g" Then WLocate WCursX+ANM_SZER,WCursY+ANM_WYS
            If PROG$="d" OR PROG$="h" Then WLocate WCursX,WCursY+ANM_WYS
            ANM_FRAMEPLAY=0
            ANM_PLAY=True
          EndIf
        EndIf

      If Peeks$(ANM_ADDR.l,4)="FORM" AND Peeks$(ANM_ADDR.l+8,4)="ANIM"
        ANM_SZER=IFF_Width{ANM_ADDR.l+12}
        ANM_WYS=IFF_Height{ANM_ADDR.l+12}
        ANM_DEPTH=IFF_Depth{ANM_ADDR.l+12}

        If PRE_SCALE=1 : AAWYS=ANM_WYS*2 : Else : AAWYS=ANM_WYS : EndIf

        If WCursY+AAWYS>SZPALTA_Y(SZPALTA)+SZPALTA_H(SZPALTA)
          If ANM_ADDR.l>0 Then FreeMem_ ANM_ADDR.l,ANM_LEN.l : ANM_ADDR.l=0 : ANM_LEN.l=0
          FSeek_ {STEROWNIK_PLIK,Loc_{STEROWNIK_PLIK}-Len(LINIA_TEKSTU$)-1} : TXT$=""
          WLocate WCursX,SZPALTA_Y(SZPALTA)+SZPALTA_H(SZPALTA)
        Else

          BitMap #ANIM_BITMAP  ,ANM_SZER,ANM_WYS,8
          BitMap #ANIM_BITMAP+1,ANM_SZER,ANM_WYS,8

          ANM=RIAnimInit (ANM_ADDR.l,#ANIM_BITMAP,#ANIM_PALETTE)

          If ANM
            x=CopyPalette{#ANIM_PALETTE,#AD_PALETTE,96,255,96}
            If PRE_GRAYSCALE=1 Then x=Greyscale{1,95,255}
            UsePalette{#AD_PALETTE}

            ANM_X=WCursX : ANM_Y=WCursY : ANM_W=ANM_SZER : ANM_H=ANM_WYS
            ANM_FRAMES=RIAnimFrameCount : ANM_PLAY=True
            ANM_TYPE$="PLANAR"

;            ANM_SKOK=SkokAnimki {ANM_H}

            CopyBitMap #ANIM_BITMAP,#ANIM_BITMAP+1 : ANM_DBUFF.b=#ANIM_BITMAP+1
            BMToWin{#ANIM_BITMAP,#AD_WINDOW,ANM_X,ANM_Y,ANM_W,ANM_H}

            If PROG$="b" OR PROG$="f" Then WLocate WCursX+ANM_SZER,WCursY
            If PROG$="c" OR PROG$="g" Then WLocate WCursX+ANM_SZER,WCursY+AAWYS
            If PROG$="d" OR PROG$="h" Then WLocate WCursX,WCursY+AAWYS
          Else
            Free BitMap #ANIM_BITMAP
            Free BitMap #ANIM_BITMAP+1
            If ANM_ADDR.l>0 Then FreeMem_ ANM_ADDR.l,ANM_LEN.l : ANM_ADDR.l=0 : ANM_LEN.l=0
          EndIf

        EndIf

      Else
        If ANM_TYPE$=""
          If ANM_ADDR.l>0 Then FreeMem_ ANM_ADDR.l,ANM_LEN.l : ANM_ADDR.l=0 : ANM_LEN.l=0
        EndIf
      EndIf

      EndIf

    Case "W" ; AnimWait
      ANM_WAIT=ValLong_{DANE$}
    Case "b" ; Pattern

      If AKTYWNY_PATTERN<>ValLong_{KDANE$}
        AKTYWNY_PATTERN=ValLong_{KDANE$}

        If PRE_TRUE_COLOR=1
          PATTFILE$=PATTERN_FILE$(AKTYWNY_PATTERN+127)
          PA_STRT.l=PATTERN_START.l(AKTYWNY_PATTERN+127)
          PA_LENG.l=PATTERN_LENGTH.l(AKTYWNY_PATTERN+127)
        Else
          PATTFILE$=PATTERN_FILE$(AKTYWNY_PATTERN)
          PA_STRT.l=PATTERN_START.l(AKTYWNY_PATTERN)
          PA_LENG.l=PATTERN_LENGTH.l(AKTYWNY_PATTERN)
        EndIf

        If Exists("RYSUNKI/"+PATTFILE$) :Else: PATTFILE$="":EndIf

        If PATT_ADDR.l>0 Then FreeMem_ PATT_ADDR.l,PATT_LEN.l : PATT_ADDR.l=0 : PATT_LEN.l=0

        PATT_ADDR.l=FileLoad{PATTFILE$,"PIC_LOAD",#AD_DATA,PA_STRT.l,PA_LENG.l}
        PATT_LEN.l=WORK_DATA.l

        If PATT_ADDR.l>0
          If CheckIFF{PATT_ADDR.l}
            PATT_WIDTH=IFF_Width{PATT_ADDR.l} : PATT_HEIGHT=IFF_Height{PATT_ADDR.l} : PDEPTH=IFF_Depth{PATT_ADDR.l}
            BitMap #PATTERN_BITMAP,PATT_WIDTH,PATT_HEIGHT,8
            x=DecodeIFFPalette{#AD_PALETTE,PATT_ADDR.l,24,31,False}
            DecodeILBM #PATTERN_BITMAP,PATT_ADDR.l
            FreeMem_ PATT_ADDR.l,PATT_LEN.l : PATT_ADDR.l=0 : PATT_LEN.l=0
            UsePalette{#AD_PALETTE}
            PATT_MODE$="PLANAR"
            PA=1
          EndIf

          If Peeks$(PATT_ADDR.l,8)="CHUNKY24"
            PATT_WIDTH=Peek.w(PATT_ADDR.l+8) : PATT_HEIGHT=Peek.w(PATT_ADDR.l+10) : PDEPTH=24
            PATT_MODE$="CHUNKY"
            PA=1
          EndIf

          If PA<>1
            BitMap #PATTERN_BITMAP,50,50,8 : PATT_WIDTH=50 : PATT_HEIGHT=50 : AKTYWNY_PATTERN=-1
            If PATT_ADDR.l>0 Then FreeMem_ PATT_ADDR.l,PATT_LEN.l : PATT_ADDR.l=0 : PATT_LEN.l=0
            PATT_MODE$="PLANAR"
          EndIf
          PA=0
        Else
          If PATT_ADDR.l>0 Then FreeMem_ PATT_ADDR.l,PATT_LEN.l : PATT_ADDR.l=0 : PATT_LEN.l=0
          BitMap #PATTERN_BITMAP,50,50,8 : PATT_WIDTH=50 : PATT_HEIGHT=50 : AKTYWNY_PATTERN=-1
          PATT_MODE$="PLANAR"
        EndIf

      EndIf


  End Select
Return


.WYMOWA
  If MODULE_PLAYING=False
    SetVoice 150,65,1,1,64,17450
    OLD_LOC.l=Loc_{#AD_TEXT}
    FSeek_ {#AD_TEXT,TEKST_STRONA_START.l(TEKST_STRONA)}
    Repeat
      Gosub DISPLAY_ANIM
      Gosub CZAS
      WYMOWA$=Edit_{#AD_TEXT}
      Repeat
        WA=Instr(WYMOWA$,Chr$($1B))
        WB=Instr(WYMOWA$,Chr$($1B),WA+1)
        WX=Instr(WYMOWA$,"[",WA)
        WY=Instr(WYMOWA$,"]",WX)
        WWA$=Left$(WYMOWA$,WA-1)
        WWB$=Right$(WYMOWA$,Len(WYMOWA$)-WY)
        WYMOWA$=WWA$+WWB$
      Until WA=0 OR WB=0
      Speak WYMOWA$
      Delay_ Len(WYMOWA$)*4
    Until (Loc_{#AD_TEXT}=>OLD_LOC.l) OR Joyb(0)=1
    FSeek_ {#AD_TEXT,OLD_LOC.l}
  Else
      xa$=GetCatStr{catalog.l,110001,"AD Informuje..."}
      xc$=GetCatStr{catalog.l,100000,"Ok!"}
      xb$=GetCatStr{catalog.l,43000,"Aby wysluchac recytacji artykulu musisz wpierw wylaczyc muzyke!"}
      Request xa$,xb$,xc$
      xa$="" : xb$="" : xc$=""
  EndIf

Return



.DISPLAY_ANIM
  If ANM_PLAY=True

    If ANM_TYPE$="CHUNKY"
      CX_SRCX.w=(ANM_W/ANM_FRAMES)*ANM_FRAMEPLAY : CX_SRCY.w=0 : CX_SRCMOD.l=ANM_W*3
      WPA{ANM_ADDR.l+18,RastPort(#AD_WINDOW),ANM_X,ANM_Y,ANM_W/ANM_FRAMES,ANM_H}
      If ANM_FRAMEPLAY=ANM_FRAMES Then ANM_FRAMEPLAY=-1
      ANM_FRAMEPLAY=ANM_FRAMEPLAY+1
    EndIf

    If ANM_TYPE$="PLANAR"
      x=RINextAnimFrame(ANM_DBUFF) : ANM_KLATKA=ANM_KLATKA+1
      BMToWin{#ANIM_BITMAP,#AD_WINDOW,ANM_X,ANM_Y,ANM_W,ANM_H}
      If ANM_DBUFF=#ANIM_BITMAP
        ANM_DBUFF=#ANIM_BITMAP+1
      Else
        ANM_DBUFF=#ANIM_BITMAP
      EndIf
    EndIf

  EndIf

  If ANM_WAIT>0
    VWait ANM_WAIT
  Else
    VWait
  EndIf
Return

.FREE_ANIM
  If ANM_ADDR.l>0 Then FreeMem_ ANM_ADDR.l,ANM_LEN.l : ANM_ADDR.l=0 : ANM_LEN.l=0
  ANM_X=0 : ANM_Y=0 : ANM_W=0: ANM_H=0 : ANM_FRAMES=0 : ANM_PLAY=False
  ANIM_KLATKA=0 : ANIM_SKOK=0 : ANM_WAIT=0

  If ANM_TYPE$="PLANAR"
    Free BitMap #ANIM_BITMAP : Free BitMap #ANIM_BITMAP+1
  EndIf

  ANM_TYPE$=""

Return

.
.___MUSIC___


.MODUL_START

  Gosub MODUL_STOP

  MODUL=MUSIC_WYBRANY_MODUL

  MODULE_ADR.l=FileLoad{MODULE_FILE$(MODUL),"MOD_LOAD",#AD_DATA,MODULE_START.l(MODUL),MODULE_LENGTH.l(MODUL)}
  MODULE_LEN.l=WORK_DATA.l

  If MODULE_ADR.l>0

    If Peeks$(MODULE_ADR.l,4)="DBM0"
      MODULE_FORMAT$="DBM0"
      If PRE_AHI_AUTOBOOST=1 : DBM_F.l=#DBF_AUTOBOOST : Else : DBM_F.l=0 : EndIf
      WYN=DBM_StartModule {MODULE_ADR.l,MODULE_LEN.l,PRE_AHI_MODE_ID.l,PRE_AHI_FREQUENCY.l,DBM_F.l}

      FreeMem_ MODULE_ADR.l,MODULE_LEN.l : MODULE_ADR.l=0 : MODULE_LEN.l=0
      If WYN=0
        MODULE_PLAYING=True
      Else
        MODULE_PLAYING=False
        If WYN=2 Then Request "AD Error...","Masz za malo pamieci!","Ok"
        If WYN=4 Then Request "AD Error...","To nie jest modul w formacie DigiBoosterPro!","Ok"
        If WYN=6 Then Request "AD Error...","Blad AHI!"+Chr$(10)+"Sprobuj zmienic ustawienia w preferencjach!","Ok"
      EndIf
    EndIf

    If Peeks$(MODULE_ADR.l,3)="MMD"
      MODULE_FORMAT$="MMD"
      MED_FORMAT$=Peeks$(MODULE_ADR.l+3,1)
      BSave TEMP_DIR$+"MED_MODULE",MODULE_ADR.l,MODULE_LEN.l
      If MODULE_ADR.l>0 Then FreeMem_ MODULE_ADR.l,MODULE_LEN.l : MODULE_ADR.l=0 : MODULE_LEN.l=0

      MED_ROUTINE=-1 : MED_ADR.l=0 : MODULE_PLAYING=False

      MED_ADR.l=MP_LoadModule_Fast {TEMP_DIR$+"MED_MODULE"}
      If MED_ADR.l>0 Then MED_ROUTINE=MP_RequiredPlayRoutine{MED_ADR.l}
      If MED_ROUTINE=-1 AND MED_ADR.l>0 Then x=MP_UnLoadModule{MED_ADR.l}

      If MED_ROUTINE=0
        If MP_GetPlayer{1}<>0
          MODULE_PLAYING=False
          x=MP_UnLoadModule{MED_ADR.l}
        Else
          x=MP_SetFastMemPlay{1,40}
          x=MP_PlayModule{MED_ADR.l}
          MODULE_PLAYING=True
        EndIf
      EndIf

      If MED_ROUTINE=1
        If OP_GetPlayer8{}<>0
          MODULE_PLAYING=False
          x=MP_UnLoadModule{MED_ADR.l}
        Else
          x=OP_SetFastMemPlay8{1,40}
          x=OP_SetHQ8{PRE_OCTAMED_HQ}
          x=OP_PlayModule8{MED_ADR.l}
          MODULE_PLAYING=True
        EndIf
      EndIf

      If MED_ROUTINE=2
        If OMX_GetPlayerM{}<>0
          MODULE_PLAYING=False
          x=MP_UnLoadModule{MED_ADR.l}
        Else
          x=OMX_SetMixingFrequency{PRE_OCTAMIX_FREQ.l}
          x=OMX_Set14BitMode{PRE_OCTAMIX_14B}
          x=OMX_PlayModuleM{MED_ADR.l}
          If x=0 Then MODULE_PLAYING=True
        EndIf
      EndIf

    EndIf

    If Peeks$(MODULE_ADR.l,4)="P61A"
      MODULE_FORMAT$="P61A"

      P61_ADR.l=AllocMem_ (MODULE_LEN.l,#MEMF_CHIP)
      P61_LEN.l=MODULE_LEN.l
      If P61_ADR.l>0
        CopyMem_ MODULE_ADR.l,P61_ADR.l,P61_LEN.l
        FreeMem_ MODULE_ADR.l,MODULE_LEN.l : MODULE_ADR.l=0 : MODULE_LEN.l=0
        WYN=pl61_Play{P61_ADR.l}

        If WYN=0
          MODULE_PLAYING=True
        Else
          FreeMem_ P61_ADR.l,P61_LEN.l : P61_ADR.l=0 : P61_LEN.l=0
        EndIf
      Else
        FreeMem_ MODULE_ADR.l,MODULE_LEN.l : MODULE_ADR.l=0 : MODULE_LEN.l=0
      EndIf


    EndIf

    If Peeks$(MODULE_ADR.l+1080,4)="M.K."
      BSave TEMP_DIR$+"PT_MODULE",MODULE_ADR.l,MODULE_LEN.l
      If MODULE_ADR.l>0 Then FreeMem_ MODULE_ADR.l,MODULE_LEN.l : MODULE_ADR.l=0 : MODULE_LEN.l=0

      mload=LoadTrackerModule (1,TEMP_DIR$+"PT_MODULE")
      DeleteFile_ TEMP_DIR$+"PT_MODULE"

      If mload
        Gosub ALLOC_CH
        If CHANNELS_ALLOCATED=True
          If StartTracker (1)
            MODULE_PLAYING=True
            MODULE_FORMAT$="M.K."
          Else
            MODULE_PLAYING=False
            FreeTrackerModule 1
            Gosub DEALLOC_CH
          EndIf
        Else
          MODULE_PLAYING=False
          FreeTrackerModule 1
        EndIf
      EndIf
    Else
      If MODULE_ADR.l>0 Then FreeMem_ MODULE_ADR.l,MODULE_LEN.l : MODULE_ADR.l=0 : MODULE_LEN.l=0
    EndIf

  EndIf

  Gosub MODUL_VOLUME

Return


.MODUL_STOP

  If MODULE_PLAYING=True

    If MODULE_FORMAT$="MMD"
      If MED_ROUTINE=0 Then x=MP_FreePlayer{}
      If MED_ROUTINE=1 Then x=OP_FreePlayer8{}
      If MED_ROUTINE=2 Then x=OMX_FreePlayerM{}
      x=MP_UnLoadModule{MED_ADR.l}
      MODULE_PLAYING=False
    EndIf

    If MODULE_FORMAT$="DBM0"
      x=DBM_StopModule{}
      MODULE_PLAYING=False
    EndIf

    If MODULE_FORMAT$="M.K."
      StopTracker
      FreeTrackerModule 1
      Gosub DEALLOC_CH
      MODULE_PLAYING=False
    EndIf

    If MODULE_FORMAT$="P61A"
      x=pl61_Stop{}
      FreeMem_ P61_ADR.l,P61_LEN.l : P61_ADR.l=0 : P61_LEN.l=0
      MODULE_PLAYING=False
    EndIf

  EndIf

  MODULE_FORMAT$=""

Return

.MODUL_VOLUME

    If MODULE_FORMAT$="DBM0"
      x=DBM_SetVolume {MUSIC_GLOSNOSC}
    EndIf

    If MODULE_FORMAT$="M.K."
      TrackerVolume MUSIC_GLOSNOSC
    EndIf

Return

.ALLOC_CH
  LONG.l=$01020408
  If CHANNELS_ALLOCATED=False

    audio_req\ioa_Data=&LONG.l
    audio_req\ioa_Length=4
    audio_req\ioa_AllocKey=0
    audio_req\ioa_Request\io_Message\mn_Node\ln_Pri=-127
    audio_req\ioa_Request\io_Command=#ADCMD_ALLOCATE
    audio_req\ioa_Request\io_Flags=#ADIOF_NOWAIT

    If OpenDevice_("audio.device", 0, &audio_req, 0)=0
      audio_req\ioa_Data=&LONG.l
      audio_req\ioa_Length=4
      audio_req\ioa_AllocKey=0
      audio_req\ioa_Request\io_Message\mn_Node\ln_Pri=127
      audio_req\ioa_Request\io_Command=#ADCMD_ALLOCATE
      audio_req\ioa_Request\io_Flags=#ADIOF_NOWAIT

      If OpenDevice_("audio.device", 0, &audio_req, 0)=0
        CHANNELS_ALLOCATED=True
      Else
        CHANNELS_ALLOCATED=False
      EndIf
    Else
        CHANNELS_ALLOCATED=False
    EndIf
  EndIf

If CHANNELS_ALLOCATED=False
  xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
  xc$=GetCatStr{catalog.l,100011,"Ponow probe|Przeskocz..."}
  xb$=GetCatStr{catalog.l,40006,"Nie moge zaalokowac kanalow dzwiekowych!"}

  If Request (xa$,xb$,xc$)=1 Then xa$="" : xb$="" : xc$="" : Goto ALLOC_CH
   xa$="" : xb$="" : xc$=""
EndIf

Return

.DEALLOC_CH
  If CHANNELS_ALLOCATED=True
      x=CloseDevice_ (&audio_req)
      CHANNELS_ALLOCATED=False
  EndIf
Return

.AHI_REQUEST

  ; AHI_REQUEST_MODE.l
  ; AHI_REQUEST_FREQ.l


  AHI_REQUEST_TITLE$="PAPLO"
  AHI_REQUEST_OK$="Taski"
  AHI_REQUEST_CANCEL$="Amiga"

  DEFTYPE .Library *AHIBase
  DEFTYPE .MsgPort *AHImp
  DEFTYPE .AHIRequest *AHIio

  AHIDevice.b=-1
  *AHImp=0 : *AHIio=0

  ;ReqFilterTags
  Dim ReqFilterTags.TagItem(1)
  ReqFilterTags(0)\ti_Tag=#AHIDB_Realtime,1
  ReqFilterTags(1)\ti_Tag=#TAG_END,0
  DEFTYPE .AHIAudioModeRequester *req
  DEFTYPE .b AHI_REQUEST_RES
  AHI_REQUEST_RES.b=0

  ; Main

  *AHImp=CreateMsgPort("")
  If *AHImp
    *AHIio=CreateIORequest_(*AHImp,SizeOf.AHIRequest)
    *AHIio\ahir_Version=1
    AHIDevice=OpenDevice_("ahi.device",#AHI_NO_UNIT,*AHIio,0)

    DEFTYPE.Library *AHIBase
    *AHIBase=*AHIio\ahir_Std\io_Device

    Dim AARTags.TagItem(3)
    AARTags(0)\ti_Tag=#AHIR_SleepWindow,1
    AARTags(1)\ti_Tag=#AHIR_UserData,999
    AARTags(2)\ti_Tag=#AHIR_Screen,ActiveScreen
    AARTags(3)\ti_Tag=#TAG_END,0

    GetReg a6,*AHIBase
    GetReg a0,&AARTags(0)
    JSR -$78(a6)
    PutReg d0,*req

    Dim AR.TagItem(10)
    AR(00)\ti_Tag=#AHIR_TitleText,&TITLE$
    AR(01)\ti_Tag=#AHIR_PositiveText,&OK$
    AR(02)\ti_Tag=#AHIR_NegativeText,&CANCEL$
    AR(03)\ti_Tag=#AHIR_DoMixFreq,1
    AR(04)\ti_Tag=#AHIR_DoDefaultMode,1
    AR(05)\ti_Tag=#AHIR_InitialAudioID,AHI_REQUEST_MODE.l
    AR(06)\ti_Tag=#AHIR_InitialMixFreq,AHI_REQUEST_FREQ.l
    AR(07)\ti_Tag=#AHIR_FilterTags,&ReqFilterTags(0)
    AR(08)\ti_Tag=#AHIR_InitialInfoOpened,1
    AR(09)\ti_Tag=#AHIR_InitialInfoLeftEdge,340
    AR(10)\ti_Tag=#TAG_END,0

    ; AudioModeRequester
    GetReg a6,*AHIBase
    GetReg a0,*req
    GetReg a1,&AR(0)
    JSR -$7e(a6)
    PutReg d0,AHI_REQUEST_RES.b

    If AHI_REQUEST_RES.b=1
      SEL_AHI_AUDIO.l=*req\ahiam_AudioID
      SEL_AHI_FREQ.l=*req\ahiam_MixFreq
    EndIf

    ; FreeAudioModeRequest
    GetReg a6,*AHIBase
    GetReg a0,*req
    JSR -$84(a6)
  EndIf

  CloseDevice_ *AHIio
  DeleteIORequest_ *AHIio
  DeleteMsgPort *AHImp

Return


.
.__CONFIGI__


.LOAD_HISTORY
  If Exists("AntyDresiarz.history")
    FOpen_ {#AD_PREFS,"AntyDresiarz.history",#MODE_OLDFILE}
    Repeat
      a$=Edit_{#AD_PREFS}
      LINK_HISTORY(Val(a$))=1
    Until Eof_{#AD_PREFS}
    FClose_{#AD_PREFS}
  EndIf
Return

.SAVE_HISTORY
  If Exists("AntyDresiarz.history") Then DeleteFile_ "AntyDresiarz.history"
  x=OpenFile(2,"AntyDresiarz.history")
  If x
    FileOutput 2
    For X=0 To 1000
      If LINK_HISTORY(X)=1 Then NPrint Str$(X)
    Next X
    CloseFile 2
  Else
    Request "AD Error...","Can't save AntyDresiarz history file","Ok"
  EndIf
Return

.LINK_FILE  ; --- laduje informacje potrzebne do odpalenia maga
  x=FileLoad{MENU_LINK_FILE$,"LOAD_TEXT",#AD_DATA,MENU_LINK_START.l,MENU_LINK_LENGTH.l}
  If Exists(TEMP_DIR$+"ANTYDRESIARZ-ARTEK")
    FOpen_ {#AD_PREFS,TEMP_DIR$+"ANTYDRESIARZ-ARTEK",#MODE_OLDFILE}
    Repeat
      LNK$=Edit_{#AD_PREFS}
      x1=Instr(LNK$,";") : x2=Instr(LNK$,";",x1+1) : x3=Instr(LNK$,";",x2+1) : x4=Instr(LNK$,";",x3+1)
      LNK=ValLong_{ Left$(LNK$,x1-1) }

      ART$=Mid$(LNK$,x1+1,x2-x1-1)
      AMODE$=Left$(ART$,4)
      p1=Instr(ART$,",") : p2=Instr(ART$,",",p1+1)

      If AMODE$="DATA"
        ARTICLE_START.l(LNK)=ValLong_{ Mid$(ART$,p1+1,p2-p1) }
        ARTICLE_LENGTH.l(LNK)=ValLong_{ Mid$(ART$,p2+1,Len(ART$)-p2) }
        ARTICLE_FILE$(LNK)=""
      Else
        ARTICLE_FILE$(LNK)=Mid$(ART$,p1+1,Len(ART$)-p1)
        ARTICLE_START.l(LNK)=0
        ARTICLE_LENGTH.l(LNK)=0
      EndIf
      ARTICLE_PICTURES$(LNK)=Mid$(LNK$,x2+1,x3-x2-1)
      ARTICLE_CHUNKY$(LNK) =Mid$(LNK$,x3+1,x4-x2-1)
    Until Eof_{#AD_PREFS}
    FClose_{#AD_PREFS}
    If Exists(TEMP_DIR$+"ANTYDRESIARZ-ARTEK") Then DeleteFile_ TEMP_DIR$+"ANTYDRESIARZ-ARTEK"
  EndIf
Return

.START_DATA  ; --- laduje informacje potrzebne do odpalenia maga

  x=FileLoad{START_DATA_FILE$,"START_DATA",#AD_DATA,START_DATA_START.l,START_DATA_LENGTH.l}

  If Exists(TEMP_DIR$+"START.DATA")
  FOpen_ {#AD_PREFS,TEMP_DIR$+"START.DATA",#MODE_OLDFILE}

  Repeat

    ART$=Edit_{#AD_PREFS}
    ART_NAGLOWEK$=UCase$(Left$(ART$,Instr(ART$,";")-1)) : ART_DATA$=Right$(ART$, Len(ART$)-Instr(ART$,";") )

; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= DATA -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

    If ART_NAGLOWEK$="DATAFILE"
      OD=0
      Repeat
        OD=Instr(ART_DATA$,";")

        If OD>0
          DFILE$=Left$(ART_DATA$,OD-1)
          DFILE_NAGL$=UCase$(Left$(DFILE$,Instr(DFILE$,"=")))
          DFILE_DATA$=Right$(DFILE$,Len(DFILE$)-Instr(DFILE$,"="))
          ART_DATA$=Right$(ART_DATA$,Len(ART_DATA$)-OD)
          Select DFILE_NAGL$
            Case "LINK_FILE="
              x1=Instr(DFILE_DATA$,",")
              x2=Instr(DFILE_DATA$,",",x1+1)
              MENU_LINK_START.l = ValLong_{ Left$(DFILE_DATA$,x1-1) }
              MENU_LINK_LENGTH.l= ValLong_{ Mid$(DFILE_DATA$,x1+1,Len(DFILE_DATA$)-1) }
              MENU_LINK_FILE$=""
            Case "MODULE="
              x1=Instr(DFILE_DATA$,",")
              x2=Instr(DFILE_DATA$,",",x1+1)
              x3=Instr(DFILE_DATA$,",",x2+1)

              MODULE_NUMBER.l                  = ValLong_{ Left$(DFILE_DATA$,x1-1) }
              MODULE_START.l (MODULE_NUMBER.l) = ValLong_{ Mid$(DFILE_DATA$,x1+1,x2-x1-1) }
              MODULE_LENGTH.l(MODULE_NUMBER.l) = ValLong_{ Mid$(DFILE_DATA$,x2+1,x3-x2-1) }
              MODULE_NAME$   (MODULE_NUMBER.l) = Right$(DFILE_DATA$,Len(DFILE_DATA$)-x3)
              MODULE_FILE$   (MODULE_NUMBER.l) = ""
            Case "DEMO_PIC="
              x1=Instr(DFILE_DATA$,",")
              x2=Instr(DFILE_DATA$,",",x1+1)
              DEMO_NUMBER.l                = ValLong_{ Left$(DFILE_DATA$,x1-1) }
              DEMO_START.l (DEMO_NUMBER.l) = ValLong_{ Mid$(DFILE_DATA$,x1+1,x2-x1) }
              DEMO_LENGTH.l(DEMO_NUMBER.l) = ValLong_{ Mid$(DFILE_DATA$,x2+1,Len(DFILE_DATA$)-x2) }
              DEMO_FILE$   (DEMO_NUMBER.l) = ""
            Case "PATTERN="
              x1 = Instr(DFILE_DATA$,",")
              x2 = Instr(DFILE_DATA$,",",x1+1)

              PATTERN_NUMBER.l                   = ValLong_{ Left$(DFILE_DATA$,x1-1) }
              PATTERN_START.l (PATTERN_NUMBER.l) = ValLong_{ Mid$(DFILE_DATA$,x1+1,x2-x1) }
              PATTERN_LENGTH.l(PATTERN_NUMBER.l) = ValLong_{ Mid$(DFILE_DATA$,x2+1,Len(DFILE_DATA$)-x2) }
              PATTERN_FILE$   (PATTERN_NUMBER.l) = ""
            Case "MENU="
              x1 = Instr(DFILE_DATA$,",")
              x2 = Instr(DFILE_DATA$,",",x1+1)
              MENU_NUMBER.l                = ValLong_{ Left$(DFILE_DATA$,x1-1) }
              MENU_START.l (MENU_NUMBER.l) = ValLong_{ Mid$(DFILE_DATA$,x1+1,x2-x1) }
              MENU_LENGTH.l(MENU_NUMBER.l) = ValLong_{ Mid$(DFILE_DATA$,x2+1,Len(DFILE_DATA$)-x2) }
              MENU_FILE$   (MENU_NUMBER.l) = ""
            Case "GADGET="
              x1 = Instr(DFILE_DATA$,",")
              x2 = Instr(DFILE_DATA$,",",x1+1)
              x3 = Instr(DFILE_DATA$,",",x2+1)
              GADGET_NUMBER.l                  = ValLong_{ Left$(DFILE_DATA$,x1-1) }
              GADGET_FRAMES  (GADGET_NUMBER.l) = ValLong_{ Mid$(DFILE_DATA$,x1+1,x2-x1) }
              GADGET_START.l (GADGET_NUMBER.l) = ValLong_{ Mid$(DFILE_DATA$,x2+1,x3-x2) }
              GADGET_LENGTH.l(GADGET_NUMBER.l) = ValLong_{ Mid$(DFILE_DATA$,x3+1,Len(DFILE_DATA$)-x3) }
              GADGET_FILE$   (GADGET_NUMBER.l) = ""
          End Select
        EndIf
      Until OD=0
    EndIf

; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= NORMAL -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=


    If ART_NAGLOWEK$="NORMFILE"

      OD=0
      Repeat
        OD=Instr(ART_DATA$,";")

        If OD>0
          DFILE$=Left$(ART_DATA$,OD-1)
          DFILE_NAGL$=UCase$(Left$(DFILE$,Instr(DFILE$,"=")))
          DFILE_DATA$=Right$(DFILE$,Len(DFILE$)-Instr(DFILE$,"=")  )
          ART_DATA$=Right$(ART_DATA$,Len(ART_DATA$)-OD)
          Select DFILE_NAGL$
            Case "LINK_FILE="
              MENU_LINK_START.l = 0
              MENU_LINK_LENGTH.l= 0
              MENU_LINK_FILE$   = DFILE_DATA$

            Case "MODULE="
              x1=Instr(DFILE_DATA$,",")
              x2=Instr(DFILE_DATA$,",",x1+1)
              MODULE_NUMBER.l               = ValLong_{ Left$(DFILE_DATA$,x1-1) }
              MODULE_FILE$(MODULE_NUMBER.l) = "MUZYKA/" + Mid$(DFILE_DATA$,x1+1,x2-x1-1)
              MODULE_NAME$(MODULE_NUMBER.l) = Right$(DFILE_DATA$,Len(DFILE_DATA$)-x2)
            Case "DEMO_PIC="
              x1=Instr(DFILE_DATA$,",")
              DEMO_NUMBER.l             = ValLong_{Left$(DFILE_DATA$,x1-1)}
              DEMO_FILE$(DEMO_NUMBER.l) = Right$(DFILE_DATA$,Len(DFILE_DATA$)-x1)
            Case "PATTERN="
              x1=Instr(DFILE_DATA$,",")
              PATTERN_NUMBER.l                = ValLong_{Left$(DFILE_DATA$,x1-1)}
              PATTERN_FILE$(PATTERN_NUMBER.l) = Right$(DFILE_DATA$,Len(DFILE_DATA$)-x1)
            Case "MENU="
              x=Instr(DFILE_DATA$,",")
              MENU_NUMBER.l             = ValLong_{Left$(DFILE_DATA$,x-1)}
              MENU_FILE$(MENU_NUMBER.l) = Right$(DFILE_DATA$,Len(DFILE_DATA$)-x)
            Case "GADGET="
              x=Instr(DFILE_DATA$,",")
              x1=Instr(DFILE_DATA$,",",x+1)
              GADGET_NUMBER.l                = ValLong_{Left$(DFILE_DATA$,x-1)}
              GADGET_FRAMES(GADGET_NUMBER.l) = ValLong_{Mid$(DFILE_DATA$,x+1,x1-x)}
              GADGET_FILE$(GADGET_NUMBER.l)  = Right$(DFILE_DATA$,Len(DFILE_DATA$)-x1)
          End Select
        EndIf
      Until OD=0

    EndIf

; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= DEMO PICS -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

    If ART_NAGLOWEK$="DEMO_PICS"
      DEMO_PICS=ValLong_{ART_DATA$}
    EndIf

; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= MENU CHUNKY -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

    If ART_NAGLOWEK$="MENU_CHUNKY"
      MENU_CHUNKY$=ART_DATA$
    EndIf

; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= MENU PLANAR -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

    If ART_NAGLOWEK$="MENU_PLANAR"
      MENU_PICTURES$=ART_DATA$
    EndIf

; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- GADGETS -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

    If ART_NAGLOWEK$="ZONE"
      OD=Instr(ART_DATA$,";")
      If OD>0

        DFILE$=Left$(ART_DATA$,OD-1)
        ZONE_NUM=ValLong_{UCase$(Left$(DFILE$,Instr(DFILE$,"=")))}
        DFILE_DATA$=Right$(DFILE$,Len(DFILE$)-Instr(DFILE$,"=")  )
        ART_DATA$=Right$(ART_DATA$,Len(ART_DATA$)-OD)

        x=Instr(DFILE_DATA$,",") : x2=Instr(DFILE_DATA$,",",x+1) : x3=Instr(DFILE_DATA$,",",x2+1)
        ZX=ValLong_{Left$(DFILE_DATA$,x-1)}
        ZY=ValLong_{ Mid$(DFILE_DATA$,x+1,x2-x)  }
        ZW=ValLong_{ Mid$(DFILE_DATA$,x2+1,x3-x2)  }
        ZH=ValLong_{ Mid$(DFILE_DATA$,x3+1,Len(DFILE_DATA$)-x3 )  }

        If PRE_SCALE=1 Then ZY=ZY*2 : ZH=ZH*2

        SetZone ZONE_NUM,ZX,ZY,ZX+ZW,ZY+ZH
      EndIf
    EndIf

  Until Eof_{#AD_PREFS}
  FClose_{#AD_PREFS}
  DeleteFile_ TEMP_DIR$+"START.DATA"
  EndIf

Return

.WCZYTAJ_PREFS

  If Exists("PREFS.PRE")
  FOpen_ {#AD_PREFS,"PREFS.PRE",#MODE_OLDFILE}

  Repeat

  a$=Edit_{#AD_PREFS}
  PREFS_KLUCZ$=UCase$(Left$(a$,Instr(a$,"=")))
  PREFS_DATA$=Right$(a$,Len(a$)-Instr(a$,"="))

  Select PREFS_KLUCZ$
    Case "KEY="
      nr=ValLong_{Left$(PREFS_DATA$,Instr(PREFS_DATA$,",")-1)}
      AD_KEY(nr)=ValLong_{Right$(PREFS_DATA$,Len(PREFS_DATA$)-Instr(PREFS_DATA$,","))}
    Case "FONT="
      nr=ValLong_{Left$(PREFS_DATA$,Instr(PREFS_DATA$,",")-1)}
      PRE_FONT$(nr)= Right$(PREFS_DATA$,Len(PREFS_DATA$)-Instr(PREFS_DATA$,","))
    Case "FONTSIZE="
      nr=ValLong_{Left$(PREFS_DATA$,Instr(PREFS_DATA$,",")-1)}
      PRE_FONT_SIZE(nr)=ValLong_{Right$(PREFS_DATA$,Len(PREFS_DATA$)-Instr(PREFS_DATA$,","))}
    Case "OPEN_ON_WB="
      PRE_OPEN_ON_WB=ValLong_{PREFS_DATA$}
    Case "DOUBLE_HEIGHT="
      PRE_SCALE=ValLong_{PREFS_DATA$}
    Case "GRAYSCALE="
      PRE_GRAYSCALE=ValLong_{PREFS_DATA$}
    Case "SMARTREFRESH="
      PRE_SMART_REFRESH=ValLong_{PREFS_DATA$}
    Case "MODE_ID="
      PRE_MODE_ID.l=ValLong_{PREFS_DATA$}
    Case "AHI_MODE_ID="
      PRE_AHI_MODE_ID.l=ValLong_{PREFS_DATA$}
    Case "AHI_FREQUENCY="
      PRE_AHI_FREQUENCY.l=ValLong_{PREFS_DATA$}
    Case "AHI_AUTOBOOST="
      PRE_AHI_AUTOBOOST=ValLong_{PREFS_DATA$}
    Case "OCTAMED_HQ="
      PRE_OCTAMED_HQ=ValLong_{PREFS_DATA$}
    Case "OCTAMIX_FREQ="
      PRE_OCTAMIX_FREQ.l=ValLong_{PREFS_DATA$}
    Case "OCTAMIX_14B="
      PRE_OCTAMIX_14B=ValLong_{PREFS_DATA$}
    Case "DEMO_MODULE="
      PRE_DEMO_MODULE$=PREFS_DATA$
    Case "START_DATA="
      START_DATA_START.l=ValLong_{Left$(PREFS_DATA$,Instr(PREFS_DATA$,",")-1)}
      START_DATA_LENGTH.l=ValLong_{Right$(PREFS_DATA$,Len(PREFS_DATA$)-Instr(PREFS_DATA$,","))}
      If START_DATA_LENGTH.l>0
        START_DATA_FILE$=""
      Else
        START_DATA_FILE$="PLIK"
      EndIf
    Case "TEMPDIR="
      GLOWNY_TEMP_DIR$=PREFS_DATA$
      TEMP_DIR$=GLOWNY_TEMP_DIR$+"AD_TMP/"
    Case "COLOR="
      c1=Instr(PREFS_DATA$,",") : c2=Instr(PREFS_DATA$,",",c1+1) : c3=Instr(PREFS_DATA$,",",c2+1)
      nr=ValLong_{Left$(PREFS_DATA$,c1)}
      PRE_R(nr)=ValLong_{ Mid$(PREFS_DATA$,c1+1,c2-c1) }
      PRE_G(nr)=ValLong_{ Mid$(PREFS_DATA$,c2+1,c3-c2) }
      PRE_B(nr)=ValLong_{ Mid$(PREFS_DATA$,c3+1,Len(PREFS_DATA$)-c3)}
    Case "PEN_DARK="
      PRE_PEN_DARK=ValLong_{PREFS_DATA$}
    Case "PEN_BRIGHT="
      PRE_PEN_BRIGHT=ValLong_{PREFS_DATA$}
    Case "PEN_SELECTED="
      PRE_PEN_SELECTED=ValLong_{PREFS_DATA$}
    Case "PEN_BACKGROUND="
      PRE_PEN_BACKGROUND=ValLong_{PREFS_DATA$}
    Case "PEN_FILLPEN="
      PRE_PEN_FILLPEN=ValLong_{PREFS_DATA$}
    Case "PEN_TEXT="
      PRE_PEN_TEXT=ValLong_{PREFS_DATA$}
    Case "TEXT_WINDOW_X="
      PRE_TEXT_WINDOW_X=ValLong_{PREFS_DATA$}
    Case "TEXT_WINDOW_Y="
      PRE_TEXT_WINDOW_Y=ValLong_{PREFS_DATA$}
    Case "TEXT_WINDOW_W="
      PRE_TEXT_WINDOW_W=ValLong_{PREFS_DATA$}
    Case "TEXT_WINDOW_H="
      PRE_TEXT_WINDOW_H=ValLong_{PREFS_DATA$}
    Case "GADGET_PREFS="
      PRE_GADGET_PREFS=ValLong_{PREFS_DATA$}
    Case "GADGET_MUSIC="
      PRE_GADGET_MUSIC=ValLong_{PREFS_DATA$}
    Case "GADGET_LEFT="
      PRE_GADGET_LEFT=ValLong_{PREFS_DATA$}
    Case "GADGET_RIGHT="
      PRE_GADGET_RIGHT=ValLong_{PREFS_DATA$}
    Case "GADGET_UP="
      PRE_GADGET_UP=ValLong_{PREFS_DATA$}
    Case "GADGET_DOWN="
      PRE_GADGET_DOWN=ValLong_{PREFS_DATA$}
    Case "GADGET_EXIT="
      PRE_GADGET_EXIT=ValLong_{PREFS_DATA$}
    Case "GADGET_SCREEN="
      PRE_GADGET_SCREEN=ValLong_{PREFS_DATA$}
    Case "GADGET_MENU="
      PRE_GADGET_MENU=ValLong_{PREFS_DATA$}
    Case "GADGET_SPEAK="
      PRE_GADGET_SPEAK=ValLong_{PREFS_DATA$}
    Case "POSITION_SHORT="
      x1=Instr(PREFS_DATA$,",") : x2=Instr(PREFS_DATA$,",",x1+1) : x3=Instr(PREFS_DATA$,",",x2+1)
      PRE_SHORT_X=ValLong_{ Mid$(PREFS_DATA$,0,x1-1) }
      PRE_SHORT_Y=ValLong_{ Mid$(PREFS_DATA$,x1+1,x2-x1-1) }
      PRE_SHORT_W=ValLong_{ Mid$(PREFS_DATA$,x2+1,x3-x2-1) }
      PRE_SHORT_H=ValLong_{ Mid$(PREFS_DATA$,x3+1,Len(PREFS_DATA$)-x2-1) }
    Case "POSITION_TIME="
      x1=Instr(PREFS_DATA$,",") : x2=Instr(PREFS_DATA$,",",x1+1) : x3=Instr(PREFS_DATA$,",",x2+1)
      PRE_TIME_X=ValLong_{ Mid$(PREFS_DATA$,0,x1-1) }
      PRE_TIME_Y=ValLong_{ Mid$(PREFS_DATA$,x1+1,x2-x1-1) }
      PRE_TIME_W=ValLong_{ Mid$(PREFS_DATA$,x2+1,x3-x2-1) }
      PRE_TIME_H=ValLong_{ Mid$(PREFS_DATA$,x3+1,Len(PREFS_DATA$)-x2-1) }
    Case "POSITION_PAGE="
      x1=Instr(PREFS_DATA$,",") : x2=Instr(PREFS_DATA$,",",x1+1) : x3=Instr(PREFS_DATA$,",",x2+1)
      PRE_PAGE_X=ValLong_{ Mid$(PREFS_DATA$,0,x1-1) }
      PRE_PAGE_Y=ValLong_{ Mid$(PREFS_DATA$,x1+1,x2-x1-1) }
      PRE_PAGE_W=ValLong_{ Mid$(PREFS_DATA$,x2+1,x3-x2-1) }
      PRE_PAGE_H=ValLong_{ Mid$(PREFS_DATA$,x3+1,Len(PREFS_DATA$)-x2-1) }

    Case "PEN_PAGE="
      PRE_PEN_PAGE=ValLong_{PREFS_DATA$}
    Case "PEN_SHORT="
      PRE_PEN_SHORT=ValLong_{PREFS_DATA$}
    Case "PEN_TIME="
      PRE_PEN_TIME=ValLong_{PREFS_DATA$}
    Case "PEN_MENU="
      PRE_PEN_MENU=ValLong_{PREFS_DATA$}
    Case "PEN_MENU_INV="
      PRE_PEN_MENU_INV=ValLong_{PREFS_DATA$}
    Case "PEN_ARTICLE="
      PRE_PEN_ARTICLE=ValLong_{PREFS_DATA$}

    Case "PEN_LINK_INV="
      PRE_PEN_LINK_INV=ValLong_{PREFS_DATA$}
    Case "PEN_LINK_READED="
      PRE_PEN_LINK_READED=ValLong_{PREFS_DATA$}



    Case "TRUE_COLOR="
      PRE_TRUE_COLOR=ValLong_{PREFS_DATA$}
      If PRE_TRUE_COLOR=1 AND cgxbase.l=0

        xa$=GetCatStr{catalog.l,110000,"AD Blad..."}
        xc$=GetCatStr{catalog.l,100000,"Ok!"}
        xx$="Nie moge odpalic AntyDresiarza w trybie TrueColor,"+Chr$(10)+"poniewaz nie moge otworzyc systemu CyberGraphX"
        xx$=xx$+Chr$(10)+Chr$(10)+"Magazyn zostanie odpalony w trybie AGA!"
        xb$=GetCatStr{catalog.l,60000,xx$}
        xx$=""
        Request xa$,xb$,xc$
        xa$="" : xb$="" : xc$=""
        PRE_TRUE_COLOR=0
      EndIf


  End Select

  Until Eof_{#AD_PREFS}

  If PRE_TRUE_COLOR=1 Then PRE_SCALE=1

  FClose_{#AD_PREFS}

  Else
    Request "AD Error...","Can't open prefs file!","OK"
  EndIf
Return

.ZAPISZ_PREFS
  If Exists("PREFS.PRE") Then DeleteFile_ "PREFS.PRE"
  x=OpenFile(2,"PREFS.PRE")

  If x
  FileOutput 2

    For x=1 To 10
      NPrint "FONT=",x,",",PRE_FONT$(x) : NPrint "FONTSIZE=",x,",",PRE_FONT_SIZE(x)
    Next x
    NPrint "OPEN_ON_WB="        ,PRE_OPEN_ON_WB
    NPrint "DOUBLE_HEIGHT="     ,PRE_SCALE
    NPrint "TRUE_COLOR="        ,PRE_TRUE_COLOR
    NPrint "GRAYSCALE="         ,PRE_GRAYSCALE
    NPrint "SMARTREFRESH="      ,PRE_SMART_REFRESH
    NPrint "MODE_ID="           ,Str$(PRE_MODE_ID.l)
    NPrint "AHI_MODE_ID="       ,Str$(PRE_AHI_MODE_ID.l)
    NPrint "AHI_FREQUENCY="     ,Str$(PRE_AHI_FREQUENCY.l)
    NPrint "AHI_AUTOBOOST="     ,Str$(PRE_AHI_AUTOBOOST)
    NPrint "OCTAMED_HQ="        ,Str$(PRE_OCTAMED_HQ)
    NPrint "OCTAMIX_FREQ="      ,Str$(PRE_OCTAMIX_FREQ.l)
    NPrint "OCTAMIX_14B="       ,Str$(PRE_OCTAMIX_14B)


    NPrint "TEMPDIR="           ,GLOWNY_TEMP_DIR$
    NPrint "DEMO_MODULE="       ,PRE_DEMO_MODULE$
    NPrint "START_DATA="        ,START_DATA_START.l,",",START_DATA_LENGTH.l

    NPrint "KEY=1,",AD_KEY(1)," ; Next Page"
    NPrint "KEY=2,",AD_KEY(2)," ; Prev Page"
    NPrint "KEY=3,",AD_KEY(3)," ; Next Article"
    NPrint "KEY=4,",AD_KEY(4)," ; Prev Article"
    NPrint "KEY=5,",AD_KEY(5)," ; Goto Menu"
    NPrint "KEY=6,",AD_KEY(6)," ; Music Menu"
    NPrint "KEY=7,",AD_KEY(7)," ; Prefs Menu"
    NPrint "KEY=8,",AD_KEY(8)," ; Quit"

  NPrint "PEN_DARK="            ,PRE_PEN_DARK
  NPrint "PEN_BRIGHT="          ,PRE_PEN_BRIGHT
  NPrint "PEN_SELECTED="        ,PRE_PEN_SELECTED
  NPrint "PEN_BACKGROUND="      ,PRE_PEN_BACKGROUND
  NPrint "PEN_FILLPEN="         ,PRE_PEN_FILLPEN
  NPrint "PEN_TEXT="            ,PRE_PEN_TEXT

  NPrint "TEXT_WINDOW_X="       ,PRE_TEXT_WINDOW_X
  NPrint "TEXT_WINDOW_Y="       ,PRE_TEXT_WINDOW_Y
  NPrint "TEXT_WINDOW_W="       ,PRE_TEXT_WINDOW_W
  NPrint "TEXT_WINDOW_H="       ,PRE_TEXT_WINDOW_H
  NPrint "GADGET_PREFS="        ,PRE_GADGET_PREFS
  NPrint "GADGET_MUSIC="        ,PRE_GADGET_MUSIC
  NPrint "GADGET_LEFT="         ,PRE_GADGET_LEFT
  NPrint "GADGET_RIGHT="        ,PRE_GADGET_RIGHT
  NPrint "GADGET_UP="           ,PRE_GADGET_UP
  NPrint "GADGET_DOWN="         ,PRE_GADGET_DOWN
  NPrint "GADGET_EXIT="         ,PRE_GADGET_EXIT
  NPrint "GADGET_SCREEN="       ,PRE_GADGET_SCREEN
  NPrint "GADGET_MENU="         ,PRE_GADGET_MENU
  NPrint "GADGET_SPEAK="        ,PRE_GADGET_SPEAK

  NPrint "POSITION_SHORT="      ,PRE_SHORT_X,",",PRE_SHORT_Y,",",PRE_SHORT_W,",",PRE_SHORT_H
  NPrint "POSITION_TIME="       ,PRE_TIME_X,",",PRE_TIME_Y,",",PRE_TIME_W,",",PRE_TIME_H
  NPrint "POSITION_PAGE="       ,PRE_PAGE_X,",",PRE_PAGE_Y,",",PRE_PAGE_W,",",PRE_PAGE_H

  NPrint "PEN_PAGE="            ,PRE_PEN_PAGE
  NPrint "PEN_SHORT="           ,PRE_PEN_SHORT
  NPrint "PEN_TIME="            ,PRE_PEN_TIME
  NPrint "PEN_MENU="            ,PRE_PEN_MENU
  NPrint "PEN_MENU_INV="        ,PRE_PEN_MENU_INV
  NPrint "PEN_ARTICLE="         ,PRE_PEN_ARTICLE

  NPrint "PEN_LINK_INV="        ,PRE_PEN_LINK_INV
  NPrint "PEN_LINK_READED="     ,PRE_PEN_LINK_READED


  For fp=0 To 23
    NPrint "COLOR="             ,Str$(fp),",",Str$(PRE_R(fp)),",",Str$(PRE_G(fp)),",",Str$(PRE_B(fp))
  Next fp

  CloseFile 2
  Else
    Request "AD Error...","Can't save preferences!","Ok!"
  EndIf
Return

.

.___OTHERS___


.HARD_CONFIG

  Dim HC$(100)

  HC$(0)="Antydresiarz Issue #4 Auto Config Tester is checking yours Amiga!"
  HC$(1)=""

  *pap.ExecBase=OpenLibrary_("exec.library",0)
  HC$(2)="CPU:                 "+"680"+Str$(CPU{})+"0"
  CL.l=AvailMem_(#MEMF_CHIP|#MEMF_LARGEST)
  HC$(3)="Chip:                "+Str$(AvailMem_(#MEMF_CHIP|#MEMF_TOTAL))+" b (Largest free: "+Str$(CL.l)+")"
  FL.l=AvailMem_(#MEMF_FAST|#MEMF_LARGEST)
  HC$(4)="Fast:                "+Str$(AvailMem_(#MEMF_FAST|#MEMF_TOTAL))+" b (Largest free: "+Str$(FL.l)+")"
  If CheckAGA=True : x$="AGA" : Else : x$="ECS" : EndIf
  If cgxbase.l>0
    *cg.Library=cgfx.l
    x$="CyberGraphX (v"+Str$(*cg.Library\lib_Version)+"."+Str$(*cg.Library\lib_Revision)+")"
  EndIf
  HC$(5)="GFX:                 "+x$

  exv=*pap.ExecBase\LibNode\lib_Version
  If exv=34 Then aosv$="1.3 (v"+Str$(exv)+"."+Str$(*pap.ExecBase\LibNode\lib_Revision)+")"
  If exv=37 Then aosv$="2.0 (v"+Str$(exv)+"."+Str$(*pap.ExecBase\LibNode\lib_Revision)+")"
  If exv=39 Then aosv$="3.0 (v"+Str$(exv)+"."+Str$(*pap.ExecBase\LibNode\lib_Revision)+")"
  If exv=40 Then aosv$="3.1 (v"+Str$(exv)+"."+Str$(*pap.ExecBase\LibNode\lib_Revision)+")"
  If exv>40 Then aosv$="3.x (v"+Str$(exv)+"."+Str$(*pap.ExecBase\LibNode\lib_Revision)+")"

  HC$(6)="AmigaOS:             "+aosv$
  HC$(7)="VBlank Freq:         "+Str$(*pap.ExecBase\VBlankFrequency)+" Hz"
  HC$(8)="Power Supply Freq:   "+Str$(*pap.ExecBase\PowerSupplyFrequency)+" Hz"
  HC$(9)="EClock Freq:         "+Str$(*pap.ExecBase\ex_EClockFrequency)+" Hz"

  DEFTYPE .BoardInfo *boards
  *boards=AllocBoardInfo_(0)
  If *boards>0
    HC$(10)=""
    HC$(11)="Extension boards:"
    HC=12
    configdev.l=NextBoardInfo_ (*boards,0)
    While configdev.l
      HC$(HC)=PeekTo$(*boards\bi_ProdName,0)+" "+PeekTo$(*boards\bi_ManuName,0)+" ("+PeekTo$(*boards\bi_ExSize,0)+")"
      configdev.l=NextBoardInfo_ (*boards,configdev.l)
      HC=HC+1
    Wend
    HC=HC-1
    FreeBoardInfo_ *boards
  EndIf

; ---------- WYSWIETLENIE

  DEFTYPE .Screen scrdata
  *scrdata.Screen=Peek.l(Addr Screen(0))
  fy=*scrdata\_RastPort\TxHeight+1
  fx=*scrdata\_RastPort\TxWidth

  width=IFF_Width {?_TASKI_LOGO}
  height=IFF_Height {?_TASKI_LOGO}

  BitMap 0,width,height,2
  DecodeILBM 0,?_TASKI_LOGO

  NAJSZER=Len(HC$(0))*fx
  For x=1 To HC
    If Len(HC$(x))*fx>NAJSZER Then NAJSZER=Len(HC$(0))*fx
  Next x


  wx=(ScrWidth{0}-NAJSZER+(WBorLeft{0}*2))/2
  wy=(ScrHeight{0}-(HC*fy)+(WBorAbove{0}*2))/2

  Window 0,wx,wy,NAJSZER+(WBorLeft{0}*2),(HC*fy)+(WBorAbove{0}*2),0,"",0,1
  WJam 0

  BitMaptoWindow 0,0,0,0,WLeftOff+InnerWidth-width,WBorAbove{0}+fy,width,height
  Free BitMap 0

  For x=0 To HC
    NPrint HC$(x)
  Next x

  VWait 200
  CloseWindow 0

Return

.CZAS
  H=Hours : H$=Right$("00",2-Len(Str$(H)))+Str$(H)
  M=Mins : M$=Right$("00",2-Len(Str$(M)))+Str$(M)
  S=Secs : S$=Right$("00",2-Len(Str$(S)))+Str$(S)

  If S<>OLD_SEK
    OLD_SEK=S

    SEK.l=S
    If (SEK.l/2)*2=S : D$=":" : Else : D$=" " : EndIf

    TIH=PRE_TIME_H : TIY=PRE_TIME_Y : If PRE_SCALE=1 Then TIY=TIY*2 : TIH=TIH*2

    If PRE_TRUE_COLOR
      chlen.l=PRE_TIME_W*TIH*3
      chbox.l=AllocMem_ (chlen.l,#MEMF_ANY|#MEMF_CLEAR)
      CX_SRCX.w=0 : CX_SRCY.w=0 : CX_SRCMOD.l=PRE_TIME_W*3
      WPA{chbox.l,RastPort(#AD_WINDOW),PRE_TIME_X,TIY,PRE_TIME_W,TIH}
      FreeMem_ chbox.l,chlen.l
    Else
      WBox PRE_TIME_X,TIY,PRE_TIME_X+PRE_TIME_W,TIY+TIH,32
    EndIf

    X=WCursX : Y=WCursY
    WindowFont #CZAS_FONT
    WJam 0

    WColour_{PRE_PEN_TIME}

    CZY=PRE_TIME_Y : If PRE_SCALE=1 Then CZY=CZY*2
    WLocate PRE_TIME_X,CZY : Print H$,D$,M$,".",S$
    WLocate X,Y
    WindowFont AKTYWNY_FONT
    WColour_{AKTYWNY_KOLOR}
    WJam AKTYWNY_JAM
  EndIf

Return

.

.PREFERENCJE

  WPointer 4 : WPOINT.b=4

  PRE_H=172
  If PRE_SCALE=1 Then PRE_H=PRE_H*2
  PRE_H=PRE_H+offb+offd

  If PRE_OPEN_ON_WB=1
    PRE_FLAGS=6+$400
    PRE_TTL$="AntyDresiarz #4 Prefs"
  Else
    PRE_FLAGS=$400+6
    PRE_TTL$="AntyDresiarz #4 Prefs"
  EndIf

  If PRE_TRUE_COLOR=1
    PD=FindColor{PRE_R(PRE_PEN_DARK),PRE_G(PRE_PEN_DARK),PRE_B(PRE_PEN_DARK)}
    PB=FindColor{PRE_R(PRE_PEN_BRIGHT),PRE_G(PRE_PEN_BRIGHT),PRE_B(PRE_PEN_BRIGHT)}
    PBA=FindColor{PRE_R(PRE_PEN_BACKGROUND),PRE_G(PRE_PEN_BACKGROUND),PRE_B(PRE_PEN_BACKGROUND)}
  Else
    PD=PRE_PEN_DARK
    PB=PRE_PEN_BRIGHT
    PBA=PRE_PEN_BACKGROUND
  EndIf


  Window #AD_WINDOW_PREFS,157,33,358+offl+offr,PRE_H,PRE_FLAGS,PRE_TTL$,PD,PB
  WCls PBA : Activate #AD_WINDOW_PREFS
;  WindowTags #AD_WINDOW_PREFS,0,"AntyDresiarz Prefs",Bank(#TAGLIST_BANK)
  WindowFont 0
  CatchDosErrs
  AttachGTList #AD_GT_PREFS,#AD_WINDOW_PREFS

  PREFS_OPEN_ON_WB=PRE_OPEN_ON_WB : GTToggle #AD_GT_PREFS,0,-PRE_OPEN_ON_WB : Redraw #AD_WINDOW_PREFS,0
  PREFS_SCALE=PRE_SCALE : GTToggle #AD_GT_PREFS,1,-PRE_SCALE : Redraw #AD_WINDOW_PREFS,1
  PREFS_GRAYSCALE=PRE_GRAYSCALE : GTToggle #AD_GT_PREFS,12,-PRE_GRAYSCALE : Redraw #AD_WINDOW_PREFS,12
  PREFS_TRUE_COLOR=PRE_TRUE_COLOR : GTToggle #AD_GT_PREFS,16,-PRE_TRUE_COLOR : Redraw #AD_WINDOW_PREFS,16
  PREFS_SMART_REFRESH=PRE_SMART_REFRESH : GTToggle #AD_GT_PREFS,13,-PRE_SMART_REFRESH : Redraw #AD_WINDOW_PREFS,13
  PREFS_SCREENMODE.l=PRE_MODE_ID.l
  PREFS_AHI_MODE_ID.l=PRE_AHI_MODE_ID.l
  PREFS_AHI_FREQUENCY.l=PRE_AHI_FREQUENCY.l
  PREFS_AHI_AUTOBOOST=PRE_AHI_AUTOBOOST

  PREFS_OCTAMED_HQ=PRE_OCTAMED_HQ
  PREFS_OCTAMIX_FREQ.l=PRE_OCTAMIX_FREQ.l
  PREFS_OCTAMIX_14B=PRE_OCTAMIX_14B

  PREFS_TEMPDIR$=GLOWNY_TEMP_DIR$
  If PREFS_TRUE_COLOR=1
    GTToggle  #AD_GT_PREFS,1,On : GTDisable #AD_GT_PREFS,1 : Redraw #AD_WINDOW_PREFS,1 : PREFS_SCALE=1
  Else
    GTEnable #AD_GT_PREFS,1 : Redraw #AD_WINDOW_PREFS,1
  EndIf
  For K=0 To 255
    PREFSY_R(K)=PRE_R(K)
    PREFSY_G(K)=PRE_G(K)
    PREFSY_B(K)=PRE_B(K)
  Next K
  For f=0 To 10
    PREFS_FONT$(f)=PRE_FONT$(f)
    PREFS_FONT_SIZE(f)=PRE_FONT_SIZE(f)
  Next f
  For f=0 To 20
    PREFS_AD_KEY(f)=AD_KEY(f)
  Next f

  GTSetString #AD_GT_PREFS,14,PREFS_TEMPDIR$
  PREFS_FONT=1
  PREFS_ZAMKNIJ=0
  PREFS_HARDCHANGE=0

  Repeat
    ev=Event  AND EventWindow=#AD_WINDOW_PREFS
    Use Window #AD_WINDOW
    Gosub CZAS : Gosub DISPLAY_ANIM
    Use Window #AD_WINDOW_PREFS

    If ev=$40
      Select GadgetHit
        Case 0
          PREFS_OPEN_ON_WB=EventCode
          PREFS_HARDCHANGE=1
        Case 1
          PREFS_SCALE=EventCode
          PREFS_HARDCHANGE=1
        Case 2
          Gosub PREFS_PALETA
        Case 3
          If PRE_TRUE_COLOR=1
            t$=   "UWAGA! UWAGA! UWAGA!"+Chr$(10)+Chr$(10)
            t$=t$+"Przy aktywnej opcji TRUE COLOR wymagany jest wybor"+Chr$(10)
            t$=t$+"trybu ekranu pracujacego przynajmniej w 15 bitach"+Chr$(10)
            t$=t$+"oraz zgodnego z systemem CyberGraphX."+Chr$(10)+Chr$(10)
            t$=t$+"Zaleca sie natomiast wybor trybu pracujacego w 24 bitach."+Chr$(10)+Chr$(10)
            t$=t$+"Wybor trybu nie umozliwiajacego otwarcie ekranu w TrueColor"+Chr$(10)
            t$=t$+"spowoduje problemy z odpaleniem magazynu!"
            x=RTEZRequest ("AD Informuje...",t$,"Ok!")
            t$=""
          EndIf
          PREFS_SCREENMODE.l=Peek.l(RTEZScreenModeRequest(GetCatStr{catalog.l,2000,"Wybierz tryb ekranu"},#SCREQF_GUIMODES))
          PREFS_HARDCHANGE=1
        Case 4
          Gosub PREFS_MUSIC
        Case 5 ; Save
          PREFS_ZAMKNIJ=5
        Case 6 ; Use
          PREFS_ZAMKNIJ=6
        Case 7 ; Cancel
          PREFS_ZAMKNIJ=7
        Case 8 ; default palette
          Gosub PALETTE_DEFAULT
        Case 9
          PREFS_FONT=EventCode+1
        Case 10
          rtFR_Sel=rtFontRequestA{"Wskaz czcionke...",PREFS_FONT$(PREFS_FONT),PREFS_FONT_SIZE(PREFS_FONT)}
          If rtFR_Sel=1
            PREFS_FONT$(PREFS_FONT)=rtFR_Name$
            PREFS_FONT_SIZE(PREFS_FONT)=rtFR_Size.w
            PREFS_HARDCHANGE=1
          EndIf
        Case 11
          Gosub PREFS_KEYS
        Case 12 ; Greyscale checkbox
          PREFS_GRAYSCALE=EventCode
        Case 13
          PREFS_SMART_REFRESH=EventCode
        Case 14
          PREFS_TEMPDIR$=GTGetString(#AD_GT_PREFS,14)
          PREFS_HARDCHANGE=1
        Case 15
          PREFS_TEMPDIR$=RTEZPathRequest(GetCatStr{catalog.l,2010,"Wskaz katalog na 'pliki wymiany'"})
          If PREFS_TEMPDIR$<>""
            GTSetString #AD_GT_PREFS,14,PREFS_TEMPDIR$
            PREFS_HARDCHANGE=1
          EndIf
        Case 16
          PREFS_TRUE_COLOR=EventCode
          If EventCode=1
            GTToggle  #AD_GT_PREFS,1,On
            GTDisable #AD_GT_PREFS,1
            Redraw #AD_WINDOW_PREFS,1
            PREFS_SCALE=1
          Else
            GTEnable #AD_GT_PREFS,1
            Redraw #AD_WINDOW_PREFS,1
          EndIf
          PREFS_HARDCHANGE=1
      End Select
    EndIf

  Until PREFS_ZAMKNIJ>0

  If PREFS_ZAMKNIJ=5                ; save
    PRE_OPEN_ON_WB=PREFS_OPEN_ON_WB
    PRE_SCALE=PREFS_SCALE
    PRE_MODE_ID.l=PREFS_SCREENMODE.l
    PRE_AHI_MODE_ID.l=PREFS_AHI_MODE_ID.l
    PRE_AHI_FREQUENCY.l=PREFS_AHI_FREQUENCY.l
    PRE_AHI_AUTOBOOST=PREFS_AHI_AUTOBOOST
    PRE_OCTAMED_HQ=PREFS_OCTAMED_HQ
    PRE_OCTAMIX_FREQ.l=PREFS_OCTAMIX_FREQ.l
    PRE_OCTAMIX_14B=PREFS_OCTAMIX_14B

    PRE_TRUE_COLOR=PREFS_TRUE_COLOR
    For f=0 To 10
      PRE_FONT$(f)=PREFS_FONT$(f)
      PRE_FONT_SIZE(f)=PREFS_FONT_SIZE(f)
    Next f
    For f=0 To 20
      AD_KEY(f)=PREFS_AD_KEY(f)
    Next f
    For K=0 To 255
      PRE_R(K)=PREFSY_R(K)
      PRE_G(K)=PREFSY_G(K)
      PRE_B(K)=PREFSY_B(K)
    Next K
    UsePalette{#AD_PALETTE}

    PRE_GRAYSCALE=PREFS_GRAYSCALE
    PRE_SMART_REFRESH=PREFS_SMART_REFRESH
    GLOWNY_TEMP_DIR$=PREFS_TEMPDIR$
    Gosub ZAPISZ_PREFS

    If PREFS_HARDCHANGE=1
      DetachGTList #AD_GT_PREFS
      CloseWindow #AD_WINDOW_PREFS
      Gosub DEINIT
      Goto ANTY_DRESIARZ_START_HERE
    EndIf

  EndIf

  If PREFS_ZAMKNIJ=6                ; use
    PRE_OPEN_ON_WB=PREFS_OPEN_ON_WB
    PRE_SCALE=PREFS_SCALE
    PRE_MODE_ID.l=PREFS_SCREENMODE.l
    PRE_AHI_MODE_ID.l=PREFS_AHI_MODE_ID.l
    PRE_AHI_FREQUENCY.l=PREFS_AHI_FREQUENCY.l
    PRE_AHI_AUTOBOOST=PREFS_AHI_AUTOBOOST
    PRE_OCTAMED_HQ=PREFS_OCTAMED_HQ
    PRE_OCTAMIX_FREQ.l=PREFS_OCTAMIX_FREQ.l
    PRE_OCTAMIX_14B=PREFS_OCTAMIX_14B

    For f=0 To 10
      PRE_FONT$(f)=PREFS_FONT$(f)
      PRE_FONT_SIZE(f)=PREFS_FONT_SIZE(f)
    Next f
    For f=0 To 20
      AD_KEY(f)=PREFS_AD_KEY(f)
    Next f
    For K=0 To 255
      PRE_R(K)=PREFSY_R(K)
      PRE_G(K)=PREFSY_G(K)
      PRE_B(K)=PREFSY_B(K)
    Next K
    UsePalette{#AD_PALETTE}

    PRE_GRAYSCALE=PREFS_GRAYSCALE
    PRE_SMART_REFRESH=PREFS_SMART_REFRESH
    PRE_TRUE_COLOR=PREFS_TRUE_COLOR
    GLOWNY_TEMP_DIR$=PREFS_TEMPDIR$

    If PREFS_HARDCHANGE=1
      DetachGTList #AD_GT_PREFS
      CloseWindow #AD_WINDOW_PREFS
      Gosub DEINIT
      Goto ANTY_DRESIARZ_START_HERE
    EndIf

  EndIf

  PREFS_ZAMKNIJ=-1

  DetachGTList #AD_GT_PREFS
  CloseWindow #AD_WINDOW_PREFS
  Use Window #AD_WINDOW

  WPointer 1 : WPOINT.b=1


Return


.MUZYKA_PREFS

  WPointer 4 : WPOINT.b=4

  MUS_H=126
  If PRE_SCALE=1 Then MUS_H=MUS_H*2
  MUS_H=MUS_H+offb+offd

  If PRE_OPEN_ON_WB=1
    MUS_FLAGS=6+$400
    MUS_TTL$="AntyDresiarz #4 Music Prefs"
  Else
    MUS_FLAGS=6+$400
    MUS_TTL$=""
  EndIf

  If PRE_TRUE_COLOR=1
    PD=FindColor{PRE_R(PRE_PEN_DARK),PRE_G(PRE_PEN_DARK),PRE_B(PRE_PEN_DARK)}
    PB=FindColor{PRE_R(PRE_PEN_BRIGHT),PRE_G(PRE_PEN_BRIGHT),PRE_B(PRE_PEN_BRIGHT)}
    PBA=FindColor{PRE_R(PRE_PEN_BACKGROUND),PRE_G(PRE_PEN_BACKGROUND),PRE_B(PRE_PEN_BACKGROUND)}
  Else
    PD=PRE_PEN_DARK
    PB=PRE_PEN_BRIGHT
    PBA=PRE_PEN_BACKGROUND
  EndIf

  AddIDCMP $10

  Window #AD_WINDOW_MUSIC,157,33,298+offl+offr,MUS_H,MUS_FLAGS,MUS_TTL$,PD,PB
  WCls PBA : Activate #AD_WINDOW_MUSIC
  WindowFont 0

  If MODULE_FORMAT$="MMD" : GTDisable #AD_GT_MUSIC,21 : Else : GTEnable #AD_GT_MUSIC,21 : EndIf
  If MODULE_PLAYING=True : GTToggle #AD_GT_MUSIC,24,Off : Else : GTToggle #AD_GT_MUSIC,24,On : EndIf

  CatchDosErrs
  AttachGTList #AD_GT_MUSIC,#AD_WINDOW_MUSIC
  Redraw #AD_WINDOW_MUSIC,21
  Redraw #AD_WINDOW_MUSIC,24
  MUSIC_PREFS_ZAMKNIJ=False

  Repeat
    ev=Event AND EventWindow=#AD_WINDOW_MUSIC
    Use Window #AD_WINDOW : Gosub CZAS : Gosub DISPLAY_ANIM : Use Window #AD_WINDOW_MUSIC

    If ev=$40
      Select GadgetHit
        Case 20
          MUSIC_WYBRANY_MODUL=EventCode+1
          If MUSIC_WYBRANY_MODUL=GT_ILOSC_MODULOW+1
     MODULE_FILE$(GT_ILOSC_MODULOW+1)=RTFileRequest(GetCatStr{catalog.l,2020,"Wskaz modul w formacie DBM lub PT lub P601"},"",0)
          EndIf

          Gosub MODUL_START
          If MODULE_FORMAT$="MMD" : GTDisable #AD_GT_MUSIC,21 : Else : GTEnable #AD_GT_MUSIC,21 : EndIf
          Redraw #AD_WINDOW_MUSIC,21
          If MODULE_PLAYING=True : GTToggle #AD_GT_MUSIC,24,Off : Else : GTToggle #AD_GT_MUSIC,24,On : EndIf
          Redraw #AD_WINDOW_MUSIC,24
        Case 23
          MUSIC_FILTR=EventCode
          If MUSIC_FILTR=0 Then Filter On
          If MUSIC_FILTR=1 Then Filter Off
        Case 24
          MUSIC_OFF=EventCode
          If MUSIC_OFF=0 Then Gosub MODUL_START
          If MUSIC_OFF=1 Then Gosub MODUL_STOP
        Case 22
          MUSIC_PREFS_ZAMKNIJ=True
      End Select
    EndIf

    If ev=$20
      Repeat
      Select GadgetHit
        Case 21
          MUSIC_GLOSNOSC=EventCode : Gosub MODUL_VOLUME
      End Select
      VWait
      Until (Event=$40 AND EventWindow=#AD_WINDOW_MUSIC)
    EndIf


  Until MUSIC_PREFS_ZAMKNIJ=True

  SubIDCMP $10

  DetachGTList #AD_GT_MUSIC
  CloseWindow #AD_WINDOW_MUSIC
  Use Window #AD_WINDOW


Return

.PREFS_KEYS

  WPointer 4 : WPOINT.b=4

  KEYS_H=142
  If PRE_SCALE=1 Then KEYS_H=KEYS_H*2
  KEYS_H=KEYS_H+offb+offd


  If PRE_OPEN_ON_WB=1
    KEYS_FLAGS.l=6+$400
    KEYS_TTL$="AntyDresiarz #4 Keys Prefs"
  Else
    KEYS_FLAGS.l=$400+6
    KEYS_TTL$="AntyDresiarz #4 Keys Prefs"
  EndIf

  If PRE_TRUE_COLOR=1
    PD=FindColor{PRE_R(PRE_PEN_DARK),PRE_G(PRE_PEN_DARK),PRE_B(PRE_PEN_DARK)}
    PB=FindColor{PRE_R(PRE_PEN_BRIGHT),PRE_G(PRE_PEN_BRIGHT),PRE_B(PRE_PEN_BRIGHT)}
    PBA=FindColor{PRE_R(PRE_PEN_BACKGROUND),PRE_G(PRE_PEN_BACKGROUND),PRE_B(PRE_PEN_BACKGROUND)}
  Else
    PD=PRE_PEN_DARK
    PB=PRE_PEN_BRIGHT
    PBA=PRE_PEN_BACKGROUND
  EndIf



  Window #AD_WINDOW_PREFS_KEYS,126,47,345+offl+offr,KEYS_H,KEYS_FLAGS,KEYS_TTL$,PD,PB
  WCls PBA : Activate #AD_WINDOW_PREFS_KEYS

  WindowFont 0

  CatchDosErrs
  AttachGTList #AD_GT_KEYS,#AD_WINDOW_PREFS_KEYS

  KEYS_ZAMKNIJ=-1

  Repeat
    ev=Event  AND EventWindow=#AD_WINDOW_PREFS_KEYS
    Use Window #AD_WINDOW
    Gosub CZAS : Gosub DISPLAY_ANIM
    Use Window #AD_WINDOW_PREFS
    rk=0

    If ev=$40
      Select GadgetHit
        Case 30
          GTSetString #AD_GT_KEYS,31,"Press the key..."
          Repeat:ev=Event:VWait 1:If ev=1024:rk=EventCode:EndIf:Until rk>0
          PREFS_AD_KEY(1)=rk
          GTSetString #AD_GT_KEYS,31,"Ok..."
        Case 32
          GTSetString #AD_GT_KEYS,33,"Press the key..."
          Repeat:ev=Event:VWait 1:If ev=1024:rk=EventCode:EndIf:Until rk>0
          PREFS_AD_KEY(2)=rk
          GTSetString #AD_GT_KEYS,33,"Ok..."
        Case 34
          GTSetString #AD_GT_KEYS,35,"Press the key..."
          Repeat:ev=Event:VWait 1:If ev=1024:rk=EventCode:EndIf:Until rk>0
          PREFS_AD_KEY(3)=rk
          GTSetString #AD_GT_KEYS,35,"Ok..."
        Case 36
          GTSetString #AD_GT_KEYS,37,"Press the key..."
          Repeat:ev=Event:VWait 1:If ev=1024:rk=EventCode:EndIf:Until rk>0
          PREFS_AD_KEY(4)=rk
          GTSetString #AD_GT_KEYS,37,"Ok..."
        Case 38
          GTSetString #AD_GT_KEYS,39,"Press the key..."
          Repeat:ev=Event:VWait 1:If ev=1024:rk=EventCode:EndIf:Until rk>0
          PREFS_AD_KEY(5)=rk
          GTSetString #AD_GT_KEYS,39,"Ok..."
        Case 40
          GTSetString #AD_GT_KEYS,41,"Press the key..."
          Repeat:ev=Event:VWait 1:If ev=1024:rk=EventCode:EndIf:Until rk>0
          PREFS_AD_KEY(6)=rk
          GTSetString #AD_GT_KEYS,41,"Ok..."
        Case 42
          GTSetString #AD_GT_KEYS,43,"Press the key..."
          Repeat:ev=Event:VWait 1:If ev=1024:rk=EventCode:EndIf:Until rk>0
          PREFS_AD_KEY(7)=rk
          GTSetString #AD_GT_KEYS,43,"Ok..."
        Case 44
          GTSetString #AD_GT_KEYS,45,"Press the key..."
          Repeat:ev=Event:VWait 1:If ev=1024:rk=EventCode:EndIf:Until rk>0
          PREFS_AD_KEY(8)=rk
          GTSetString #AD_GT_KEYS,45,"Ok..."
        Case 46 ; use
          KEYS_ZAMKNIJ=1
        Case 47 ; cancel

      End Select
    EndIf

  Until KEYS_ZAMKNIJ>0

  DetachGTList #AD_GT_KEYS
  CloseWindow #AD_WINDOW_PREFS_KEYS
  Use Window #AD_WINDOW_PREFS

  WPointer 1 : WPOINT.b=1


Return

.PREFS_MUSIC

  WPointer 4 : WPOINT.b=4

  PREFS_MUSIC_H=119
  If PRE_SCALE=1 Then PREFS_MUSIC_H=PREFS_MUSIC_H*2
  PREFS_MUSIC_H=PREFS_MUSIC_H+offb+offd


  If PRE_OPEN_ON_WB=1
    PREFS_MUSIC_FLAGS.l=6+$400
    PREFS_MUSIC_TTL$="AntyDresiarz #4 Keys Prefs"
  Else
    PREFS_MUSIC_FLAGS.l=$400+6
    PREFS_MUSIC_TTL$="AntyDresiarz #4 Keys Prefs"
  EndIf

  If PRE_TRUE_COLOR=1
    PD=FindColor{PRE_R(PRE_PEN_DARK),PRE_G(PRE_PEN_DARK),PRE_B(PRE_PEN_DARK)}
    PB=FindColor{PRE_R(PRE_PEN_BRIGHT),PRE_G(PRE_PEN_BRIGHT),PRE_B(PRE_PEN_BRIGHT)}
    PBA=FindColor{PRE_R(PRE_PEN_BACKGROUND),PRE_G(PRE_PEN_BACKGROUND),PRE_B(PRE_PEN_BACKGROUND)}
  Else
    PD=PRE_PEN_DARK
    PB=PRE_PEN_BRIGHT
    PBA=PRE_PEN_BACKGROUND
  EndIf

  Window #AD_WINDOW_PREFS_MUSIC,126,47,330+offl+offr,PREFS_MUSIC_H,PREFS_MUSIC_FLAGS,PREFS_MUSIC_TTL$,PD,PB
  WCls PBA : Activate #AD_WINDOW_PREFS_MUSIC
  WindowFont 0
  CatchDosErrs
  AttachGTList #AD_GT_PREFS_MUSIC,#AD_WINDOW_PREFS_MUSIC

  GTSetAttrs #AD_GT_PREFS_MUSIC,63,#GTSL_Level,PREFS_OCTAMIX_FREQ.l/10
  GTToggle   #AD_GT_PREFS_MUSIC,61,-PREFS_OCTAMED_HQ  : Redraw #AD_WINDOW_PREFS_MUSIC,61
  GTToggle   #AD_GT_PREFS_MUSIC,62,-PREFS_OCTAMIX_14B : Redraw #AD_WINDOW_PREFS_MUSIC,62
  GTToggle   #AD_GT_PREFS_MUSIC,65,-PREFS_AHI_AUTOBOOST : Redraw #AD_WINDOW_PREFS_MUSIC,65

  WJam 0 : WColour 2,0
  SC=1
  If PRE_SCALE=1 Then SC=2
  WLocate 110,3*SC : Print"DigiBooster Pro"
  WLocate 97,41*SC : Print"OctaMed (8 kanalow)"
  WLocate 42,63*SC : Print"OctaMed SoundStudio (64 kanaly)"

  PREFS_MUSIC_ZAMKNIJ=-1

  Repeat
    ev=Event  AND EventWindow=#AD_WINDOW_PREFS_MUSIC
    Use Window #AD_WINDOW
    Gosub CZAS : Gosub DISPLAY_ANIM
    Use Window #AD_WINDOW_PREFS
    rk=0

    If ev=$40
      Select GadgetHit
        Case 60
          AHI_REQUEST_MODE.l=PREFS_AHI_MODE_ID.l
          AHI_REQUEST_FREQ.l=PREFS_AHI_FREQUENCY.l
          Gosub AHI_REQUEST
          If AHI_REQUEST_RES=1
            PREFS_AHI_MODE_ID.l=SEL_AHI_AUDIO.l
            PREFS_AHI_FREQUENCY.l=SEL_AHI_FREQ.l
          EndIf
        Case 61
          PREFS_OCTAMED_HQ=EventCode
        Case 63
          PREFS_OCTAMIX_FREQ.l=EventCode*10
        Case 62
          PREFS_OCTAMIX_14B=EventCode
        Case 64
          PREFS_MUSIC_ZAMKNIJ=1
        Case 65
          PREFS_AHI_AUTOBOOST=EventCode
      End Select
    EndIf

  Until PREFS_MUSIC_ZAMKNIJ>0

  DetachGTList #AD_GT_PREFS_MUSIC
  CloseWindow #AD_WINDOW_PREFS_MUSIC
  Use Window #AD_WINDOW_PREFS

  WPointer 1 : WPOINT.b=1


Return


.PREFS_PALETA

  WPointer 4 : WPOINT.b=4

  PAL_H=87
  If PRE_SCALE=1 Then PAL_H=PAL_H*2
  PAL_H=PAL_H+offb+offd


  If PRE_OPEN_ON_WB=1
    PAL_FLAGS=6+$400 : PAL_TTL$="AntyDresiarz #4 Palette Prefs"
  Else
    PAL_FLAGS=$400+6 : PAL_TTL$="AntyDresiarz #4 Palette Prefs"
  EndIf

  If PRE_SCALE=1
    PAL_BW=12*2 : PAL_BY=(56+offy)*2
  Else
    PAL_BW=12 : PAL_BY=56+offy
  EndIf

  If PRE_TRUE_COLOR=1
    PD=FindColor{PRE_R(PRE_PEN_DARK),PRE_G(PRE_PEN_DARK),PRE_B(PRE_PEN_DARK)}
    PB=FindColor{PRE_R(PRE_PEN_BRIGHT),PRE_G(PRE_PEN_BRIGHT),PRE_B(PRE_PEN_BRIGHT)}
    PBA=FindColor{PRE_R(PRE_PEN_BACKGROUND),PRE_G(PRE_PEN_BACKGROUND),PRE_B(PRE_PEN_BACKGROUND)}
  Else
    PD=PRE_PEN_DARK
    PB=PRE_PEN_BRIGHT
    PBA=PRE_PEN_BACKGROUND
  EndIf

  AddIDCMP $10
  Window #AD_WINDOW_PALETTE,130,33,294+offl+offr,PAL_H,PAL_FLAGS,PAL_TTL$,PD,PB
  WCls PBA : Activate #AD_WINDOW_PALETTE

  CatchDosErrs
  WindowFont 0
  AttachGTList #AD_GT_PALETTE,#AD_WINDOW_PALETTE

  GTBevelBox #AD_GT_PALETTE,8+offl,PAL_BY,281,PAL_BW,1

  PALETTE_QUIT=0
  PALETTE_AGA=255
  PALETTE_AGA_R=AGARed(PALETTE_AGA)
  PALETTE_AGA_G=AGAGreen(PALETTE_AGA)
  PALETTE_AGA_B=AGABlue(PALETTE_AGA)

  For K=0 To 255
    PREFS_R(K)=PREFSY_R(K) : PREFS_G(K)=PREFSY_G(K) : PREFS_B(K)=PREFSY_B(K)
  Next K

  PALETTE_KOLOR=0
  GTSetAttrs #AD_GT_PALETTE,50,#GTSL_Level,PREFS_R(PALETTE_KOLOR)
  GTSetAttrs #AD_GT_PALETTE,51,#GTSL_Level,PREFS_G(PALETTE_KOLOR)
  GTSetAttrs #AD_GT_PALETTE,52,#GTSL_Level,PREFS_B(PALETTE_KOLOR)
  GTSetAttrs #AD_GT_PALETTE,53,#GTSL_Level,PALETTE_KOLOR
  If PRE_TRUE_COLOR
    p.l=$00000000
    Poke.b &p+1,PREFS_R(PALETTE_KOLOR) : Poke.b &p+2,PREFS_G(PALETTE_KOLOR) : Poke.b &p+3,PREFS_B(PALETTE_KOLOR)
    FPA{RastPort(#AD_WINDOW_PALETTE),8+offl+2,PAL_BY+2,281-4,PAL_BW-4,p.l}
  Else
    AGAPalRGB #AD_PALETTE,PALETTE_AGA,PREFS_R(PALETTE_KOLOR),PREFS_G(PALETTE_KOLOR),PREFS_B(PALETTE_KOLOR)
    UsePalette{#AD_PALETTE}
    WBox 8+offl,PAL_BY,8+offx+281,PAL_BY+PAL_BW,PALETTE_AGA
  EndIf

  Repeat
    ev=Event AND EventWindow=#AD_WINDOW_PALETTE
    Use Window #AD_WINDOW : Gosub CZAS : Gosub DISPLAY_ANIM : Use Window #AD_WINDOW_PALETTE

    If ev=$20
      Repeat
      Select GadgetHit
        Case 50
          PREFS_R(PALETTE_KOLOR)=EventCode
          If PRE_TRUE_COLOR
             p.l=$00000000
             Poke.b &p+1,PREFS_R(PALETTE_KOLOR) : Poke.b &p+2,PREFS_G(PALETTE_KOLOR) : Poke.b &p+3,PREFS_B(PALETTE_KOLOR)
             FPA{RastPort(#AD_WINDOW_PALETTE),8+offl+2,PAL_BY+2,281-4,PAL_BW-4,p.l}
          Else
            AGAPalRGB #AD_PALETTE,PALETTE_AGA,PREFS_R(PALETTE_KOLOR),PREFS_G(PALETTE_KOLOR),PREFS_B(PALETTE_KOLOR)
            UsePalette{#AD_PALETTE}
          EndIf
        Case 51
          PREFS_G(PALETTE_KOLOR)=EventCode
          If PRE_TRUE_COLOR
             p.l=$00000000
             Poke.b &p+1,PREFS_R(PALETTE_KOLOR) : Poke.b &p+2,PREFS_G(PALETTE_KOLOR) : Poke.b &p+3,PREFS_B(PALETTE_KOLOR)
             FPA{RastPort(#AD_WINDOW_PALETTE),8+offl+2,PAL_BY+2,281-4,PAL_BW-4,p.l}
          Else
            AGAPalRGB #AD_PALETTE,PALETTE_AGA,PREFS_R(PALETTE_KOLOR),PREFS_G(PALETTE_KOLOR),PREFS_B(PALETTE_KOLOR)
            UsePalette{#AD_PALETTE}
          EndIf
        Case 52
          PREFS_B(PALETTE_KOLOR)=EventCode
          If PRE_TRUE_COLOR
             p.l=$00000000
             Poke.b &p+1,PREFS_R(PALETTE_KOLOR) : Poke.b &p+2,PREFS_G(PALETTE_KOLOR) : Poke.b &p+3,PREFS_B(PALETTE_KOLOR)
             FPA{RastPort(#AD_WINDOW_PALETTE),8+offl+2,PAL_BY+2,281-4,PAL_BW-4,p.l}
          Else
            AGAPalRGB #AD_PALETTE,PALETTE_AGA,PREFS_R(PALETTE_KOLOR),PREFS_G(PALETTE_KOLOR),PREFS_B(PALETTE_KOLOR)
            UsePalette{#AD_PALETTE}
          EndIf
      End Select
      Until (Event=$40 AND EventWindow=#AD_WINDOW_PALETTE)
    EndIf


    If ev=$40

      Select GadgetHit
        Case 55
          PALETTE_QUIT=1
        Case 54
          PALETTE_QUIT=2
        Case 53
          PALETTE_KOLOR=EventCode
          If PRE_TRUE_COLOR
             p.l=$00000000
             Poke.b &p+1,PREFS_R(PALETTE_KOLOR) : Poke.b &p+2,PREFS_G(PALETTE_KOLOR) : Poke.b &p+3,PREFS_B(PALETTE_KOLOR)
             FPA{RastPort(#AD_WINDOW_PALETTE),8+offl+2,PAL_BY+2,281-4,PAL_BW-4,p.l}
          Else
            AGAPalRGB #AD_PALETTE,PALETTE_AGA,PREFS_R(PALETTE_KOLOR),PREFS_G(PALETTE_KOLOR),PREFS_B(PALETTE_KOLOR)
            UsePalette{#AD_PALETTE}
          EndIf

          GTSetAttrs #AD_GT_PALETTE,50,#GTSL_Level,PREFS_R(PALETTE_KOLOR)
          GTSetAttrs #AD_GT_PALETTE,51,#GTSL_Level,PREFS_G(PALETTE_KOLOR)
          GTSetAttrs #AD_GT_PALETTE,52,#GTSL_Level,PREFS_B(PALETTE_KOLOR)
      End Select

    EndIf


  Until PALETTE_QUIT<>0

  SubIDCMP $10

  If PALETTE_QUIT=1 ; cancel
;    bez zmian prefsy
  Else              ; use
    For K=0 To 255
      PREFSY_R(K)=PREFS_R(K)
      PREFSY_G(K)=PREFS_G(K)
      PREFSY_B(K)=PREFS_B(K)
    Next K
  EndIf

  If PRE_TRUE_COLOR<>1
    AGAPalRGB #AD_PALETTE,PALETTE_AGA,PALETTE_AGA_R,PALETTE_AGA_G,PALETTE_AGA_B
    UsePalette{#AD_PALETTE}
  EndIf


  DetachGTList #AD_GT_PALETTE
  CloseWindow #AD_WINDOW_PALETTE
  Use Window #AD_WINDOW_PREFS

  WPointer 1 : WPOINT.b=1


Return

.PALETTE_DEFAULT

  PREFSY_R(0)=170
  PREFSY_G(0)=170
  PREFSY_B(0)=170

  PREFSY_R(1)=170
  PREFSY_G(1)=170
  PREFSY_B(1)=170

  PREFSY_R(2)=170
  PREFSY_G(2)=170
  PREFSY_B(2)=170


Return


.SET_FONTS_PALETTE
  If CheckAGA=True
    For fp=0 To 23
      AGAPalRGB #AD_PALETTE,fp,PRE_R(fp),PRE_G(fp),PRE_B(fp)
    Next fp
  EndIf
  UsePalette{#AD_PALETTE}
Return

.

.KASUJ_TMP
If (TEMP_DIR$<>"") AND Exists(TEMP_DIR$)

DEFTYPE .FileInfoBlock myfib

  p$=TEMP_DIR$
  lock.l=Lock_(&p$,-2)

If Examine_(lock,myfib)<>0
  While ExNext_(lock,myfib)<>0
    USEPATH myfib

    If \fib_DirEntryType<0             ;jezeli nie katalog to...
      Nazwa_pliku$=LSet$(Peek$(&\fib_FileName),30)
      Nazwa_pliku$=Left$(Nazwa_pliku$,Instr(Nazwa_pliku$,"  ")-1)

         DeleteFile_(TEMP_DIR$+Nazwa_pliku$)
    EndIf
  Wend
EndIf

UnLock_ lock

DeleteFile_ (TEMP_DIR$)

EndIf
Return

.HELP

  T$=""
  T$=T$+"Witamy w AntyDresiarz Help"+Chr$(10)+Chr$(10)
  T$=T$+"Prosze wybrac jeden z wariantow pomocy:"
  R=Request("AntyDresiarz Help...",T$,"Menu|Gadgets|Keys|Preferences|Music Prefs|Rezygnuj")
  T$=""

  If R=1
    T$=""
    T$=T$+"Obsluga menu:"+Chr$(10)
    T$=T$+"-------------"+Chr$(10)
    T$=T$+"W menu znajduje sie lista artykulow odzielonych od siebie tematycznie."+Chr$(10)
    T$=T$+"Aby wybrac artykul do porzeczytania wystarczy przeciagnac kursor myszki,"+Chr$(10)
    T$=T$+"na tekst symbolizujacy tytul artykulu. Jezeli kursor znajduje sie juz"+Chr$(10)
    T$=T$+"nad tytulem, wizerunek kursora powinien przybrac postac 'raczki'."+Chr$(10)
    T$=T$+"Teraz wystarczy kliknac lewym przyciskiem myszki na tytule, a artykul"+Chr$(10)
    T$=T$+"zaladuje sie automatycznie."
    Request "AntyDresiarz Menu Help...",T$,"OK!"
  EndIf


Return

.____INCBIN

_POINTER:
IncBin "_POINT"
Even

_TASKI_LOGO:
IncBin "_TASKI"
