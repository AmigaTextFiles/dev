!Nervfenster


datum=0
time=0
empfang=0
ClearList Gadget00_list()

If disku$<>"" Then empfaenger$=disku$
disku$=""
If empfaenger$<>""
  If AddLast(Gadget00_list())
    Gadget00_list()\Text=empfaenger$
  EndIf
  If Instr(Mail(Auswahl)\mailflags,"A")=0
    Mail(Auswahl)\mailflags+" A"
  EndIf
EndIf
GTTags #GA_TabCycle,True

Gosub mail_inhalt
Gosub pgp

GTListView 10,0,0,0,352,80,"",$00,Gadget00_list()
GTString 10,1,0,76,352,12,"",$40,256,""
GTButton 10,2,0,89,87,11,locale$(165),$16
GTButton 10,3,87,89,88,11,locale$(166),$16
GTButton 10,4,175,89,88,11,locale$(167),$16
GTButton 10,5,263,89,88,11,locale$(168),$56
GTCheckBox 10,6,575,12,26,12,locale$(169),$01
GTCheckBox 10,7,575,29,26,12,locale$(170),$01
GTCycle 10,8,456,83,146,12,locale$(171),$01,locale$(172)
GTString 10,9,98,111,370,12,locale$(173),$01,256,subjekt$
GTString 10,10,98,128,507,12,locale$(174),$01,256,kommentar$
GTString 10,11,98,145,470,12,locale$(175),$01,256,disku$
GTButton 10,12,572,146,30,12,locale$(176),$16
GTString 10,13,99,177,470,12,locale$(177),$00,256,dosdatei$
GTString 10,14,99,193,507,12,locale$(178),$00,256,dateiname$
GTButton 10,15,573,178,30,12,locale$(179),$40
GTButton 10,16,11,217,117,12,locale$(180),$16
GTButton 10,17,129,217,117,12,locale$(181),$16
GTButton 10,18,247,217,117,12,locale$(182),$16
GTButton 10,19,364,217,117,12,locale$(183),$16
GTButton 10,20,482,217,117,12,locale$(184),$16
GTCheckBox 10,21,575,46,26,12,locale$(185),$01
GTCheckBox 10,22,575,63,26,12,locale$(186),$01
GTString 10,23,565,111,40,12,locale$(187),$01,256,lifetime_prefs$

Window 10,windowxpos,windowypos,640,245,$000000F,locale$(188),1,2
AttachGTList 10,10
GTBevelBox 10,4,184,618,36,1
GTBevelBox 10,361,12,261,99,1
GTBevelBox 10,4,116,618,67,1

GTDisable 10,13
GTDisable 10,14
GTDisable 10,0
GTDisable 10,15
GTSetString 10,13,""
GTSetString 10,14,""

If weiterleiten=1
  GTDisable 10,9
  GTDisable 10,8
  GTDisable 10,17
  Redraw    10,8
  Redraw    10,9
  Redraw    10,17
EndIf

versandart=0
CloseWin=False

Repeat
    GTEnable 10,0
    ev.l = WaitEvent
    Select ev
      Case #IDCMP_REFRESHWINDOW
        GT_BeginRefresh_ Peek.l (Addr Window(10))
        GT_EndRefresh_ Peek.l (Addr Window(10)),True

      Case #IDCMP_GADGETUP
        Select GadgetHit
            Case 0
              Auswahl.w=EventCode
              ResetList Gadget00_list()
              For a=0 To Auswahl
                If NextItem (Gadget00_list()) Then ok=0
              Next

              GTEnable       10,1
              Redraw         10,1
              GTSetString    10,1,Gadget00_list()\Text
              GTEnable 10,5:Redraw 10,5
              ActivateString 10,1

            Case 1 : empfaenger$=GTGetString(10,1)
                     GTChangeList 10,0
                     If AddLast(Gadget00_list())
                      Gadget00_list()\Text=empfaenger$
                     EndIf
                     GTChangeList 10,0,Gadget00_list()
                     GTEnable 10,0
                     GTSetString 10,1,""
                     GTDisable 10,1:Redraw 10,1
            Case 2
              GTEnable 10,1:Redraw 10,1:ActivateString 10,1
            Case 3
              ClearList Liste2()
              If OpenFile(0,"bretter.pp")
                FileInput 0
                While NOT Eof(0)
                 If AddItem(Liste2())
                    Liste2()\Text=Edit$(999)
                 EndIf
                Wend
              EndIf
              Window 12, 0, 11, 640,245, $000000F,locale$(189),1,2

              GTListView 12,0,  0,  0, 618,200, "",0,Liste2()
              GTString   12,1,  0,198, 618,15, "",$40,80
              GTButton   12,2,  0,213, 618,15, locale$(190), 0
              AttachGTList 12,12
              CloseWin=False

              Repeat
                bv.l = WaitEvent
                Select bv
                  Case #IDCMP_REFRESHWINDOW
                    GT_BeginRefresh_ Peek.l (Addr Window(12))
                    GT_EndRefresh_ Peek.l (Addr Window(12)),True

                  Case #IDCMP_GADGETUP
                    Select GadgetHit
                      Case 0
                       Auswahl.w=EventCode
                       ResetList Liste2()
                       For a=0 To Auswahl
                         If NextItem (Liste2()) Then ok=0
                       Next

                       GTEnable       12,1
                       GTSetString    12,1,Liste2()\Text
                       ActivateString 12,1
                      Case 1
                       GTChangeList 12,0
                       empfaenger$ = GTGetString (12,1)
                       GTChangeList 12,0,Liste2()
                      Case 2
                       GTChangeList 12,0
                       empfaenger$ = GTGetString (12,1)
                       GTChangeList 12,0,Liste2()
                       GTChangeList 10,0
                       If AddLast(Gadget00_list())
                        Gadget00_list()\Text=empfaenger$
                       EndIf
                       GTChangeList 10,0,Gadget00_list()
                       CloseWin=True
                    End Select
                  Case #IDCMP_CLOSEWINDOW
                    CloseWin=True
                End Select
              Until CloseWin
              CloseWindow 12
              DetachGTList 12
              Free GTList 12
              CloseWin=False

            Case 4
              ClearList Liste1()
              If OpenFile(0,"absender.pp")
                FileInput 0
                While NOT Eof(0)
                 If AddItem(Liste1())
                    Liste1()\Text=Edit$(999)
                 EndIf
                Wend
              EndIf

              Window 12, 0, 11, 640,245, $000000F,locale$(191),1,2

              GTListView 12,0,  0,  0, 618,200, "",0,Liste1()
              GTString   12,1,  0,198, 618,15, "",$40,80
              GTButton   12,2,  0,213, 618,15, locale$(192), 0
              AttachGTList 12,12
              CloseWin=False

              Repeat
                bv.l = WaitEvent
                Select bv
                  Case #IDCMP_REFRESHWINDOW
                    GT_BeginRefresh_ Peek.l (Addr Window(12))
                    GT_EndRefresh_ Peek.l (Addr Window(12)),True

                  Case #IDCMP_GADGETUP
                    Select GadgetHit
                      Case 0
                       Auswahl.w=EventCode
                       ResetList Liste1()
                       For a=0 To Auswahl
                         If NextItem (Liste1()) Then ok=0
                       Next

                       GTEnable       12,1
                       GTSetString    12,1,Liste1()\Text
                       ActivateString 12,1
                      Case 1
                       GTChangeList 12,0
                       empfaenger$ = GTGetString (12,1)
                       GTChangeList 12,0,Liste1()
                      Case 2
                       GTChangeList 12,0
                       empfaenger$ = GTGetString (12,1)
                       GTChangeList 12,0,Liste1()
                       GTChangeList 10,0
                       If AddLast(Gadget00_list())
                         Gadget00_list()\Text=empfaenger$
                       EndIf
                       GTChangeList 10,0,Gadget00_list()
                       CloseWin=True
                    End Select
                  Case #IDCMP_CLOSEWINDOW
                    CloseWin=True
                End Select
              Until CloseWin
              CloseWindow 12
              DetachGTList 12
              Free GTList 12
              CloseWin=False

            Case 5
              empfaenger$=GTGetString (10,1)
              GTChangeList 10,0
              ResetList Gadget00_list()
              While NextItem(Gadget00_list())
                If Gadget00_list()\Text=empfaenger$ Then KillItem Gadget00_list()
              Wend
              GTChangeList 10,0,Gadget00_list()
              GTSetString 10,1,""
              ResetList Gadget00_list()
              GTDisable 10,5:Redraw 10,5
              GTDisable 10,1:Redraw 10,1
            Case 6
              empfang=GTStatus(10,6 )
            Case 7
              time=GTStatus(10,7)
            Case 8
              If ExecVersion < 39
                versandart+1
                If versandart=3 Then versandart=0
              Else
                versandart=GTGetAttrs(10,8,#GTCY_Active)
              EndIf
              Select versandart
                Case 0
                  GTEnable 10,16:GTEnable 10,17:GTEnable 10,18:GTEnable 10,19:GTEnable 10,20
                  GTDisable 10,13:GTDisable 10,15:GTSetString 10,13,""
                  Redraw 10,15:Redraw 10,16:Redraw 10,17:Redraw 10,18:Redraw 10,19
                Case 1
                  GTDisable 10,17
                  GTDisable 10,18
                  GTDisable 10,19
                  GTDisable 10,13:GTDisable 10,14:GTDisable 10,15::GTSetString 10,13,"":GTSetString 10,14,""
                  GTDisable 10,16
                  Redraw 10,15:Redraw 10,16:Redraw 10,17:Redraw 10,18:Redraw 10,19
                  ;Gosub fehler
                Case 2
                  GTEnable 10,16:GTEnable 10,17:GTEnable 10,18:GTEnable 10,20
                  GTEnable 10,13:GTEnable 10,15:GTSetString 10,13,dosdatei$
                  GTDisable 10,19:Redraw 10,16:Redraw 10,17:Redraw 10,18:Redraw 10,19
                  Redraw 10,15
              End Select
            Case 9 : titel$=GTGetString (10,9)
            Case 10 : kommentar$=GTGetString(10,10)
            Case 11 : disku$=GTGetString (10,11)
            Case 12
              ClearList Liste2()
              ClearList Liste2()
              If OpenFile(0,"bretter.pp")
                FileInput 0
                While NOT Eof(0)
                 If AddItem(Liste2())
                    Liste2()\Text=Edit$(999)
                 EndIf
                Wend
              EndIf
              Window 12, 0, 11, 640,245, $000000F,locale$(189),1,2

              GTListView 12,0,  0,  0, 618,200, "",0,Liste2()
              GTString   12,1,  0,198, 618,15, "",$40,80
              GTButton   12,2,  0,213, 618,15, locale$(190), 0
              AttachGTList 12,12
              CloseWin=False

              Repeat
                bv.l = WaitEvent
                Select bv
                  Case #IDCMP_REFRESHWINDOW
                    GT_BeginRefresh_ Peek.l (Addr Window(12))
                    GT_EndRefresh_ Peek.l (Addr Window(12)),True

                  Case #IDCMP_GADGETUP
                    Select GadgetHit
                      Case 0
                        Auswahl.w=EventCode
                        GTEnable       12,1
                        ResetList Liste2()
                        For a=0 To Auswahl
                          If NextItem (Liste2()) Then ok=0
                        Next

                        GTSetString    12,1,Liste2()\Text
                        ActivateString 12,1
                      Case 1
                        GTChangeList 12,0
                        disku$ = GTGetString (12,1)
                        GTChangeList 12,0,Liste2()
                      Case 2
                        GTChangeList 12,0
                        disku$ = GTGetString (12,1)
                        GTChangeList 12,0,Liste2()
                        GTSetString 10,11,disku$
                        CloseWin=True
                    End Select
                  Case #IDCMP_CLOSEWINDOW
                    CloseWin=True
                End Select
              Until CloseWin
              CloseWin=False
              CloseWindow 12
              DetachGTList 12
              Free GTList 12
            Case 13 : dosdatei$=GTGetString (10,13):GTSetString 10,13,dosdatei$
            Case 14 : dateiname$=GTGetString (10,14)
            Case 15
              MaxLen pa$=192
              MaxLen fi$=192
              dosdatei$=ASLFileRequest$(locale$(193),pa$,fi$,"#?")
              GTSetString 10,13,dosdatei$

            ; Mail Versenden

            Case 16
              Gosub mail_versenden

            Case 17
              x=0
              If new_mail=0 AND weiterleiten=0
                If WriteFile (0,"ram:t/ppedit.dat")
                  FileOutput 0
                  While x<y
                    NPrint">",text$(x)
                    x=x+1
                  Wend
                  DefaultOutput
                EndIf
                CloseFile 0
              EndIf
              editor$=Replace$(editor_prefs$,"%s","ram:t/ppedit.dat")
              Execute_ editor$,0,0
            Case 18
              editor$=Replace$(editor_prefs$,"%s","Sig.pp")
              Execute_ editor$,0,0
            Case 19
              GTCheckBox 11,0,269,10,26,11,locale$(200),$01
              GTCheckBox 11,1,269,29,26,11,locale$(201),$01
              GTCheckBox 11,2,269,48,26,11,locale$(202),$01
              GTButton 11,3,48,72,234,12,locale$(203),$16
              If keyanhang=1 Then GTToggle 11,0,On
              If pgp_sig=1   Then GTToggle 11,2,On
              If pgp_verschluesseln=1 Then GTToggle 11,1,On

              Window 11,129,69,354,99,$0000000F,locale$(204),1,2
              AttachGTList 11,11
              GTBevelBox 11,21,16,294,63,1
              CloseWin=False
              Repeat
                k$ = Inkey$
                av.l = WaitEvent
                Select av
                 Case #IDCMP_REFRESHWINDOW
                    GT_BeginRefresh_ Peek.l (Addr Window(11))
                    GT_EndRefresh_ Peek.l (Addr Window(11)),True

                 Case #IDCMP_GADGETUP
                  Select GadgetHit
                    Case 0
                      keyanhang=GTStatus(11,0)
                    Case 1
                      pgp_verschluesseln=GTStatus(11,1)
                    Case 2
                      pgp_sig=GTStatus(11,2)
                    Case 3
                      CloseWin=True
                  End Select
                 Case #IDCMP_CLOSEWINDOW
                  CloseWin=True
                End Select
              Until CloseWin
              DetachGTList 11
              Free GTList 11
              CloseWindow 11
              CloseWin=False
            Case 20
              CloseWin=True
            Case 21
              datum=GTStatus(10,21)
            Case 22
              Gosub server
            Case 23
              lifetime$=GTGetString (10,23)
        End Select
      Case #IDCMP_CLOSEWINDOW
        CloseWin=True
    End Select
Until CloseWin
DetachGTList 10
Free GTList 10
CloseWindow 10
weiterleiten=0
pgp_verschluesseln=0
keyanhang=0
pgp_sig=0
new_mail=0
reply$=""
kommentar$=""
direkt=0
direkt$=""
versandart=0
DeleteFile_("ram:t/ppedit.dat")
CloseWin=False

Return

signatur:
While s<t
  CaseSense Off
  aktdatum$=Date$(SystemDate)
  aktuhrzeit$=Str$(Hours)+":"+Str$(Mins)+":"+Str$(Secs)+" Uhr"
  cookie_new=Int(Rnd(cookie))
  sig$(s)=Replace$(sig$(s),"$cookie$",cookie$(cookie_new))
  sig$(s)=Replace$(sig$(s),"$absender$",Mail(Auswahl)\absender)
  sig$(s)=Replace$(sig$(s),"$subjekt$",Mail(Auswahl)\subject)
  sig$(s)=Replace$(sig$(s),"$uhrzeit$",Mail(Auswahl)\mailtime)
  sig$(s)=Replace$(sig$(s),"$datum$",Mail(Auswahl)\maildate)
  sig$(s)=Replace$(sig$(s),"$rubrik$",Mail(Auswahl)\empfaenger)
  sig$(s)=Replace$(sig$(s),"$routeweg$",Mail(Auswahl)\mailpath)
  sig$(s)=Replace$(sig$(s),"$bid$",Mail(Auswahl)\nummer)
  sig$(s)=Replace$(sig$(s),"$zeilen$",Str$(Mail(Auswahl)\zeilen)+" "+locale$(244))
  sig$(s)=Replace$(sig$(s),"$$","$")
  sig$(s)=Replace$(sig$(s),"$aktuhrzeit$",aktuhrzeit$)
  sig$(s)=Replace$(sig$(s),"$aktdatum$",aktdatum$)
  NPrint sig$(s)
  s=s+1
Wend
CaseSense On
Return

quote:
quote=0:quote1=0
If ReadFile(1,"quote.pp")
  FileInput 1
  While NOT Eof(1)
    quote+1
    quote1+1
    einleitung$(quote)=Edit$(999)
  Wend
  quote1+1
  quote=0
  CloseFile 1
EndIf
Return

server:

direkt=GTStatus (10,22)
If direkt=1
  Window        12,197,67,178,65,$0000000F,"",1,2
  GTString      12,1,8,5,140,13,locale$(205),$0008,256,""
  GTButton      12,2,18,38,121,11,locale$(206),$0010
  AttachGTList  12,12
  CloseWin=False
  Repeat
    di.l=WaitEvent
    Select di
      Case #IDCMP_REFRESHWINDOW
        GT_BeginRefresh_ Peek.l (Addr Window(12))
        GT_EndRefresh_ Peek.l (Addr Window(12)),True

      Case #IDCMP_GADGETUP
        Select GadgetHit
          Case 1 : direkt$=GTGetString(12,1)
          Case 2 : CloseWin=True
        End Select
      Case #IDCMP_CLOSEWINDOW
        CloseWin=True
    End Select
  Until CloseWin
  DetachGTList 12
  Free GTList 12
  CloseWindow 12
  direkt=GTStatus (10,22)
  CloseWin=False
EndIf
Return

softwareversand:
Select software
  Case 0
    NPrint "Send ",empfaenger$," #",lifetime$," ",titel$
  Case 1
    Stop
    If Empfaenger{empfaenger$}=1
      NPrint "SB ",empfaenger$
    Else
      NPrint "SP ",empfaenger$
    EndIf
    NPrint titel$
  Case 2
End Select
Return


.mail_versenden

             ResetList Gadget00_list()
             While NextItem(Gadget00_list())
              empfaenger$=Gadget00_list()\Text
              titel$=GTGetString(10,9)
              kommentar$=GTGetString(10,10)
              disku$=GTGetString (10,11)
              dosdatei$=GTGetString (10,13)
              dateiname$=GTGetString (10,14)
              lifetime$=GTGetString(10,23)

              ;PGP Verschluesseln

              If pgp_sig=1 OR pgp_verschluesseln=1
                If pgp_sig=1 cmd$=pgp_path$+" -sat ram:t/ppedit.dat -u"+user_id$+Chr$(10)+"ENDCLI"
                If pgp_verschluesseln=1AND pgp_sig=1 Then cmd$=pgp_path$+" -esat ram:t/ppedit.dat -u"+user_id$+Chr$(10)+"ENDCLI"
                If pgp_verschluesseln=1 AND pgp_sig=0 Then cmd$=pgp_path$+" -ea ram:t/ppedit.dat"+Chr$(10)+"ENDCLI"
                cli$="con:0/0/"+Str$(WBWidth)+"/"+Str$(WBHeight)+""
                If WriteFile(0,cli$)
                  WBenchToFront_
                  Execute_ &cmd$,Peek.l(Addr File(0)),0
                  WBenchToBack_
                  CloseFile 0
                EndIf
                If OpenFile(0,"ram:t/ppedit.dat.asc")
                 g=0:h=0
                 FileInput 0
                 While NOT Eof(0)
                   ppedit$(g)=Edit$(999)
                   g=g+1:h=h+1
                 Wend
                 h=h+1
                 DefaultInput
                 CloseFile 0
                EndIf
              Else
                 If OpenFile(0,"ram:t/ppedit.dat")
                    g=0:h=0
                    FileInput 0
                    While NOT Eof(0)
                     ppedit$(g)=Edit$(999)
                     g=g+1:h=h+1
                    Wend
                    h=h+1
                    DefaultInput
                    CloseFile 0
                 EndIf
              EndIf

              ;Versandart = Textdatei

              If versandart=2
                If OpenFile (1,dosdatei$)
                 g=0:h=0
                 FileInput 1
                 While NOT Eof(1)
                   ppedit$(g)=Edit$(999)
                   g=g+1:h=h+1
                 Wend
                 h=h+1
                 DefaultInput
                 CloseFile 1
                EndIf
              EndIf

              ;Signatur einlesen

              If OpenFile(0,"SIG.pp")
                s=0:t=0
                FileInput 0
                While NOT Eof(0)
                  sig$(s)=Edit$(999)
                  s=s+1:t=t+1
                Wend
                t=t+1
                DefaultInput
                CloseFile 0
              EndIf

              ; Neue Header einfuegen

              If OpenFile(0,puffer_speichern$)
                FileOutput 0
                FileSeek 0,Lof(0)
                If disku$ <> ""
                  If direkt=1 Then empfaenger$=direkt$
                  Gosub softwareversand
                  NPrint "DISKU-IN:yes | "+disku$
                Else
                  If direkt=1 Then empfaenger$=direkt$
                  Gosub softwareversand
                  NPrint "DISKU-IN:no"
                EndIf
                If empfang=1
                  NPrint "EMP:yes"
                Else
                  NPrint "EMP:no"
                EndIf
                If datum=1
                  NPrint "DATE:01/01/1978"
                Else
                  NPrint "DATE:",Date$(SystemDate)
                EndIf
                If time=1
                  NPrint "TIME:00:00:00"
                Else
                  time_hours=Hours
                  time_mins=Mins
                  time_secs=Secs
                  If time_hours<10
                    Print "TIME: 0",time_hours
                  Else
                    Print "TIME:",time_hours
                  EndIf
                  If time_mins<10
                    Print ":0",time_mins
                  Else
                    Print ":",time_mins
                  EndIf
                  If time_secs<10
                    NPrint":0",time_secs
                  Else
                    NPrint":",time_secs
                  EndIf
                EndIf
                If kommentar$ <> ""
                  NPrint"COMMENT:",kommentar$
                EndIf
                If reply$ <> ""
                  NPrint"REPLYOF:",reply$," <",Mail(Auswahl)\nummer,">"
                EndIf
                NPrint""

                ; Einleitungstext schreiben

                If new_mail=0
                  Gosub quote
                  CaseSense Off
                  quote=0
                  While quote<quote1
                    quote+1
                    aktdatum$=Date$(SystemDate)
                    aktuhrzeit$=Str$(Hours)+":"+Str$(Mins)+":"+Str$(Secs)+" Uhr"
                    einleitung$(quote)=Replace$(einleitung$(quote),"$absender$",Mail(Auswahl)\absender)
                    einleitung$(quote)=Replace$(einleitung$(quote),"$subjekt$",Mail(Auswahl)\subject)
                    einleitung$(quote)=Replace$(einleitung$(quote),"$uhrzeit$",Mail(Auswahl)\mailtime)
                    einleitung$(quote)=Replace$(einleitung$(quote),"$datum$",Mail(Auswahl)\maildate)
                    einleitung$(quote)=Replace$(einleitung$(quote),"$rubrik$",Mail(Auswahl)\empfaenger)
                    einleitung$(quote)=Replace$(einleitung$(quote),"$routeweg$",Mail(Auswahl)\mailpath)
                    einleitung$(quote)=Replace$(einleitung$(quote),"$bid$",Mail(Auswahl)\nummer)
                    einleitung$(quote)=Replace$(einleitung$(quote),"$zeilen$",Str$(Mail(Auswahl)\zeilen)+" "+locale$(244))
                    einleitung$(quote)=Replace$(einleitung$(quote),"$$","$")
                    einleitung$(quote)=Replace$(einleitung$(quote),"$aktuhrzeit$",aktuhrzeit$)
                    einleitung$(quote)=Replace$(einleitung$(quote),"$aktdatum$",aktdatum$)
                    NPrint einleitung$(quote)
                  Wend
                  NPrint""
                  CaseSense On
                EndIf

                ;Versandart = Binaer

                If versandart=1 AND dosdatei$ <> ""
                  If OpenFile(1,dosdatei$)
                    g=0:h=0
                    FileInput 1
                    FileSeek 1,0
                    While NOT Eof(1)
                      ppedit$(g)=Edit$(999)
                      h=h+1:g=g+1
                    Wend
                    h=h+1
                    DefaultInput
                    doslaenge=Lof(1)
                    CloseFile 1
                  EndIf

                  Print "#BIN#",doslaenge,""+Chr$(10)+Chr$(13)
                  g=0
                  While g<h
                    Print ppedit$(g)
                    g=g+1
                  Wend

                Else ; Versandart=Text

                  If weiterleiten=1
                    While x<y
                      NPrint text$(x)
                      x=x+1
                    Wend
                    x=0:y=0
                  EndIf
                  g=0

                  ; Textausgabe

                  While g<h
                    NPrint ppedit$(g)
                    ppedit$(g)=""
                    g=g+1
                  Wend

                  ; Signatur sichern

                  s=0
                  NPrint"-- "
                  Gosub signatur
                  NPrint""

                  ; PGP Key anhaengen

                  If keyanhang=1
                   If OpenFile(1,"pgpkey.pp")
                     g=0:h=0
                     FileInput 1
                     While NOT Eof(1)
                       keyfile$(g)=Edit$(999)
                       g=g+1:h=h+1
                     Wend
                     h=h+1:g=0
                     DefaultInput
                     CloseFile 1
                   EndIf

                   While g<h
                     FileOutput 0
                     NPrint keyfile$(g)
                     g=g+1
                   Wend
                   g=0:h=0
                  EndIf

                  ; Packet-Point Version

                  NPrint""
                  If weiterleiten=1
                    NPrint locale$(194)+username$+" @"+homebbs$+" ("+nickname$+")"
                    NPrint locale$(195)+absender$
                  EndIf
                  If keynummer > 0
                    NPrint locale$(196)+ver$+locale$(197)+Str$(keynummer)+locale$(198)
                  Else
                    NPrint locale$(196)+ver$+locale$(197)+locale$(199)
                  EndIf

                  ; Abschluss der Mail

                  Select software
                    Case 0
                      NPrint"nnnn"
                    Case 1
                      NPrint"/EX"
                    Case 2
                  End Select

                  CloseFile 0
                  DefaultOutput
                EndIf
              EndIf

              ; LogFile Eintrag

              If weiterleiten=1
                LogFileOutput{locale$(262)+" "+empfaenger$}
              Else
                LogFileOutput{locale$(260)+" "+empfaenger$}
              EndIf
             Wend
             CloseWin=True
Return
