;
; Routine zum Einlesen der Mails fuer FBB Mailbox-Systeme
;

CaseSense Off

If OpenFile (0,puffer_laden$)
  FileInput 0
  x=1
  While NOT Eof(0)
    text$=Edit$(80)
    If Left$(text$,13)="Von         :"
      Mail(x)\absender=UnRight$(text$,13)
      Mail(x)\laenge=Loc(0)
      Mail(x)\mailnummer=x
      Mail(x)\mailfilter=0
      x+1
    EndIf
  Wend
  maxmails=x-1
  For a=1 To x-1
    bid=False
    subject=False
    empfaenger=False
    path=False
    header=False
    absender=True
    sent=False
    emp=False
    date=False
    time=False
    disku=False
    maillaenge=False
    reply=False
    comment=False
    FileSeek 0,Mail(a)\laenge
    While NOT Eof(0)
      text$=Edit$(999)
      Mail(a)\zeilen+1
      If Left$(text$,13)="Titel       :" AND subject=False Then Mail(a)\subject=UnRight$(text$,13):subject=True
      If Left$(text$,13)="An          :" AND empfaenger=False Then Mail(a)\empfaenger=UnRight$(text$,13):empfaenger=True
      If Left$(text$,13)="Datum/Zeit  :" AND sent=False Then Mail(a)\sent=UnRight$(text$,13):sent=True
      If Left$(text$,13)="BID (MID)   :" AND bid=False Then Mail(a)\nummer=UnRight$(text$,13):bid=True
      If path=True AND Instr(text$,"!")>0 AND header=False Then Mail(a)\mailpath+UnRight$(text$,5)
      If Left$(text$,5)="Path:" AND path=False Then Mail(a)\mailpath=UnRight$(text$,5):path=True
;
      If UCase$(text$)="EMP=YES"AND emp=False AND header=False
        If Mail(a)\empfaenger=" "+username$+"@"+homebbs$ Then Mail(a)\emp=True:emp=True
        If Instr(Mail(a)\empfaenger,username$+"@"+homebbs$)>0 Then Mail(a)\emp=True:emp=True
        If Instr(Mail(a)\empfaenger,username$+" @ "+homebbs$)>0 Then Mail(a)\emp=True:emp=True
      EndIf
;
      If UCase$(Left$(text$,5))="DATE=" AND date=False AND header=False Then Mail(a)\maildate=UnRight$(text$,5):date=True
      If UCase$(Left$(text$,5))="TIME=" AND time=False AND header=False Then Mail(a)\mailtime=UnRight$(text$,5):time=True
      If UCase$(Left$(text$,12))="DISKU-IN=YES"AND disku=False AND header=False Then Mail(a)\disku=UnRight$(text$,14):disku=True
      If UCase$(Left$(text$,8))="REPLYOF=" AND reply=False AND header=False Then Mail(a)\reply=UnRight$(text$,8):reply=True
      If UCase$(Left$(text$,8))="COMMENT="AND comment=False AND header=False Then Mail(a)\comment=UnRight$(text$,8):comment=True
;
      If text$=prompt$ Then Mail(a)\newmail=Loc(0):FileSeek 0,Lof(0)
      If Left$(text$,22)="--- Ende der Nachricht"  Then Mail(a)\newmail=Loc(0):FileSeek 0,Lof(0)
      If Left$(text$,13)="Von         :" Then Mail(a)\newmail=Loc(0):FileSeek 0,Lof(0)
      If signatur_ab=1 AND text$=signaturtrenner$ Then Mail(a)\newmail=Loc(0):FileSeek 0,Lof(0)
      If text$="-----BEGIN PGP MESSAGE-----" OR text$="-----BEGIN PGP SIGNED MESSAGE-----" Then Mail(a)\pgpmail=True
      If text$="" AND empfaenger=True AND maillaenge=False Then Mail(a)\laenge=Loc(0):maillaenge=True
      If text$="" AND header=False Then header=True
    Wend
    If Mail(a)\empfaenger="" Then Mail(a)\empfaenger=" UNKNOWN"
    If Mail(a)\absender="" Then Mail(a)\absender=" UNKNOWN"
    If Mail(a)\mailpath="" Then Mail(a)\mailpath=" UNKNOWN"
    If Mail(a)\sent="" Then Mail(a)\sent=" UNKNOWN"
    If Mail(a)\subject="" Then Mail(a)\subject=" UNKNOWN"
    If Mail(a)\mailtime="" AND sent=True
      Mail(a)\mailtime=Mid$(Mail(a)\sent,9,5)+" "+locale$(250)
    EndIf
    If Mail(a)\maildate="" AND sent=True
      Mail(a)\maildate=Mid$(Mail(a)\sent,2,6)
    EndIf
    Mail(a)\maildatum=" "+Mail(a)\maildate+", "+Mail(a)\mailtime
    If reply=True
      rep=Instr(Mail(a)\reply,"<")
      rep$=UnRight$(Mail(a)\reply,rep)
      Mail(a)\replybid=Mid$(rep$,1,Len(rep$)-1)
    EndIf
  Next
  CloseFile 0
EndIf

For a=1 To x-1
  If Instr(Mail(a)\absender,"(")-1 > 0
    Mail(a)\absender=Left$(Mail(a)\absender,Instr(Mail(a)\absender,"(")-1)
  EndIf
  If UCase$(Mail(a)\subject)=UCase$(" "+betreff$)
   If OpenFile(1,datei$)
      FileInput 1
      s=0:t=0
      FileSeek 1,0
      While NOT Eof(1)
        t=t+1
        s=s+1
        text_info$(s)=Edit$(999)
      Wend
      s=0
      CloseFile 1
    EndIf
    DefaultInput

    If OpenFile(1,puffer_speichern$)
      FileSeek 1,Lof(1)
      FileOutput 1
      NPrint "send ",Mail(a)\absender," RE:",Mail(a)\subject," "
      NPrint""
      NPrint locale$(211)+Mail(a)\subject+"`:"
      NPrint""
      While s<t
         s=s+1
         NPrint text_info$(s)
      Wend
         NPrint""
         NPrint locale$(212)+username$+" @"+homebbs$+" ("+nickname$+")"
         NPrint locale$(213)+Date$(SystemDate)+locale$(214)+Str$(Hours)+":"+Str$(Mins)+":"+Str$(Secs)+locale$(215)
         NPrint""
         If keynummer > 0
           NPrint locale$(196)+ver$+locale$(197)+Str$(keynummer)+locale$(198)
         Else
           NPrint locale$(196)+ver$+locale$(197)+locale$(199)
         EndIf
         NPrint "nnnn"
         NPrint""
         DefaultOutput
         CloseFile 1
    EndIf
    s=0:t=0
  EndIf
  If Mail(a)\emp=True
        If OpenFile(1,puffer_speichern$)
          FileOutput 1
          FileSeek 1,Lof(1)
          NPrint"Send ",Mail(a)\absender," E:",Mail(a)\subject,""
          NPrint"EMP=no"
          NPrint"DATE=",Date$(SystemDate)
          NPrint"TIME=",Hours,":",Mins,":",Secs
          NPrint""
          NPrint locale$(216)+" "+Mail(a)\absender+"!"
          NPrint locale$(217)+" "+Mail(a)\subject+" "+locale$(218)
          NPrint""
          NPrint locale$(219)
          NPrint locale$(220)
          NPrint""
          NPrint locale$(221)
          NPrint"   ",nickname$
          NPrint""
          If key_mitschicken=1
            If OpenFile(2,"pgpkey.pp")
              g=0:h=0
              FileInput 2
              While NOT Eof(2)
                keyfile$(g)=Edit$(999)
                g=g+1:h=h+1
              Wend
              h=h+1:g=0
              DefaultInput
              CloseFile 2
            EndIf
            While g<h
              FileOutput 1
              NPrint keyfile$(g)
              g=g+1
            Wend
            g=0:h=0
          EndIf
          NPrint""
          If keynummer > 0
            NPrint locale$(196)+ver$+locale$(197)+Str$(keynummer)+locale$(198)
          Else
            NPrint locale$(196)+ver$+locale$(197)+locale$(199)
          EndIf
          NPrint"nnnn"
          DefaultOutput
          CloseFile 1
        EndIf
        LogFileOutput{locale$(261)+" "+Mail(a)\absender}
  EndIf
  DefaultInput
  If AddLast(Liste())
    Liste()\Text=Mail(a)\empfaenger+" >"+Mail(a)\subject
  EndIf
  b=0
  c=0
  If OpenFile(0,"filterliste.pp")
    FileInput 0
    While NOT Eof(0)
      b=b+1
      c=c+1
      filterliste$(b)=Edit$(999)
    Wend
    CloseFile 0
    DefaultOutput
    DefaultInput
  EndIf
  b=0
  c=c+1
  While b<c
    If Mail(a)\absender=filterliste$(b) Then KillItem Liste():Mail(a)\mailfilter=1
    If Mail(a)\reply <> "" AND Instr(Mail(a)\reply,filterliste$(b))>0 Then KillItem Liste():Mail(a)\mailfilter=1
    b+1
  Wend
Next

CaseSense On
