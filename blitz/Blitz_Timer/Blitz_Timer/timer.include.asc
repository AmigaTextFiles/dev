
; timer.include.bb2 generated by FD2inc.


*_TimerBase.Library = 0

Macro timer_AddTime ; {dest,src}
   GetReg a0,`1 : GetReg a1,`2
   GetReg a6,*_TimerBase : JSR -42(a6)
End Macro

Macro timer_SubTime ; {dest,src}
   GetReg a0,`1 : GetReg a1,`2
   GetReg a6,*_TimerBase : JSR -48(a6)
End Macro

Macro timer_CmpTime ; {ret,dest,src}
   GetReg a0,`2 : GetReg a1,`3
   GetReg a6,*_TimerBase : JSR -54(a6) : PutReg d0,`1
End Macro

Macro timer_ReadEClock ; {ret,dest}
   GetReg a0,`2
   GetReg a6,*_TimerBase : JSR -60(a6) : PutReg d0,`1
End Macro

Macro timer_GetSysTime ; {dest}
   GetReg a0,`1
   GetReg a6,*_TimerBase : JSR -66(a6)
End Macro


; This is where the living beings take over. ;)

Function.l timer_Init {tunit.l}
   SHARED *_TimerBase, *tr.timerequest, *trmp.MsgPort
   If *_TimerBase Then Function Return *_TimerBase
   *trmp=CreateMsgPort_
   If *trmp
      *tr=CreateIORequest_ (*trmp, SizeOf .timerequest)
      If *tr
         err.l = OpenDevice_ ("timer.device",tunit,*tr,0)
         If err
            DeleteIORequest_ *tr : DeleteMsgPort_ *trmp
            *tr=0 : *_TimerBase=0 : *trmp=0
         Else
            *_TimerBase = *tr\tr_node\io_Device
         EndIf
      Else
         *_TimerBase=0 : DeleteMsgPort_ *trmp : *trmp=0
      EndIf
   Else
      *_TimerBase=0
   EndIf
   Function Return *_TimerBase
End Function


Statement TimerWait {sec.l, mic.l}
   SHARED *_TimerBase, *tr, *trmp
   *tr\tr_node\io_Command = #TR_ADDREQUEST
   *tr\tr_time\tv_secs = sec
   *tr\tr_time\tv_micro = mic
   DoIO_ *tr
End Statement
 

Statement timer_Free {}
   SHARED *_TimerBase, *tr, *trmp
   If *_TimerBase Then CloseDevice_ *tr : *_TimerBase = 0
   If *tr Then DeleteIORequest_ *tr : *tr = 0
   If *trmp Then DeleteMsgPort_ *trmp : *trmp=0
End Statement



