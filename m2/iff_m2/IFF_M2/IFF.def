(* ---------------------------------------------------------------------------

   IFF.def - Library Interface Module for the iff.library, V18.8, 31-Jul-90

   By Olivier Schraner, Roggenweg 6, 5036 Oberentfelden/AG, Switzerland
   For A+L's "M2Amiga" Modula-2 Compiler V3.3 

   27 Mar 1998 - updated by T.B. <tonyiommi@geocities.com>
  						 - tested with iff.library v23.2 and Cyclone Modula-2
--------------------------------------------------------------------------- *)

DEFINITION MODULE IFF {"iff.library",21};

FROM SYSTEM    IMPORT ADDRESS,CAST;
FROM GraphicsD IMPORT BitMapPtr,ViewModeSet;
FROM ExecD     IMPORT MemReqSet;
IMPORT DosD;	 //no problem, Cyclone has an optimizing linker

TYPE IFFID = LONGINT;

CONST
 badTask 			= -1;       (* IFFError() called by wrong task *)
 cantOpenFile = 16;       (* File not found *)
 readError 		= 17;       (* Error reading file *)
 noMem 				= 18;       (* Not enough memory *)
 notIFF 			= 19;       (* File is not an IFF file *)
 writeError 	= 20;       (* Error writing file *)
 noILBM 			= 24;       (* IFF file is not of type ILBM *)
 noBMHD 			= 25;       (* BMHD chunk not found *)
 noBODY 			= 26;       (* BODY chunk not found *)
 tooManyPlanes = 27;      (* Obsolete since V18.6 *)
 unknownCompression = 28; (* Unknown compression type *)
 noANHD 			= 29;       (* ANHD chunk not found *)
 noDLTA 			= 30;       (* DLTA chunk not found *)

 idFORM = CAST(IFFID,"FORM") ;
 idPROP = CAST(IFFID,"PROP") ;
 idLIST = CAST(IFFID,"LIST") ;
 idCAT  = CAST(IFFID,"CAT ")-ORD(" ") ;

 idANIM = CAST(IFFID,"ANIM") ;
 idANHD = CAST(IFFID,"ANHD") ;
 idILBM = CAST(IFFID,"ILBM") ;
 idBMHD = CAST(IFFID,"BMHD") ;
 idBODY = CAST(IFFID,"BODY") ;
 idCAMG = CAST(IFFID,"CAMG") ;
 idCLUT = CAST(IFFID,"CLUT") ;
 idCMAP = CAST(IFFID,"CMAP") ;
 idCRNG = CAST(IFFID,"CRNG") ;
 idDLTA = CAST(IFFID,"DLTA") ;
 idSHAM = CAST(IFFID,"SHAM") ;

 id8SVX = CAST(IFFID,"8SVX") ;
 idATAK = CAST(IFFID,"ATAK") ;
 idNAME = CAST(IFFID,"NAME") ;
 idRLSE = CAST(IFFID,"RLSE") ;
 idVHDR = CAST(IFFID,"VHDR") ;

TYPE
 StrPtr = ADDRESS;
 
 FileHandlePtr=POINTER TO FileHandle;
 FileHandle=RECORD
	file 			:DosD.FileHandlePtr;
	formSize,							(* Größe des gesamten FORM *)
	chunkSize,						(* Größe des aktuellen Chunks *)
	chunkFPos:LONGINT;		(* Position im File wo dieser Chunk beginnt *)
 END; (* FileHandle *)

 ChunkPtr=POINTER TO Chunk;
 Chunk=RECORD
   ckID:IFFID;
   ckSize:LONGINT;
	 //ckData:ARRAY [1..ckSize] OF SHORTINT; (variable size)
 END;

 BitMapHeaderPtr=POINTER TO BitMapHeader;
 BitMapHeader=RECORD
   w:CARDINAL;
   h:CARDINAL;
   x:INTEGER;
   y:INTEGER;
   nPlanes:SHORTINT;
   masking:SHORTINT;
   compression:SHORTINT;
   pad1:SHORTINT;
   transparentColor:CARDINAL;
   xAspect:SHORTINT;
   yAspect:SHORTINT;
   pageWidth:INTEGER;
   pageHeight:INTEGER;
 END;

 AnimHeaderPtr=POINTER TO AnimHeader;
 AnimHeader=RECORD
   operation:SHORTINT;
   mask:SHORTINT;
   w:CARDINAL;
   h:CARDINAL;
   x:INTEGER;
   y:INTEGER;
   absTime:LONGCARD;
   relTime:LONGCARD;
   interleave:SHORTINT;
   pad0:SHORTINT;
   bits:LONGCARD;
   pad:ARRAY [0..15] OF SHORTINT;
 END;

CONST
 //modes for the new OpenIFF
 modeRead  = 0;
 modeWrite = 1;

 //compression flags for SaveIFF and CompressBlock
 cmpNone		 = 0;
 cmpByteRun1 = 1;	//ILBM BODY
 cmpFibDelta = 5; //8SVX BODY
 cmpHAM   	 = 7;	//HAM is a lossy hardware compression! (If you didn´t knew that already).

//PROCEDURE OpenIFF(fileName{8}:StrPtr):ADDRESS; CODE -30;	//obsolete
PROCEDURE Close(iffFile{9}:FileHandlePtr); CODE -36;
PROCEDURE FindChunk(iffFile{9}:FileHandlePtr; chunkName{0}:IFFID):ChunkPtr; CODE -42;
PROCEDURE GetBMHD(iffFile{9}:FileHandlePtr):BitMapHeaderPtr; CODE -48;
PROCEDURE GetColorTab(iffFile{9}:FileHandlePtr; colortable{8}:ADDRESS):LONGINT; CODE -54;
PROCEDURE DecodePic(iffFile{9}:FileHandlePtr; bitmap{8}:BitMapPtr):BOOLEAN; CODE -60;

PROCEDURE SaveBitMap(fileName{8}:StrPtr; bitmap{9}:BitMapPtr; colortable{10}:ADDRESS;
                     flags{0}:SHORTINT):BOOLEAN; CODE -66;

PROCEDURE SaveClip(filename{8}:StrPtr;
                   bitmap{9}:BitMapPtr;
                   coltab{10}:ADDRESS;
                   flags{0}:SHORTINT;
                   xoff{1}:LONGINT;
                   yoff{2}:LONGINT;
                   width{3}:LONGINT;
                   height{4}:LONGINT):BOOLEAN; CODE -72;

PROCEDURE Error():LONGINT; CODE -78;
PROCEDURE GetViewModes(iffFile{9}:FileHandlePtr):ViewModeSet; CODE -84;
PROCEDURE NewOpenIFF(fileName{8}:StrPtr; type{0}:MemReqSet):ADDRESS; CODE -90;
PROCEDURE ModifyFrame(modForm{9}:ADDRESS; bm{8}:BitMapPtr):BOOLEAN; CODE -96;
(* --- functions in V21 or higher --- *)
PROCEDURE OpenIFF(fileName{8}:StrPtr; mode{0}:LONGINT):FileHandlePtr; CODE -78H;
PROCEDURE PushChunk(iff{8}:FileHandlePtr; type{0}:LONGINT; id{1}:LONGINT):BOOLEAN; CODE -7EH;
PROCEDURE PopChunk(iff{8}:FileHandlePtr):BOOLEAN; CODE -84H;
PROCEDURE WriteChunkBytes(iff{8}:FileHandlePtr; buf{9}:ADDRESS; size{0}:LONGINT):BOOLEAN; CODE -8AH;
PROCEDURE CompressBlock(source{8}:ADDRESS; destination{9}:ADDRESS; size{0}:LONGINT; mode{1}:LONGINT):LONGINT; CODE -90H;
PROCEDURE DecompressBlock(source{8}:ADDRESS; destination{9}:ADDRESS; size{0}:LONGINT; mode{1}:LONGINT):LONGINT; CODE -96H;

END IFF.
