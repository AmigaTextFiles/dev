$Id: MkDepend.doc,v 1.13 1997/11/09 23:55:52 lars Exp $

                                 MkDepend 1.4

                     Copyright © 1995-1997 by Lars Düning
                             All Rights Reserved.
                  Permission granted for non-commercial use.


Introduction
------------
  Makefiles are very useful in the development of larger program systems,
  as they notate the various dependencies and associated needed actions
  in a machine-useable notation. Unfortunately it's the most important
  dependency between C sources and their includes which have to be
  maintained by hand, a most boring and errorprone task. MkDepend is one
  of those programs which attempt to automate this part of development
  by scanning source files for includes and repeating this step
  recursively until the complete transitive closure of included files
  is determined. The found dependencies are then written into an
  existing makefile, keeping it up to date. Additionally, the dependencies
  may be written into a separate file ('depfile') for documentary purposes.


Usage
-----
  MkDepend is a CLI-only program, needs at least OS 2.0 and 10 KByte stack.

  Template: -F=MAKE/K,-D=DEP/K,-I=INCLUDE/K/M,-X=EXCEPT/K/M,-S=SUFFIX/K/M,
            -P=OBJPAT/K/M,-L=FLAT/S,-K=KEEP/S,-V=VERBOSE/S,CLEAN/S,PROPER/S,
            FILES/M

  mkdepend  {-i|INCLUDE <includepath>[::<symbol>]}
            {-x|EXCEPT  <filepattern>}
            {-h|HIDE    <filepattern>}
            {-s|SUFFIX  <src_ext>{,<src_ext>}[+][:<obj_ext>] | [+]:<obj_ext>}
            {-p|OBJPAT  <src_ext>{,<src_ext>}[+]:<obj_pattern>}
            [-f|MAKE    <makefile>]
            [-y|STYLE   M|MP|S|SP]
            [-d|DEP     <depfile>]
            [-l|FLAT]
            [-k|KEEP]
            [-v|VERBOSE]
            {<filepattern>} | CLEAN | PROPER


    The space between the short form of the keywords and their operands
    may be omitted. For example

      mkdepend -IINCLUDE:
      mkdepend -I INCLUDE:
      mkdepend -I=INCLUDE:

    are equivalent.


  MkDepend is given a 'skeleton' of C source files and searches them for
  included files. The Includes found are recursively searched for includes
  themselves, until the complete transitive closure has been determined.
  MkDepend searches the includes first in the current directory, then in
  the given paths (if any), imitating the C preprocessor's behaviour.
  The files are scanned for include statements of the form

    #include "<filename>"

  excluding those which are commented out using C-style /* */- or
  C++-style //-comments. Every other content of the files is ignored.

  After all includes have been found, the dependencies are written into
  a makefile (creating it if necessary). The makefile is searched for
  a line

    # --- DO NOT MODIFY THIS LINE -- AUTO-DEPENDS FOLLOW ---

  after which MkDepend adds the dependencies, overwriting old ones, then
  terminating the dependencies with the line

    # --- DO NOT MODIFY THIS LINE -- AUTO-DEPENDS PRECEDE ---

  Text following the second tagline in the makefile is not modified.

  If the first tagline is not found, the tagged dependencies are simply
  appended to the file. Existing makefiles are modified by renaming it
  to <origname>.bak and then re-creating the makefile by copying the
  data not to be modified.

  The found dependencies for the 'skeleton' files are usually written as

    <skeleton> : <included file 1> <included file 2>...

  Lines are limited to 80 chars, longer entries are folded into several
  lines, ending each but the last line with a backslash (\). The list
  of included files is sorted alphabetically.

  MkDepend can be taught to know about source/object file relationships
  to be used in the entries written. E,g, the entry generated for a typical
  C source file would be of the form

    <skeleton>.o : <include 1> <include 2> ...

  Includes appear with that path in the list under which MkDepend found
  them. To support multi-platform development, replacement texts may
  be specified for the paths which are then used instead in the output.


  For documentary purposes MkDepend may additionally (or instead) write
  the dependencies into a separate file, either as flat lists or in
  tree form. Here it writes the 'a includes b' relationships in the
  form "a <- b" as well as the 'b is included by a' relationsships
  in the form "b -> a".


Arguments
---------

  <filepattern>

    Any command argument not recognizable as option is considered as
    specification of one of the 'skeleton' sources.
    Wildcards are recognized.

    Default: #?.c

    Example:

      mkdepend #?.c #?.cc

        All files ending in ".c" or ".cc" are considered.

   ------

  CLEAN
  PROPER

    If either CLEAN or PROPER is specified, MkDepend _removes_ the
    dependency entries from the specified Makefile.
    In CLEAN mode, only the taglines survive, in PROPER the taglines
    are removed as well.

   ------

  -x     <filepattern>
  EXCEPT <filepattern>

    Files which are not part of the 'skeleton', even if they are specified
    as such.

    Example:

      mkdepend #?.c -x test#?

        All files ending in ".c", except those whose name start with "test",
        are considered as sources.

   ------

  -h   <filepattern>
  HIDE <filepattern>

    Files which are not to be listed in the Makefile as dependencies, even
    if they are included by some files. They are listed in a dependency
    file, though.

    Example:

      mkdepend #?.c -h pgm_rev.h

        The file pgm_rev.h is never listed in the Makefile as dependency,
        even if it is included by some source files.

   ------

  -i      <includepath>[::<symbol>]}
  INCLUDE <includepath>[::<symbol>]}

     Specify a directory to be searched for include files. The paths are
     searched in the order given on the command line. The current
     directory is always searched first.

     If <symbol> is specified, the <includepath> is replaced by it in
     the dependencies written to the makefile.

     Example:

       mkdepend -i INCLUDE:

         Include files are searched in the current directory and in INCLUDE: .

       mkdepend -I INCLUDE:pdlibs::$(PDLIBS)

         Include files are searched in the current directory and
         in INCLUDE:pdlibs. A file like "INCLUDE:pdlibs/tree.h" will be
         written as "$(PDLIBS)tree.h" into the makefile.

   ------

  -s     <src_ext>{,<src_ext>}[+][:<obj_ext>] | [+]:<obj_ext>}
  SUFFIX <src_ext>{,<src_ext>}[+][:<obj_ext>] | [+]:<obj_ext>}

    Specify a name relationship between source and object files.
    If a source name ends in one of the given <src_ext>s, an Makefile entry
    with the object name constructed using the associated <obj_ext>.
    The <obj_ext> given with no associated <src_ext> serves as default
    extension used for those <src_ext> which are given without own
    <obj_ext>.
    When constructing the dependency list for a defined source/object
    relation, the sourcefile itself is not included in the list, as
    normally implicit makerules take care of them. This can be overridden
    by specifying the '+' sign (which is associated with the given source
    extensions).

    Default: -s :.o -s .c

    Example:

      mkdepend -s :.o -s .c,.cc

        Default <obj_ext> is ".obj", which is used for files with the
        extension ".c" and ".cc".

   ------

  -p      <src_ext>{,<src_ext>}[+]:<obj_pattern>
  OBJPAT  <src_ext>{,<src_ext>}[+]:<obj_pattern>

    Similar to SUFFIX, but allows more complicated name relations.
    <obj_pattern> gives the object file name verbatim, using placeholders
    for the actual filenames:

      %s: the full sourcename (w/o suffix)
      %p: the path part of the sourcename
      %[-][<][<number>]p: the path part of the sourcename
        <number>: skip the first <number> directories of the path,
                  defaults to 0.
        <       : count the directories from the end or the path part.
        -       : use, don't skip the counted directories.
      %n: the base of the sourcename (w/o suffix)
      %%: the character '%'.
      %x: the character x for every other character.

    Example:

      mkdepend -p .c:obj/%n.o

        For every sourcefile <name>.c, an entry for obj/<name>.o is
        created.

      mkdepend -p .c:obj/%1p%n.o source/#?.c

        For every sourcefile source/<name>.c, an entry for obj/<name>.o is
        created.

   ------

  -f    <makefile>
  MAKE  <makefile>

    Specify the makefile to modify. If none is specified and also the DEP
    option is missing, MkDepend searches in order for "Makefile",
    "Makefile.mk", "DMakefile", "SMakefile" and "GNUMakefile". If none of
    these exists, "Makefile" is used.

   ------

  -y    M|MP|S|SP
  STYLE M|MP|S|SP

    Specifiy the style of the dependencies written to the makefile.
    The supported styles are:

      M  "Multi"         : As many dependencies per line as possible, the
                           list for each object file may span several lines.
      MP "Multi-Prefix"  : As many dependencies per line as possible, each
                           line prefixed anew with the object designation.
      S  "Single"        : One dependency per line, the list for each object
                           file may span several lines.
      SP "Single-Prefix" : One dependency per line as possible, each line
                           prefixed anew with the object designation.

    Default is the "Multi" style.

   ------

  -d    <depfile>
  DEP   <depfile>

    Specify the depfile to write the dependencies into.
    The output hereinto notes just the plain dependencies between the
    skeleton and the included files, i.e. ignores any SUFFIX or OBJPAT
    setting. However, Symbolic include paths are used here as well.
    MkDepend prints both the 'a is included by b' as well as the
    'b includes a' relationships. The former are tagged with '<-' in
    the output, the latter with '->'.

    If FLAT is not specified, the dependencies are written in tree
    form with indentation representating the nesting.
    If FLAT is specified, a flat list like that in Makefiles will
    be written.

   ------

  -l
  FLAT

    Print the plain dependency file (see option DEP) as flat list instead
    of tree form.

   ------

  -k
  KEEP

    The backup of the Makefile (<origname>.bak) is not removed after
    completion of the new Makefile.

   ------

  -v
  VERBOSE

    Print some output during operation, namely the program name and the
    file currently under examination.


Installation
------------
  Copy the executable "MkDepend" into a suiting directory, profitably
  into one in your search path. That's it.


Program Information
-------------------
  MkDepend consists of three source files with associated includes:

    reader.c,.h: Reading of source files and scanning for #include statements.
                 Copying and writing of makefiles.
    nodes.c,.h : Management of the names and locations of the files analysed.
                 It is implemented as a binary search tree with an addition
                 linked list.
    args.c,.h  : Commandline parsing.
    main.c,h.  : Program control, data generation routines.

  To recreate MkDepend, compile the four sources and link them.

  MkDepend was written for DICE 3.20, makefiles are provided for use with
  DICE own dmake (`DMakefile'), Dennis Vadura's DMake (`Makefile') and
  GNU-Make ('GNUMakefile').


Bugs/TODO
---------
  main.c is a mixture of Amiga-specific and generic code.
  Wildcard expansion is usually compiled to use DICE' expand_files(), which
    does not accept the full set of wildcards implemented by AmigaDOS.
    Alternatively (and especially when compiling with other compilers
    than DICE) a simulation using AmigaDOS' MatchFirst()/MatchNext()
    can be compiled in, which does not support multilevel wildcards
    like `#?/#?.c' .
  The version number shows up verbatim in far too many files.


History
-------
  v 1.0 (18-Sep-1995) :
     Initial release.
  v 1.1 (13-Oct-1995) :
     The dependencies may now be placed in midst of a makefile.
     Object file name pattern %p expanded to %[-][<][<number>]p .
  v 1.2 (25-Feb-1996) :
     New option -D=DEP/K to write a separate file with the plain source
       dependencies.
     New option -L=FLAT/S to write the plain dependencies as flat
       list instead of a tree.
  v 1.3 (02-Mar-1996) :
     For source/object relations, the source is no longer included in
       dependency list, except when demanded by '+'-command option.
  v 1.4 (09-Nov-1997) :
     Dependency lists are now sorted alphabetically.
     Added 'GNUMakefile' to the set of makefiles searched automatically.
     New option -H=HIDE/K to hide specific include files from the
       dependency lists in the Makefile.
     New option -K=KEEP/S to keep the backup of the Makefile.
     New option -Y=STYLE/K to select different output styles.
     New options CLEAN/S and PROPER/S to clean up the Makefile.
     Bugfixes: a filename was allocated to small; ends of comments
       weren't recognized after an even number of '*'; write-protected
       Makefiles weren't removed; unreadable skeleton source-files are now
       excluded from the generated Makefile entries.


Author
------
  Lars Düning <duening@ibr.cs.tu-bs.de>

  The file reader was inspired by the input module of lcc by David Hanson
  and Christopher Fraser.

  The elaborate %p pattern follows a suggestion by Michael A. Wiedmer
  (<maw@paralax.demon.co.uk>).

  Flavio Stanchina (<flavio@ies.it>) sent in the GNUMakefile, a few bug
  fixes, and patches for SAS/C. He also suggested various additional
  output formats.


Legalese
--------
  MkDepend is Copyright © 1995-1997 by Lars Düning. All Rights are reserved.
  Permission granted for non-commercial use.

  MkDepend may be freely distributed, provided that all copyright notices
  and associated disclaimers are reproduced, and that only a reasonable
  copying fee is charged. MkDepend may be included as "one program among
  many" in (even commercial) software distributions.
  No fee may be charged for MkDepend itself.

  MkDepend may be freely modified, provided that the modifications are
  made available to the public, that each changed file carries a notice
  stating who changed what and when, and that the modified versions are
  clearly distinguishable from the original.

  Parts of MkDepend may be used in other (even commercial) programs provided
  that proper credit is given.

  MkDepend IS PROVIDED "AS IS" AND WITHOUT ANY EXPRESS OR IMPLIED
  WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF
  MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.

  Or in other words: All rights reserved. No guarantee given whatsoever.
  Your fault, not mine. Blablabla.


Last Words
----------
  "Good information are hard to get. It is even more difficult to put
   it into use." -- Sherlock Holmes

