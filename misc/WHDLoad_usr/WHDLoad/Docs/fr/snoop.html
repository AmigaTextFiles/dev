<HTML>
<HEAD>
<TITLE>Snooping</TITLE>
<meta name="DC.Language" content="fr">
<meta http-equiv="content-language" content="fr">
<meta http-equiv="content-type" content="text/html; charset=iso-8859-1">
<!-- $Id: snoop.html 1.5 2004/04/07 19:59:52 wepl Exp wepl $ -->
</HEAD>
<BODY>
<h3>Snooping</h3>
<h4>Qu'est ce c'est ?</h4>
Snooping est une caract&eacute;ristique de WHDLoad qui enregistre tous les acc&egrave;s CPU
aux registres sp&eacute;cialis&eacute;s (Custom).
Si <a href="opt.html#Snoop">Snoop</a> est activ&eacute;, tous les acc&egrave;s invalides aux
registres Custom cr&eacute;eront un Access Fault et le programme install&eacute; sera termin&eacute;.
Les acc&egrave;s invalides sont:
<ul>
<li>acc&egrave;s aux registres non-existants
<li>acc&egrave;s en lecture aux registres Write Only
<li>acc&egrave;s en &eacute;criture aux registres Read Only
<li>acc&egrave;s aux registres Early Read
<li>acc&egrave;s par un octet en &eacute;criture (&agrave; l'exception de <tt>bltcon0</tt> et <tt>aud*vol+1</tt>)
</ul>
Les registres Strobe peuvent &ecirc;tre lus et &eacute;crits. La validit&eacute; des registres Custom
varient en fonction des Amigas OCS (Old ChipSet - A500, A1000, ancien A2000),
ECS (Enhanced ChipSet - A600, r&eacute;cent A2000, A3000) et AGA (Advanced Graphics - A1200, A4000).
Ceci est utile pour localiser les bugs dans les anciens programmes qui causent des acc&egrave;s
ind&eacute;finis aux nouveaux registres AGA.
<h4>Comment &ccedil;a marche</h4>
Si Snoop est activ&eacute;, WHDLoad marque les adresses des registres Custom comme valide
dans l'arbre de traduction MMU. Donc chaque acc&egrave;s &agrave; un registre Custom aura comme
r&eacute;sultat un Access Fault exception. Cette exception sera prise en main par WHDLoad.
D'abord, il v&eacute;rifie que l'acc&egrave;s est valide. Si l'acc&egrave;s est invalide le programme
sera termin&eacute;. Si l'acc&egrave;s est valide et que c'est un acc&egrave;s en lecture, il sera
&eacute;mul&eacute; et l'ex&eacute;cution du programme continuera. Si c'est un acc&egrave;s en &eacute;criture,
WHDLoad sauvegarde la valeur qui devait &ecirc;tre &eacute;crite avant l'&eacute;mulation.
<br>Le programme ex&eacute;cut&eacute; sera ralenti car les exceptions et l'emulation prennent
le dessus. Le ralentissement d&eacute;pend du type de CPU, du type de m&eacute;moire chip
(16/32 Bit), de l'alignement du pointeur de la pile, si la m&eacute;moire chip est
32 Bit (LongWord align&eacute; ou non). Cela diff&egrave;re aussi suivant le type d'acc&egrave;s
(Byte/Word/LongWord, Read/Write). Sur le 68030, l'Ecriture est plus rapide
que la Lecture (car pour la lecture, le stackframe est de 92 octets, pour
l'&eacute;criture, 32 octets), pour le 68060, la Lecture est plus rapide parce que
l'&eacute;mulation pour l'&eacute;criture est plus complexe.
<h4>Le mode Fast Snoop</h4>
L'option Snoop/S active le Snooping rapide. Les acc&egrave;s &agrave; la lecture ne seront
pas v&eacute;rifi&eacute;s. Aucune verification sp&eacute;ciale ne sera &eacute;ffectu&eacute;e. Ce mode est utile
seulement pour recueillir les informations contenues dans les registres
custom, ex. pour capturer l'image de l'&eacute;cran en utilisant <a
href="sp.html">SP</a>.
<h4>Le scanner de la Copper-Liste</h4>
Depuis la version 13 de WHDLoad, les copper-listes sont aussi v&eacute;rifi&eacute;es.
Le scanner sera activ&eacute; en acc&egrave;s &eacute;criture aux registres <tt>coplc</tt>, si le
copper dma est activ&eacute;, ou quand le programme install&eacute; active le copper dma
en inscrivant dans le registre <tt>dmacon</tt>. Le scanner suit la copper-liste
et valide toutes les instructions Move en appliquant les restrictions caus&eacute;es par
l'option Snoop (OCS/ECS/AGA). Les instructions Skip et Wait (sauf CEND) seront
ignor&eacute;es. Quand il trouve des entr&eacute;es invalides, le programme install&eacute; sera
termin&eacute;. Le scanner suit les branches (<tt>copjmp</tt>), d&eacute;tecte les boucles et
v&eacute;rifie jusqu'&agrave; 16 sous-listes. Les moves dans les copper-listes seront sauvegard&eacute;s
dans le fichier interne des registres Custom cr&eacute;&eacute; par WHDLoad quand il sera
quitt&eacute;. Le scanner est inactif dans le mode Fast Snoop.
<h4>V&eacute;rification de la priorit&eacute; du Blitter</h4>
Quand l'option ChkBltHogs/S est activ&eacute;, WHDLoad v&eacute;rifiera que le programme install&eacute;
n'active pas le bit BltHog en inscrivant dans le registre <tt>dmacon</tt>.
La priorit&eacute; du Blitter peut causer des probl&egrave;mes sur certain mat&eacute;riel
en conjonction avec de large op&eacute;rations Blitter (tous canaux utilis&eacute;s).
<h4>V&eacute;rification de la taille du Blitter</h4>
Quand l'option ChkBltSize/S est activ&eacute;, WHDLoad v&eacute;rifiera que le travail
du Blitter n'acc&egrave;de pas &agrave; la m&eacute;moire en dehors de la BaseMem. Pour les acc&egrave;s
en &eacute;criture &agrave; <tt>bltsize</tt> or <tt>bltsizh</tt>, il v&eacute;rifiera si le mode ligne
est activ&eacute; dans <tt>bltcon1</tt>. Si le mode ligne est activ&eacute;, il annulera
la v&eacute;rification de la taille. Autrement WHDload calculera le premier et le dernier
mot d'acc&egrave;s pour chaque canal DMA activ&eacute;. Si une adresse est en dehors de la BaseMem,
le programme sera termin&eacute; par un message. Le calcul a &eacute;t&eacute; con&ccedil;u pour fonctionner avec
tous les modes (montant/descandant, modulos positive/n&eacute;gative, modulos/pointeur
impairs).
<br>Souvenez-vous que le mode "line drawing" ne sera pas v&eacute;rifi&eacute; et que tous
les registres du blitter peuvent aussi &ecirc;tre inscrits par le copper, si
<tt>copcon</tt> est activ&eacute;.
<h4>V&eacute;rification du Blitter Wait</h4>
Quand l'option ChkBltWait/S est activ&eacute;, WHDLoad utilisera une instruction trace
pour v&eacute;rifier que le programme install&eacute; attend correctement que le blitter ait
fini son travail avant d'en commencer un autre. Une variable interne sera utilis&eacute;e,
elle repr&eacute;sente l'&eacute;tat de marche du Blitter. La variable est activ&eacute;e s'il se
produit un acc&egrave;s en &eacute;criture dans <tt>bltsize</tt> ou <tt>bltsizh</tt> et
effac&eacute;e quand il y a un acc&egrave;s en lecture dans <tt>dmaconr</tt>. A chaque &eacute;criture
dans le  registre du Blitter, la valeur de la variable interne est v&eacute;rifi&eacute;e,
si l'&eacute;tat est un travail du Blitter, le programme install&eacute; sera termin&eacute; et
WHDLoad rapportera la ligne de code du dernier travail du Blitter et l'acc&egrave;s actuel.
<br>Il y a 2 goulets majeurs. Le premier est l'utilisation du Blitter via
le copper ne sera pas v&eacute;rifi&eacute;e et le second est l'emploi des interruptions
du Blitter qui provoquera des erreurs superflues dans la routine de v&eacute;rification.
<h4>Futur</h4>
L'impl&eacute;mentation des caract&eacute;ristiques comme le Freezing et
l'Iconifing est en projet.
Pour cela, Snoop est primordial. Par cons&eacute;quent, il est recommand&eacute;
aux auteurs d'installs de v&eacute;rifier leurs installs avec l'option Snoop pour garantir
une compatibilit&eacute; future.
<h4>Ce que vous avez besoin</h4>
Un MMU est n&eacute;cessaire pour utiliser les options Snoop. Ainsi WHDLoad doit
<a href="mmu.html#usercontrol">utiliser</a> le MMU, par cons&eacute;quent l'option <a
href="opt.html#MMU">MMU/S</a> doit &ecirc;tre activ&eacute;e sur les machines &agrave; base 68030.
<h4>Limitations</h4>
<ul>
<li>68020 + 68851
<ul>
<li>Ce hardware n'est pas support&eacute; actuellement
</ul>
<li>68030
<ul>
<li>Aucune limitation connue
</ul>
<li>68040
<ul>
<li>Ce hardware n'est pas support&eacute; actuellement
</ul>
<li>68060
<ul>
<li>L'instruction <tt>movem</tt> peut acc&eacute;der &agrave; un registre invalide sans cr&eacute;er
un Access Fault exception, ceci est possible car seulement le 1er acc&egrave;s sera
v&eacute;rifi&eacute;.
<li><tt>Move &lt;Cia/Custom register&gt;,sr</tt> ne sera pas ex&eacute;cut&eacute; correctement,
s'il veut changer l'octet superviseur du registre d'&eacute;tat, l'octet restera
inchang&eacute;.
<li>N'importe quel<tt>(ssp)+</tt> ou <tt>-(ssp)</tt> en conjonction avec un acc&egrave;s en
&eacute;criture &agrave; un registre Cia ou Custom ne peut pas &ecirc;tre pris en main &agrave; cause des
probl&egrave;mes de stackframe. WHDLoad d&eacute;tectera ce genre d'acc&egrave;s et quittera avec
un message appropri&eacute;.
<li>Les instructions ne doivent pas acc&eacute;der &agrave; plus d'un registre snoop&eacute; &agrave; la
fois, comme cette instruction <tt>move.b ($dff006),($bfd800)</tt> ne peut pas
&ecirc;tre prise en main. Si ce genre de code appara&icirc;t, WHDLoad affichera une requ&ecirc;te
d'Access Fault.
</ul>
</ul>
</BODY>
</HTML>
