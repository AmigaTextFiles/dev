<HTML>
<HEAD>
<TITLE>Snooping</TITLE>
<meta name="DC.Language" content="cz">
<meta http-equiv="content-language" content="cz">
<meta http-equiv="content-type" content="text/html; charset=windows-1250">
<!-- $Id: snoop.html 1.3 2004/01/16 06:32:49 wepl Exp wepl $ -->
</HEAD>
<BODY>
<h3>Snooping</h3>
<h4>Co to je</h4>
Snooping je schopnost WHDLoad, která kontroluje a loguje CPU pøístupy k custom registrùm.
Pokud je <a href="opt.html#Snoop">Snoop</a> aktivován, všechny nesprávné pøístupy k custom
registrùm vytvoøí chybu a nainstalovanı program bude ukonèen. Nesprávné pøístupy jsou:
<ul>
<li>pøístupy k neexistujícím registrùm
<li>read pøístupy k Write Only registrùm
<li>write pøístupy k Read Only registrùm
<li>pøístupy k Early Read registrùm
<li>byte write pøístupy (krome <tt>bltcon0l</tt> a <tt>aud*vol+1</tt>)
</ul>
Strobe registry mohou bıt èteny nebo zapisovány.Custom registry se odlišují -
OCS (Old ChipSet - A500, A1000, old A2000), ECS (Enhanced ChipSet
- A600, nova A2000, A3000) a AGA (Advanced Graphics - A1200, A4000). Take se
tato funkce hodí obzvláštì pro hledání chyb ve starıch programech, zpùsobenıch
špatnım pøístupem k AGA registrùm.
<h4>Jak to funguje</h4>
Pokud je snooping zapnutı, WHDLoad oznaèí adresy custom registrù v MMU translation
tree jako nesprávné. Díky tomu se kadı pøístup do custom registrù stane Access Fault
vyjímkou. WHDload tuto vyjímku ovládá, take mùe zjistit, jestli je pøístup správnı
nebo ne (pøi nekorektním pøístupu je program ukonèen, jinak program pokraèuje).
<br>Kvùli pøetíení vyjímek a emulaèní sekvenci se bìh programu znaènì zpomalí.
Jak moc, záleí na CPU, typu Chip RAM a stackpointer aligmentu. Vše se take liší
podle druhu pøístupu (Byte/Word/LongWord, Read/Write). Na 68030 jsou zápisy
rychlejší ne ètení (protoe pøi ètení je stackframe 92 bajtu, pøi psaní 32),
na 68060 je to naopak, protoe emulace zápisu je sloitìjší.
<h4>Fast Snoop Mode</h4>
Volba Snoop/S zapíná rychlı snooping. Read pøístupy nebudou testovány.
ádné speciální zkoušky nejsou provedeny. Tento mód je uiteènı jen pro
získání obsahu custom registru, napø. pro uloení obrázku pomocí
<a href="sp.html">SP</a>.
<h4>Copper List Scanner</h4>
Od verze 13 budou zkoušeny také copperlisty. Scanner bude aktivován pøi zápisu
do registru coplc. Scanner procházi copperlist a ovìøuje všechny move instrukce
aplikováním omezení zpùsobenıch Snoop volbou. Skip a Wait instrukce budou ignorovány,
Pokud scanner objeví ilegální pøístup, program bude ukonèen s chybovou hláškou.
Scanner následuje branche (<tt>copjmp</tt>), detekuje smyèky a zkouší a 16 sublistù.
Pohyby v copperlistech budou uloeny do interního logu pro custom registry a ten
bude vypsán do souboru pøi exitu. Scanner není aktivní pøi Fast Snoop módu.
<h4>Zkouška Blitter Priority</h4>
Kdy je volba ChkBltHog/S aktivována, WHDLoad otestuje, zda instalovanı program
nezapíná BltHog bit zapsáním do dmacon registru. Priorita blitteru mùe zpùsobit
problémy na nìkterıch konfiguracích v souvislosti s rozsáhlımi operacemi pøes blitter
(pouití všech kanálù).
<h4>Test velikosti blitter bloku</h4>
Kdy je volba ChkBltSize/S aktivována, WHDlaod otestuje, zda práce blitteru
nepøistupuje mimo vyhrazenou pamì. Pøi zápisu do <tt>bltsize</tt> nebo <tt>bltsizh</tt>
zkouší, jestli je zapnut øádkovı mód - pokud ano, nebude WHDLoad zkoušet velikost bloku.
Jinak vypoèítá WHDLoad první a poslední word pro kadı aktivovanı DMA kanál. Pokud
je adresa mimo BaseMem území, program bude ukonèen s requesterem. Kalkulace je navrena
k práci se všemi módy.
<h4>Blitter Wait test</h4>
Pokud je volba ChkBltWait/S zapnuta, WHDLoad bude sledovat instrukce, aby ovìøil,
e nainstalovanı program korektnì èeká na konec blitter operace ne zaène novou.
Pouívá interní hodnotu, která reprezentuje status další blitter operace.
Hodnota je nastavena pøi zápisu do <tt>bltsize</tt> nebo <tt>bltsizh</tt>
a vymazána, kdy je èten <tt>dmaconr</tt> registr. Pøi kadém kontrolovaném zápisu
je hodnota testována a pokud je zjištìno, e pøedchozí blitter operace stále
bìí, program bude ukonèen s chybovım registrem s adresou neukonèeného blitter
procesu.
<br>Jsou tu ale dva nedostatky: pouití blitteru pøes copperlist není testováno
a pouití blitter pøerušení zpùsobí, e testovací rutina hlásí zbyteèné chyby.
<h4>Budoucnost</h4>
Plánuje se implementovat schopnosti jako Freezing nebo ikonifikace. Pro tohle
je Snooping ideální. Autorùm instalaèek se doporuèuje zkoušet jejich produkty
se Snoop pro budoucí kompatibilitu.
<h4>Poadavky</h4>
Pro Snoop mód je vyadováno vlastnit MMU, se kterım umí WHDLoad pracovat
(na 68030 je ho tøeba zapnout)
<h4>Omezeni</h4>
<ul>
<li>68020 + 68851
<ul>
<li>tento hardware není podporován
</ul>
<li>68030
<ul>
<li>ádná omezení
</ul>
<li>68040
<ul>
<li>tento hardware není podporován
</ul>
<li>68060
<ul>
<li><tt>movem</tt> instrukce mohou zasahovat nesprávnı registr bez chybového
hlášení (protoe je testován jen první pøístup)
<li><tt>move &lt;Cia/Custom registr&gt;,sr</tt> bude vykonán nesprávnì, pokud
se snaí zmìnit supervisor portion stavového registru, nezmìní se.
<li>any <tt>(ssp)+</tt> or <tt>-(ssp)</tt> ve spojení s write pøístupem k
Cia nebo Custom registru nemùe bıt pøevzato kvùli problémùm se stackframes,
WHDLoad takove pøístupy detekuje a vyskoèí s pøíslušnım requesterem.
<li>instrukce nesmi pøistupovat víc ne do jednoho støeeného registru najednou,
to znamená, e kód jako <tt>move.b ($dff006),($bfd800)</tt> nemùe bıt zvládnutı
a zpùsobí chybu Access Fault.
</ul>
</ul>
</BODY>
</HTML>
