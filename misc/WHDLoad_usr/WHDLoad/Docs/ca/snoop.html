<HTML>
<HEAD>
<TITLE>Snooping</TITLE>
<meta name="DC.Language" content="ca">
<meta http-equiv="content-language" content="ca">
<meta http-equiv="content-type" content="text/html; charset=iso-8859-1">
<!-- $Id: snoop.html,v 1.1 2007/08/19 12:24:49 wepl Exp wepl $ -->
</head>
<BODY>
<h3>Snooping</h3>
<h4>De què es tracta?</h4>
Snooping és una funcionalitat de WHDLoad que registra i valida els accessos als registres Custom i CIA. Si 
<a href="opt.html#Snoop">Snoop</a> està actiu tots els accessos invàlids crearan una Falla d'Accés i el programa instal·lat
 acabarà. Aquests accessos són: 

<ul>
<li>Accessos a registres inexistents
<li>Accessos de lectura a registres de només escriptura
<li>Accessos d'escriptura a registres de només lectura
<li>Accessos a registres Early Read
<li>Accessos d'escriptura de byte (excepte <tt>bltcon0l</tt> i <tt>aud*vol+1</tt>)
</ul>
Els registres Strobe es poden llegir o escriure. El conjunt de registres Custom vàlids pot variar entre OCS 
(Old ChipSet - A500, A1000, A2000 vells), ECS (Enhanced ChipSet - A600, A2000 nous, A3000) i AGA (Advanced Graphics - A1200,
 A4000). Això és útil especialment per a localitzar errors en programes vells causats per accessos no definits als nous 
registres AGA.
<h4>Com funciona?</h4>
Si Snoop està activat, WHDLoad marca les adreces dels registres Custom i CIA com a invàlides en l'arbre de traducció de la 
MMU. A causa d'això, cada accés a un registre Custom o CIA ocasionarà una excepció de Falla d'Accés. El gestor d'excepcions
 dintre de WHDLoad tractarà aquesta excepció: Primer controlarà si l'accés és vàlid; Si l'accés és invàlid el programa finalitzarà. 
Si l'accés és vàlid i és tracta d'una operació de lectura, serà emulat i l'execució del programa continuarà. Si és
 una operació d'escriptura, WHDLoad addicionalment guardarà els valors escrits en un espai d'emmagatzematge intern. 
<br>

A causa de la sobrecàrrega de l'excepció i la seqüència d'emulació el programa patirà un alentiment a l'execució. 
La quantitat d'aquest alentiment dependrà del tipus de CPU, el tipus de Memòria Xip (16/32 bits) i l'alineament del Punter
 de Pila si la Memòria Xip és de 32 bits (Paraules Llargues alineades o no). També diferirà pel tipus d'accés (Byte/Paraula/
Paraula Llarga, Lectura/Escriptura). En processadors 68030 l'Escriptura serà més ràpida que la Lectura (degut al fet que 
durant les lectures l'entorn de pila és de 92 bytes i en escriptures és de 32 bytes), al 68060 les Lectures seran mes 
ràpides degut al fet que l'emulació per a les Escriptures és més complexa. 
<h4>Mode Snoop Ràpid (Fast Snoop)</h4>
L'opció <a href="opt.html#Snoop">Snoop/S</a> activa el mode de snoop ràpid. Els accessos de lectura no es comprovaran. No 
es realitzaran controls especials. Aquest mode només serà útil per a obtenir el contingut dels registres Custom, per ex. 
per a salvar una pantalla usant <a href="sp.html">SP</a>.
<h4>Analitzador de la CopperList</h4>
Des de la versió 13 de WHDLoad també la copperlist en sí mateixa es comprova. L'analitzador s'activa durant les escriptures
als registres <tt>coplc</tt> si el DMA de copper està activat, o quan el programa instal·lat activa el DMA de copper 
escrivint el registre <tt>dmacon</tt>. L'analitzador seguirà la copperlist i validarà totes les instruccions Move aplicant 
les restriccions causades per l'opció Snoop (OCS/ECS/AGA). Les instruccions Skip i Wait (excepte CEND) s'ignoraran. Quan 
trobi entrades invàlides, el programa instal·lat finalitzarà. L'analitzador segueix les ramificacions (<tt>copjmp</tt>), 
detecta cicles i comprova fins a 16 subllistes. Els Move's en la copperlist es desen a l'arxiu intern de registres Custom 
que es bolca en sortir de WHDLoad. L'analitzador no es troba actiu al mode Snoop Ràpid. 

<h4>Comprobació de la Prioritat del Blitter</h4>
Quan l'opció ChkBltHog/S es trobi activa, WHDLoad comprovarà que el programa instal·lat no activi el bit <tt>BltHog</tt> 
 escrivint al registre <tt>dmacon</tt>. La Prioritat del Blitter pot causar problemes en algunes configuracions de 
maquinari en conjunt amb grans operacions del blitter (on s'usin tots els canals). 

<h4>Comprovació del Tamany del Blitter</h4>
Quan s'activa l'opció ChkBltSize/S WHDLoad comprovarà que els treballs del blitter no accedeixin memòria fora de l'àrea 
BaseMem. En accessos d'escriptura a <tt>bltsize</tt> o <tt>bltsizh</tt> comprova si el mode lineal està activat a bltcon1. 
Si el mode lineal està activat, cancel·larà el control de tamany. En cas contrari WHDLoad calcularà la primera i última 
paraula on accedir per a cada canal actiu de DMA. Si una adreça es troba fora de l'àrea BaseMem el programa finalitzarà amb
un quadre de diàleg. El càlcul està dissenyat per a treballar en tots els modes (ascendent/descendent, mòduls positius/
negatius, mòduls/punters imparells). 
<br>
Recordi que el mode de dibuix de línies no serà verificat i que tots els registres del blitter poden ser escrits pel 
copper si <tt>copcon</tt> està configurat.
<h4>Comprovació de l'Espera del Blitter</h4>
Quan l'opció ChkBltWait/S està activa, WHDLoad empra un seguiment d'instruccions per a verificar que el programa instal·lat
 espera correctament que el blitter acabi abans de començar un altre treball de blitter. S'utilitza una variable interna 
que representa l'estat de treball del blitter. La variable és configurada quan es produeix un accés d'escriptura a 
<tt>bltsize</tt> o <tt>bltsizh</tt> i desactivada quan es realitza un accés de lectura al registre <tt>dmaconr</tt>. 
A cada escriptura a un registre del blitter es comprova el valor de la variable interna, si es troba un treball de 
blitter en execució, el programa instal·lat finalitzarà i WHDLoad informarà l'ordinador de l'últim treball de blitter 
arrencat conjuntament amb l'accés actual. 
<br>
Hi ha dos colls d'ampolla principals en aquesta funcionalitat. Primer, l'ús de blitter a través del copper no es comprova,
 i segon, l'ús de les interrupcions del blitter ocasionen que la rutina de comprovació reporti errors inexistents.
<h4>El futur</h4>
S'ha planejat implementar funcionalitats tals com Congelat i Iconificat. Per a les mateixes, Snoop és un requeriment 
necessari. Per tant és recomanable que els autors dels instal·ladors comprovin els seus instal·ladors amb Snoop per a 
assegurar la compatibilitat futura. 
<h4>Requeriments</h4>
Es requereix una MMU per a la funcionalitat Snoop. WHDLoad també <a href="mmu.html#usercontrol">ha</a> d'utilitzar la MMU i en 
conseqüència s'ha d'activar l'opció <a href="opt.html#MMU">MMU/S</a> en màquines basades en 68030.
<h4>Limitacions</h4>
<ul>
<li>68020 + 68851
<ul>
<li>Aquest maquinari no és suportat actualment
</ul>
<li>68030
<ul>
<li>Sense limitacions conegudes
</ul>
<li>68040
<ul>
<li>Aquest maquinari no està suportat
</ul>
<li>68060
<ul>
<li>Les instruccions <tt>movem</tt> poden accedir a un registre invàlid sense ocasionar una excepció de Falla d'Accés, això 
és possible degut al fet que només es verifica que el primer accés concordi amb un registre vàlid.

<li><tt>move &lt;registre Cia/Custom&gt;,sr</tt> serà executat incorrectament si intenta canviar la part supervisor del 
registre d'estat, la part de supervisor romandrà sense canvis 

<li>Qualsevol instrucció <tt>(ssp)+</tt> o <tt>-(ssp)</tt> en conjunt amb un accés d'escriptura a un registre CIA o Custom 
no pot ser gestionat degut a problemes de marc de pila, en aquest cas, WHDLoad detectarà tals accessos i acabarà amb el 
quadre de diàleg apropiat 

<li>Les instruccions no han d'accedir més d'un registre controlat per Snoop al mateix temps; això significa que codi com 
 <tt>move.b ($dff006),($bfd800)</tt> no pot ésser gestionat. Si té lloc una situació com aquesta, WHDLoad mostrarà un 
diàleg de Falla d'Accés
</ul>
</ul>
</BODY>
</HTML>
