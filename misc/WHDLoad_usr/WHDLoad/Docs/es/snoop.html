<HTML>
<HEAD>
<TITLE>Snooping</TITLE>
<meta name="DC.Language" content="es">
<meta http-equiv="content-language" content="es">
<meta http-equiv="content-type" content="text/html; charset=iso-8859-1">
<!-- $Id: snoop.html 1.2 2003/12/10 16:04:51 wepl Exp wepl $ -->
</head>
<BODY>
<h3>Snooping</h3>
<h4>De que se trata</h4>
Snooping es una funcionalidad de WHDLoad que realiza la validación y registro de
los accesos a los registros Custom y de la CIA. Si <a href="opt.html#Snoop">Snoop</a> esta
activo todos los accesos inválidos crearán una Falla de Acceso y el programa instalado
terminará. Dichos accesos son:
<ul>
<li>accesos a registros no existentes
<li>accesos de lectura a registros de Solo Escritura
<li>accesos de escritura a registros de Solo Lectura
<li>accesos a registros Early Read
<li>accesos de escritura de byte (excepto <tt>bltcon0l</tt> y <tt>aud*vol+1</tt>)
</ul>
Los registros Strobe pueden ser leídos o escritos. El conjunto de registros Custom
válidos puede variar entre OCS (Old ChipSet - A500, A1000, viejas A2000), ECS (Enhanced ChipSet
- A600, nuevas A2000, A3000) y AGA (Advanced Graphics - A1200, A4000). Esto es útil
especialmente para localizar errores en programas viejos causados por accesos no
definidos a los nuevos registros AGA.
<h4>Como trabaja</h4>
Si Snoop esta activado, WHDLoad marca las direcciones de los registros Custom y CIA como
inválidas en el árbol de traducción de la MMU. Debido a esto, cada acceso a un registro
Custom o CIA ocasionará una excepción de Falla de Acceso. El gestor de excepciones
dentro de WHDLoad manejará esta excepción. Primero controlará si el acceso es válido.
Si el acceso es inválido el programa será terminado. Si el acceso es válido y es una operación
de lectura será emulado y la ejecución del programa continuara. Si es una operación de
escritura WHDLoad adicionalmente guardara los valores escritos en un espacio de
almacenamiento interno.<br>
Debido a la sobrecarga de la excepción y la secuencia de emulación la ejecución del
programa se enlentecera. Cuando dependerá del tipo de CPU, el tipo de Memoria
Chip (16/32 bits) y el alineamiento del Puntero de Pila si la Memoria Chip es de
32 bits (Palabras Largas alineadas o no). También diferirá por el tipo de acceso
(Byte/Palabra/Palabra Larga, Lectura/Escritura). En el 68030 la Escritura será
mas rápida que la Lectura (debido a que durante las lecturas el entorno de pila
es de 92 bytes, y en escrituras 32 bytes), en el 68060 las Lecturas serán mas
rápidas debido a que la emulación para las Escrituras es mas compleja.
<h4>Modo Snoop Rápido (Fast Snoop)</h4>
La opción <a href="opt.html#Snoop">Snoop/S</a> activa el modo de snoop rápido.
Los accesos de lectura no serán comprobados. No se realizan controles especiales.
Este modo solo será útil para obtener el contenido de los registros Custom,
por ej. para salvar una pantalla usando <a href="sp.html">SP</a>.
<h4>Analizador de la CopperList</h4>
Desde la versión 13 de WHDLoad también la copperlist en si será comprobada. El analizador
se activará durante las escrituras a los registros <tt>coplc</tt> si el DMA de copper
esta activado, o cuando el programa instalado active el DMA de copper escribiendo
el registro <tt>dmacon</tt>. El analizador seguirá la copperlist y validara todas
las instrucciones Move aplicando las restricciones causadas por la opción Snoop
(OCS/ECS/AGA). Las instrucciones Skip y Wait (excepto CEND) serán ignoradas. Cuando
encuentre entradas inválidas el programa instalado terminara. El analizador sigue
las ramificaciones (<tt>copjmp</tt>), detecta ciclos y comprueba hasta 16 sublistas. Los
Move's en la copperlist serán salvados en el archivo interno de registros Custom que
se vuelca al salir de WHDLoad. El analizador también no estará activo en el modo Snoop Rápido.
<h4>Comprobación de la Prioridad del Blitter</h4>
Cuando la opción ChkBltHog/S este activa WHDLoad comprobará que el programa instalado
no active el bit <tt>BltHog</tt> bit escribiendo al registro <tt>dmacon</tt>.
La Prioridad del Blitter puede causar problemas en algunas configuraciones de hardware
en conjunto con grandes operaciones del blitter (donde se usen todos los canales).
<h4>Comprobación del Tamaño del Blitter</h4>
Cuando se activa la opción ChkBltSize/S WHDLoad comprobará que los trabajos del blitter
no accedan memoria fuera del área BaseMem. En accesos de escritura a <tt>bltsize</tt> o
<tt>bltsizh</tt> comprueba si el modo lineal esta activado en <tt>bltcon1</tt>.
Si el modo lineal esta activado, cancelará el control de tamaño.
En caso contrario WHDLoad calculara la primer y ultima palabra a acceder para cada
canal activo de DMA. Si una dirección esta fuera del área BaseMem el programa será
terminado con un cuadro de diálogo. El calculo esta diseñado para trabajar en
todos los modos (ascendente/descendente, módulos positivos/negativos, módulos/punteros impares).<br>
Recuerde que el modo de dibujo de líneas no será verificado y que todos los registros del
blitter pueden ser escritos por el copper si <tt>copcon</tt> esta configurado.
<h4>Comprobación de la Espera del Blitter</h4>
Cuando la opción ChkBltWait/S esta activa WHDLoad usara un seguimiento de instrucciones
para verificar que el programa instalado espera correctamente a que el blitter termine
antes de lanzar otro trabajo de blitter. Usa una variable interna que representa el
estado de trabajo del blitter. La variable es configurada cuando se produce un acceso de
escritura a <tt>bltsize</tt> o <tt>bltsizh</tt> y desactivada cuando se realiza un acceso
de lectura al registro <tt>dmaconr</tt>. En cada escritura a un registro del blitter
el valor de la variable interna es comprobado, si demuestra un trabajo de blitter en
ejecución el programa instalado será terminado y WHDLoad reportara el PC del ultimo
trabajo de blitter arrancado conjuntamente con el acceso actual.<br>
Hay dos cuellos de botella principales en esta funcionalidad. Primero, el uso de blitter
a través del copper no se comprueba, y segundo, el uso de las interrupciones del blitter
ocasionara que la rutina de comprobación reporte errores inexistentes.
<h4>El futuro</h4>
Esta planeado implementar funcionalidades tales como Congelado e Iconificado.
Para las mismas, Snoop es un requisito necesario. Por lo tanto es recomendable que
los autores de los instaladores comprueben sus instaladores con Snoop para
asegurar la compatibilidad futura.
<h4>Requerimientos</h4>
Se requiere una MMU para la funcionalidad Snoop. WHDLoad también debe <a href="mmu.html#usercontrol">usar</a>
la MMU, por lo tanto <a href="opt.html#MMU">MMU/S</a> debe estar activo en máquinas con 68030.
<h4>Limitaciones</h4>
<ul>
<li>68020 + 68851
<ul>
<li>este hardware actualmente no esta soportado
</ul>
<li>68030
<ul>
<li>sin limitaciones conocidas
</ul>
<li>68040
<ul>
<li>este hardware actualmente no esta soportado
</ul>
<li>68060
<ul>
<li>instrucciones <tt>movem</tt> pueden acceder a un registro inválido sin ocasionar
una excepción de Falla de Acceso, esto es posible debido a que solamente el primer
acceso es comprobada contra validez del registro
<li><tt>move &lt;registro Cia/Custom&gt;,sr</tt> será ejecutado incorrectamente
si intenta cambiar la porción supervisor del registro de estado, la porción
de supervisor permanecerá sin cambios
<li>cualquier <tt>(ssp)+</tt> o <tt>-(ssp)</tt> en conjunto con un acceso de escritura
a un registro CIA o Custom no puede ser gestionado debido a problemas del entorno
de pila, WHDLoad detectara tales accesos y terminara con un cuadro de diálogo apropiado
<li>las instrucciones no deben acceder mas de un registro controlado por Snoop al mismo tiempo,
esto significa que código como <tt>move.b ($dff006),($bfd800)</tt> no puede ser gestionado,
si ocurre un código como este WHDLoad mostrara un diálogo de Falla de Acceso
</ul>
</ul>
</BODY>
</HTML>
