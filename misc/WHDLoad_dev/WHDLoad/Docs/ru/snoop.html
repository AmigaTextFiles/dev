<html>

<head>
<title>Snooping</title>
<meta name="DC.Language" content="ru">
<meta http-equiv="content-language" content="ru">
<meta http-equiv="content-type" content="text/html; charset=windows-1251">
<!-- $Id: snoop.html 1.6 2005/12/04 12:44:34 wepl Exp wepl $ -->
</head>

<body>

<h3>Snooping (слежение)</h3>

<h4>Что это такое</h4>

<p><strong>Snooping</strong> это особенность программы WHDLoad,
позволяющая отслеживать и вести журнал событий,
доступов к регистрам <strong>Cia</strong> и <strong>Custom</strong>.
Если активирован параметр <a href="opt.html#Snoop">Snoop</a>, то
все некорректные обращения создадут Ошибку
Доступа, а установленная программа будет
завершена. Вот что это за обращения:

<ul>
  <li>доступы к запрещённым регистрам </li>
  <li><em>чтение</em> регистров, предназначенных только
    для записи (Write Only)</li>
  <li><em>запись</em> в регистры, предназначенных только
    для чтения (Read Only)</li>
  <li>доступ к регистрам Early Read</li>
  <li>попытка записи байта в регистры (за исключением <strong><tt>bltcon0l</tt></strong>
    и <strong><tt>aud*vol+1</tt></strong>) </li>
</ul>

<p>Регистры строба (Strobe) могут быть прочитаны или
записаны. Набор Custom-регистров может изменяется
между OCS (Old ChipSet - A500, A1000, старая A2000), ECS (Enhanced ChipSet -
A600, новая A2000, A3000) и AGA (Advanced Graphics - A1200, A4000). Это
полезно для поиска в старых программах ошибок
из-за обращений к новым регистрам AGA.</p>

<h4>Как это работает</h4>

<p>Если Snoop включен, WHDLoad отмечает в списке
перевода диспетчера памяти (MMU) адреса Custom и Cia
регистров, как неверные. Из-за этого, каждый
доступ к Custom или Cia регистрам закончится
исключением &quot;Ошибка Доступа&quot;. Это
исключение будет взято под управление WHDLoad.
Вначале, он проверяет, что доступ действителен.
Если доступ недействителен, программа будет
закончена. Если доступ действителен и если это
операция чтения, он будет эмулироваться и
выполнение программы продолжится. Если это
операция записи то WHDload дополнительно, сохранит
значение во внутреннем буфере. <br>
Произойдёт замедление выполняемой программы,
так как будут еще обрабатываться исключения и
будет производиться эмуляция. Насколько сильно
замедлится программа, зависит от типа
центрального процессора, типа Chip-памяти (16/32-bit) и
выравнивания указателя стека, если Chip-память 32-х
битная (есть выравнивание по длинным словам или
нет). Это также отличается для типа доступа (байт /
слово / длинное слово, чтение/запись). 68030 пишет,
быстрее чем, читает (потому что чтение, фрейма
стека включает 92 байта, запись - 32 байта), на
процессорах 68060 чтение, быстрее, потому что
эмуляция для записи, более сложная. </p>

<h4>Режим быстрого слежения (Fast Snoop)</h4>

<p>Параметр <a href="opt.html#Snoop">Snoop/S</a> активизирует
режим быстрого слежения. Доступы по чтению
проверяться не будут. Не будет выполняться никаких
специальных проверок. Этот способ может быть
полезен только для получения содержания
Custom-регистров, например, чтобы сделать снимок
экрана, используя <a href="sp.html">SP</a>.</p>

<h4>Сканер Copper List'а</h4>

<p>Начиная с версии 13, WHDLoad также может сканировать
копперлисты (copperlists). Сканер будет активирован на
запись в регистры <strong><tt>coplc</tt></strong>, если активизирован
copper dma, или когда установленная программа активизирует
coppper dma, записывая в регистр<strong><tt> dmacon</tt></strong>.
Сканер следит за копперлистом и подтверждает все
инструкции Move, применяя ограничения, наложенные
опцией Snoop (OCS / ECS / AGA). Инструкции Skip и Wait (за
исключением CEND) будут игнорироваться. Когда он
находит недействительные вхождения,
установленная программа завершается. Сканер
также следит за ответвлениями (<tt>copjmp</tt>),
обнаруживает циклы и проверяет до 16 подсписков.
Инструкции Move в копперлистах будут сохранены во
внутреннем файле регистров, который будет создан
при выходе WHDLoad. Сканер не активен в режиме
быстрого слежения&nbsp; (Fast Snoop). </p>

<h4>Проверка приоритета блиттера</h4>

<p>Когда активизирована опция ChkBltHog/S, WHDLOAD
проверит, что установленная программа не активизирует
бит BltHog, записывая в <tt>dmacon</tt> регистр. Приоритет
блиттера может создать проблемы на некоторых
аппаратных конфигурациях при использовании всех
его возможностей (при использовании всех каналов).
</p>

<h4>Проверка размера блиттера</h4>

<p>Когда параметр ChkBltSize/S активизирован, WHDLOAD
проверит, чтобы блиттер не работал с памятью за
пределами области BaseMem. При доступе на запись в <strong><tt>bltsize</tt>
</strong>или <strong><tt>bltsizh</tt></strong>, он проверяет,
установлен ли линейный режим в <strong><tt>bltcon1</tt></strong>.
Если линейный режим активен, проверка размера
будет отменена. Иначе WHDLoad вычислит первое и
последнее слово к доступу для каждого
активированного канала прямого доступа к памяти.
Если один адрес находится за пределами области
памяти BaseMem, то программа будет завершена с
выводом окна сообщения. Вычисление
предназначено для работы со всеми режимами
(ascending/descending, positive/negativ modulos, odd modulos/pointers). <br>
Помните, что режим &quot;line drawing&quot; не проверяется и
что все регистры блиттера могут быть перезаписаны
коппером, в случае если установлен <strong><tt>copcon</tt></strong>.
</p>

<h4>Проверка ожидания блиттера (Blitter Wait Check)</h4>

<p>Когда параметр ChkBltWait/S активизирован, WHDLOAD будет
использовать трассировку инструкций на предмет
того, что установленная программа действительно
правильно ждет окончания работы блиттера, перед
его следующим запуском. Whdload использует
внутреннюю переменную, которая отображает
рабочее состояние блиттерa. Переменная устанавливается,
когда производится запись в <tt>bltsize</tt> или <tt>bltsizh</tt>,
и сбрасывается, когда происходит чтение из
регистра <tt>dmaconr</tt>. При каждой записи в регистр
блиттера, проверяется значение переменной, и
если значение показывает, что блиттер запущен, то
установленная программа будет завершена, а WHDLoad
сообщит PC последней запущенной задачи блиттера
совместно с реальным доступом.<br>
У данного параметра есть два главных недостатка:<br>
1) использование блиттера через коппер НЕ проверяется;<br>
2) использование перерываний блиттера вынудит
процедуру проверки выводить бессмысленные
сообщения об ошибках.</p>

<h4>Планы на будущее</h4>

<p>Планируется реализовать такую возможность, как
приостановка программы и свёртывание ее в иконку.
Для этого отлично подходит <strong>Snoop</strong>. Поэтому,
для обеспечения совместимости в дальнейшем,
рекомендую авторам инсталляционных модулей
проверять корректность работы ваших патчей с
параметром Snoop.</p>

<h4>Системные требования</h4>

<p>Для работы параметра Snoop необходим диспетчер
памяти (MMU). WHDLoad также должен <a href="mmu.html#usercontrol">использовать</a>
MMU, поэтому на машинах с процессорами 68030 необходимо
активизировать опцию <a href="opt.html#MMU">MMU/S</a>. </p>

<h4>Ограничения</h4>

<ul>
  <li>68020 + 68851 <ul>
      <li>Эта конфигурация в данный момент не
        поддерживается</li>
    </ul>
  </li>
  <li>68030 <ul>
      <li>Неизвестно никаких ограничений </li>
    </ul>
  </li>
  <li>68040 <ul>
      <li>Эта конфигурация в данный момент не
        поддерживается</li>
    </ul>
  </li>
  <li>68060 <ul>
      <li>Инструкция<tt> <strong>movem</strong></tt> может обратиться к
        недействительному регистру, не создав при этом
        сообщения об ошибке доступа. Это возможно потому,
        что только первое обращение будет обработано на
        соответствие действительному регистру.</li>
      <li>Инструкция<tt> move &lt;Cia/Custom register&gt;,sr</tt>&nbsp; будет
        выполнена неправильно, если она изменяет часть
        регистра статуса, принадлежащую супервайзеру,
        часть супервайзера не изменится. </li>
      <li>Любая из команд <tt>(ssp)+</tt> или <tt>-(ssp)</tt> совместно
        с доступом по записи в регистры Cia или Custom не
        может быть обработана в связи с проблемами
        фрейма стека. WHDLoad обнаружит такое обращение и
        завершит работу программы с соответствующим
        сообщением.</li>
      <li>Инструкции не должны одновременно обращаться к
        более чем одному &quot;snooped&quot;-регистру. Это
        означает, что код, подобный move.b ($dff006), ($bfd800) не
        может быть обработан и если такой код выполнится,
        то WHDLOAD выведет сообщение об ошибке доступа.</li>
    </ul>
  </li>
</ul>
</body>
</html>
