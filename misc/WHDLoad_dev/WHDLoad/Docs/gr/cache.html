<HTML>
<HEAD>
<TITLE>Χειρισμός CPU Cache</TITLE>
<meta name="DC.Language" content="gr">
<meta http-equiv="content-language" content="gr">
<meta http-equiv="content-type" content="text/html; charset=iso-8859-7">
<!-- $Id: cache.html 1.2 2007/08/19 12:24:49 wepl Exp wepl $ -->
</HEAD>
<BODY>
<h3>Γενικά για CPU Cache</h3>
Για να βελτιώσουν την απόδοσή τους μερικοί από τους επεξεργαστές της οικογένειας 68k
μπορούν να κρατάνε στην cache διευθύνσεις μνήμης.
<br>Στα Caches αναφερόμαστε παντα με λογικές διευθύνσεις, συμπεριλαμβανομένου του
κώδικα συνάρτησης της πρόσβασης. Αυτό σημαίνει ότι η πρόσβαση σε User Mode και
Supervisor Mode θα δημιουργήσει διαφορετικές καταχωρήσεις Cache (παρακαλώ συμβουλευτείτε τα εγχειρίδια της Motorola
για περισσότερες πληροφορίες).
<p>Ακολουθεί μία περιγραφή των δυνατοτήτων caching στους 68k CPU:
<ul><li>68000
τίποτα
<li>68010<ul>
<li>Instruction Prefetch
<br>δύο words prefetch, ένας καταχωρητής αποκωδικοποίησης word
<li>Loop Mode
<br>εδώ μπαίνει όταν μία εντολή word ακολουθείται από ένα DBcc, δεν υπάρχουν
άλλες λήψεις εντολών μέχρι το τέλος του loop
</ul><li>68020<ul>
<li>Instruction Prefetch
<br>μία long word
<li>Instruction Cache
<br>16 γραμμές &aacute; 16 byte = 256 byte
<br>μπορεί να ενεργοποιηθεί ή να παγώσει μέσω του CACR
</ul><li>68030<ul>
<li>Instruction Prefetch
<br>μία long word
<li>Instruction Cache
<br>16 γραμμές &aacute; 16 byte = 256 byte
<br>μπορεί να ενεργοποιηθεί ή να παγώσει μέσω του CACR
<li>Data Cache
<br>16 γραμμές &aacute; 16 byte = 256 byte
<br>μπορεί να ενεργοποιηθεί ή να παγώσει μέσω του CACR
<br>πάντα WriteThrough
<br>επιλεγόμενο Write Allocation mode
</ul><li>68040<ul>
<li>Instruction Prefetch
<br>μία long word
<li>Instruction Cache
<br>256 γραμμές &aacute; 16 byte = 4096 byte
<br>can be enabled via the CACR
<li>Data Cache
<br>256 γραμμές &aacute; 16 byte = 4096 byte
<br>μπορεί να ενεργοποιηθεί μέσω του CACR
<br>επιλεγόμενα modes CopyBack/WriteThrough μέσω MMU
</ul><li>68060<ul>
<li>Instruction Prefetch
<br>μία long word
<li>Instruction Cache
<br>512 γραμμές &aacute; 16 byte = 8192 byte
<br>μπορεί να ενεργοποιηθεί, να παγώσει και να μειωθεί στο μισό μέγεθος μέσω του CACR
<li>Branch Cache
<br>μπορεί να ενεργοποιηθεί μέσω του CACR
<br>δεν επηρρεάζεται από το MMU setup!
<li>Superscalar Dispatch
<br>μπορεί να ενεργοποιηθεί μέσω του CACR
<li>Data Cache
<br>512 γραμμές &aacute; 16 byte = 8192 byte
<br>μπορεί να ενεργοποιηθεί, να παγώσει και να μειωθεί στο μισό μέγεθος μέσω του CACR
<br>επιλεγόμενα modes CopyBack/WriteThrough μέσω MMU
<li>Push Buffer
<br>μπορεί να απενεργοποιηθεί μέσω του PCR
<li>Store Buffer
<br>μπορεί να ενεργοποιηθεί μέσω του CACR
<br>Οι σελίδες δεν πρέπει να είναι NonCachable Serialized (precise)
</ul></ul>
<h4><a name="cache">Διαχείριση Cache στο WHDLoad</a></h4>
Το πρώτο σημαντικό πράγμα που πρέπει να κατανοηθεί είναι ότι τα caches στους 68030..68060
ελέγχονται από τον Cache Control Register (CACR) <b>και</b> το MMU
(με την προϋπόθεση ότι το WHDLoad χρησιμοποιεί και ελέγχει το MMU)!
<br>Στον CACR τα caches θα είναι καθολικά ενεργοποιημένα ή απενεργοποιημένα. Με τη χρήση του
MMU συγκεκριμένες Σελίδες (των 4 KByte με το WHDLoad) θα σημειωθούν για το ότι μπορούν
να είναι cached.
<br>Στον 68030 μία σελίδα μνήμης μπορεί να είναι Cacheable ή NotCacheable. Σε έναν
68040/68060 μπορεί να είναι cachable WriteThrough, cachable CopyBack, NonCachable
(impercise) ή NonCachable Serialized (precise).
<p>Εάν το MMU δεν χρησιμοποιηθεί από το WHDLoad, τότε ελέγχει μόνο τον CACR.
<h4>Προεπιλεγμένες Ρυθμίσεις Cache</h4>
Από προεπιλογή οι περιοχές του WHDLoad, του Slave και ExpMem σημειώνονται ως
cacheable CopyBack. Η περιοχή BaseMem σημειώνεται ως NonCachable, και τα Data
και Instruction Cache ενεργοποιούνται στον CACR. Οπότε το πρόγραμμα που βρίσκεται
στην περιοχή BaseMem τρέχει χωρίς Caches αλλά το WHDLoad και το Slave χρησιμοποιούν
τα Caches για καλύτερη απόδοση.
<h4>Έλεγχος Cache για Προγραμματιστές</h4>
Υπάρχουν δύο συναρτήσεις resload που ελέγχουν τα Caches: <a HREF="../../Autodoc/whdload.doc">resload_SetCACR</a> 
και <a HREF="../../Autodoc/whdload.doc">resload_SetCPU</a>. Η resload_SetCACR είναι η
ιστορικά παλιότερη ρουτίνα και μπορεί να αντικατασταθεί πλήρως από την resload_SetCPU (Το WHDLoad
εσωτερικά κρατάει τις παραμέτρους της resload_SetCACR και καλεί την resload_SetCPU).
Τελικά η χρήση της resload_SetCACR συνιστάται για όλους τους ανθρώπους που δεν ξέρουν
αρκετά για τα Caches και τη συμπεριφορά τους σε ένα σύστημα Amiga. Χρησιμοποιώντας
την resload_SetCACR τα instruction και data cache μπορούν ανεξάρτητα να ενεργοποιηθούν ή
να απενεργοποιηθούν. Η resload_SetCACR επηρρεάζει μόνο τη δυνατότητα cache της περιοχής BaseMem.
<h4>Έλεγχος Cache για Χρήστες</h4>
Αν ο προγραμματιστής έχει κάνει καλά τη δουλειά του τότε ο χρήστης δεν έχει τίποτα να κάνει
σχετικά με τα Caches γιατί όλες οι απαραίτητες ρυθμίσεις έχουν ήδη γίνει από το
Slave.
<br>Ωστόσο ίσως υπάρχουν δύο λόγοι για να αλλάξει χειροκίνητα η ρύθμιση Cache.
Πρώτον να κάνετε μία εγκατάσταση να δουλέψει σωστά γιατί έχει πρόβλημα επειδή τρέχει πολύ
γρήγορα (π.χ. δημιουργεί παράσιτα στα γραφικά) και δεύτερον για να κάνετε ένα εγκατεστημένο
πρόγραμμα ποιό γρήγορο.
<p>Για να κάνετε ένα πρόγραμμα που δεν λειτουργεί να λειτουργήσει, η επιλογή 
	<a href="opt.html#NoCache">NoCache</a> μπορεί να χρησιμοποιηθεί. Αυτή η επιλογή
απενεργοποιεί όλα τα τα caches και σημειώνει όλη τη μνήμη ως NonCachable Serialized (precise). Αν το μηχάνημα
έχει 32-bit Chip-Memory θα συνεχίσει να είναι γρηγορότερο από μία αυθεντική A500.
<p>Για να κάνετε ένα εγκατεστημένο πρόγραμμα γρηγορότερο μπορούν να οριστούν μερικές επιλογές που θα ενεργοποιήσουν
τα Caches. Αυτό θα αντικαταστήσει τις ρυθμίσεις του Slave. Σε έναν 68020 η επιλογή
<a href="opt.html#Cache">Cache</a> μπορεί να οριστεί. Σε 68030 επίσης η επιλογή 
<a href="opt.html#DCache">DCache</a> μπορεί να οριστεί που συμπεριλαμβάνει την επιλογή Cache.
Στον 68060 υπάρχουν περισσότερες επιλογές: <a href="opt.html#BranchCache">BranchCache</a>,
<a href="opt.html#StoreBuffer">StoreBuffer</a> και
<a href="opt.html#SuperScalar">SuperScalar</a>. Η επιλογή 
<a href="opt.html#ChipNoCache">ChipNoCache/S</a> μπορεί να βελτιώσει την απόδοση
σε 68040 και 68060, δείτε παρακάτω.
<a name="chipmem"></a><h4>Δυνατότητα Cache της Μνήμης Chip</h4>
Η δυνατότητα cache μπορεί να οριστεί όχι μόνο για τον ίδιο τον επεξεργαστή (CACR) και τις ρυθμίσεις του MMU
αλλά επίσης και για εξωτερικό hardware. Ο CPU δίνει σήμα στο bus αν προσπαθεί να
βάλει στη cache μία πρόσβαση. Και το εξωτερικό hardware μπορεί να στείλει σήμα στον CPU (μετά από
τοποθέτηση μίας διεύθυνσης στο address bus κατά τη διάρκεια πρόσβασης μνήμης) ότι κάποια
πρόσβαση δεν πρέπει να μπει στην cache.
<br>Ο μηχανισμός που το hardware στέλνει σήμα στον CPU ότι η μνήμη πρέπει ή δεν πρέπει
να μπει στη cache χρησιμοποιείται σε όλες τις (AFAIK) Amiga και τα CPU-Boards που περιέχουν
CPU &gt;= 68030 (επειδή έχουν data cache). Επηρρεαζόμενες είναι όλη η
Chip-Memory και το IO-Space (Cia/Custom/RTC) που δεν πρέπει να μπουν στη cache
από το data cache. Αυτό είναι απαραίτητο για να αποφευχθούν ασυμφωνίες της cache, για
παράδειγμα λόγω δραστηριότητας DMA.
<br>Η αντίδραση του CPU σε μία άρνηση από hardware για τοποθέτηση πρόσβασης στην cache
διαφέρει σε διαφορετικούς CPU. Στον 68030 δεν υπάρχει επίπτωση στην απόδοση της
πρόσβασης, τα δεδομένα απλά δεν θα μπούν στη cache. Στον 68040 οι προσβάσεις ανάγνωσεις θα γίνουν
σε πλήρη ταχύτητα αλλά οι προσβάσεις εγγραφής (CopyBack) θα
ακυρωθούν και θα ξεκινήσουν πάλι χωρίς να μπαίνουν στη cache
με αποτέλεσμα περίπου 5 φορές (εξαρτάται από το
hardware και την ταχύτητα του CPU) αργότερη πρόσβαση σε σύγκριση
με μία πρόσβαση χωρίς cache. Στον 68060 οι προσβάσεις ανάγνωσης και εγγραφής θα ακυρωθούν
και θα ξεκινήσουν πάλι. Οι προσβάσεις ανάγνωσεις
θα είναι περίπου 3 φορές αργότερες και οι προσβάσεις εγγραφής θα είναι περίπου 5 φορές αργότερες.
<br>Τα αναφερόμενα θέματα σχετίζονται με προσβάσεις δεδομένων. Οι προσβάσεις εντολών συνήθως
δεν επηρρεάζονται και είναι cacheable μέσα στην Chip-Memory.
Υπάρχει κάποιο (ίσως προβληματικό) hardware που δεν επιτρέπει εντολές να
μπαίνουν στη cache από την Chip-Memory. Σε τέτοιο hardware η επιλογή <a
href="opt.html#ChipNoCache">ChipNoCache/S</a> πρέπει να χρησιμοποιηθεί για να
αποφευχθεί μεγάλη καθυστέρηση στην ταχύτητα εκτέλεσης γιατί διαφορετικά οι προσβάσεις εντολών θα είναι
περίπου 2 φορές αργότερες.
<p>Μπορείτε να ελέγξετε αυτή τη συμπεριφορά στο μηχάνημά σας εκτελώντας το <i>Speed.Slave</i>
που περιέχεται στο κατάλογο <tt>src/memory-speed</tt> του αρχείου προγραμματιστών.
<h4>Write Allocation</h4>
Η Write Allocation ελέγχει το χειρισμό της cache στον 68030 όταν συμβαίνει αστοχία cache
σε μία διαδικασία εγγραφής. Η Write Allocation πρέπει να είναι ενεργοποιημένη όταν μέρη του
εγκατεστημένου προγράμματος τρέχουν σε User Mode. Αν το εγκατεστημένο πρόγραμμα τρέχει μόνο σε
Supervisor Mode η Write Alloction μπορεί να απενεργοποιηθεί, που μπορεί να δώσει ένα μικρό
βοήθημα απόδοσης.
<h4>Branch Cache</h4>
<p>Η Branch Cache είναι διαθέσιμη μόνο σε 68060. Είναι ένα είδος
cache εντολών για εντολές branch. Αλλά σε αντίθεση με την
cache εντολών δεν επηρρεάζεται από τις ρυθμίσεις του MMU! Αυτό σημαίνει ότι ακόμα και όταν
η κατάλληλη Σελίδα μνήμης έχει σημειωθεί ως Non Cacheable, οι εντολές branch
θα είναι cached εάν η Branch Cache είναι ενεργοποιημένη.</p>
<hr>Διαβάστε τα Motorola Microprocessors User Manuals για περισσότερες πληροφορίες.
Εάν έχετε κάτι να προσθέσετε ή να διορθώσετε σε αυτή τη σελίδα παρακαλώ <A
HREF="mailto:wepl@whdload.de">επικοινωνήστε</A> μαζί μου.
</BODY>
</HTML>
