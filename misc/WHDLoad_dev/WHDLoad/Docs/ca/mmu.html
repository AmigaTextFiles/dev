<HTML>
<HEAD>
<TITLE>WHDLoad i la MMU</TITLE>
<meta name="DC.Language" content="ca">
<meta http-equiv="content-language" content="ca">
<meta http-equiv="content-type" content="text/html; charset=iso-8859-1">
<!-- $Id: mmu.html,v 1.1 2007/08/19 12:24:49 wepl Exp wepl $ -->
</head>
<BODY>
<h3>WHDLoad i la Unitat de Gestió de Memòria (MMU, <i>Memory Management Unit</i>)</h3>
Els següents processadors de la família 68k: 68030 , 68040, 68060 contenen una MMU. També existeix l'anomenada versió EC (econòmica) d'aquests processadors que disposa d'una unitat MMU 
"falsa" sense funcionalitat. Per exemple, totes els A4000/030 estàndard disposen d'una CPU 68EC030. En plaques acceleradores de tercers això és diferent, consulti la documentació apropiada
 per a aprendre sobre aquest tema. Fins a on jo sé, tots els 68040/68060 utilitzats en Amiga són CPU's complertes que contenen una MMU funcional (degut al fet que el mode burst i el bus 
 Zorro III requereixen mapeig de l'espai d'E/S mitjançant MMU). La distinció entre una CPU complerta i una versió EC no pot fer-se per programari (no almenys en un temps acceptable). 
 Per tant l'usuari ha de fer això configurant les <a href="#usercontrol">opcions correctes</a> a WHDLoad.
<br>Per al 68020 existeix una MMU externa anomenada 68851, però actualment no està suportada per WHDLoad. 
<h4>Funcionalitats d'una MMU i el seu ús a WHDLoad</h4>
El propòsit principal de la MMU és traduir adreces lògiques a adreces físiques. Això es requereix per a la memòria virtual i espais separats de memòria (per exemple en un sistema 
multiprocés protegit). Una altra característica es la d'especificar propietats especials com Solament Mode Supervisor, Protecció Contra Escriptura i Mode de Caché per a cada adreça física 
en l'espai d'adreces (basant-se en pàgines, on una pàgina utilitzada per WHDLoad consisteix en 4096 bytes). WHDLoad no empra la traducció d'adreces lògiques a físiques però sí utilitza la MMU 
per a <a href="#mem">protecció de memòria</a>, <a href="cache.html">gestió de la caché</a> i algunes funcionalitats especials (<a href="snoop.html"><i>Snooping</i></a>, <A
HREF="../../Autodoc/whdload.doc">resload_Protect#?</a>).
<h4><a name="mem">Protecció de memòria a WHDLoad</a></h4>
Durant l'arrencada, WHDLoad recorre la llista de memòria i construeix un arbre de traducció que inclou tota la memòria accessible. Marca els següents espais d'adreces com vàlids i accessibles:
 $0...BaseMem (usant la informació de l'Esclau), $dff000...$dff200 (registres Custom), $bfd000...$bff000 (registres CIA) i la memòria utilitzada per l'Esclau i WHDLoad. Si es troba un 
 Congelador en memòria (<i>freezer</i>), la memòria que utilitzi el congelador també serà marcada com a vàlida. Tota altra memòria serà marcada com a invàlida i per tant qualsevol accés a 
 aquesta àrea (Lectura o Escriptura) ocasionarà una Excepció de Falla d'Accés que acabarà amb el quadre de diàleg d'error apropiat creat per WHDLoad. 
<h4><a name="usercontrol">Control per part de l'usuari de la gestió de MMU a WHDLoad</a></h4>
Hi ha 3 modes diferentes en què WHDLoad pot afectar una MMU :
<ol>
<li><b>Ignorar la MMU</b>:<br>
En aquesta mode WHDLoad no canviarà cap registre relacionat amb la MMU. Això pot ser útil si s'estant executant programes que modifiquen la MMU i es vol que la funcionalitat d'aquests programes 
romangui intacta (per exemple un congelador per programari com TK). 
<br>
Precaució: Atès que WHDLoad no pren control per sí mateix de la MMU, poden aparéixer un munt de problemes. Aquests problemes poden causar caigudes del sistema, mal funcionament o altres 
comportaments inesperats. Aquí hi ha una llista dels riscos existents: 
<ul>
<li>Executar Enforcer/CyberGuard o una eina similar congelarà/penjarà la màquina, atès que WHDLoad crearà una gran quantitat de Hits cada vegada que arrenqui/apagui el S.O.
Aquests Hits no són errors de WHDLoad sinó part d'una operació normal.

<li>Les versions més noves de la 68060.library (començant per v41.1) remapejaran la memòria $0-$1000 (la primer pàgina) a una ubicació en memòria Fast emprant la MMU; en mode "ignorar la MMU" 
aquesta traducció d'adreces romandrà intacta i si el programa instal·lat intenta utilitzar aquesta àrea per a qualsevol acció DMA (per ex. a causa de una <i>copperlist</i> en aquesta àrea) 
els resultats no poden predir-se, atès que la CPU escriurà/llegirà la ubicació de memòria Fast mentre que la DMA ho farà sobre la memòria Xip real que conté dades aleatòries. 
<li>Si el codi de MMU en execució depèn del seu gestor d'excepcions ("Access Fault" exception) l'opció 
<a href="opt.html#NoTrapHandler">NoTrapHandler/S</a>
s'ha d'activar, d'altra banda qualsevol excepció que ocorri serà gestionada per WHDLoad, el qual sortirà del programa instal·lat si succeeix qualsevol cosa no esperada 
<li>Si el codi de MMU en execució usa qualsevol memòria (gestió d'excepcions, arbre de traducció, ...) dintre de BaseMem del programa instal·lat, ocasionarà una caiguda del sistema, 
atès que la BaseMem serà sobreescrita durant l'execució del programa instal·lat (temporalment) 
<li>En general cada programa que canviï funcions bàsiques del sistema (emprant la MMU) pot entrat en conflicte amb WHDLoad ... 
</ul>
<li><b>Desactivar la MMU</b>:<br>
En aquest mode, que és possible només en un 68030, la MMU serà desactivada per WHDLoad i no estaran disponibles funcionalitats relacionades amb la MMU. 

<li><b>Utilitzar la MMU</b>:<br>
En aquest mode WHDLoad prèn el control total sobre la MMU i realitza la protecció de memòria i gestió de la caché tal com s'ha explicat anteriorment
</ol>
Al 68030 el mode per defecte és <i>Desactivar la MMU</i>. Als 68040/68060 el mode per defecte és <i>utilitzar la MMU</i>.
Es disposa de dos opcions per a controlar aquest comportament: <a href="opt.html#MMU">MMU/S</a> força WHDLoad
a <i>emprar</i> la <i>MMU</i> i és requerit en sistemes basats en 68030 per a utilitzar les funcionalitats de la MMU.
<a href="opt.html#NoMMU">NoMMU/S</a> desactiva l'ús de la MMU per part de WHDLoad (<i>ignorar la MMU</i>).
<center><p><cite>Un hit d'<i>Enforcer</i> és un hit d'<i>Enforcer</i>, punt.</cite> (Michael Sinz)</p></center>
</BODY>
</HTML>
