<HTML>
<HEAD>
<TITLE>Snooping</TITLE>
<meta name="DC.Language" content="pl">
<meta http-equiv="content-language" content="pl">
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2">
<!-- $Id: snoop.html 1.4 2004/01/12 17:18:39 wepl Exp wepl $ -->
</HEAD>
<BODY>
<h3>Snooping</h3>
<h4>Co to jest?</h4>
Snooping to jedna z cech WHDLoad, która dokonuje sprawdzania i odnotowuje
dostêpy do rejestrów CIA oraz rejestrów w³asnych.
Je¶li opcja <a href="opt.html#Snoop">Snoop</a> jest aktywna, wszystkie
nieprawid³owe i b³êdne próby dostêpu wygeneruj± b³±d dostêpu i przerwanie pracy
uruchamianego programu. Do takich prób dostêpów mo¿na zaliczyæ:
<ul>
<li>dostêpy do nieistniej±cych rejestrów,
<li>odczyt z rejestrów oznaczonych jako przeznaczone &quot;tylko do zapisu&quot; (Write Only),
<li>zapis do rejestrów oznaczonych jako przeznaczone &quot;tylko do odczytu&quot; (Read Only),
<li>dostêpy do rejestrów wczesnego odczytu (Early Read),
<li>dostêpy typu &quot;byte write&quot; (za wyj±tkiem <tt>bltcon0l</tt> i <tt>aud*vol+1</tt>).
</ul>
Rejestry &quot;Strobe&quot; mog± byæ odczytywane i zapisywane. Zestaw sprawdzonych
rejestrów w³asnych mo¿e siê ró¿niæ w zale¿no¶ci od uk³adów graficznych: OCS
(Old ChipSet - A500, A1000, stara A2000), ECS (Enhanced ChipSet
- A600, nowa A2000, A3000) i AGA (Advanced Graphics - A1200, A4000). Jest to
u¿yteczne zw³aszcza przy wychwytywaniu b³êdów w starych programach.
<h4>Jak to dzia³a?</h4>
Je¿eli opcja &quot;Snoop&quot; jest w³±czona, WHDLoad zaznacza w drzewie
translacji MMU adresy rejestrów CIA i rejestrów w³asnych
jako nieprawid³owe. Z tego powodu ka¿dy dostêp do rejestrów w³asnych lub/i CIA
generuje b³±d dostêpu. WHDLoad wówczas sprawdza, czy próba dostêpu by³a prawid³owa.
Je¿eli oka¿e siê, ¿e nie by³a, nast±pi przerwanie wykonywanego programu. Je¿eli
próba dostêpu jest prawid³owa i wyst±pi³a operacja odczytu, zostanie ona zaemulowana
i bêdzie kontynuowane wykonywanie programu. Je¿eli wyst±pi³a operacja zapisu,
WHDLoad odpowiednio dokonana zapisu warto¶ci wewnêtrznego schowka.
<br>Zaznaczanie obszarów pamiêci oraz emulacja poci±gaj± za sob±
zwolnienie wykonywania programu. Jak bardzo, to zale¿y od typu procesora
oraz typu pamiêci graficznej (16/32-bit), a tak¿e od ustawienia wska¼nika stosu.
Zale¿ne jest to równie¿ od typu dostêpu (Bajt/S³owo/D³ugie S³owo, Zapis/Odczyt).
Na 68030 zapis jest szybszy ni¿ odczyt
(gdy¿ odczyt stosu zajmuje 92 bajty, a zapis 32 bajty), na
68060 odczyt jest szybszy, poniewa¿ emulacja zapisu jest bardziej z³o¿ona.
<h4>Tryb &quot;Fast Snoop&quot;</h4>
Opcja <a href="opt.html#Snoop">Snoop/S</a> uaktywnia szybki snooping.
Dostêpy odczytu nie bêd± sprawdzane. Równie¿ nie s± prowadzone oznaczenia.
Ten tryb mo¿e byæ przydatny w celu zdobycia zawarto¶ci rejestrów w³asnych, np.
zapisania obrazka przy wykorzystaniu programu <a href="sp.html">SP</a>.
<h4>Skaner copperlisty</h4>
Od WHDLoad w wersji 13 sprawdzana jest równie¿ copperlista. Skaner
zostaje uaktywniony podczas zapisu do rejestrów <tt>coplc</tt> je¶li
DMA coppera jest w³±czone lub wtedy, gdy zainstalowany program w³±cza DMA coppera
poprzez zapis do rejestrów <tt>dmacon</tt>.
Skaner pod±¿a za copperlist±, sprawdza i ustawia wszystkie instrukcje Move
zgodnie z restrykcjami opcji Snoop (OCS/ECS/AGA).
Instrukcje Skip i Wait (za wyj±tkiem CEND) s± ignorowane. Gdy zostanie
odnaleziona nieprawid³owa próba dostêpu, zainstalowany program zostanie
wy³±czony. Skaner pod±¿y za odga³êzieniami
(<tt>copjmp</tt>), wykryje pêtle i sprawdzi do 16 podlist. Instrukcje
Move w copperli¶cie zostan± zapisane do wêwnêtrznego pliku rejestru,
który zostanie zapisany na dysk przy wyj¶ciu z WHDLoad. Skaner jest
nieaktywny w trybie &quot;Fast Snoop&quot;.
<h4>Sprawdzanie priorytetu blittera</h4>
Gdy opcja &quot;ChkBltHog/S&quot; jest w³±czona, WHDLoad sprawdza, czy zainstalowany program
nie w³±cza bitu <tt>BltHog</tt> poprzez zapis do rejestru <tt>dmacon</tt>.
Priorytet blittera mo¿e powodowaæ problemy na niektórych konfiguracjach
w po³±czeniu z du¿ymi operacjami na blitterze (wykorzystanie wszystkich kana³ów).
<h4>Sprawdzanie rozmiaru blittera</h4>
Gdy opcja &quot;ChkBltSize/S&quot; jest w³±czona, WHDLoad sprawdza, czy zadania blittera
nie próbuj± przedostaæ siê poza pamiêæ okre¶lon± w BaseMem. Podczas próby
zapisu do <tt>bltsize</tt> lub <tt>bltsizh</tt> sprawdza, czy tryb linii jest w³±czony
w <tt>bltcon1</tt>. Je¿eli jest w³±czony, zostanie zignorowane sprawdzanie rozmiaru.
W przeciwnym razie WHDLoad wyliczy pierwsze i ostatnie s³owo dla ka¿ego
uaktywnionego kana³u DMA. Je¿eli jeden adres znajduje siê poza obszarem
BaseMem, program zostanie wy³±czony z odpowiedni± informacj± w oknie
komunikatu.
Obliczenia zosta³y zaprojektowany w taki sposób, aby wspó³pracowa³y
ze wszystkimi trybami (rosn±cy/malej±cy, pozytywny/negatywny, nieparzyste
modu³y/wska¼niki).
<br>Pamiêtaj, ¿e tryb rysowania linii nie jest sprawdzany i wszystkie rejestry
blittera mog± byæ zapisane do coppera je¶li bit <tt>copcon</tt> jest ustawiony.
<h4>Sprawdzanie oczekiwania blittera</h4>
Gdy opcja &quot;ChkBltWait/S&quot; jest w³±czona WHDLoad u¿yje instrukcji ¶ledzenia, aby
sprawdziæ, czy zainstalowany program wykonuje poprawienie oczekiwanie na
zakoñczenie wykonywania operacji blittera, zanim ten rozpocznie wykonywaæ
kolejn±. Wykorzystywana jest do tego wewnêtrzna zmienna, która reprezentuje
stan pracy blittera. Zmienna jest ustawiona, gdy dokonywany jest zapis
do <tt>bltsize</tt> lub <tt>bltsizh</tt>. Zmienna jest czyszczona,
gdy dokonywany jest odczyt z rejestru <tt>dmaconr</tt>.
Przy ka¿dorazowym zapisie do rejestru blittera sprawdzana jest wewnêtrzna
zmienna. Je¿eli wykazuje ona pracê blittera, wykonywanie zainstalowanego programu
zostanie przerwane, a WHDLoad zg³osi PC ostatniej czynno¶ci wykonywanej
przez blitter.
<br>Istniej± dwa &quot;w±skie gard³a&quot; tej opcji. Pierwsze to takie, ¿e nie
jest sprawdzane wykorzystanie blittera poprzez coppera, drugie - wykorzystanie
przerwañ blittera.
<h4>Przysz³o¶æ</h4>
Planujê dodanie funkcji podobnych do zamra¿ania (Freezing) i ikonifikacji (Iconifing)
Zalecane jest, aby autorzy programów instalacyjnych sprawdzali swoje pliki .slave z opcj±
&quot;Snoop&quot;, aby zapewniæ sobie kompatybilno¶æ w przysz³o¶ci.
<h4>Wymagania</h4>
Dla opcji &quot;Snoop&quot; wymagane jest MMU. WHDLoad musi
<a href="mmu.html#usercontrol">u¿ywaæ</a> MMU, a z racji tej <a
href="opt.html#MMU">MMU/S</a> musi byæ w³±czony na procesorach 68030.
<h4>Ograniczenia</h4>
<ul>
<li>68020 + 68851
<ul>
<li>Nie jest obs³ugiwany.
</ul>
<li>68030
<ul>
<li>Bez ograniczeñ.
</ul>
<li>68040
<ul>
<li>Nie jest obecnie obs³ugiwany.
</ul>
<li>68060
<ul>
<li>Instrukcja <tt>movem</tt> mo¿e wywo³ywaæ dostêpy do nieprawid³owych
rejestrów bez wygenerowania b³êdu dostêpu. Jest to mo¿liwe gdy¿
tylko pierwsza próba dostêpu jest sprawdzana.
<li>Instrukcja <tt>move &lt;rejestr CIA/w³asny&gt;,sr</tt> jest wykonywana
nieprawid³owo.
<li>Jakakolwiek instrukcja <tt>(ssp)+</tt> lub <tt>-(ssp)</tt> w po³±czeniu z
zapisem do rejestrów CIA lub rejestrów w³asnych nie mo¿e zostaæ wykonana z powodu
problemów z ramk± stosu. WHDLoad wykrywa takie próby dostêpu i informuje
o nich stosownym komunikatem.
<li>Instukcje nie mog± odwo³ywaæ siê do wiêcej ni¿ jednego ¶ledzonego rejestru w tym samym czasie.
Oznacza to, ¿e np. kod <tt>move.b ($dff006),($bfd800)</tt> nie mo¿e zostaæ
wykonany. Je¿eli taki kod wyst±pi w programie, WHDLoad poka¿e komunikat o
b³êdzie dostêpu.
</ul>
</ul>
</BODY>
</HTML>
