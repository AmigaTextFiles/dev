/*
[ ]------------------------------------------------------------------------[ ]
 |                                                                          |
 |     Programmmodul    : NetUti.c                                          |
 |     Verwendung       : Routinen zur Dateiverwaltung im Netz              |
 |     erstellt am      : 09.03.1993                                        |
 |     letztes Update am: 14.02.1996                                        |
 |                                                                          |
 |     (Copyright)      : 1993 by Olaf Asholz                               |
 |                                                                          |
[ ]------------------------------------------------------------------------[ ]
*/

void Isam_Init(long FreeBytes)
  Variablen:
    long FreeBytes;          Größe des gewünschten freien Heap-Speichers

  Rückgabewert:
    void;
  Beschreibung:
    Initialisiert die BTIsam-Routinen;

int IsamIsInit(void)
  Variablen:
    void;
  Rückgabe:
    int;                     TRUE/FALSE
  Beschreibung:
    Liefert TRUE zurück, wenn die ISAM aktiviert ist.

int Remove_Datei(int id);
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
  Rückgabewert:
    int;             -1 oder id
  Beschreibung;
    Versucht die Datei mit Handle id freizugeben und alle Strukturen aus der
    ISAM zu entfernen. Gibt bei Erfolg -1 zurück. ID=Remove_Datei(ID);

int DupIsamHandle(char ***mem,dateifkt D,int ReadOnly,int OvWrite)
  Variablen:
    char ***mem;     Zeiger auf die Datenstruktur
    dateifkt D;      DateiInit-Funktion
    int ReadOnly;    TRUE/FALSE
    int OvWrite;     TRUE/FALSE
  Rückgabewert:
    int;             Dateihandle der Isam
  Beschreibung;
    Erzeugt eine zweite Datei mit gemeinsamen Zugriff auf den Stammsatz.

int First_Satz(int id,unsigned keynr);
int Last_Satz (int id,unsigned keynr);
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
    unsigned keynr;  Schlüsselnummer
  Rückgabewert:
    int;             True False
  Beschreibung;
    Liefert den ersten oder letzten Datensatz nach der Sortierung des Schlüssels
    keynr im Datenbereich zurück

int Next_Satz(int id,unsigned keynr, IsamKeyStr key)
int Prev_Satz(int id,unsigned keynr, IsamKeyStr key)
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
    unsigned keynr;  Schlüsselnummer
    IsamKeyStr key;  Vergleichsschlüssel
  Rückgabewert:
    int;             True False
  Beschreibung;
    Sucht den n"chsten Datensatz der mit den ersten strlen(key) chars
    mit key ?bereinstimmt und liefert ihn im Datenbereich zurück.

int Such_Satz(int id,unsigned keynr, IsamKeyStr key,int flag)
int Find_Satz(int id,unsigned keynr, IsamKeyStr key)
int Find_Satz_Quick(int id,unsigned keynr, IsamKeyStr key)
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
    unsigned keynr;  Schlüsselnummer
    IsamKeyStr key;  Vergleichsschlüssel
    int flag;        True False
  Rückgabewert:
    int;             True: Datensatz wurde gefunden und gelesen.
  Beschreibung:
    Wie Search_Key() und Find_Key() mit folgenden GetRec().
    Such_Satz sucht bei Flag True nach dem n"chst gr~?eren Datensatz
    dessen ersten strlen(key) chars mit key ?bereinstimmen.
    Die Quick-Routine pr?ft erst ob der Datensatz mit dem passenden
    Schlüssel sich nicht schon im Speicher befindet.

long Next_Key(int id,unsigned keynr, IsamKeyStr key);
long Prev_Key(int id,unsigned keynr, IsamKeyStr key);
long Such_Key(int id,unsigned keynr, IsamKeyStr key,int flag);
long Find_Key(int id,unsigned keynr,IsamKeyStr key);
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
    unsigned keynr;  Schlüsselnummer
    IsamKeyStr key;  Vergleichsschlüssel
    int flag;        True False
  Rückgabewert:
    long;            Datensatzreferenz
  Beschreibung:
    Such_Key sucht bei Flag True nach dem n?chst gr~?eren Datensatz
    dessen ersten strlen(key) chars mit key ?bereinstimmen.

int Lock_Satz (int id,LockMode lmode)
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
    LockMode lmode;  UnLock,LockSatz,LockKette,LockDatei,ReadLock
  Rückgabewert:
    int;             True False
  Beschreibung:
    Lockt einen oder mehrere Datens?tze oder eine ganze Datei.
    UnLock     hebt alle Locks auf.
    LockSatz   unlockt alle Datens?tze und lockt den in Daten[1] befindlichen
               Datensatz
    LockKette  wie Locksatz, jedoch ohne Freigabe der bisher gelockten.
               Anzahl durch MaxLockEntries in btisam.h beschr"nkt z.Zt. 4

    LockDatei  Lockt die ganze Datei zum alleinigen Gebrauch.
    ReadLock   Sch?tzt den Fileblock gegen Beschreiben durch andere Stationen

int Schreib_Satz(int id)
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
  Rückgabewert:
    int;             True False
  Beschreibung:
    Schreibt den Datensatz zurück wenn er sich ge"ndert hat(Daten[0]!=Daten[1]).

int Loesch_Satz (int id)
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
  Rückgabewert:
    int;             True False
  Beschreibung:
    L~scht ihn falls er zwischendurch in der Datei nicht ge"ndert wurde.

int Check_Satz(int id)
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
  Rückgabewert:
    int;             True False
  Beschreibung:
    Pr?ft ob Daten[1] immer noch dem Satz in der Datei entspricht.

int Clear_Satz(int id)
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
  Rückgabewert:
    int;             True False
  Beschreibung:
    Setzt Daten[0] und Daten[1] auf 0(memset).

int Kopie_Satz(int idd, int ids, unsigned keynr, IsamKeyStr key)
  Variablen:
    int idd;          Von DateiInit zurückgegebener Handle Destination
    int ids;          Von DateiInit zurückgegebener Handle Source
    unsigned keynr;   Schlüsselnummer
    IsamKeyStr key;   Vergleichsschlüssel
  Rückgabewert:
    int;             True False
  Beschreibung:
    Kopiert alle Datens?tze aus der Source-Datei in die Destination-Datei
    deren keynr-Schlüssel die ersten strlen(key) Stellen mit key
    ?bereinstimmt.

int Loesch_Isam(int id,unsigned keynr,IsamKeyStr key);
  Variablen:
    int id;           Von DateiInit zurückgegebener Handle
    unsigned keynr;   Schlüsselnummer
    IsamKeyStr key;   Vergleichsschlüssel
  Rückgabewert:
    int;             True False
  Beschreibung:
    L~scht alle Datens?tze aus der Datei die dem Teilschlüssel aus key
    entsprechen. strncmp(IKS,key,strlen(key))==0;

int Get_Satz(int id,long St)
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
    long St;         Stelle in der Datei (Nummer des Datensatzes)
  Rückgabewert:
    int;             True False
  Beschreibung:
    Liest den Datensatz direkt aus der Datei.

void Gross(IsamKeyStr key)
  Variablen:
    IsamKeyStr key;
  Rückgabewert:
    void;
  Beschreibung:
    Wandelt key in Gro?buchstaben um. Alle Keys sind aus Gro?buchstaben
    aufgebaut.

long Used_Satz(int id);
long Free_Satz(int id);
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
  Rückgabewert:
    long;            Anzahl der gefundenen Datens?tze
  Beschreibung:
    Used_Satz liefert die Anzahl der benutzten Datens?tze
    Free_Satz liefert die Anzahl der gel~schten Datens?tze

long GetPos_Satz(int id,unsigned keynr,unsigned scale,IsamKeyStr key);
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
    unsigned keynr;  Schlüsselnummer
    unsigned scale;  Raster der Meßlatte
    IsamKeyStr key;  Vergleichsschlüssel
  Rückgabewert:
    long;            Relative Position des Schlüssel in der Indexdatei
  Beschreibung:
    Sch"tzt die Position des Keys innerhalb der Indexdatei ab.
    Scale nicht größer als PageSize/2 (maximal 2/3 Pagesize) sonst werden
    die Ergebnisse ungenau. (PageSize in BTIsam z.Zt.: 62)

int Check_Datei(int id);
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle oder -1
  Rückgabewert:
    int;             True / False
  Beschreibung:
    Versucht die angegebene Datei zu öffnen. -1 öffnet alle mit DateiInit
    angemeldeteten Dateien. Die Dateien werden alle wieder geschlossen.

int Close_Datei(int id);
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle oder -1
  Rückgabewert:
    int;             True / False
  Beschreibung:
    Versucht die angegebene Datei zu schließen. -1 schließt alle mit
    DateiInit angemeldeten Dateien.

int Loesch_Datei(int id);
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle oder -1
  Rückgabewert:
    int;             True / False
  Beschreibung:
    Versucht die angegebene Datei zu Löschen.

int SetNetFehler(int id,t_FehlerFkt Fehler);
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
    t_FehlerFkt Fehler   Eine User Fehlerbehandlungsfunktion(siehe unten)
  Rückgabewert:      True
    int;
  Beschreibung:
    Gibt die M~glichkeit Fehlermeldungen lokal innerhalb eines Programms
    abzufangen. Das Beispiel versucht jede Fehlerart einmal durch Bestätigung
    zu korrigieren.

char *GetIsamPfad(char *Key);
  Variablen:
    char *Key;       Fconfig-Schlüssel
  Rückgabewert:
    char *;          Pfad
  Beschreibung:
    Liest den Pfad f?r einen FConfig-Schlüssel

int AddIsamPfad(char *Key,char *Pfad);
  Variablen:
    char *Key;       Fconfig-Schlüssel des Pfades
    char *Pfad;      Kompletter Pfad
  Rückgabewert:
    int;             True / False
  Beschreibung:
    F?gt einen Pfad in die Pfad-Verwaltung ein.

int ChangeDateiPfad(int id,int pfad,char *Key);
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
    int pfad;        LOC,DAT,AUF,MAT,USER
    char *Key;       Bei USER der FConfig-Schlüssel des Pfades
  Rückgabewert:
    int;             True / False
  Beschreibung:
    Ändert den Pfad auf die Datei des Handles id.

char* GetDateiName(int id);
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
  Rückgabewert:
    char *;          Dateiname
  Beschreibung:
    Liefert den aktuellen Dateinamen des Handles id.

int ChangeDateiName(int id,char *Name)
  Variablen:
    int id;          Von DateiInit zurückgegebener Handle
    char *Name;      Neuer Dateiname
  Rückgabewert:
    int;             True / False
  Beschreibung:
    ?ndert den Dateinamen des Handles id.

/* Einmal Autobest"tigung */
int SDIR_Fehler(int Fehlernr)
{
  static int F=0;
  Datentyp *P;
  P=(Datentyp*) npara.DateiInfoPtr;

  if(F==Fehlernr){
    P[npara.AktDatei].FehlerFkt=NULL;
  }else{
    F=Fehlernr;
    return(TRUE);
  }
}

Programmierbeispiel:

Variablendeklarationen:
  IsamKeyStr IKS,Key;
  long  St;

  /* Die IsamTools werden zum Betrieb ohne Netz ge~ffnet
     5 Dateihandles werden bereit gestellt
     1 Key soll nur unterst?tzt werden                  */
  IsamInit(NoNet,5,1);

  /* Die Handle verschiedener Dateien werden geholt */
  /* siehe febosXXX.doc                             */
  ID110=DateiInit110(TRUE,FALSE);
  ID121=DateiInit121(TRUE,FALSE);
  ID122=DateiInit122(TRUE,FALSE);
  ID130=DateiInit130(TRUE,FALSE);
  ID310=DateiInit310(FALSE,TRUE);
  if(FALSE=Check_Datei(-1)) exit(0); /* Eine Datei ist nicht verf?gbar */

  /* Vorerst noch Key aufbauen */
  sprintf(Key,"%-8.8s%-8.8s",As,Ps);
  sprintf(IKS,"%-8.8s%-8.8s%4.4d%c%2.2d",As,Ps,1,'P',0);
  Gross(key);
  Gross(IKS);

  Find_Satz(ID310,1U,IKS);

  /* Vorg"ngersatz holen */
  Prev_Satz(ID310,1U,"");

  /* Solange die ersten 16 Buchstaben ?bereinstimmen hole den Nachfolgesatz*/
  while(Next_Satz(ID310,1U,Key)){
    sprintf(IKS,"%-8.8s%-8.8s%4.4d%c%2.2d",
       S310[1].D1.auftrag,S310[1].D1.pos,S310[1].D1.sa1,
       S310[1].D1.sa2,S310[1].D1.nr);
    Gross(IKS);
    strcpy(S310[1].D1.auftrag,Az);
    strcpy(S310[1].D1.pos,Pz);
    Schreib_Satz(ID310);
    /* N~tig weil eventuell der Zeiger auf die Indexdatei zerst~rt wird */
    //Find_Satz(ID310,1,IKS); behoben
  }


typedef void (pascal far *FBuildKey) ( void*, unsigned, IsamKeyStr ) ;
typedef int (far *t_FehlerFkt)(long Fehlernummer) ;

typedef enum {DAT=0,LOC,AUF,MAT,USER} e_Pfad;

typedef struct{
  char  name[33];                /* Langname des Key */
  int  flag;                     /* Index-Datei ge~ffnet oder geschlossen */
  unsigned char laenge;          /* länge des Key */
  Boolean  einein;               /* Eineindeutigkeit des Key */
  char etyp;         /*  Eingabetyp alphanum oder num... nach SAA- TOOLS   */
  IsamKeyStr Key;                /* augenblicklicher Key als String */
} Indextyp;

typedef struct{
  Indextyp *id;             /* Definitionen f?r die Indexdateien */
  char  name[18];           /* Dateiname: Datendatei..dat Indexdateien..ix*/
  int  flag;                /* Datei ge~ffnet oder geschlossen */
  int  LockAnz;             /* Anzahl der gelockten Records dieser Datei */
  int  LockDatei;           /* TRUE/FALSE Diese Datei wurde gelockt */
  e_Pfad  Pfad;             /* DAT=0 LOC=1 AUF=2 MAT=3 USER=4 */
  char pfadkey[9];          /* Bei User-Pfad der FConfig-Key  */
  Boolean Save;             /* Save-Modus Ja/Nein */
  Boolean ReadOnly;         /* ReadOnly   Ja/Nein */
  Boolean OvWrite;          /* True ?berschreibt alle ?nderungen */
  Boolean SetDate;          /* True schreibt das SysZeit-Datum   */
  long  IsamLastError;      /* Letzter Status von IsamError dieser Datei */
  t_FehlerFkt FehlerFkt;    /* FktZeiger   Fehlerbearbeitungsteuerung */
  unsigned anzkey;          /* Anzahl der belegten Keys d.h. Indexdateien */
  long size;                /* Gr~?e eines Datensatzes */
  void *daten[2];           /* Zeiger auf den ersten und zweiten Datensatz*/
  void *IFBPtr;             /* reserved */
  FBuildKey BuildKey;       /* Keys aufbauen */
} Datentyp;


typedef struct {
  int MaxRetries;        /* Wiederholungsversuche bei Lockversuchen    */
  int RetryCount;        /* WiederholungsZ"hler bei Lockversuchen      */
  int LockEnde;          /* Lockversuche abbrechen?                    */
  long IsamLastError;    /* IsamError zum externen Zugriff             */
  int AnzDateien;        /* Anzahl der verwalteten Dateien             */
  int MaxDateien;        /* Maximale Zahl der verwaltbaren Dateien     */
  int AktDatei;          /* Aktuelle Datei                             */
  int NoFlush;           /* TRUE/FALSE  Flush?: FALSE Schlie?en der Datei*/
  int NoSave;            /* TRUE/FALSE  Save?:  FALSE ist SAVE-Modus   */
  Datentyp *DateiInfoPtr;/* Zeiger auf das Dateiverwaltungsarray       */
  long PBS;              /* Speicherseiten f?r Index im Heap und EMS   */
  NetSupportType Netz;   /* die verwendete Netzemulation               */
  /*char Pfad[4][MAXPATH];/* 0 Globaler Datenpfad  gemeinsame Dateien  */
                         /* 1 Lokaler  Datenpfad  private    Dateien   */
                         /* 2 Globaler Auftrasgsdatenpfad              */
                         /* 3 Materialwirtschaft                       */
  t_nodepara *npfad;     /* Liste aller Pfade                          */
}t_npara;

typedef struct{
  char key[6];           /* FConfig-Key max 5 Buchstaben               */
  char pfad[MAXPATH];    /* Fconfig-Pfad                               */
}t_pfad;



