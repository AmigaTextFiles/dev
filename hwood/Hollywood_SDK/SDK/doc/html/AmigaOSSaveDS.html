<html>
<!-- generated from hollywood_sdk.meta by MetaDoc 1.13 (c) by Andreas Falkenhahn -->
<head>
<title>__saveds keyword</title>
<meta name="author" content="Andreas Falkenhahn">
<meta name="generator" content="MetaDoc 1.13">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<style type="text/css">
<!--
body {font-family: sans-serif;}
ul.toc {list-style: none; margin-left: 20px; padding-left: 0px;}
dt.autodoc {font-variant: small-caps; font-size: larger; margin-top: 10px; margin-bottom: 10px; padding-left: 0.2em; padding-top: 0.2em; padding-bottom: 0.2em;
	background-color: #bae1ff; border-width: 1px; border-color: #3baaff; border-style: solid;}
dt.codelist {margin-bottom: 0.2em;}
h2.heading {background-color: #bae1ff; font-family: Arial; padding-top: 0.4em; padding-bottom: 0.4em;}
code {background-color: #f2f2f2; padding: 2px 4px; font-weight: bold;}
pre {background-color: #f2f2f2; border: 1px solid #ddd; padding: 0.3em;}
		
-->
</style>
</head>
<body bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#0000FF" alink="#0000FF">
<h2 class="heading">3.4 __saveds keyword</h2>

<p>
If you compile plugins for the Motorola 680x0 processors or for WarpOS you have to make sure
that all your functions that will be called by Hollywood are declared using the <code>__saveds</code>
keyword or your compiler's equivalent of this keyword (some compilers use a
function called <code>geta4()</code> or a <code>__geta4</code> keyword instead). This is to make sure that
the compiler generates code that loads the near data pointer in register <code>a4</code> on each
function entry so that your function is able to access its data. If you don't use
<code>__saveds</code> in your functions that can be called from Hollywood, then the index register
will still point to to the data section within Hollywood and not within your plugin
which will lead to all sorts of trouble.

<p>
Note that you need not use <code>__saveds</code> for all your functions but only the ones
that Hollywood will directly call into. This includes the functions your plugin
exports, the Lua functions offered by your plugin as well as callback functions
within your plugin whose pointers you pass to Hollywood functions.

<p>
When declaring your plugin functions, the <code>HW_EXPORT</code> macro will automatically set
<code>__saveds</code> for you, e.g.

<p>
<table cellpadding="0" cellspacing="0"><tr><td>&nbsp;</td><td><pre>HW_EXPORT int InitPlugin(hwPluginBase *self, hwPluginAPI *cl, STRPTR p)
{
    ...
}
</pre></td></tr></table><p>

However, you will also need to use <code>__saveds</code> when defining the
Lua functions for your <code>HWPLUG_CAPS_LIBRARY</code> plugin, e.g.

<p>
<table cellpadding="0" cellspacing="0"><tr><td>&nbsp;</td><td><pre>static SAVEDS int MyDiv(lua_State *L)
{
    double a = luaL_checknumber(L, 1);
    double b = luaL_checknumber(L, 2);

    // catch division by zero CPU exception and handle
    // it cleanly
    if(b == 0) return ERR_ZERODIVISION;

    lua_pushnumber(L, a / b);

    // push 1 to indicate one return value
    return 1;
}

static const struct hwCmdStruct plug_commands[] = {
    {&quot;MyDiv&quot;, MyDiv},
    ...
    {NULL, NULL}
};
</pre></td></tr></table><p>

Here we use the macro <code>SAVEDS</code> which will only insert the <code>__saveds</code> keyword
when building for 680x0 or WarpOS-based systems.

<p>
Finally, don't forget to set <code>__saveds</code> when writing callback functions that you pass
to a Hollywood API call. These must also be declared with the <code>__saveds</code> keyword because,
obviously, Hollywood calls into them, e.g.

<p>
<table cellpadding="0" cellspacing="0"><tr><td>&nbsp;</td><td><pre>static SAVEDS int dispatcher(APTR h, int op, APTR data, APTR udata)
{
    ...
}

handle = hw_AttachDisplaySatellite(&amp;id, dispatcher, data, tags);
</pre></td></tr></table><p>

Make sure that you don't forget the <code>__saveds</code> keyword for all these functions! Trying
to debug a crash that is caused by a missing <code>__saveds</code> declaration can be a really
frustrating experience because very strange things will start to happen if the data
index register hasn't been set up correctly.

<p>
<hr>
<font size=-2><a href="AmigaOSSaveDS_.html" target="_top">Show TOC</a></font>
</body>
</html>