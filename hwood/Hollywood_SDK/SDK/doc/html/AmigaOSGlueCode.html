<html>
<!-- generated from hollywood_sdk.meta by MetaDoc 1.13 (c) by Andreas Falkenhahn -->
<head>
<title>Glue code</title>
<meta name="author" content="Andreas Falkenhahn">
<meta name="generator" content="MetaDoc 1.13">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<style type="text/css">
<!--
body {font-family: sans-serif;}
ul.toc {list-style: none; margin-left: 20px; padding-left: 0px;}
dt.autodoc {font-variant: small-caps; font-size: larger; margin-top: 10px; margin-bottom: 10px; padding-left: 0.2em; padding-top: 0.2em; padding-bottom: 0.2em;
	background-color: #bae1ff; border-width: 1px; border-color: #3baaff; border-style: solid;}
dt.codelist {margin-bottom: 0.2em;}
h2.heading {background-color: #bae1ff; font-family: Arial; padding-top: 0.4em; padding-bottom: 0.4em;}
code {background-color: #f2f2f2; padding: 2px 4px; font-weight: bold;}
pre {background-color: #f2f2f2; border: 1px solid #ddd; padding: 0.3em;}
		
-->
</style>
</head>
<body bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#0000FF" alink="#0000FF">
<h2 class="heading">3.1 Glue code</h2>

<p>
As AmigaOS doesn't support the export of named symbols from library files,
Hollywood plugins need to provide some glue code on AmigaOS and compatible
systems so that Hollywood can locate symbols by name instead of by jumptable.

<p>
After calling <code>LoadSeg()</code> on your plugin, Hollywood will look for
two magic cookies that must be embedded in the <code>MagicCookie[]</code> array
in the following structure:

<p>
<table cellpadding="0" cellspacing="0"><tr><td>&nbsp;</td><td><pre>typedef struct _hwAmigaEntry
{
    ULONG MagicCookie[2];
    int Platform;
    void *(*GetProcAddress)(STRPTR name);
} hwAmigaEntry;
</pre></td></tr></table><p>

Thus, your plugin needs to declare a global constant based on this structure
so that Hollywood can identify the file as a Hollywood plugin. An example
declaration could be like this:

<p>
<table cellpadding="0" cellspacing="0"><tr><td>&nbsp;</td><td><pre>const hwAmigaEntry entry = {
    {HWPLUG_COOKIE1, HWPLUG_COOKIE2},
    HWARCH_OS3,
    GetProcAddress,
};
</pre></td></tr></table><p>

Make sure that the compiler doesn't optimize this declaration away just because it
isn't referenced anywhere. Otherwise Hollywood won't be able to load your
plugin. As you can see <code>MagicCookie[]</code> needs to be set to <code>HWPLUG_COOKIE1</code>
and <code>HWPLUG_COOKIE2</code> which are both defined in <code>hollywood/plugin.h</code>.
Note that different cookies are used on little endian systems so make sure to
define the preprocessor constant <code>HW_LITTLE_ENDIAN</code> if you target little
endian systems.

<p>
It is very important to set <code>hwAmigaEntry.Platform</code> to the correct
architecture constant. In the above example we set it to <code>HWARCH_OS3</code> indicating
that this is a plugin for AmigaOS 3.

<p>
You can also see that the declaration above references a function named
<code>GetProcAddress()</code>. You need to implement this function in your glue
code as well. Hollywood calls this function whenever it needs to resolve a function
pointer from a symbol name. Thus, your implementation of <code>GetProcAddress()</code>
needs to look at the string argument it has received and then return the
appropriate function pointer. This can be implemented using a lookup table like
this:

<p>
<table cellpadding="0" cellspacing="0"><tr><td>&nbsp;</td><td><pre>static const struct
{
    STRPTR name;
    void *func;
} funcs[] =
{
    {&quot;InitPlugin&quot;, (void *) InitPlugin},
    {&quot;ClosePlugin&quot;, (void *) ClosePlugin},
    // ...more function pointers here, depending on plugin type
    {NULL, NULL}
};

HW_EXPORT void *GetProcAddress(STRPTR name)
{
    int k;

    for(k = 0; funcs[k].name; k++) {
        if(!strcmp(name, funcs[k].name)) return funcs[k].func;
    }

    return NULL;
}
</pre></td></tr></table><p>

Another speciality on AmigaOS is that you cannot use certain functions from the
standard ANSI C runtime library. See <a href="AmigaOSCRT.html">AmigaOS C runtime limitations</a> for details.

<p>
<hr>
<font size=-2><a href="AmigaOSGlueCode_.html" target="_top">Show TOC</a></font>
</body>
</html>