	xdef	_GetPen
	SECTION      text,CODE
;__asm ULONG GetPen(register __a0 struct ColorEntry *Cols,
;register __d0 UWORD Number,
;register __d1 long R,register __d2 long G,register __d3 long B);
_GetPen:
	Movem.l	D4-D7/A2-A6,-(A7)
	MoveM.l	D1-D3,-(A7)
	Lsr.w	#6,D1
	Lsr.w	#6,D2
	Lsr.w	#6,D3
	Lsl.w	#2,D1
	Or.w	D2,D1
	Lsl.w	#2,D1
	Or.w	D3,D1
	Mulu	#10*2,D1
	Lea	ColWeight(pc),A6
	Add.l	D1,A6
	MoveM.l	(A7)+,D1-D3

	Move.l	A0,A4
	Move.l	#$7ffffff,D7
	Move.w	#$ffff,A3

	Bra.b	StartScan
NextPenEntry	Move.l	A4,A0
	Move.l	D4,D5
	Lsl.w	#2,D5
	Add.w	D5,A0
	Add.w	D5,D5
	Add.w	D5,A0
	Moveq.L	#$0,D5
	Move.b	$4(A0),D5
	Sub.w	D1,D5
	Muls	D5,D5
	Cmp.l	D7,D5
	Bge.b	NotClose
	Moveq.l	#$0,D6
	Move.b	$5(A0),D6
	Sub.w	D2,D6
	Muls	D6,D6
	Add.l	D6,D5
	Cmp.l	D7,D5
	Bge.b	NotClose
	Moveq.l	#$0,D6
	Move.b	$6(A0),D6
	Sub.w	D3,D6
	Muls	D6,D6
	Add.l	D6,D5
	Bne.b	NoDirectMatch
	Move.w	$A(A0),D0
	Swap	D0
	Move.w	$A(A0),D0
	Bra.b	EndScan
NoDirectMatch:
	Cmp.l	D7,D5
	Bge.b	NotClose
Match:
	Move.l	D7,A1
	Move.l	D5,D7
	Move.w	A2,A3
	Move.w	D4,A2
NotClose:
StartScan:
	Move.w	(A6)+,D4
	Bpl.b	NextPenEntry
	Cmp.w	#$ffff,A3
	Beq.b	Merge
	Add.l	D7,D7
	Cmp.l	A1,D7
	Bge.b	NoMerge
Merge:	Move.l	A2,A3
NoMerge:
	Move.l	A2,D0
	Add.l	D0,D0
	Add.l	A2,D0
	Asl.l	#$2,D0
	Move.w	$A(A4,D0.L),D0
	Swap	D0
	Move.l	A3,D5
	Add.l	D5,D5
	Add.l	A3,D5
	Asl.l	#$2,D5
	Move.w	$A(A4,D5.L),D0
EndScan:	Movem.l	(A7)+,D4-D7/A2-A6
	RTS

ColWeight:	Dc.w	$7d,$1f,$06,$1a,$1e,$01,$05,$19,$00,$ffff
	Dc.w	$7e,$20,$07,$1b,$02,$1f,$06,$1a,$01,$ffff
	Dc.w	$7f,$21,$08,$1c,$03,$20,$07,$1b,$02,$ffff
	Dc.w	$80,$22,$09,$1d,$04,$21,$08,$1c,$03,$ffff
	Dc.w	$81,$24,$0b,$23,$0a,$1f,$06,$1e,$05,$ffff
	Dc.w	$82,$25,$0c,$20,$24,$07,$0b,$1f,$06,$ffff
	Dc.w	$83,$26,$0d,$21,$25,$08,$0c,$20,$07,$ffff
	Dc.w	$84,$27,$0e,$22,$26,$09,$0d,$21,$08,$ffff
	Dc.w	$85,$29,$10,$28,$0f,$24,$0b,$23,$0a,$ffff
	Dc.w	$86,$2a,$11,$25,$29,$0c,$10,$24,$0b,$ffff
	Dc.w	$87,$2b,$12,$26,$2a,$0d,$11,$25,$0c,$ffff
	Dc.w	$88,$2c,$13,$27,$2b,$0e,$12,$26,$0d,$ffff
	Dc.w	$89,$2e,$15,$2d,$14,$29,$10,$28,$0f,$ffff
	Dc.w	$8a,$2f,$16,$2a,$2e,$11,$15,$29,$10,$ffff
	Dc.w	$8b,$30,$17,$2b,$2f,$12,$16,$2a,$11,$ffff
	Dc.w	$8c,$31,$18,$2c,$30,$13,$17,$2b,$12,$ffff
	Dc.w	$8d,$38,$33,$37,$32,$1f,$1a,$1e,$19,$ffff
	Dc.w	$8e,$39,$34,$20,$38,$1b,$33,$1f,$1a,$ffff
	Dc.w	$8f,$3a,$35,$21,$39,$1c,$34,$20,$1b,$ffff
	Dc.w	$90,$3b,$36,$22,$3a,$1d,$35,$21,$1c,$ffff
	Dc.w	$91,$3d,$3c,$24,$38,$23,$37,$1f,$1e,$ffff
	Dc.w	$92,$3e,$25,$39,$3d,$20,$24,$38,$1f,$ffff
	Dc.w	$93,$3f,$26,$3a,$3e,$21,$25,$39,$20,$ffff
	Dc.w	$94,$40,$27,$3b,$3f,$22,$26,$3a,$21,$ffff
	Dc.w	$95,$42,$41,$29,$3d,$28,$3c,$24,$23,$ffff
	Dc.w	$96,$43,$2a,$3e,$42,$25,$29,$3d,$24,$ffff
	Dc.w	$97,$44,$2b,$3f,$43,$26,$2a,$3e,$25,$ffff
	Dc.w	$98,$45,$2c,$40,$44,$27,$2b,$3f,$26,$ffff
	Dc.w	$99,$47,$46,$2e,$42,$2d,$41,$29,$28,$ffff
	Dc.w	$9a,$48,$2f,$43,$47,$2a,$2e,$42,$29,$ffff
	Dc.w	$9b,$49,$30,$44,$48,$2b,$2f,$43,$2a,$ffff
	Dc.w	$9c,$4a,$31,$45,$49,$2c,$30,$44,$2b,$ffff
	Dc.w	$9d,$51,$4c,$50,$4b,$38,$33,$37,$32,$ffff
	Dc.w	$9e,$52,$4d,$39,$51,$34,$4c,$38,$33,$ffff
	Dc.w	$9f,$53,$4e,$3a,$52,$35,$4d,$39,$34,$ffff
	Dc.w	$a0,$54,$4f,$3b,$53,$36,$4e,$3a,$35,$ffff
	Dc.w	$a1,$56,$55,$3d,$51,$3c,$50,$38,$37,$ffff
	Dc.w	$a2,$57,$3e,$52,$56,$39,$3d,$51,$38,$ffff
	Dc.w	$a3,$58,$3f,$53,$57,$3a,$3e,$52,$39,$ffff
	Dc.w	$a4,$59,$40,$54,$58,$3b,$3f,$53,$3a,$ffff
	Dc.w	$a5,$5b,$5a,$42,$56,$41,$55,$3d,$3c,$ffff
	Dc.w	$a6,$5c,$43,$57,$5b,$3e,$42,$56,$3d,$ffff
	Dc.w	$a7,$5d,$44,$58,$5c,$3f,$43,$57,$3e,$ffff
	Dc.w	$a8,$5e,$45,$59,$5d,$40,$44,$58,$3f,$ffff
	Dc.w	$a9,$60,$5f,$47,$5b,$46,$5a,$42,$41,$ffff
	Dc.w	$aa,$61,$48,$5c,$60,$43,$47,$5b,$42,$ffff
	Dc.w	$ab,$62,$49,$5d,$61,$44,$48,$5c,$43,$ffff
	Dc.w	$ac,$63,$4a,$5e,$62,$45,$49,$5d,$44,$ffff
	Dc.w	$ad,$6a,$65,$69,$64,$51,$4c,$50,$4b,$ffff
	Dc.w	$ae,$6b,$66,$52,$6a,$4d,$65,$51,$4c,$ffff
	Dc.w	$af,$6c,$67,$53,$6b,$4e,$66,$52,$4d,$ffff
	Dc.w	$b0,$6d,$68,$54,$6c,$4f,$67,$53,$4e,$ffff
	Dc.w	$b1,$6f,$6e,$56,$6a,$55,$69,$51,$50,$ffff
	Dc.w	$b2,$70,$57,$6b,$6f,$52,$56,$6a,$51,$ffff
	Dc.w	$b3,$71,$58,$6c,$70,$53,$57,$6b,$52,$ffff
	Dc.w	$b4,$72,$59,$6d,$71,$54,$58,$6c,$53,$ffff
	Dc.w	$b5,$74,$73,$5b,$6f,$5a,$6e,$56,$55,$ffff
	Dc.w	$b6,$75,$5c,$70,$74,$57,$5b,$6f,$56,$ffff
	Dc.w	$b7,$76,$5d,$71,$75,$58,$5c,$70,$57,$ffff
	Dc.w	$b8,$77,$5e,$72,$76,$59,$5d,$71,$58,$ffff
	Dc.w	$b9,$79,$78,$60,$74,$5f,$73,$5b,$5a,$ffff
	Dc.w	$ba,$7a,$61,$75,$79,$5c,$60,$74,$5b,$ffff
	Dc.w	$bb,$7b,$62,$76,$7a,$5d,$61,$75,$5c,$ffff
	Dc.w	$bc,$7c,$63,$77,$7b,$5e,$62,$76,$5d,$ffff

	END
