/****h* StateMachine:Example.fsm **************************************
*
* NAME
*   StateMachine:Example.fsm
*
* NOTES
*     File Generated by:
*     StateMachine (c) 1994-2004 by J.T. Steichen
*****************************************************
*
*/





/****h* Example.preamble [1.0] ********************************************
*
* NAME
*    Example.preamble
*
* DESCRIPTION
*    This is an example program (Preamble) for the StateMachine program.
***************************************************************************
*
*/

#include <stdio.h>
#include <string.h>
#include <exec/types.h>

#include <AmigaDOSErrs.h> // For ERROR_INVALID_RESIDENT_LIBRARY, RETURN_OK, etc.

#include <intuition/intuitionbase.h>
#include <graphics/gfxbase.h>

void Ignore(    void );  // Your compiler will complain if these are not here!
void RptErr(    void );
void StowNum(   void );
void DrawFunc(  void );
void MoveFunc(  void );
void OpenGraph( void );
void ChgColor(  void );
void Cleanup(   void );

// -------- FSMGen definitions go here: ----------------------------------------

   

struct Transitions {

	int    nextstate;
	void (*act)( void );

};

// ------------- Defines for Symbol names: ------------------

#define EMPTY		-1
#define EndFile_            		0
#define WhiteSpace_         		1
#define SemiColon_          		2
#define HiRes_              		3
#define LoRes_              		4
#define Move_               		5
#define Draw_               		6
#define Color_              		7
#define Number_             		8
#define Comma_              		9
#define EndLine_            		10

// ------------- Defines for State names: ------------------- 

#define Begin               		0
#define DefColor            		1
#define DefMove             		2
#define DefDraw             		3
#define Error               		4
#define Done                		5
#define STOP                		5

struct Transitions fsm_table[][11] = {


/*
   EndFile_          WhiteSpace_       SemiColon_        HiRes_           
   LoRes_            Move_             Draw_             Color_           
   Number_           Comma_            EndLine_         
*/

//  Begin:

Done   ,Cleanup, Begin  ,Ignore , Begin  ,Ignore , Begin  ,OpenGraph, 
Begin  ,OpenGraph, DefMove,Ignore , DefDraw,Ignore , DefColor,Ignore , 
Error  ,RptErr , Begin  ,Ignore , Begin  ,Ignore , 

//  DefColor:

Error  ,RptErr , DefColor,Ignore , Begin  ,ChgColor, Error  ,RptErr , 
Error  ,RptErr , Error  ,RptErr , Error  ,RptErr , Error  ,RptErr , 
DefColor,StowNum, DefColor,Ignore , DefColor,Ignore , 

//  DefMove:

Error  ,RptErr , DefMove,Ignore , Begin  ,MoveFunc, Error  ,RptErr , 
Error  ,RptErr , Error  ,RptErr , Error  ,RptErr , Error  ,RptErr , 
DefMove,StowNum, DefMove,Ignore , Begin  ,Ignore , 

//  DefDraw:

Error  ,RptErr , DefDraw,Ignore , Begin  ,DrawFunc, Error  ,RptErr , 
Error  ,RptErr , Error  ,RptErr , Error  ,RptErr , Error  ,RptErr , 
DefDraw,StowNum, DefDraw,Ignore , Begin  ,Ignore , 

//  Error:

Done   ,Cleanup, Begin  ,Ignore , Begin  ,Ignore , Begin  ,OpenGraph, 
Begin  ,OpenGraph, DefMove,Ignore , DefDraw,Ignore , DefColor,Ignore , 
Error  ,RptErr , Begin  ,Ignore , Begin  ,Ignore , 

//  Done:

Done   ,Cleanup, Done   ,Cleanup, Done   ,Cleanup, Error  ,RptErr , 
Error  ,RptErr , Error  ,RptErr , Error  ,RptErr , Error  ,RptErr , 
Done   ,Cleanup, Done   ,Cleanup, Done   ,Cleanup 

};


typedef int FSMTYPE;

static int mstate, token;


// --------- Code for FSM Start_Function(): ------------ 

FSMTYPE main( int argc, char **argv )
{
   mstate = Begin;

   token  = EMPTY;

   do {

      token = yylex();

      (*fsm_table[ mstate ][ token ].act)();

      mstate = fsm_table[ mstate ][ token ].nextstate;

      } while (mstate != STOP);

   return( 0 );
}



/****h* Example/Example.code [1.0] ************************************
*
* NAME
*    Example.code
*
* DESCRIPTION
*    Example.code file for the StateMachine program.
***********************************************************************
*
*/

extern char *idstr;   // defined in the scanner (Example.flex & ExampleLex.c)

int linecount = 0;    // used for error reporting

void Ignore( void ) 
{ 
   if (idstr[0] == '\n')
      linecount++;

   return; 
}

void RptErr( void )
{
   fprintf( stderr, "ERROR in input stream!\n" );
   fprintf( stderr, "Found on line %d\n", linecount );

   return;
}

/* WARNING:  This is extremely old code, do NOT expect it to work! */

struct NewScreen ns = {

    0, 0, 1024, 768, 8, 0xFF, 0xFF, HIRES, CUSTOMSCREEN,
    NULL, (UBYTE *) "StateMachine Example:", NULL, NULL
};

struct NewWindow nw = {

    0, 0, 1024, 768, 0xFF, 0xFF, CLOSEWINDOW,
    WINDOWCLOSE | ACTIVATE | SMART_REFRESH,
    NULL, NULL, (UBYTE *) "StateMachine Example:",
    NULL, NULL, 600, 480, 1024, 768, CUSTOMSCREEN
};

#ifndef __amigaos4__

struct IntuitionBase *IntuitionBase;
struct GfxBase       *GfxBase;

#else

# define __USE_INLINE__

# include <proto/exec.h>
# include <proto/dos.h>
# include <proto/intuition.h>
# include <proto/graphics.h>

extern struct Library *SysBase;
extern struct Library *DOSBase;
extern struct Library *IntuitionBase;
extern struct Library *GfxBase;

extern struct ExecIFace      *IExec;
extern struct DOSIFace       *IDOS;
extern struct IntuitionIFace *IIntuition;
extern struct GraphicsIFace  *IGraphics;

#endif

struct Window *example_window = NULL;
struct Screen *example_screen = NULL;

static void closeLibraries( void )
{
#  ifndef __amigaos4__
   if (GfxBase)
      CloseLibrary( (struct Library *) GfxBase );

   if (IntuitionBase)
      CloseLibrary( (struct Library *) IntuitionBase );
#  endif
      
   return;
}

static int openLibraries( void )
{
   int rval = RETURN_OK;
   
#  ifndef __amigaos4__
   if (!(IntuitionBase = (struct IntuitionBase *) OpenLibrary( "intuition.library", 0L )))
      return( ERROR_INVALID_RESIDENT_LIBRARY );

   if (!(GfxBase = (struct GfxBase *) OpenLibrary( "graphics.library", 0L )))
      {
      closeLibraries();
 
      return( ERROR_INVALID_RESIDENT_LIBRARY );
      }
#  endif // Don't have to do anything for gcc & -lauto !!

   return( rval );
}

void OpenGraph( void ) 
{
   if (openLibraries() != RETURN_OK)
      return;
      
   if (strcmp( idstr, "LORES" ) == 0)
      {
      ns.ViewModes = 0;
      ns.Depth     = 5;
      ns.Width     = 320;
      ns.Height    = 200;
      nw.Width     = 320;  // Make window LoRes also!
      nw.Height    = 200;
      nw.MaxWidth  = 320;
      nw.MaxHeight = 200;
      }

   if (!(example_screen = (struct Screen *) OpenScreen( &ns )))
      {
      closeLibraries();

      return;
      }

   nw.Screen = example_screen;

   if (!(example_window = (struct Window *) OpenWindow( &nw )))
      {
      CloseScreen( example_screen );

      closeLibraries();

      return;
      }

   return;
}

int nums[5] = { -1, -1, -1, -1, 0 };

void StowNum( void )  // store numbers for DrawFunc, MoveFunc & ChgColor
{
   extern int atoi( char * );

   int index = 0;

   while (nums[index] >= 0)
      index++;

   nums[index] = atoi( idstr );

   return;
}

void DrawFunc( void )
{
   if (example_window) // != NULL)
      Draw( example_window->RPort, nums[0], nums[1] );

   nums[0] = nums[1] = -1;

   return;
}

void MoveFunc( void )
{
   if (example_window) // != NULL)
      Move( example_window->RPort, nums[0], nums[1] );

   nums[0] = nums[1] = -1;

   return;
}

void ChgColor( void ) 
{
   if (example_window) // != NULL)
      {
      SetRGB4( &(example_screen->ViewPort), nums[0], nums[1], nums[2], nums[3] );
      SetAPen( example_window->RPort, nums[0] );
      }

   nums[0] = nums[1] = nums[2] = nums[3] = -1;

   return;
}

#ifndef   TRUE
# define  TRUE  1
# define  FALSE 0
#endif

void Cleanup( void )
{
   int                 Checking = TRUE;
   ULONG               clazz    = 0;
   struct IntuiMessage *message = NULL;
   char                nil[256], *title = &nil[0];
   
   if (!example_window) // == NULL)
      goto SkipLoop;

   strcpy( title, nw.Title );
   strcat( title, " Click on close window gadget to EXIT!" );

   SetWindowTitles( example_window, title, NULL );
   
   while (Checking == TRUE)
      {
      if (!(message = (struct IntuiMessage *) 
                       GetMsg( example_window->UserPort )))
         {
         (void) Wait( 1L << example_window->UserPort->mp_SigBit );

         continue;
         }

      clazz = message->Class;

      (void) ReplyMsg( (struct Message *) message );

      switch( clazz )
         {
         case CLOSEWINDOW:
            Checking = FALSE;
            break;

         default:
            break;
         }
      }
      
SkipLoop:

   if (example_window)
      CloseWindow( example_window );
      
   if (example_screen)
      CloseScreen( example_screen );

   closeLibraries();      

   return;
}

/* -------------------  of Example.code file! ----------------------- */