@database "resource"
@master "Ram Disk:T/docs/resource.doc"

@Node Main "resource.doc"
    @{" initializeResourceTracking() " Link "initializeResourceTracking()"}
    @{" resourceMessage() " Link "resourceMessage()"}
    @{" --resource--() " Link "--resource--()"}
    @{" end() " Link "end()"}
    @{" getLastCommand() " Link "getLastCommand()"}
    @{" getLastData() " Link "getLastData()"}
    @{" getLastMessage() " Link "getLastMessage()"}
    @{" getLastResource() " Link "getLastResource()"}
    @{" new() " Link "new()"}
    @{" removeResourceTracking() " Link "removeResourceTracking()"}
    @{" safePutToPort() " Link "safePutToPort()"}
    @{" sendMessageToMaster() " Link "sendMessageToMaster()"}
@EndNode

@Node "initializeResourceTracking()" "/initializeResourceTracking"

@{b}   NAME@{ub}
       initializeResourceTracking() -- Initialization

@{b}   SYNOPSIS@{ub}
       initializeResourceTracking()

@{b}   FUNCTION@{ub}
       Initializes the resource tracking system. On the Amiga this means that
       the reply @{"port" Link "port/port()"} for the messages is created and the @{"message" Link "standard/message()"} itself is
       created.

@{b}   SEE ALSO@{ub}
       @{"removeResourceTracking()" Link "removeResourceTracking()"}

@EndNode

@Node "resourceMessage()" "/resourceMessage"

@{b}   NAME@{ub}
       resourceMessage

@{b}   ATTRIBUTES@{ub}
       msg:mn -- normal exec @{"message" Link "standard/message()"} node

       command:LONG -- the command sent to the master

       resource:LONG -- the resource that sends this @{"message" Link "standard/message()"}

       data:LONG -- any data that is required for the execution of that
           command. Leave NIL if unused.

@{b}   CREATION@{ub}
       October 16 1995 Gregor Goldbach

@{b}   HISTORY@{ub}
       November 1 1995 Gregor Goldbach
         Removed the remove-and-end stuff from resource.end() and put it in
         the command evaluation of the master program. @{"end()" Link "end()"} does now only
         END the object of this resource.

       December 10 1995 Gregor Goldbach
         Added parent attribute. This could make the handling of the
         resources a bit easier. The Resource master should be able to sort
         the resources by this parent entry. It's the object that allocated
         the owner object. For example, take the eSource object. There are
         a number of @{"eVar" Link "eVar/eVar()"} and eObjects allocated as well as some other
         stuff. The Resource Master can display/calculate the memory
         devoured by an eSource object by looking at the parent. It should
         be same value for every @{"eVar" Link "eVar/eVar()"} etc.

         The bad thing about this is that the parent attribute has to be set
         when NEWing an object. This *has* to be done explicitly. Maybe a
         default entry for the option list passed to @{"new()" Link "new()"} could be "prnt".


         Added getLastxxx() methods. These get an attribute from the last
         @{"message" Link "standard/message()"} that was sent to the Resource Master or the @{"message" Link "standard/message()"} itself.
         The @{"new()" Link "new()"} and @{"end()" Link "end()"} methods of Object could now be extended by some
         calls to resource methods:

           in @{"new()" Link "new()"}

           NEW resource.new([self,FindTask(NIL),0]) ->add to Resource List


           in @{"end()" Link "end()"}

           NEW dummyResource.new()

          /*
           * Get resource of myself. That way I don't have to store it
           */

           dummyResource.sendMessageToMaster(RCMD_GETRESOURCE, self)
           resourceOfMyself := dummyResource.getLastData()

          /*
           * END my resource. CAUTION: do *not* do this by now.
           * @{"end()" Link "end()"} of resource calls @{"end()" Link "end()"} of object, so this would result
           * in a deadlock. Simply remove the END self.owner from @{"end()" Link "end()"} of
           * resource.
           */

           dummyResource.sendMessageToMaster(RCMD_END, resourceOfMyself)

          /*
           * end the dummy resource
           */

           dummyResource.sendMessageToMaster(RCMD_END, resourceOfMyself)


         NOTE: The behaviour outlined above is not aware of the parent. That
         one should get a not on the death of it's child, don't you think?
@EndNode

@Node "--resource--()" "resource/--resource--"

@{b}   NAME @{ub}
       resource

@{b}   ATTRIBUTES@{ub}
       owner -- What this resource represents. This should be the pointer to
           an object.

       task -- The task that created this resource/object.

       flags -- Special flags.

       parent:PTR TO object -- The parent object of owner. Used for
           grouping. It's the object that NEWs the owner object.

@{b}   CREATION@{ub}
       October 16 1995 Gregor Goldbach

@{b}   HISTORY@{ub}
       October 19 1995 Gregor Goldbach
         Added RMCD_END -- Performs an END on the resource. Use carefully!

@{b}   NOTES@{ub}
       The first attempt to implement this resource tracking system failed.
       It used a queuestack of which the address was put to an ENV var.
       The client read it and called addLast() and so on.

       This version uses the Amiga's @{"message" Link "standard/message()"} @{"port" Link "port/port()"} system. That means that
       this basic element of the object library is NOT portable. However,
       the user does not know that this system is there, so without
       changing a single line of code this system can be removed from the
       library without any problems.

       IMPORTANT: Each resource definitely HAS to be ended via END. Because
       of the internal handling of objects in Amiga E one can't simply wait
       till Amiga E ends them automatically.

       Implemented commands:
           RCMD_ADD -- Add resource to tracking list.

           RCMD_REMOVE -- Remove resource from tracking list.

           RMCD_INFO -- Get number of resources being tracked. This command
               may disappear in the future.

           RCMD_END -- Perform an END on the object represented by the
               resource after removing it from the list. Use carefully!

@EndNode

@Node "end()" "resource/end"

@{b}   NAME@{ub}
       end() of resource -- Destructor

@{b}   SYNOPSIS@{ub}
       resource.end()

@{b}   FUNCTION@{ub}
       Removes itself from the global resource list by sending a @{"message" Link "standard/message()"}
       to the master about this. If the list is empty after removing
       itself the tracking system is removed, too. The object that is
       represented by this resource is ENDed.

       There may be a notification of the task in the future so make sure
       the task and flags attributes are not changed.

@{b}   NOTES@{ub}
       It is possible to initialize end remove the tracking system multiple
       times.

@{b}   SEE ALSO@{ub}
       @{"new()" Link "new()"}, @{"initializeResourceTracking()" Link "initializeResourceTracking()"}, @{"removeResourceTracking()" Link "removeResourceTracking()"},
       resource

@EndNode

@Node "getLastCommand()" "resource/getLastCommand"

@{b}   NAME@{ub}
       getLastCommand() of resource -- Get the last command sent to the
           master.

@{b}   SYNOPSIS@{ub}
       resource.getLastCommand()

@{b}   FUNCTION@{ub}
       Returns the last Resource Message's command.

@{b}   RESULT@{ub}
       LONG -- last command

@{b}   CREATION@{ub}
       December 10 1995 Gregor Goldbach

@{b}   SEE ALSO@{ub}
       resource, @{"getLastMessage()" Link "getLastMessage()"}, @{"getLastData()" Link "getLastData()"}
@EndNode

@Node "getLastData()" "resource/getLastData"
@{b}   NAME@{ub}
       getLastData() of resource -- Get the last data sent to the master.

@{b}   SYNOPSIS@{ub}
       resource.getLastData()

@{b}   FUNCTION@{ub}
       Returns the last Resource Message's data the master worked on.

@{b}   RESULT@{ub}
       LONG -- data attribute of the last messagesent to the Resource
           Master.

@{b}   CREATION@{ub}
       December 10 1995 Gregor Goldbach

@{b}   SEE ALSO@{ub}
       resource, @{"getLastCommand()" Link "getLastCommand()"}, @{"getLastMessage()" Link "getLastMessage()"}
@EndNode

@Node "getLastMessage()" "resource/getLastMessage"

@{b}   NAME@{ub}
       getLastMessage() of resource -- Get the last @{"message" Link "standard/message()"} worked with.

@{b}   SYNOPSIS@{ub}
       resource.getLastMessage()

@{b}   FUNCTION@{ub}
       Returns the last Resource Message the master worked on.

@{b}   RESULT@{ub}
       PTR TO @{"resourceMessage" Link "resource/resourceMessage()"}

@{b}   EXAMPLE@{ub}

@{b}   CREATION@{ub}
       December 10 1995 Gregor Goldbach

@{b}   NOTES@{ub}

@{b}   SEE ALSO@{ub}
       resource, @{"getLastCommand()" Link "getLastCommand()"}, @{"getLastData()" Link "getLastData()"}

@EndNode

@Node "getLastResource()" "resource/getLastResource"
@{b}   NAME@{ub}
       @{"getLastMessage()" Link "getLastMessage()"} of resource -- Get the last @{"message" Link "standard/message()"} worked with.

@{b}   SYNOPSIS@{ub}
       resource.getLastMessage()

@{b}   FUNCTION@{ub}
       Returns the last Resource Message the master worked on.

@{b}   RESULT@{ub}
       PTR TO @{"resourceMessage" Link "resource/resourceMessage()"}

@{b}   EXAMPLE@{ub}

@{b}   CREATION@{ub}
       December 10 1995 Gregor Goldbach

@{b}   NOTES@{ub}

@{b}   SEE ALSO@{ub}
       resource, @{"getLastCommand()" Link "getLastCommand()"}, @{"getLastData()" Link "getLastData()"}

@EndNode

@Node "new()" "resource/new"

@{b}   NAME@{ub}
       new() of resource -- Create new instance of resource.

@{b}   SYNOPSIS@{ub}
       resource.new(LONG=NIL)

       resource.new(list)

@{b}   FUNCTION@{ub}
       Sends a @{"message" Link "standard/message()"} to the master about being added to the global
       resource list. If the tracking system hasn't been set up it does
       this first.

@{b}   INPUTS@{ub}
       list:LONG -- used for compatibility with Object. An @{"elist" Link "elist/elist()"} of three
           or four items: object, task, flags and parent.

@{b}   NOTES@{ub}
       The list parameter is used for compatibility with Object's new().
       Makes everything look more homogeneous. May vanish in the future
       or be modified.

@{b}   SEE ALSO@{ub}
       resource, @{"initializeResourceTracking()" Link "initializeResourceTracking()"}
@EndNode

@Node "removeResourceTracking()" "resource/removeResourceTracking"

@{b}   NAME@{ub}
       removeResourceTracking() -- Remove the tracking system.

@{b}   SYNOPSIS@{ub}
       removeResourceTracking()

@{b}   FUNCTION@{ub}
       By the call to this proc the resorce tracking system is removed from
       memory.

@{b}   NOTES@{ub}
       Is is possilbe to call @{"initializeResourceTracking()" Link "initializeResourceTracking()"} and
       removeResourceTracking() a number of times in one program.
       You may, however, only call @{"initializeResourceTracking()" Link "initializeResourceTracking()"} after
       removing the system.

@{b}   SEE ALSO@{ub}
       @{"initializeResourceTracking()" Link "initializeResourceTracking()"}
@EndNode

@Node "safePutToPort()" "resource/safePutToPort"

@{b}   NAME @{ub}
       safePutToPort() -- Put @{"message" Link "standard/message()"} to @{"port" Link "port/port()"} safely.

@{b}   SYNOPSIS@{ub}
       safePutToPort(LONG, LONG)

       safePutToPort(message, portname)

@{b}   FUNCTION@{ub}
       Puts a @{"message" Link "standard/message()"} to a @{"port" Link "port/port()"} only if the @{"port" Link "port/port()"} exists.

@{b}   INPUTS@{ub}
       @{"message" Link "standard/message()"} -- normal exec @{"message" Link "standard/message()"}. Has to be initialized.

       portname:PTR TO CHAR -- Name of the @{"port" Link "port/port()"} to put the @{"message" Link "standard/message()"} in.

@{b}   RESULT@{ub}
       TRUE if the @{"port" Link "port/port()"} did exist, FALSE otherwise.

@EndNode

@Node "sendMessageToMaster()" "resource/sendMessageToMaster"

@{b}   NAME@{ub}
       sendMessageToMaster() of resource --

@{b}   SYNOPSIS@{ub}
       resource.sendMessageToMaster(LONG, LONG=NIL)

       resource.sendMessageToMaster(command, data)

@{b}   FUNCTION@{ub}
       A @{"message" Link "standard/message()"} is sent to the resource master. The command defines the
       kind of this @{"message" Link "standard/message()"}.

@{b}   INPUTS@{ub}
       command:LONG -- The command to send
           RCMD_ADD -- Add resource to list
           RCMD_REMOVE -- Remove resource from list
           RCMD_INFO -- Get info about list. This means that the data
               entry of the reply contains the number of resource
               currently being tracked.

       data:LONG -- Any data that may be required for the execution of the
       command.

@{b}   NOTES@{ub}
       Uses {resourcePortName} as the port's name.

@{b}   SEE ALSO@{ub}
       @{"new()" Link "new()"}, @{"end()" Link "end()"}
@EndNode

