#rE
	.include	ppcmacros.pasm
	.text
	.sdreg	r2
	.align	2
#MOD:re:modules/lib/restd_PPC.m
	.global	_RealF
_RealF:
.set	RealF_str,16
.set	RealF_f,12
.set	RealF_n,8
	link	a5,-40
	push	a0
#DEF  top,neg=NIL,rest
.set	RealF_top,-40
.set	RealF_neg,-36
	liw	d0,0
	stw	d0,RealF_neg(a5)
.set	RealF_rest,-32
#DEF  buf[24]:ARRAY                           
.set	RealF_buf,-28
	addi	a0,a5,RealF_buf
	mr	d0,a0
	addiw	d0,d0,4
	stw	d0,0(a0)
#IF !f<0.0
#RealF_if1
	addi	a0,a5,RealF_f
	lfs	fp0,0(a0)
	law	a0,_fltn_1
	lfs	fp1,0(a0)
	fcmpo	0,fp0,fp1
	scc	lt,d0
	tstw	d0
	beq	RealF_else1_0
#neg:='-'
	law	a0,_str1
	stw	a0,RealF_neg(a5)
#
#f:=!-f
	addi	a0,a5,RealF_f
	lfs	fp0,0(a0)
	fneg	fp0,fp0
	stfs	fp0,RealF_f(a5)
#
#ENDIF
RealF_else1_0:
#
#top:=!f!
	addi	a0,a5,RealF_f
	lfs	fp0,0(a0)
	fmovl	d0,fp0
	stw	d0,RealF_top(a5)
#
#IF n=0
#RealF_if2
	lwz	d0,RealF_n(a5)
	cmpiw	d0,0
	bne	RealF_else2_0
#f:=0.0
	law	a0,_fltn_2
	lfs	fp0,0(a0)
	stfs	fp0,RealF_f(a5)
#
#ELSE
	b	RealF_endif2
RealF_else2_0:
#
#IF !f<(top!) THEN top--
#RealF_if3
	addi	a0,a5,RealF_f
	lfs	fp0,0(a0)
	fmovl	d0,fp0
	lwz	d1,RealF_top(a5)
	fmovs	fp1,d1
	fcmpo	0,fp0,fp1
	scc	lt,d0
	tstw	d0
	beq	RealF_else3_0
#top--
	addi	a6,a5,RealF_top
	lwz	r7,0(a6)
	subi	r7,r7,1
	stw	r7,0(a6)
	addi	a0,a5,RealF_top
RealF_else3_0:
#rest:=!(f-(top!))
	lwz	d0,RealF_f(a5)
	lwz	d1,RealF_top(a5)
	fmovs	fp1,d1
	fsubs	fp0,fp0,fp1
	stfs	fp0,RealF_rest(a5)
#
#f:=!rest*Fpow(10.0,n!)!                                             
	addi	a0,a5,RealF_rest
	lfs	fp0,0(a0)
	fpush	fp0
	law	a0,_fltn_3
	lfs	fp1,0(a0)
	fpush	fp1
	lwz	d1,RealF_n(a5)
	fmovs	fp1,d1
	fmr	f2,fp1
	fpop	fp0
	bl	_pow
	.extern	_pow 
	frsp	fp0,fp0
	fmr	fp1,fp0
	fpop	fp0
	fmuls	fp0,fp0,fp1
	fmovl	d0,fp0
	stw	d0,RealF_f(a5)
#                                             
#ENDIF
RealF_else2_1:
RealF_endif2:
#
#StringF(buf,'\s\d.',neg,top)
	lwz	d0,RealF_buf(a5)
	push	d0
	law	a0,_str2
	push	a0
	law	a0,_list1
	lwz	d1,RealF_neg(a5)
	stw	d1,0(a0)
	addi	a0,a0,4
	lwz	d1,RealF_top(a5)
	stw	d1,0(a0)
	subi	a0,a0,4
	push	a0
	bl	_StringF
	addi	a7,a7,3*4
#
#StrCopy(str,buf,StrLen(buf))
	push	d0
	lwz	d0,RealF_str(a5)
	push	d0
	lwz	d1,RealF_buf(a5)
	push	d1
	push	d0
	lwz	d0,RealF_buf(a5)
	bl	_StrLen
	mr	d1,d0
	pop	d0
	mr	d0,d1
	pop	a1
	pop	a0
	bl	_StrCopy
	mr	d1,d0
	pop	d0
#
#StringF(buf,'\z\d[9]',f)
	lwz	d0,RealF_buf(a5)
	push	d0
	law	a0,_str3
	push	a0
	law	a0,_list2
	lwz	d1,RealF_f(a5)
	stw	d1,0(a0)
	push	a0
	bl	_StringF
	addi	a7,a7,3*4
#
#StrAdd(str,buf+9-n,StrLen(buf)-9+n)
	push	d0
	lwz	d0,RealF_str(a5)
	push	d0
	lwz	d1,RealF_buf(a5)
	addiw	d1,d1,9
	lwz	d2,RealF_n(a5)
	sub	d1,d1,d2
	push	d1
	push	d0
	lwz	d0,RealF_buf(a5)
	bl	_StrLen
	mr	d1,d0
	pop	d0
	subiw	d1,d1,9
	lwz	d2,RealF_n(a5)
	add	d0,d1,d2
	pop	a1
	pop	a0
	bl	_StrAdd
	mr	d1,d0
	pop	d0
#
#ENDPROC str
	.global	_RealF_end
_RealF_end:
	lwz	d0,RealF_str(a5)
_RealF_finish:
	pop	a0
	unlk	a5
	blr

	.type	_RealF,2
	.size	_RealF,$-_RealF

	.extern	_StrAdd
	.extern	_StrLen
	.extern	_StringF
	.extern	_StrCopy
	.align	2
	.tocd
fconv:	.long	0x43300000,0x80000000
	.extern	_stdrast_
_fltn_1:
	.float	0.0
.set	_fltn_2,_fltn_1
_fltn_3:
	.float	10.0
_list1:	.ualong	0
	.ualong	0
	.align	2
_list2:	.ualong	0
	.align	2
_str1:
	.byte	"-"
	.byte	0
	.align	2
_str2:
	.byte	"%"
	.byte	"l"
	.byte	"s"
	.byte	"%"
	.byte	"l"
	.byte	"d"
	.byte	"."
	.byte	0
	.align	2
_str3:
	.byte	"%"
	.byte	"0"
	.byte	"9"
	.byte	"."
	.byte	"9"
	.byte	"l"
	.byte	"d"
	.byte	0
	.align	2

	.tocd
fconv_:	.long	fconv
	.extern	_PowerPCBase_
_RealF_:	.long	_RealF
_RealF_end_:	.long	_RealF_end
_RealF_finish_:	.long	_RealF_finish
_fltn_1_:	.long	_fltn_1
_fltn_2_:	.long	_fltn_1
_fltn_3_:	.long	_fltn_3
_list1_:	.long	_list1
_list2_:	.long	_list2
_str1_:	.long	_str1
_str2_:	.long	_str2
_str3_:	.long	_str3
