#rE
	.include	ppcmacros.pasm
	.text
	.sdreg	r2
	.align	2
	.global	_WaitIMessage
_WaitIMessage:
.set	WaitIMessage_win,8
	link	a5,-12
	push	a0
#DEF port,mes:PTR TO IntuiMessage,class
.set	WaitIMessage_port,-12
.set	WaitIMessage_mes,-8
.set	WaitIMessage_class,-4
#port:=win.UserPort
	lwz	a0,WaitIMessage_win(a5)
	lwz	d0,86(a0)
	stw	d0,WaitIMessage_port(a5)
#
#IFN (mes:=GetMsg(port))
WaitIMessage_if1:
	push	d0
	lwz	a0,WaitIMessage_port(a5)
	RUN_68K	_ExecBase,-372
	mr	d1,d0
	pop	d0
	stw	d1,WaitIMessage_mes(a5)
	tstw	d1
	bne	WaitIMessage_else1_0
#REPEAT
WaitIMessage_repeat2:
#WaitPort(port)
	push	d0
	lwz	a0,WaitIMessage_port(a5)
	RUN_68K	_ExecBase,-384
	mr	d1,d0
	pop	d0
#
#UNTIL (mes:=GetMsg(port))<>NIL
WaitIMessage_nextloop2:
	push	d0
	lwz	a0,WaitIMessage_port(a5)
	RUN_68K	_ExecBase,-372
	mr	d1,d0
	pop	d0
	stw	d1,WaitIMessage_mes(a5)
	cmpiw	d1,0
	beq	WaitIMessage_repeat2
WaitIMessage_endloop2:
#ENDIF
WaitIMessage_else1_0:
#
#class:=mes.Class
	lwz	a0,WaitIMessage_mes(a5)
	lwz	d0,20(a0)
	stw	d0,WaitIMessage_class(a5)
#
#code:=mes.Code
	lwz	a0,WaitIMessage_mes(a5)
	lhz	d0,24(a0)
	andi.	d0,d0,0xFFFF
	law	a0,_code
	stw	d0,0(a0)
#
#qual:=mes.Qualifier
	lwz	a0,WaitIMessage_mes(a5)
	lhz	d0,26(a0)
	andi.	d0,d0,0xFFFF
	law	a0,_qual
	stw	d0,0(a0)
#
#iaddr:=mes.IAddress
	lwz	a0,WaitIMessage_mes(a5)
	lwz	d0,28(a0)
	law	a0,_iaddr
	stw	d0,0(a0)
#
#ReplyMsg(mes)
	push	d0
	lwz	a1,WaitIMessage_mes(a5)
	RUN_68K	_ExecBase,-378
	mr	d1,d0
	pop	d0
#
#ENDPROC class
	.global	WaitIMessage_end
WaitIMessage_end:
	lwz	d0,WaitIMessage_class(a5)
WaitIMessage_finish:
	pop	a0
	unlk	a5
	blr

	.type	_WaitIMessage,2
	.size	_WaitIMessage,$-_WaitIMessage

	.global	_MsgCode
_MsgCode:
	link	a5,0
	push	a0
	law	a0,_code
	lwz	d0,0(a0)
MsgCode_finish:
	pop	a0
	unlk	a5
	blr

	.type	_MsgCode,2
	.size	_MsgCode,$-_MsgCode

	.global	_MsgQualifier
_MsgQualifier:
	link	a5,0
	push	a0
	law	a0,_qual
	lwz	d0,0(a0)
MsgQualifier_finish:
	pop	a0
	unlk	a5
	blr

	.type	_MsgQualifier,2
	.size	_MsgQualifier,$-_MsgQualifier

	.global	_MsgIaddr
_MsgIaddr:
	link	a5,0
	push	a0
	law	a0,_iaddr
	lwz	d0,0(a0)
MsgIaddr_finish:
	pop	a0
	unlk	a5
	blr

	.type	_MsgIaddr,2
	.size	_MsgIaddr,$-_MsgIaddr

	.align	2
	.tocd
fconv:	.long	0x43300000,0x80000000
	.extern	_laststackptr_
	.extern	_stdrast_
	.extern	_lastexceptptr_
_iaddr:	.ualong	0
_qual:	.ualong	0
	.extern	_lastframeptr_
	.extern	_ExecBase_
	.extern	_exceptioninfo_
	.extern	_exception_
_code:	.ualong	0

	.tocd
fconv_:	.long	fconv
	.extern	_PowerPCBase_
_WaitIMessage_:	.long	_WaitIMessage
WaitIMessage_if1_:	.long	WaitIMessage_if1
WaitIMessage_repeat2_:	.long	WaitIMessage_repeat2
WaitIMessage_nextloop2_:	.long	WaitIMessage_nextloop2
WaitIMessage_endloop2_:	.long	WaitIMessage_endloop2
WaitIMessage_end_:	.long	WaitIMessage_end
_MsgCode_:	.long	_MsgCode
_MsgQualifier_:	.long	_MsgQualifier
_MsgIaddr_:	.long	_MsgIaddr
_iaddr_:	.long	_iaddr
_qual_:	.long	_qual
_code_:	.long	_code
