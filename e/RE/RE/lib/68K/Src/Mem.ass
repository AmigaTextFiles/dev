;rE
;phxass NOEXE opt nrqbtlps re:lib/elib_68K/Mem.ass

	machine mc68020

; d0 - size
	xdef	_ReNewR
_ReNewR:
	move.l	d0,-(a7)
;IFN _repool THEN IFN _repool:=CreatePool($10005,$2000,$1000) THEN Raise("MEM")
	move.l	__repool,d0
	bne	ReNewR_else
	move.l	#65541,d0
	move.l	#8192,d1
	move.l	#4096,d2
	movea.l	_ExecBase,a6
	jsr	-696(a6)
	move.l	d0,__repool
	beq	ReNewR_Raise
ReNewR_else:
;AllocVecPooled(_repool,size)
	move.l	d0,a0
	move.l	(a7)+,d0
	jsr	_AllocVecPooled
	tst.l	d0
	bne	ReNewR_end
ReNewR_Raise:
;Raise("MEM")
	move.l	#5064013,d0
	move.l	#0,d1
	jsr	_Raise
ReNewR_end:
	rts

; a0 - pool
; a1 - mem
	xdef	_ReDispose
_ReDispose:
;IF mem THEN FreeVecPooled(pool,mem)
	tst.l	a1
	beq	ReDispose_else3_0
;FreeVecPooled(_repool,mem)
	move.l	__repool,a0
	jsr	_FreeVecPooled
ReDispose_else3_0:
	rts



; a0 - pool
	xdef	_ReDisposeAll
_ReDisposeAll:
;DeletePool(_repool)
	move.l	__repool,a0
	tst.l	a0
	beq	ReDisposeAll_else
	movea.l	_ExecBase,a6
	jsr	-702(a6)
	move.l	#0,__repool
ReDisposeAll_else:
	rts



; a0 - pool
; d0 - size

	xdef	_AllocVecPooled
_AllocVecPooled:
	addq.l	#4,d0
;IF mem:=AllocPooled(pool,size)
	move.l	d0,-(a7)
	movea.l	_ExecBase,a6
	jsr	-708(a6)
	move.l	(a7)+,d1
	tst.l	d0
	beq.s	.exit
;  mem[]++:=size
	move.l	d0,a0
	move.l	d1,(a0)+
	move.l	a0,d0
.exit	rts



; a0 - pool
; a1 - mem
; d0 - size

	xdef	_FreeVecPooled
_FreeVecPooled:
;FreePooled(pool,mem-4,mem[-1])
	move.l	-(a1),d0
	movea.l	_ExecBase,a6
	jsr	-714(a6)
	rts




	xref	_Raise
	cnop	0,2

	section	".tocd",data
	xref	_laststackptr
	xref	_lastexceptptr
	xref	_lastframeptr
	xref	_ExecBase
	xref	_exceptioninfo
__repool:
	dc.l	0
	xref	_exception

