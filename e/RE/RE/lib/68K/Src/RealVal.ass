;rE
	machine mc68020
	fpu	1

	dsource	"re:lib/elib_68K/RealVal.e"
;MOD:re:modules/lib/restd_68k.m
	xdef	_RealVal
_RealVal:
RealVal_str	equ	8
	link	a5,#-28
	movem.l	a0,-(a7)
;DEF divider=1.0,fraction=0.0,sign=1.0
	lea	_fltn_1,a0
	fmove.s	(a0),fp0
RealVal_divider	equ	-28
	fmove.s	fp0,RealVal_divider(a5)
	lea	_fltn_2,a0
	fmove.s	(a0),fp0
RealVal_fraction	equ	-24
	fmove.s	fp0,RealVal_fraction(a5)
	lea	_fltn_3,a0
	fmove.s	(a0),fp0
RealVal_sign	equ	-20
	fmove.s	fp0,RealVal_sign(a5)
;DEF x=0
RealVal_x	equ	-16
	move.l	#0,RealVal_x(a5)
;DEF pre=TRUE,n,oldstr
RealVal_pre	equ	-12
	move.l	#-1,RealVal_pre(a5)
RealVal_n	equ	-8
RealVal_oldstr	equ	-4
;oldstr:=str
	move.l	RealVal_str(a5),RealVal_oldstr(a5)
;
;WHILE (str[]=" ") OR (str[]="\n") OR (str[]="\t") OR (str[]="+") DO str++
RealVal_while1:
	movea.l	RealVal_str(a5),a0
	move.b	(a0),d0
	and.l	#$FF,d0
	cmpi.l	#32,d0
	seq	d0
	extb.l	d0
	movea.l	RealVal_str(a5),a0
	move.b	(a0),d1
	and.l	#$FF,d1
	cmpi.l	#10,d1
	seq	d1
	extb.l	d1
	or.l	d1,d0
	movea.l	RealVal_str(a5),a0
	move.b	(a0),d1
	and.l	#$FF,d1
	cmpi.l	#9,d1
	seq	d1
	extb.l	d1
	or.l	d1,d0
	movea.l	RealVal_str(a5),a0
	move.b	(a0),d1
	and.l	#$FF,d1
	cmpi.l	#43,d1
	seq	d1
	extb.l	d1
	or.l	d1,d0
	tst.l	d0
	beq	RealVal_elsewhile1_0
;str++
	add.l	#1,RealVal_str(a5)
	bra	RealVal_while1
RealVal_elsewhile1_0:
;
;IF str[]="-"
;RealVal_if2
	movea.l	RealVal_str(a5),a0
	move.b	(a0),d0
	and.l	#$FF,d0
	cmpi.l	#45,d0
	bne	RealVal_else2_0
;sign:=-1.0
	lea	_fltn_4,a0
	fmove.s	(a0),fp0
	fmove.s	fp0,RealVal_sign(a5)
;
;str++
	add.l	#1,RealVal_str(a5)
;
;ENDIF
RealVal_else2_0:
;
;WHILE str[]
RealVal_while3:
	movea.l	RealVal_str(a5),a0
	move.b	(a0),d0
	and.l	#$FF,d0
	beq	RealVal_elsewhile3_0
;SELECT str[]
RealVal_select4:
	movea.l	RealVal_str(a5),a0
	move.b	(a0),d0
	and.l	#$FF,d0
;CASE "0" TO "9"
	cmpi.l	#48,d0
	blt	RealVal_casenext4_11
	cmpi.l	#57,d0
	ble	RealVal_casecode4_1
RealVal_casenext4_11:
	bra	RealVal_case4_1
RealVal_casecode4_1:
;n:=(str[]-"0")
	movea.l	RealVal_str(a5),a0
	move.b	(a0),d0
	and.l	#$FF,d0
	subi.l	#48,d0
	move.l	d0,RealVal_n(a5)
;
;IF pre
;RealVal_if5
	move.l	RealVal_pre(a5),d0
	tst.l	d0
	beq	RealVal_else5_0
;x:=x*10+n
	move.l	RealVal_x(a5),d0
	muls.l	#10,d0
	add.l	RealVal_n(a5),d0
	move.l	d0,RealVal_x(a5)
;
;ELSE
	bra	RealVal_endif5
RealVal_else5_0:
;
;fraction:=!fraction*10.0+(n!)
	fmove.s	RealVal_fraction(a5),fp0
	lea	_fltn_5,a0
	fmove.s	(a0),fp1
	fmul.s	fp1,fp0
	fmove.l	fp0,d0
	move.l	RealVal_n(a5),d1
	fmove.l	d1,fp1
	fadd.s	fp1,fp0
	fmove.s	fp0,RealVal_fraction(a5)
;
;divider:=!divider*10.0
	fmove.s	RealVal_divider(a5),fp0
	lea	_fltn_6,a0
	fmove.s	(a0),fp1
	fmul.s	fp1,fp0
	fmove.s	fp0,RealVal_divider(a5)
;
;ENDIF
RealVal_endif5:
;
;CASE "."
	bra	RealVal_endselect4
RealVal_case4_1:
	cmpi.l	#46,d0
	beq	RealVal_casecode4_2
	bra	RealVal_case4_2
RealVal_casecode4_2:
;pre:=FALSE
	move.l	#0,RealVal_pre(a5)
;
;ENDSELECT
RealVal_case4_2:
RealVal_endselect4:
;
;str++
	add.l	#1,RealVal_str(a5)
;
;ENDWHILE
RealVal_nextloop3:
	bra	RealVal_while3
RealVal_elsewhile3_0:
RealVal_endloop3:
;
;x:=!(x!)+(!fraction/divider)                                 
	move.l	RealVal_x(a5),d0
	fmove.l	d0,fp0
	fmove.s	RealVal_fraction(a5),fp1
	fmove.s	RealVal_divider(a5),fp2
	fdiv.s	fp2,fp1
	fadd.s	fp1,fp0
	fmove.s	fp0,RealVal_x(a5)
;                                 
;ENDPROC !x*sign,str-oldstr
	xdef	_RealVal_end
_RealVal_end:
	fmove.s	RealVal_x(a5),fp0
	fmove.s	RealVal_sign(a5),fp1
	fmul.s	fp1,fp0
	fmove.s	fp0,d0
	move.l	RealVal_str(a5),d1
	sub.l	RealVal_oldstr(a5),d1
_RealVal_finish:
	movem.l	(a7)+,a0
	unlk	a5
	rts
; END
; NOX
	cnop	0,2

	section	".tocd",data
	xref	_stdrast
_fltn_1:
	dc.s	1.0
_fltn_2:
	dc.s	0.0
_fltn_3	equ	_fltn_1
_fltn_4:
	dc.s	-1.0
_fltn_5:
	dc.s	10.0
_fltn_6	equ	_fltn_5
