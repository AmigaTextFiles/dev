;rE
	machine mc68020
	fpu	1

	dsource	"re:lib/elib_68K/RealF.e"
;MOD:re:modules/lib/restd_68k.m
	xdef	_RealF
_RealF:
RealF_str	equ	16
RealF_f	equ	12
RealF_n	equ	8
	link	a5,#-40
	movem.l	a0,-(a7)
;DEF  top,neg=NIL,rest
RealF_top	equ	-40
RealF_neg	equ	-36
	move.l	#0,RealF_neg(a5)
RealF_rest	equ	-32
;DEF  buf[24]:ARRAY                           
RealF_buf	equ	-28
	lea	RealF_buf(a5),a0
	move.l	a0,d0
	addi.l	#4,d0
	move.l	d0,(a0)
;IF !f<0.0
;RealF_if1
	fmove.s	RealF_f(a5),fp0
	lea	_fltn_1,a0
	fmove.s	(a0),fp1
	fcmp.s	fp1,fp0
	fslt	d0
	extb.l	d0
	tst.l	d0
	beq	RealF_else1_0
;neg:='-'
	lea	_str1,a0
	move.l	a0,RealF_neg(a5)
;
;f:=!-f
	fmove.s	RealF_f(a5),fp0
	fneg.s	fp0
	fmove.s	fp0,RealF_f(a5)
;
;ENDIF
RealF_else1_0:
;
;top:=!f!
	fmove.s	RealF_f(a5),fp0
	fmove.l	fp0,d0
	move.l	d0,RealF_top(a5)
;
;IF n=0
;RealF_if2
	move.l	RealF_n(a5),d0
	cmpi.l	#0,d0
	bne	RealF_else2_0
;f:=0.0
	lea	_fltn_2,a0
	fmove.s	(a0),fp0
	fmove.s	fp0,RealF_f(a5)
;
;ELSE
	bra	RealF_endif2
RealF_else2_0:
;
;IF !f<(top!) THEN top--
;RealF_if3
	fmove.s	RealF_f(a5),fp0
	move.l	RealF_top(a5),d1
	fmove.l	d1,fp1
	fcmp.s	fp1,fp0
	fslt	d0
	extb.l	d0
	tst.l	d0
	beq	RealF_else3_0
;top--
	sub.l	#1,RealF_top(a5)
	lea	RealF_top(a5),a0
RealF_else3_0:
;rest:=!(f-(top!))
	move.l	RealF_f(a5),d0
	move.l	RealF_top(a5),d1
	fmove.l	d1,fp1
	fsub.s	fp1,fp0
	fmove.s	fp0,RealF_rest(a5)
;
;f:=!rest*Fpow(10.0,n!)!                                             
	fmove.s	RealF_rest(a5),fp0
	fmove.s	fp0,-(a7)
	lea	_fltn_3,a0
	fmove.s	(a0),fp1
	fmove.s	fp1,-(a7)
	move.l	RealF_n(a5),d1
	fmove.l	d1,fp1
	fmove.s	(a7)+,fp0
	jsr	_Pow
	fmove.s	fp0,fp1
	fmove.s	(a7)+,fp0
	fmul.s	fp1,fp0
	fmove.l	fp0,d0
	move.l	d0,RealF_f(a5)
;                                             
;ENDIF
RealF_else2_1:
RealF_endif2:
;
;StringF(buf,'\s\d.',neg,top)
	move.l	d0,-(a7)
	move.l	RealF_buf(a5),d0
	move.l	d0,-(a7)
	lea	_str2,a0
	move.l	a0,-(a7)
	lea	_list1,a0
	move.l	RealF_neg(a5),(a0)+
	move.l	RealF_top(a5),(a0)
	suba.l	#4,a0
	move.l	a0,a1
	move.l	(a7)+,a0
	move.l	(a7)+,a3
	jsr	_StringF
	move.l	d0,d1
	move.l	(a7)+,d0
;
;StrCopy(str,buf,StrLen(buf))
	move.l	d0,-(a7)
	move.l	RealF_str(a5),d0
	move.l	d0,-(a7)
	move.l	RealF_buf(a5),d1
	move.l	d1,-(a7)
	move.l	d0,-(a7)
	move.l	RealF_buf(a5),a0
	jsr	_StrLen
	move.l	d0,d1
	move.l	(a7)+,d0
	move.l	d1,d0
	move.l	(a7)+,a1
	move.l	(a7)+,a0
	jsr	_StrCopy
	move.l	d0,d1
	move.l	(a7)+,d0
;
;StringF(buf,'\z\d[9]',f)
	move.l	d0,-(a7)
	move.l	RealF_buf(a5),d0
	move.l	d0,-(a7)
	lea	_str3,a0
	move.l	a0,-(a7)
	lea	_list2,a0
	move.l	RealF_f(a5),(a0)
	move.l	a0,a1
	move.l	(a7)+,a0
	move.l	(a7)+,a3
	jsr	_StringF
	move.l	d0,d1
	move.l	(a7)+,d0
;
;StrAdd(str,buf+9-n,StrLen(buf)-9+n)
	move.l	d0,-(a7)
	move.l	RealF_str(a5),d0
	move.l	d0,-(a7)
	move.l	RealF_buf(a5),d1
	addi.l	#9,d1
	sub.l	RealF_n(a5),d1
	move.l	d1,-(a7)
	move.l	d0,-(a7)
	move.l	RealF_buf(a5),a0
	jsr	_StrLen
	move.l	d0,d1
	move.l	(a7)+,d0
	subi.l	#9,d1
	add.l	RealF_n(a5),d1
	move.l	d1,d0
	move.l	(a7)+,a1
	move.l	(a7)+,a0
	jsr	_StrAdd
	move.l	d0,d1
	move.l	(a7)+,d0
;
;ENDPROC str
	xdef	_RealF_end
_RealF_end:
	move.l	RealF_str(a5),d0
_RealF_finish:
	movem.l	(a7)+,a0
	unlk	a5
	rts
; END
; NOX
	xref	_StrAdd
	xref	_Pow
	xref	_StrLen
	xref	_StringF
	xref	_StrCopy
	cnop	0,2

	section	".tocd",data
	xref	_stdrast
_fltn_1:
	dc.s	0.0
_fltn_2	equ	_fltn_1
_fltn_3:
	dc.s	10.0
_list1:
	dc.l	0
	dc.l	0
	cnop	0,2
_list2:
	dc.l	0
	cnop	0,2
_str1:
	dc.b	"-"
	dc.b	0
	cnop	0,2
_str2:
	dc.b	"%"
	dc.b	"l"
	dc.b	"s"
	dc.b	"%"
	dc.b	"l"
	dc.b	"d"
	dc.b	"."
	dc.b	0
	cnop	0,2
_str3:
	dc.b	"%"
	dc.b	"0"
	dc.b	"9"
	dc.b	"."
	dc.b	"9"
	dc.b	"l"
	dc.b	"d"
	dc.b	0
	cnop	0,2
