/* PE/FastMem.e 11-09-2020
	An incredibly fast memory allocator, with O(1) performance.


Copyright (c) 2009,2010,2011,2012,2016,2020 Christopher Steven Handley ( http://cshandley.co.uk/email )
All rights reserved.

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

* The source code must not be modified after it has been translated or converted
away from the PortablE programming language.  For clarification, the intention
is that all development of the source code must be done using the PortablE
programming language (as defined by Christopher Steven Handley).

* Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/ /*
This allocator is based upon the TLSF algorithm, but adapted to work on a
per-program basis (rather than the per-OS basis that it was intended for).  It
adds space (aka "pools") as needed, starting off at 64KB, and gradually
increasing up to 16MB.  Pools are removed when they become empty.

Unfortunately the TLSF algorithm has an overhead of 8 bytes per block, which is
unacceptable for small allocations, plus it's O(1) constant time allocation is
still quite large.  So on top of it there is a "Slab" allocator (loosly based
upon the real Slab allocator & also upon AmigaE's FastNew algorithm), which for
blocks <= 256 bytes will pre-allocate 16 blocks of identical size in a single
slab.  The downside is that blocks > 256 bytes now have an overhead of 12 ??
bytes per block.  But the upside is that blocks <= 256 bytes only have an
overhead of 2.875 ??  bytes per block, and their O(1) constant allocation time
is small.

(?? = this was calculated before SIZEOF_slab increase from 10 to 12 bytes.)
*/
OPT NATIVE,POINTER,INLINE,PREPROCESS
MODULE 'PE/pSemaphores_prototypes','target/PE/base'
PRIVATE
OBJECT q;PRIVATE;q;qq[11342 XOR $2C6E]:ARRAY OF PTR TO qqpq;ENDOBJECT
OBJECT qq;PRIVATE;q;qq[11342 XOR $2C6E]:ARRAY OF q ;qqp:PTR TO qqp;qqq;qqpp;qqpq:PTR TO qqp ;ENDOBJECT
OBJECT qqp;PRIVATE;q:PTR TO qqp ;qq:PTR TO qqp ;qqp;ENDOBJECT
OBJECT qqq;PRIVATE;q;qq:PTR TO qqq ;ENDOBJECT
OBJECT qqpp OF qqq; ; ;ENDOBJECT
OBJECT qqpq OF qqq;PRIVATE;qqp:PTR TO qqpq ;qqq:PTR TO qqpq ;ENDOBJECT
OBJECT qqqp OF qq;PRIVATE;qqqp[(6788805 XOR $6797C1)/(281402 XOR $44B3E)+(27991862 XOR $1AB1F37)]:ARRAY OF PTR TO qqqq;ENDOBJECT
OBJECT qqqq;PRIVATE;q:PTR TO qqqq ;qq:PTR TO qqqq ;qqp:INT;ENDOBJECT
OBJECT qqppp;PRIVATE;q:BYTE ;qq:BYTE;ENDOBJECT
DEF q:PTR TO qqqp,qq:SEMAPHORE,qqp:ARRAY OF CHAR,qqq:ARRAY OF CHAR,qqpp:ARRAY OF CHAR,qqpq:ARRAY OF CHAR,qqqp:ARRAY OF CHAR,qqqq:ARRAY OF CHAR,qqppp:ARRAY OF CHAR,qqppq:ARRAY OF CHAR,qqpqp:ARRAY OF CHAR,qqpqq:ARRAY OF CHAR,qqqpp:ARRAY OF CHAR,qqqpq:ARRAY OF CHAR,qqqqp:ARRAY OF CHAR,qqqqq:ARRAY OF CHAR,qqpppp:ARRAY OF CHAR,qqpppq:ARRAY OF CHAR,qqppqp:ARRAY OF CHAR,qqppqq:ARRAY OF CHAR,qqpqpp:ARRAY OF CHAR,qqpqpq:ARRAY OF CHAR,qqpqqp:ARRAY OF CHAR,qqpqqq:ARRAY OF CHAR,qqqppp:ARRAY OF CHAR,qqqppq:ARRAY OF CHAR,qqqpqp:ARRAY OF CHAR,qqqpqq:ARRAY OF CHAR,qqqqpp:ARRAY OF CHAR,qqqqpq:ARRAY OF CHAR,qqqqqp:ARRAY OF CHAR,qqqqqq:ARRAY OF CHAR
PROC q(qqppppp:QUAD, qqppppq=NILA:ARRAY OF CHAR);; IF 9058 XOR $2362; IF qqppppp THEN PrintException(); ENDIF; Throw(qqppppp, qqppppq);ENDPROC
PROC qqp(qqppppp) ;DEF qqppppq:BYTE; IF qqppppp AND (1632992 XOR $FFE7EAE0); IF qqppppp AND (245542 XOR $FF03BF26); IF qqppppp AND (7237714 XOR $F06E7052); IF qqppppp AND (8186489 XOR $C07CEA79); IF qqppppp AND (191961 XOR $8002EDD9); qqppppq := 368915 XOR $5A10C; ELSE ; qqppppq := 98783552 XOR $5E3515E; ENDIF; ELSE ; IF qqppppp AND (102130904 XOR $261664D8); qqppppq := 173737 XOR $2A6B4; ELSE ; qqppppq := 258639 XOR $3F253; ENDIF; ENDIF; ELSE ; IF qqppppp AND (123613334 XOR $B5E3096); IF qqppppp AND (971112 XOR $80ED168); qqppppq := 413342 XOR $64E85; ELSE ; qqppppq := 1280461676 XOR $4C524B76; ENDIF; ELSE ; IF qqppppp AND (6229814 XOR $25F0F36); qqppppq := 71745381 XOR $446BF7C; ELSE ; qqppppq := 93417 XOR $16CF1; ENDIF; ENDIF; ENDIF; ELSE ; IF qqppppp AND (7560259 XOR $835C43); IF qqppppp AND (16505 XOR $C04079); IF qqppppp AND (6321809 XOR $E07691); qqppppq := 382701 XOR $5D6FA; ELSE ; qqppppq := 1272054124 XOR $4BD2017A; ENDIF; ELSE ; IF qqppppp AND (2615205 XOR $7E7A5); qqppppq := 413420 XOR $64EF9; ELSE ; qqppppq := 158488 XOR $26B0C; ENDIF; ENDIF; ELSE ; IF qqppppp AND (7979898 XOR $75C37A); IF qqppppp AND (194786 XOR $AF8E2); qqppppq := 1973804 XOR $1E1E3F; ELSE ; qqppppq := 61202411 XOR $3A5DFF9; ENDIF; ELSE ; IF qqppppp AND (52673751 XOR $321BCD7); qqppppq := 75840383 XOR $4853B6E; ELSE ; qqppppq := 339515 XOR $52E2B; ENDIF; ENDIF; ENDIF; ENDIF; ELSE IF qqppppp AND (1767862572 XOR $695F8ED3); IF qqppppp AND (253594668 XOR $F1D732C); IF qqppppp AND (1501439624 XOR $597ED688); IF qqppppp AND (3098008 XOR $2F8598); IF qqppppp AND (384634 XOR $55E7A); qqppppq := 803946 XOR $C4465; ELSE ; qqppppq := 2732006 XOR $29AFE8; ENDIF; ELSE ; IF qqppppp AND (101361453 XOR $60A872D); qqppppq := 6238034 XOR $5F2F5F; ELSE ; qqppppq := 253958 XOR $3E00A; ENDIF; ENDIF; ELSE ; IF qqppppp AND (144873 XOR $239E9); IF qqppppp AND (749249184 XOR $2CA8AAA0); qqppppq := 384186316 XOR $16E637C7; ELSE ; qqppppq := 1309956624 XOR $4E145A1A; ENDIF; ELSE ; IF qqppppp AND (289513 XOR $468E9); qqppppq := 771935632 XOR $2E02CD99; ELSE ; qqppppq := 324378 XOR $4F312; ENDIF; ENDIF; ENDIF; ELSE ; IF qqppppp AND (418582 XOR $663E6); IF qqppppp AND (610248500 XOR $245FA7F4); IF qqppppp AND (5426361 XOR $52CC39); qqppppq := 67602316 XOR $407878B; ELSE ; qqppppq := 1686717680 XOR $648944F6; ENDIF; ELSE ; IF qqppppp AND (11342 XOR $2C6E); qqppppq := 73008632 XOR $45A05FD; ELSE ; qqppppq := 46790608 XOR $2C9F7D4; ENDIF; ENDIF; ELSE ; IF qqppppp AND (253958 XOR $3E00A); IF qqppppp AND (2222035 XOR $21E7DB); qqppppq := 26587407 XOR $195B10C; ELSE ; qqppppq := 1977993 XOR $1E2E8B; ENDIF; ELSE ; IF qqppppp AND (1727723148 XOR $66FAF68E); qqppppq := 892908868 XOR $3538B545; ELSE ; qqppppq := 285809 XOR $45C71; ENDIF; ENDIF; ENDIF; ENDIF; ELSE ; qqppppq := -(460518 XOR $706E7); ENDIF;ENDPROC qqppppq 
PROC qqq(qqppppp) ;DEF qqppppq:BYTE; IF qqppppp AND (1767862572 XOR $695F8ED3); IF qqppppp AND (43173449 XOR $292C6B6); IF qqppppp AND (803946 XOR $C4465); IF qqppppp AND (214308 XOR $34527); IF qqppppp AND (114791197 XOR $6D7931C); qqppppq := 1659663280 XOR $62EC73B0; ELSE ; qqppppq := 1195807388 XOR $4746929D; ENDIF; ELSE ; IF qqppppp AND (404927 XOR $62DBB); qqppppq := 813155116 XOR $3077C32E; ELSE ; qqppppq := 881903040 XOR $3490C5C3; ENDIF; ENDIF; ELSE ; IF qqppppp AND (720684976 XOR $2AF4C780); IF qqppppp AND (339515 XOR $52E2B); qqppppq := 351838 XOR $55E5A; ELSE ; qqppppq := 6181091 XOR $5E50E6; ENDIF; ELSE ; IF qqppppp AND (809714 XOR $C5AB2); qqppppq := 129613036 XOR $7B9BCEA; ELSE ; qqppppq := 18758409 XOR $11E3B0E; ENDIF; ENDIF; ENDIF; ELSE ; IF qqppppp AND (36903212 XOR $233162C); IF qqppppp AND (2642523 XOR $28515B); IF qqppppp AND (686505848 XOR $28EB3E78); qqppppq := 1654446388 XOR $629CD93C; ELSE ; qqppppq := 161256 XOR $275E1; ENDIF; ELSE ; IF qqppppp AND (6769647 XOR $674FEF); qqppppq := 1309956624 XOR $4E145A1A; ELSE ; qqppppq := 384186316 XOR $16E637C7; ENDIF; ENDIF; ELSE ; IF qqppppp AND (1469761100 XOR $579AF64C); IF qqppppp AND (802738660 XOR $2FD8C1E4); qqppppq := 253958 XOR $3E00A; ELSE ; qqppppq := 6238034 XOR $5F2F5F; ENDIF; ELSE ; IF qqppppp AND (324011 XOR $4B1AB); qqppppq := 2732006 XOR $29AFE8; ELSE ; qqppppq := 803946 XOR $C4465; ENDIF; ENDIF; ENDIF; ENDIF; ELSE IF qqppppp AND (1632992 XOR $FFE7EAE0); IF qqppppp AND (402214 XOR $F92326); IF qqppppp AND (53957259 XOR $338528B); IF qqppppp AND (83410703 XOR $4FBBF0F); IF qqppppp AND (5270768 XOR $516CF0); qqppppq := 339515 XOR $52E2B; ELSE ; qqppppq := 75840383 XOR $4853B6E; ENDIF; ELSE ; IF qqppppp AND (8206627 XOR $793923); qqppppq := 61202411 XOR $3A5DFF9; ELSE ; qqppppq := 1973804 XOR $1E1E3F; ENDIF; ENDIF; ELSE ; IF qqppppp AND (2864738 XOR $1BB662); IF qqppppp AND (426496 XOR $168200); qqppppq := 158488 XOR $26B0C; ELSE ; qqppppq := 413420 XOR $64EF9; ENDIF; ELSE ; IF qqppppp AND (1057089024 XOR $3F41E600); qqppppq := 1272054124 XOR $4BD2017A; ELSE ; qqppppq := 382701 XOR $5D6FA; ENDIF; ENDIF; ENDIF; ELSE ; IF qqppppp AND (7891988 XOR $F786C14); IF qqppppp AND (2282894 XOR $322D58E); IF qqppppp AND (1134815952 XOR $42A3EAD0); qqppppq := 93417 XOR $16CF1; ELSE ; qqppppq := 71745381 XOR $446BF7C; ENDIF; ELSE ; IF qqppppp AND (3729608 XOR $438E8C8); qqppppq := 1280461676 XOR $4C524B76; ELSE ; qqppppq := 413342 XOR $64E85; ENDIF; ENDIF; ELSE ; IF qqppppp AND (1325843 XOR $30143B13); IF qqppppp AND (37922237 XOR $1242A5BD); qqppppq := 258639 XOR $3F253; ELSE ; qqppppq := 173737 XOR $2A6B4; ENDIF; ELSE ; IF qqppppp AND (1733469336 XOR $2752A498); qqppppq := 98783552 XOR $5E3515E; ELSE ; qqppppq := 368915 XOR $5A10C; ENDIF; ENDIF; ENDIF; ENDIF; ELSE ; qqppppq := -(1409464396 XOR $5402B84D); ENDIF;ENDPROC qqppppq 
PROC qqpp(qqppppp) ;DEF qqppppq:PTR TO qq; qqppppq := NewR(qqppppp) !!PTR TO qq; qqppppq.qqp := NIL; qqppppq.qqq := 24354903 XOR $173A057; qqppppq.qqpp := 3653052 XOR $37BDBC; qqppppq.qqpq := NIL;ENDPROC qqppppq 
PROC qqpq(qqppppp:PTR TO qq);DEF qqppppq:PTR TO qqp,qqpppqp:PTR TO qqp; qqppppq := qqppppp.qqp; WHILE qqppppq; qqpppqp := qqppppq.q; Dispose(qqppppq !!PTR); qqppppq := qqpppqp; ENDWHILE; Dispose(qqppppp);ENDPROC
PROC qqqp(qqppppp:PTR TO qq) ;DEF qqppppq,qqpppqp,qqpppqq,qqppqpp,qqppqpq,qqppqqp:PTR TO qqp,qqppqqq:PTR TO qqq,qqpqppp,qqpqppq:BOOL; qqppppq := 60771 XOR $ED63; qqpppqp := 6874816 XOR $68E6C0; qqpppqq := 98738809 XOR $5E2A279; qqppqpp := 49709254 XOR $2F680C6; qqppqpq := 5052592 XOR $4D18B0; qqppqqp := qqppppp.qqp; WHILE qqppqqp; qqppqqq := qqppqqp !!PTR + (SIZEOF qqp  + (359497 XOR $57C4A) AND NOT (888927628 XOR $34FBF58F)) ; qqpqppp := qqppqqp !!PTR + qqppqqp.qqp; REPEAT; qqpqppq := qqppqqq.q AND (121363601 XOR $73BDC93) <> (111945006 XOR $6AC252E); IF qqpqppq = (4846322 XOR $49F2F2); qqpppqp:= qqpppqp+(122660920 XOR $74FA839); qqppppq := qqppppq + (qqppqqq.q AND (164243 XOR -$28191)); ELSE; qqppqpp:= qqppqpp+(133613035 XOR $7F6C5EA); qqpppqq := qqpppqq + (qqppqqq.q AND (164243 XOR -$28191)); ENDIF; qqppqqq := qqppqqq + (qqppqqq.q AND (164243 XOR -$28191)); UNTIL qqppqqq >= qqpqppp; qqppqpq:= qqppqpq+(133613035 XOR $7F6C5EA); qqppqqp := qqppqqp.q; ENDWHILE;;ENDPROC qqppppq ,qqpppqp ,qqpppqq ,qqppqpp ,qqppqpq 
PROC qqqq(qqppppp, qqppppq=NILA:ARRAY OF VALUE) ;DEF qqpppqp,qqpppqq; qqpppqp := qqp(qqppppp); qqpppqq := Shr(qqppppp, qqpppqp - (427285 XOR $68510)) AND ((70086787 XOR $42D7082) SHL (1049060808 XOR $3E8765CD)  - (6367425 XOR $6128C0)) ; IF qqppppq THEN qqppppq[(5364256 XOR $51DA20)] := qqpppqq;ENDPROC qqpppqp 
PROC qqppq(qqppppp:PTR TO qq, qqppppq, qqpppqp=NILA:ARRAY OF VALUE, qqpppqq=NILA:ARRAY OF VALUE, qqppqpp=NILA:ARRAY OF PTR TO q) ;DEF qqppqpq:PTR TO qqpq,qqppqqp,qqppqqq,qqpqppp:PTR TO q,qqpqppq,qqpqpqp,qqpqpqq; qqpqppq := qqqq(qqppppq + Shl(373211 XOR $5B1DA, qqp(qqppppq) - (1630787924 XOR $6133D951)) - (1722650936 XOR $66AD9139), ADDRESSOF  qqpqpqp); qqpqppp := qqppppp.qq[qqpqppq]; qqpqpqq := qqpqppp.q AND ((318201 XOR $FFFB2506) SHL qqpqpqp); IF qqpqpqq <> (88978724 XOR $54DB524); qqppqqq := qqq(qqpqpqq); qqppqqp := qqpqppq; ELSE; qqpqpqq := qqppppp.q AND ((318201 XOR $FFFB2506) SHL (qqpqppq + (88978724 XOR $54DB525))); IF qqpqpqq = (218523 XOR $3559B) ; qqppqqp:=(qqppqqq:=-(79637997 XOR $4BF2DEC) ); qqpqppp:=NIL ; RETURN NIL ; ENDIF ; qqppqqp := qqq(qqpqpqq); qqpqppp := qqppppp.qq[qqppqqp]; qqppqqq := qqq(qqpqppp.q); ENDIF; qqppqpq := qqpqppp.qq[qqppqqq]; IF qqppqpq = (957377904 XOR $39106D70) THEN q("BUG", qqp );FINALLY; IF qqpppqp THEN qqpppqp[(298826 XOR $48F4A)] := qqppqqp; IF qqpppqq THEN qqpppqq[(1361132436 XOR $51213B94)] := qqppqqq; IF qqppqpp THEN qqppqpp [(105705682 XOR $64CF0D2)] := qqpqppp;ENDPROC qqppqpq 
PROC qqpqp(qqppppp:PTR TO qq, qqppppq:PTR TO qqpq, qqpppqp, qqpppqq, qqppqpp:PTR TO q) ;DEF qqppqpq:PTR TO qqpp,qqppqqp,qqppqqq,qqpqppp:BOOL; IF 25054 XOR $61DE; qqppqqp := qqqq(qqppppq.q AND (164243 XOR -$28191), ADDRESSOF  qqppqqq); IF qqpppqp <> qqppqqp  OR (qqpppqq <> qqppqqq); Print(qqq , qqppppq.q, qqppppq.q, qqpppqp, qqppqqp, qqpppqq, qqppqqq); ENDIF; IF qqpppqp <> qqppqqp THEN q("BUG", qqpp ); IF qqpppqq <> qqppqqq THEN q("BUG", qqpq ); ENDIF; IF 133613035 XOR $7F6C5EB THEN IF qqppqpp <> qqppppp.qq[qqpppqp] THEN q("BUG", qqqp ); qqpqppp := 427285 XOR $68515; IF qqppppq.qqp <> (70086787 XOR $42D7083); qqppppq.qqp.qqq := qqppppq.qqq; ENDIF; IF qqppppq.qqq <> (1049060808 XOR $3E8765C8); qqppppq.qqq.qqp := qqppppq.qqp; ELSE; IF 6367425 XOR $6128C1 THEN IF qqppqpp.qq[qqpppqq] <> qqppppq THEN q("BUG", qqqq ) ; qqppqpp.qq[qqpppqq] := qqppppq.qqp; IF qqppppq.qqp = (5364256 XOR $51DA20); qqpqppp := 373211 XOR -$5B1DC; ELSE; qqppppq.qqp.qqq := NIL; ENDIF; ENDIF; qqppppq.q := qqppppq.q AND NOT (1630787924 XOR $6133D956); qqppqpq := qqppppq ::qqq::qqpp; IF qqpqppp; qqppqpp.q := qqppqpp.q AND NOT ((1722650936 XOR $66AD9139) SHL qqpppqq); IF qqppqpp.q = (399718 XOR $61966); qqppppp.q := qqppppp.q AND NOT ((478810 XOR $74E5B) SHL qqpppqp); ENDIF; ENDIF;ENDPROC qqppqpq 
PROC qqpqq(qqppppp:PTR TO qq, qqppppq:PTR TO qqpq) ;DEF qqpppqp:PTR TO qqpp,qqpppqq,qqppqpp,qqppqpq:PTR TO q; qqpppqq := qqqq(qqppppq.q AND (164243 XOR -$28191), ADDRESSOF  qqppqpp); qqppqpq := qqppppp.qq[qqpppqq]; qqpppqp := qqpqp(qqppppp, qqppppq, qqpppqq, qqppqpp, qqppqpq);ENDPROC qqpppqp 
PROC qqqpp(qqppppp:PTR TO qq, qqppppq:PTR TO qqpp);DEF qqpppqp:PTR TO qqpq,qqpppqq,qqppqpp,qqppqpq:PTR TO q; qqppppq.q := qqppppq.q OR (133613035 XOR $7F6C5E9); qqpppqp := qqppppq ::qqq::qqpq; qqpppqq := qqqq(qqpppqp.q AND (164243 XOR -$28191), ADDRESSOF  qqppqpp); qqppqpq := qqppppp.qq[qqpppqq]; qqpppqp.qqp := qqppqpq.qq[qqppqpp]; qqpppqp.qqq := NIL; IF qqpppqp.qqp THEN qqpppqp.qqp.qqq := qqpppqp; qqppqpq.qq[qqppqpp] := qqpppqp; qqppqpq.q := qqppqpq.q OR ((133613035 XOR $7F6C5EA) SHL qqppqpp); qqppppp.q := qqppppp.q OR ((427285 XOR $68514) SHL qqpppqq);ENDPROC
PROC qqqpq(qqppppp:PTR TO qqpp, qqppppq, qqpppqp) ;DEF qqpppqq:PTR TO qqpp,qqppqpp:PTR TO qqq;  IF qqppppq AND (70086787 XOR $42D7080) THEN q("BUG", qqppp ); IF 1049060808 XOR $3E8765C8 THEN IF qqpppqp <> (qqppppp.q AND (164243 XOR -$28191)) THEN q("BUG", qqppq ); IF 133613035 XOR $7F6C5EB THEN IF qqpppqp AND (427285 XOR $68516) THEN q("BUG", qqpqp ); qqpppqq := qqppppp + qqppppq; qqpppqq.q := qqpppqp - qqppppq ; IF qqppppp.q AND (70086787 XOR $42D7082) THEN qqpppqq.q := qqpppqq.q OR (1049060808 XOR $3E8765C9); qqpppqq.qq := qqppppp; qqppppp.q := qqppppq ; IF qqpppqq.q AND (6367425 XOR $6128C0) = (5364256 XOR $51DA20); qqppqpp := qqppppp + qqpppqp; qqppqpp.qq := qqpppqq; ENDIF;ENDPROC qqpppqq 
PROC qqqqp(qqppppp:PTR TO qqpp, qqppppq:PTR TO qqpp) ;DEF qqpppqp:PTR TO qqpp,qqpppqq:PTR TO qqq; IF 373211 XOR $5B1DB THEN IF qqppppp <> qqppppq.qq THEN q("BUG", qqpqq ); qqppppp.q := qqppppp.q AND (164243 XOR -$28191)  + (qqppppq.q AND (164243 XOR -$28191)) ; IF qqppppq.q AND (133613035 XOR $7F6C5EA); qqppppp.q := qqppppp.q OR (427285 XOR $68514); ELSE; qqpppqq := qqppppq + (qqppppq.q AND (164243 XOR -$28191)); qqpppqq.qq := qqppppp; ENDIF; qqpppqp := qqppppp;ENDPROC qqpppqp 
PROC qqqqq(qqppppp:PTR TO qq, qqppppq) ;DEF qqpppqp:BOOL,qqpppqq,qqppqpp:PTR TO qqp,qqppqpq:PTR TO qqpp; qqpppqp := 133613035 XOR $7F6C5EB; qqppppq := qqppppq  + (427285 XOR $68516) AND NOT (70086787 XOR $42D7080)  ; qqpppqq := SIZEOF qqp  + (1049060808 XOR $3E8765CB) AND NOT (6367425 XOR $6128C2)   + qqppppq; qqppqpp := New(qqpppqq,  5364256 XOR -$51DA21)!!PTR TO qqp; IF qqppqpp = (373211 XOR $5B1DB) THEN RETURN; qqppqpp.qqp := qqpppqq; qqppppp.qqq := qqppppp.qqq +  (qqppqpp.qqp - (SIZEOF qqp  + (1630787924 XOR $6133D957) AND NOT (1722650936 XOR $66AD913B)) ); qqppppp.qqpp:= qqppppp.qqpp+(399718 XOR $61967); qqppqpp.q := qqppppp.qqp; qqppqpp.qq := NIL; IF qqppppp.qqp THEN qqppppp.qqp.qq := qqppqpp; qqppppp.qqp := qqppqpp; qqppqpq := qqppqpp !!PTR + (SIZEOF qqp  + (478810 XOR $74E59) AND NOT (333828 XOR $51807)) ; qqppqpq.q := qqppppq OR (131301172 XOR $7D37F35); qqppqpq.qq := NIL; qqqpp(qqppppp, qqppqpq); qqpppqp := 274132 XOR -$42ED5;ENDPROC qqpppqp 
PROC qqpppp(qqppppp:PTR TO qq, qqppppq:PTR TO qqp);DEF qqpppqp:PTR TO qqp,qqpppqq:PTR TO qqp,qqppqpp:PTR TO qqq; qqppqpp := qqppppq !!PTR + (SIZEOF qqp  + (6568520 XOR $643A4B) AND NOT (406216 XOR $632CB)) ; IF 108601 XOR $1A839; IF qqppqpp.q AND ((52994 XOR $CF03) OR (277498 XOR $43BF8)) <> ((5180577 XOR $4F0CA0) OR (1431563048 XOR $5553EB2A)) THEN q("EMU", qqqpp ); IF qqppqpp.qq <> (1513891464 XOR $5A3C2688) THEN q("BUG", qqqpq ); ENDIF; qqpqq(qqppppp, qqppqpp::qqpq); qqpppqp := qqppppq.qq; qqpppqq := qqppppq.q; IF qqpppqp; qqpppqp.q := qqpppqq; ELSE; IF 24905808 XOR $17C0850 THEN IF qqppppp.qqp <> qqppppq THEN q("BUG", qqqqp ); qqppppp.qqp := qqpppqq; ENDIF; IF qqpppqq; qqpppqq.qq := qqpppqp; ENDIF; qqppppp.qqq := qqppppp.qqq - (qqppppq.qqp - (SIZEOF qqp  + (57970439 XOR $3748F04) AND NOT (279830 XOR $44515)) ); qqppppp.qqpp:= qqppppp.qqpp-(6973431 XOR $6A67F6); Dispose(qqppppq !!PTR);ENDPROC
PROC qqpppq(qqppppp:PTR TO qq, qqppppq, qqpppqp=NILA:ARRAY OF VALUE) ;DEF qqpppqq:ARRAY,qqppqpp,qqppqpq:PTR TO qqpq,qqppqqp,qqppqqq,qqpqppp:PTR TO q,qqpqppq:PTR TO qqpp,qqpqpqp,qqpqpqq:PTR TO qqpp,qqpqqpp,qqpqqpq,qqpqqqp; qqppppq := Max(SIZEOF qqpp  + (36638 XOR $8F1D) AND NOT (69042425 XOR $41D80FA)    + qqppppq, SIZEOF qqpq)  + (4077217 XOR $3E36A2) AND NOT (260038 XOR $3F7C5)  ; qqppqpq := qqppq(qqppppp, qqppppq, ADDRESSOF  qqppqqp, ADDRESSOF  qqppqqq, ADDRESSOF  qqpqppp); IF qqppqpq = (231481 XOR $38839); IF (1712532420 XOR $66132BC4) = (26575189 XOR $1958155); qqpqqpp := Max(qqppppq * (107856328 XOR $66DC1C0), qqppppp.qqq + (qqppppp.qqq / Max(95022438 XOR $5A9ED67,qqppppp.qqpp))) ; IF qqpqqpp > (1134815952 XOR $42A3EAD0); qqpqqpq := qqqq(qqppppq + Shl(1149818616 XOR $4488D6F9, qqp(qqppppq) - (57322041 XOR $36AAA3C)) - (1389268200 XOR $52CE8CE9), ADDRESSOF  qqpqqqp); qqpqqpp := (145742 XOR $2394F) SHL (1459930 XOR $1646DF) OR qqpqqqp SHL (qqpqqpq - (1652789336 XOR $6283905D)); qqpqqpp := Max(qqpqqpp, 1134815952 XOR $42A3EAD0); ELSE IF qqpqqpp < (5270768 XOR $516CF0); qqpqqpp := 5270768 XOR $516CF0; ENDIF; IF qqqqq(qqppppp, qqpqqpp) = (3559588 XOR $3650A4); qqppqq(qqppppp); qqpqqpq := qqqq(qqppppq + Shl(1935184144 XOR $73589111, qqp(qqppppq) - (432876 XOR $69AE9)) - (14570047 XOR $DE523E), ADDRESSOF  qqpqqqp); qqpqqpp := (4765754 XOR $48B83B) SHL (7307120 XOR $6F7F75) OR qqpqqqp SHL (qqpqqpq - (50183394 XOR $2FDBCE7)); qqqqq(qqppppp, qqpqqpp); ENDIF; qqppqpq := qqppq(qqppppp, qqppppq, ADDRESSOF  qqppqqp, ADDRESSOF  qqppqqq, ADDRESSOF  qqpqppp); ENDIF; IF qqppqpq = (1021364376 XOR $3CE0C898) ; qqppqpp:=7950136 XOR $794F38 ; RETURN NILA ; ENDIF  ; ENDIF; qqpqppq := qqpqp(qqppppp, qqppqpq, qqppqqp, qqppqqq, qqpqppp); qqpqpqp := qqpqppq.q AND (164243 XOR -$28191); IF qqpqpqp - qqppppq >= (SIZEOF qqpq+ (133613035 XOR $7F6C5EA)); qqpqpqq := qqqpq(qqpqppq, qqppppq, qqpqpqp); qqqpp(qqppppp, qqpqpqq); qqpqpqp := qqppppq; ENDIF; qqpppqq := qqpqppq !!PTR + (SIZEOF qqpp  + (427285 XOR $68516) AND NOT (70086787 XOR $42D7080))  !!ARRAY; qqppqpp := qqpqpqp - (SIZEOF qqpp  + (1049060808 XOR $3E8765CB) AND NOT (6367425 XOR $6128C2))  ; IF 5364256 XOR $51DA20 THEN IF qqpppqq <> (qqpppqq  + (373211 XOR $5B1D8) AND NOT (1630787924 XOR $6133D957))  THEN q("EMU", qqqqq ); ; ; ; ;FINALLY; IF qqpppqp THEN qqpppqp[(1722650936 XOR $66AD9138)] := qqppqpp;ENDPROC qqpppqq 
PROC qqppqp(qqppppp:PTR TO qq, qqppppq:ARRAY);DEF qqpppqp:PTR TO qqpp,qqpppqq:PTR TO qqq,qqppqpp:PTR TO qqpp,qqppqpq:PTR TO qqq,qqppqqp:PTR TO qqpp,qqppqqq:PTR TO qqp; qqpppqp := qqppppq !!PTR - (SIZEOF qqpp  + (399718 XOR $61965) AND NOT (478810 XOR $74E59))  ; qqpppqq := qqpppqp.qq; qqppqpq := qqpppqp + (qqpppqp.q AND (164243 XOR -$28191)); IF qqpppqq; IF qqpppqq.q AND (133613035 XOR $7F6C5E9); qqppqpp := qqpqq(qqppppp, qqpppqq::qqpq); qqpppqp := qqqqp(qqppqpp, qqpppqp); ENDIF; ENDIF; IF qqpppqp.q AND (427285 XOR $68514) = (70086787 XOR $42D7083); IF qqppqpq.q AND (1049060808 XOR $3E8765CA); qqppqqp := qqpqq(qqppppp, qqppqpq::qqpq); qqpppqp := qqqqp(qqpppqp, qqppqqp); ENDIF; ENDIF; qqqpp(qqppppp, qqpppqp); IF (6367425 XOR $6128C1) = (5364256 XOR $51DA20); IF qqpppqp.qq = (373211 XOR $5B1DB); IF qqpppqp.q AND (1630787924 XOR $6133D955); qqppqqq := qqpppqp !!PTR - (SIZEOF qqp  + (1722650936 XOR $66AD913B) AND NOT (399718 XOR $61965)) ; IF qqppqqq <> qqppppp.qqpq; qqppqq(qqppppp); qqppppp.qqpq := qqppqqq; ENDIF; ENDIF; ENDIF; ENDIF;ENDPROC
PROC qqppqq(qqppppp:PTR TO qq);DEF qqppppq:PTR TO qqq; IF qqppppp.qqpq; qqppppq := qqppppp.qqpq !!PTR + (SIZEOF qqp  + (478810 XOR $74E59) AND NOT (333828 XOR $51807)) ; IF qqppppq.q AND ((131301172 XOR $7D37F35) OR (274132 XOR $42ED6)) = ((6568520 XOR $643A49) OR (406216 XOR $632CA)); qqpppp(qqppppp, qqppppp.qqpq); qqppppp.qqpq := NIL; ENDIF; ENDIF;ENDPROC
PROC qqpqpp() ;DEF qqppppp:PTR TO qqqp; qqppppp := qqpp(SIZEOF qqqp)::qqqp;ENDPROC qqppppp 
PROC qqpqpq(qqppppp:PTR TO qqqp);; qqpq(qqppppp);ENDPROC
PROC qqpqqp(qqppppp:PTR TO qqqp, qqppppq, qqpppqp=NILA:ARRAY OF VALUE, qqpppqq=108601 XOR $1A839:BOOL) ;DEF qqppqpp:ARRAY,qqppqpq,qqppqqp:BYTE,qqppqqq:PTR TO qqppp,qqpqppp,qqpqppq:BYTE,qqpqpqp:PTR TO qqqq; qqpqppp := (52994 XOR $CF00) + qqppppq  + (277498 XOR $43BF9) AND NOT (5180577 XOR $4F0CA2)   ; IF qqpqppp > (6788805 XOR $6797C1)  OR (281402 XOR $44B3A) OR qqpppqq; qqppqpp := qqpppq(qqppppp, (27991862 XOR $1AB1F34)  + (9058 XOR $2361) AND NOT (377210 XOR $5C179)   + qqppppq, ADDRESSOF  qqppqpq); IF qqppqpp = (142726 XOR $22D86) ; qqppqpq:=16041963 XOR $F4C7EB ; RETURN NILA ; ENDIF ; qqppqpp := qqppqpp !!PTR + ((2011023484 XOR $77DDC87E)  + (1025321 XOR $FA52A) AND NOT (734765 XOR $B362E)) !!ARRAY; qqppqpq := qqppqpq - ((102663679 XOR $61E85FD)  + (501119 XOR $7A57C) AND NOT (5342007 XOR $518334)) ; qqppqqq := qqppqpp !!PTR - (38271644 XOR $247FA9E); qqppqqq.q := -(96074069 XOR $5B9F954); ELSE; qqpqppq := qqpqppp / (6927480 XOR $69B47C) !!BYTE; IF 2016722204 XOR $7834BD1C THEN IF qqpqppq < (131639 XOR $20237)  OR (qqpqppq > ((6788805 XOR $6797C1)/(281402 XOR $44B3E))) THEN q("BUG", qqpppp ); qqpqpqp := qqppppp.qqqp[qqpqppq]; IF qqpqpqp = (27991862 XOR $1AB1F36); qqpqpqp := qqpppq(qqppppp, (2732006 XOR $29AFE8) + ((339515 XOR $52E2B) * qqpqppp)) !!PTR TO qqqq; IF qqpqpqp = (351838 XOR $55E5E); qqppqpp := qqpqqp(qqppppp, qqppppq, qqpppqp,  6181091 XOR -$5E50E4); IF qqpppqp THEN qqppqpq := qqpppqp[(398509508 XOR $17C0C5C4)]; RETURN; ENDIF; qqpqpqp.q := NIL; qqpqpqp.qq := NIL ; qqpqpqp.qqp := -(92863 XOR $16ABE) ; qqppppp.qqqp[qqpqppq] := qqpqpqp; qqppqqp := 3723938 XOR $38D2A2 ; ELSE; qqppqqp := qqp(qqpqpqp.qqp AND (1767862572 XOR $695F8ED3)); ENDIF; IF 980704 XOR $EF6E0 THEN IF qqppqqp < (1917490104 XOR $724A93B8)  OR (qqppqqp > (803946 XOR $C4465)) THEN q("BUG", qqpppq ); qqppqqq := qqpqpqp !!PTR + (2732006 XOR $29AFE8) + (qqppqqp * qqpqppp); qqppqpp := qqppqqq !!PTR + (78883012 XOR $4B3A8C6)!!ARRAY; qqppqpq := qqpqppp - (4752420 XOR $488426); qqppqqq. q := qqpqppq; qqppqqq.qq := qqppqqp; qqpqpqp.qqp := qqpqpqp.qqp AND NOT ((198438856 XOR $BD3EFC9) SHL qqppqqp)!!INT; IF qqpqpqp.qqp = (977710868 XOR $3A46AF14); IF 2879046 XOR $2BEE46 THEN IF qqpqpqp.q <> (426561 XOR $68241) THEN q("BUG", qqppqp ); IF 474047 XOR $73BBF THEN IF qqppppp.qqqp[qqpqppq] <> qqpqpqp THEN q("BUG", qqppqq ); qqppppp.qqqp[qqpqppq] := qqpqpqp.qq; IF qqpqpqp.qq THEN qqpqpqp.qq.q := NIL; ENDIF; ENDIF; IF 415460 XOR $656E4 THEN IF qqppqpp <> (qqppqpp  + (134754 XOR $20E61) AND NOT (110944398 XOR $69CE08D))  THEN q("EMU", qqpqpp );FINALLY; IF qqpppqp THEN qqpppqp[(59681269 XOR $38EA9F5)] := qqppqpq;ENDPROC qqppqpp 
PROC qqpqqq(qqppppp:PTR TO qqqp, qqppppq:ARRAY);DEF qqpppqp:BYTE,qqpppqq:PTR TO qqppp,qqppqpp,qqppqpq:BYTE,qqppqqp:PTR TO qqqq; qqpppqq := qqppppq !!PTR - (622942144 XOR $252157C2); IF qqpppqq.q = -(116387844 XOR $6EFF005); qqppppq := qqppppq !!PTR - ((4995802 XOR $4C3AD8)  + (27321087 XOR $1A0E2FC) AND NOT (489999756 XOR $1D34CD8F)) !!ARRAY; qqppqp(qqppppp, qqppppq); ELSE; IF 426789944 XOR $19704C38 THEN q("BUG", qqpqpq );  qqppqpq := qqpppqq. q; qqpppqp := qqpppqq.qq; IF 4305156 XOR $41B104 THEN IF qqppqpq < (5070436 XOR $4D5E64)  OR ( qqppqpq > ((6788805 XOR $6797C1)/(281402 XOR $44B3E))) THEN q("BUG", qqpqqp ); IF 27991862 XOR $1AB1F36 THEN IF qqpppqp < (9058 XOR $2362)  OR (qqpppqp > (803946 XOR $C4465)) THEN q("BUG", qqpqqq ); qqppqpp := qqppqpq * (214308 XOR $34520); qqppqqp := qqpppqq !!PTR - (2732006 XOR $29AFE8) - (qqpppqp * qqppqpp); IF qqppqqp.qqp = (78883012 XOR $4B3A8C4); qqppqqp.q := NIL; qqppqqp.qq := qqppppp.qqqp[qqppqpq]; qqppppp.qqqp[qqppqpq] := qqppqqp; IF qqppqqp.qq THEN qqppqqp.qq.q := qqppqqp; ENDIF; qqppqqp.qqp := qqppqqp.qqp OR ((4752420 XOR $488425) SHL qqpppqp)!!INT; IF qqppqqp.qqp AND (1767862572 XOR $695F8ED3) = (1767862572 XOR $695F8ED3); IF qqppqqp.q = (980704 XOR $EF6E0); IF 1917490104 XOR $724A93B8 THEN IF qqppppp.qqqp[qqppqpq] <> qqppqqp THEN q("BUG", qqqppp ); qqppppp.qqqp[qqppqpq] := qqppqqp.qq; IF qqppqqp.qq THEN qqppqqp.qq.q := NIL; ELSE; qqppqqp.q.qq := qqppqqp.qq; IF qqppqqp.qq THEN qqppqqp.qq.q := qqppqqp.q; ENDIF; qqppqp(qqppppp, qqppqqp); ENDIF; ENDIF;ENDPROC
PROC new();; qqp := 'PE/FastMem; findFreeInArena(); freeBlock=NIL'; qqq := '# freeBlock.size=\d=$\h, freeFI=\d, freeSI=\d, debugFI=\d, debugSI=\d\n'; qqpp := 'PE/FastMem; removeFreeFromArena(); incorrect freeFI - please use FastVerify() to find memory corruption'; qqpq := 'PE/FastMem; removeFreeFromArena(); incorrect freeSI - please use FastVerify() to find memory corruption'; qqqp := 'PE/FastMem; removeFreeFromArena(); incorrect sl'; qqqq := 'PE/FastMem; removeFreeFromArena(); freeBlock.prevFree=NIL'; qqppp := 'PE/FastMem; splitBlock(); sizeInBytes is not a multiple of 4'; qqppq := 'PE/FastMem; splitBlock(); incorrect blockSize'; qqpqp := 'PE/FastMem; splitBlock(); blockSize is not a multiple of 4'; qqpqq := 'PE/FastMem; mergeBothBlocks(); blocks not adjacent'; qqqpp := 'PE/FastMem; removePoolFromArena(); pool is not completely free'; qqqpq := 'PE/FastMem; removePoolFromArena(); prevBlock<>NIL'; qqqqp := 'PE/FastMem; removePoolFromArena(); pool was unexpectedly not head of list'; qqqqq := 'PE/FastMem; allocFromArena(); block is not aligned'; qqpppp := 'PE/FastMem; allocFromSlabArena(); slabIndex out of bounds'; qqpppq := 'PE/FastMem; allocFromSlabArena(); blockIndex out of bounds'; qqppqp := 'PE/FastMem; allocFromSlabArena(); slab not head (1)'; qqppqq := 'PE/FastMem; allocFromSlabArena(); slab not head (2)'; qqpqpp := 'PE/FastMem; allocFromSlabArena(); block is not aligned'; qqpqpq := 'PE/FastMem; deallocFromSlabArena(); slabIndex<>-1'; qqpqqp := 'PE/FastMem; deallocFromSlabArena(); slabIndex out of bounds'; qqpqqq := 'PE/FastMem; deallocFromSlabArena(); blockIndex out of bounds'; qqqppp := 'PE/FastMem; deallocFromSlabArena(); slab not head'; qqqppq := 'WARNING: FastMem calls leaked \d bytes (\d MB) in \d blocks.  There are \d UNused bytes (\d MB) still pre-allocated in \d blocks by \d pools.\n'; qqqpqp := 'FastNew(); size<=0'; qqqpqq := 'FastDispose(); size<=0'; qqqqpp := 'SIZEOF_slab is too small'; qqqqpq := 'SIZEOF_slabBlock is too small'; qqqqqp := 'FastMem/FastVerify() FAILED due to: \s\n'; qqqqqq := 'NOTE: FastMem calls allocated \d bytes (\d MB) in \d blocks.  There are \d UNused bytes (\d MB) still pre-allocated in \d blocks by \d pools.\n'; qq := NewSemaphore(); q := qqpqpp(); ; ;ENDPROC
PROC end();DEF qqppppp,qqppppq,qqpppqp,qqpppqq,qqppqpp; IF 49994422 XOR $2FADAB6; qqppppp, qqppppq, qqpppqp, qqpppqq, qqppqpp := qqqp(q); IF qqppppq <> (218489 XOR $35579) THEN Print(qqqppq , qqppppp, qqppppp/(6769647 XOR $674FEF)/(6769647 XOR $674FEF), qqppppq, qqpppqp, qqpppqp/(6769647 XOR $674FEF)/(6769647 XOR $674FEF), qqpppqq, qqppqpp); ENDIF; qqpqpq(q) ; q := NIL; qq := DisposeSemaphore(qq);ENDPROC
PUBLIC
PROC FastNew(qqppppp, qqppppq=46612989 XOR $2C741FD:BOOL)  REPLACEMENT;DEF qqpppqp:ARRAY ; IF qqppppp <= (514354 XOR $7D932) THEN Throw("MEM", qqqpqp ); SemLock(qq); qqpppqp := qqpqqp(q, qqppppp); SemUnlock(qq); IF qqpppqp = (1488495812 XOR $58B8A4C4) THEN Raise("MEM"); IF qqppppq = (32688110 XOR $1F2C7EE) THEN NATIVE{memset(}qqpppqp {, 0,}qqppppp {)} ENDNATIVE; ; ;ENDPROC qqpppqp 
PROC FastDispose(qqppppp:ARRAY, qqppppq)  REPLACEMENT;; IF qqppppp; IF qqppppq <= (1152416 XOR $1195A0)  AND (qqppppq <> -(471566 XOR $731E9)) THEN q("MEM", qqqpqq ); SemLock(qq); qqpqqq(q, qqppppp); SemUnlock(qq); ENDIF;ENDPROC NILA
PROC FastVerify(qqppppp=918898992 XOR $36C54930:BOOL)  REPLACEMENT;DEF qqppppq:BOOL ; SemLock(qq); IF (253958 XOR $3E00A) < SIZEOF qqqq; IF qqppppp = (2222035 XOR $21E7D3) THEN Throw("FAIL", qqqqpp ); qqppppq := 26587407 XOR -$195B110; ENDIF; IF (1977993 XOR $1E2E8B) < SIZEOF qqppp; IF qqppppp = (1727723148 XOR $66FAF68C) THEN Throw("FAIL", qqqqpq ); qqppppq := 892908868 XOR -$3538B545; ENDIF; qqppppq :=  qqppppp BUT (285809 XOR $45C71) ;FINALLY; SemUnlock(qq); IF exception = "FAIL"; exception := 460518 XOR $706E6; IF qqppppp = (1927095520 XOR $72DD24E0) THEN Print(qqqqqp , exceptionInfo); qqppppq := 4980104 XOR -$4BFD89; ENDIF;ENDPROC qqppppq 
PROC FastReport(qqppppp=178748 XOR $2BA3C:BOOL)  REPLACEMENT;DEF qqppppq,qqpppqp,qqpppqq,qqppqpp,qqppqpq; SemLock(qq); qqppppq, qqpppqp, qqpppqq, qqppqpp, qqppqpq := qqqp(q); SemUnlock(qq); IF qqppppp = (305609 XOR $4A9C9) THEN Print(qqqqqq , qqppppq, qqppppq/(6769647 XOR $674FEF)/(6769647 XOR $674FEF), qqpppqp, qqpppqq, qqpppqq/(6769647 XOR $674FEF)/(6769647 XOR $674FEF), qqppqpp, qqppqpq);ENDPROC qqppppq ,qqpppqp ,qqpppqq ,qqppqpp ,qqppqpq 
