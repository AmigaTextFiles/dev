<html>
<head>
  <title>PowerD.html - jak vyrvorit linkovaci knihovnu</title>
  <meta http-equiv="Content-Type" content="text/html">
</head>
<body bgcolor=#ffffff>
<ul type=square>
<li><big>jak pouzivat linkovaci knihovku:</big><br>
  nejlepsi zpusob, jak pouzit funkce linkovaci knihovny je definovat
  si jeji funkce v modulu. a aby bylo pro programatora vse jeste jednodussi,
  je lepsi pridat do toho modulu obdobu nasledujiciho radku:
<font color=#ff0000><pre>
  OPT LINK='linklibrary'
</pre></font><br>
  kde linklibrary je nazev vasi linkovaci knihovny, pokud je ulozena v
  adresari 'd:lib', a pokud ne, tak pridejte '*' pred nazev, a pak celou
  cestu (napr.: 'hd5:lib/moje_knihovna.lib'). tento radek prida tuto linkovaci
  knihovnu do seznamu objektu, ktere se budou po kompilaci spojovat do jednoho
  spustitelneho souboru. vsechny moduly linkovacich knihoven by meli byt v
  adresari 'dmodules:lib.
<br><br>

<li><big>definice funkci:</big><br>
  PowerD umoznuje pouziti vice druhu funkci. prvni typ funkci bezny typ
  pouzivany v linkovacich knihovnach, a umoznuje posledni argument typu
  LIST. vsechny argumenty jsou nactene na zasobnik v opacnem poradi a pak
  je zavolana samotna funkce:

<font color=#ff0000><pre>
  LPROC nazev(argumenty)(vysledky)
</pre></font><br>
  LPROC je nejcasteji pouzita C prekladaci, zpracovava argumenty v opacnem poradi,
  nez je jejich definice: x(a,b,c) tato funkce ulozi nejdriv na zasobnik c, pak b pak a
  a nakonec se spusti. pokud pouzijete typ argumentu LIST, pak bude vse ulozeno na
  zasobnik v tomto poradi:
<font color=#ff0000><pre>
    LPROC x(u,v,w:LIST OF LONG)
    x(a,b,c,d,e,f)
</pre></font><br>
  toto presune na zasobnik nejdrive f, e, d, c, b, a nakonec a. je to ponekud hloupe,
  pokud chcete pouzit napriklad toto:
<font color=#ff0000><pre>
    LPROC x(a,b,c,d)
    n:=0
    x(n++,n++,n++,n++)
</pre></font><br>
  protoze se na staci ulozi hodnoty 3 do a, 2 do b, 1 do c a 0 do d.
<br><br>
  
    dalsi typ funkce je PowerD procedura, ktera ma jine uzivani zaobniku. zapisuje na
  zasobnik ve spravnem poradi, ale momentalne nepodporuje typ LIST. take je mozne pouzit
  externi procedury:
<font color=#ff0000><pre>
  EPROC procname(args)(results)
</pre></font><br>
  toto zapisovani na stack je mnohem prirozenejsi, ale neumoznuje pouziti typu list u
  posledniho argumentu, nicmene samozrejme lze pouzit list primo pomoci [ a ].
<font color=#ff0000><pre>
    EPROC x(a,b,c,d)
    n:=0
    x(n++,n++,n++,n++)
</pre></font><br>
  pracuje spravne, a zapisuje 0 do a, 1 do b, 2 do c, a 3 do d.
<br><br>

  posledni typ funkci je nejlepe pouzitelny pro rutiny assembleru, protoze nepouziva
  zasobnik (je pomalejsi, nez registry), a to je taky jeho jedine omezeni, a sice ze
  pocet argumentu je dan poctem registru pouzitelnych pro argumenty, pro 68k je to
  8 datobych registru, 5 adresovych (a5, a6, a7 jsou pouzity specializovane) a 8 
  registru obsahujici cisla s plovouci teckou (double/float). na powerpc lze pouzit
  8 datobych/adresovych registru (celkem 8, ne 8+8) a 13 s desetinou teckou.
<font color=#ff0000><pre>
  RPROC procname(argumenty s registry)(vysledky)<font color=#000000>[<font color=#ff0000>='asm'<font color=#000000>]
</pre></font><br>
</pre></font><font color=#000000>
  jak je videt, je mozne pridat assemblerovy zdrojovy kod primo k definici RPROC funkce.
  tim lze docilit inline funkci (jejich kod nahradi volani funkce). nicmene pouzivejte
  tuto moznost opatrne a dodrzujte nasledujici pravidla:
<pre>
  - kazda radka zacina tabulatorem '\t' nebo nejakymi mezerami, nebo navestim
  - kazda radka musi byt zakoncena koncem radku '\n'
  - musite pouzit spravnou instrukcni sadu
  - tento kod neni nijak ovlivnen PowerD, bude pouze zkopirovat do vystupniho assembleroveho kodu namisto volani funkce
  - je to obycejny textovy retezec, takze lze pousit viceradnovy <a href="strings.html">retezce</a>
  - celkova velikost retezce musi byt mensi nez 320 znaku, potrebujeteli vic, pouzijte APROC
</pre>
<br><br>

<li><big>jak vytvorit linkovaci knihovnu:</big><br>
  nejdriuve musite vytvorit objektove soubory, kazdy objektovy soubor by mel
  obsahovat jedinou funkci. toho muzete dosahnout tim, ze do kazdeho takoveho
  zdrojoveho kodu s jednou funkci pridate radek OPT OBJECT pro funkci v PowerD.
  jestlize chcete tvorit assemblerove rutiny, pouzijte exportni prikaz (obvykle
  xdef).<br>
  zkopirujte vsechny tyto objektove soubory do jednoho adresare, otevrete shell
  s timto adresarem, a v nem napiste:
<font color=#0000ff><pre>
  1.> join #?.o as xxx.lib
</pre></font><br>
  kde xxx je nazev nove vytvorene linkovaci knihovny. pak tuto knihovku zkopirujte
  do adresare 'd:lib', nakonec byste meli napsat modul pro tuto knihovnu, ktery
  musi obsahovat vsechny definice funkci, ktere jsou v knihovne obsazene, a to vcetne
  spravnych typu pro PowerD, C i assembler (EPROC/LPROC/RPROC).
<br><br>

<li><big>ukazky:</big>
<font color=#ff0000><pre>
  LPROC printf(fmt:PTR TO CHAR,args:LIST)

  EPROC PrintF(fmt:PTR TO CHAR,args:PTR)

  RPROC PrintF(a0:PTR TO CHAR,a1:LIST)</pre></font>
</ul>
</body>
</html>
