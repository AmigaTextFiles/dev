/*
 *  Source machine generated by GadToolsBox V2.0b
 *  which is (c) Copyright 1991-1993 Jaba Development
 *
 *  GUI Designed by : Kriton Kyrimis
 */

#include <exec/types.h>
#include <intuition/intuition.h>
#include <intuition/classes.h>
#include <intuition/classusr.h>
#include <intuition/imageclass.h>
#include <intuition/gadgetclass.h>
#include <libraries/gadtools.h>
#include <graphics/displayinfo.h>
#include <graphics/gfxbase.h>
#include <string.h>

#include <proto/exec.h>
#include <proto/intuition.h>
#include <proto/gadtools.h>
#include <proto/graphics.h>
#include <proto/utility.h>

#include "ixprefs.h"

struct Screen         *Scr = NULL;
UBYTE                 *PubScreenName = NULL;
APTR                   VisualInfo = NULL;
struct Window         *ixprefsWnd = NULL;
struct Gadget         *ixprefsGList = NULL;
struct Menu           *ixprefsMenus = NULL;
struct IntuiMessage    ixprefsMsg;
struct Gadget         *ixprefsGadgets[17];
UWORD                  ixprefsLeft = 0;
UWORD                  ixprefsTop = 11;
UWORD                  ixprefsWidth = 507;
UWORD                  ixprefsHeight = 141;
UBYTE                 *ixprefsWdt = (UBYTE *)"ixprefs";
struct TextAttr       *Font, Attr;
UWORD                  FontX, FontY;
UWORD                  OffX, OffY;
struct TextFont       *ixprefsFont = NULL;

struct NewMenu ixprefsNewMenu[] = {
	NM_TITLE, (STRPTR)"Project", NULL, 0, NULL, NULL,
	NM_ITEM, (STRPTR)"Save", (STRPTR)"S", 0, 0L, (APTR)ixprefssave,
	NM_ITEM, (STRPTR)"Use", (STRPTR)"U", 0, 0L, (APTR)ixprefsuse,
	NM_ITEM, (STRPTR)NM_BARLABEL, NULL, 0, 0L, NULL,
	NM_ITEM, (STRPTR)"About", (STRPTR)"?", 0, 0L, (APTR)ixprefsabout,
	NM_ITEM, (STRPTR)NM_BARLABEL, NULL, 0, 0L, NULL,
	NM_ITEM, (STRPTR)"Quit", (STRPTR)"Q", 0, 0L, (APTR)ixprefsquit,
	NM_TITLE, (STRPTR)"Edit", NULL, 0, NULL, NULL,
	NM_ITEM, (STRPTR)"Reset to defaults", (STRPTR)"D", 0, 0L, (APTR)ixprefsreset,
	NM_ITEM, (STRPTR)"Last Saved", (STRPTR)"L", 0, 0L, (APTR)ixprefslast,
	NM_ITEM, (STRPTR)"Restore", (STRPTR)"R", 0, 0L, (APTR)ixprefsrestore,
	NM_END, NULL, NULL, 0, 0L, NULL };

UWORD ixprefsGTypes[] = {
	CHECKBOX_KIND,
	BUTTON_KIND,
	BUTTON_KIND,
	BUTTON_KIND,
	CHECKBOX_KIND,
	CHECKBOX_KIND,
	CHECKBOX_KIND,
	INTEGER_KIND,
	INTEGER_KIND,
	CHECKBOX_KIND,
	INTEGER_KIND,
	CHECKBOX_KIND,
	CHECKBOX_KIND,
	CHECKBOX_KIND,
	CHECKBOX_KIND,
	CHECKBOX_KIND,
	CHECKBOX_KIND
};

struct NewGadget ixprefsNGad[] = {
	4, 1, 26, 11, (UBYTE *)"translate . and ..", NULL, GD_translatedot, PLACETEXT_RIGHT, NULL, (APTR)translatedotClicked,
	4, 128, 63, 11, (UBYTE *)"Save", NULL, GD_savegad, PLACETEXT_IN, NULL, (APTR)savegadClicked,
	222, 128, 63, 11, (UBYTE *)"Use", NULL, GD_usegad, PLACETEXT_IN, NULL, (APTR)usegadClicked,
	440, 128, 63, 11, (UBYTE *)"Cancel", NULL, GD_cancelgad, PLACETEXT_IN, NULL, (APTR)cancelgadClicked,
	327, 1, 26, 11, (UBYTE *)"translate symlinks", NULL, GD_translatelinks, PLACETEXT_RIGHT, NULL, (APTR)translatelinksClicked,
	192, 1, 26, 11, (UBYTE *)"translate /", NULL, GD_translateslash, PLACETEXT_RIGHT, NULL, (APTR)translateslashClicked,
	4, 14, 26, 11, (UBYTE *)"allow AmigaDOS notation", NULL, GD_amigados, PLACETEXT_RIGHT, NULL, (APTR)amigadosClicked,
	444, 14, 60, 12, (UBYTE *)"membuf size", NULL, GD_membuf, PLACETEXT_LEFT, NULL, (APTR)membufClicked,
	444, 28, 60, 12, (UBYTE *)"red zone size", NULL, GD_redzone, PLACETEXT_LEFT, NULL, (APTR)redzoneClicked,
	4, 27, 26, 11, (UBYTE *)"enable stack watcher", NULL, GD_watcher, PLACETEXT_RIGHT, NULL, (APTR)watcherClicked,
	4, 40, 60, 12, (UBYTE *)"physical blocks build one logical block (for stdio)", NULL, GD_blocks, PLACETEXT_RIGHT, NULL, (APTR)blocksClicked,
	4, 54, 26, 11, (UBYTE *)"ignore global environment (ENV:)", NULL, GD_ignoreenv, PLACETEXT_RIGHT, NULL, (APTR)ignoreenvClicked,
	4, 67, 26, 11, (UBYTE *)"use UNIX-style pattern-matching (", NULL, GD_pattern, PLACETEXT_RIGHT, NULL, (APTR)patternClicked,
	301, 67, 26, 11, (UBYTE *)"case sensitive)", NULL, GD_case, PLACETEXT_RIGHT, NULL, (APTR)caseClicked,
	4, 81, 26, 11, (UBYTE *)"suppress the \"Insert volume in drive\" requester", NULL, GD_suppress, PLACETEXT_RIGHT, NULL, (APTR)suppressClicked,
	4, 94, 26, 11, (UBYTE *)"open console if no errorstream was provided", NULL, GD_console, PLACETEXT_RIGHT, NULL, (APTR)consoleClicked,
	4, 107, 26, 11, (UBYTE *)"disable fibcache", NULL, GD_fibcache, PLACETEXT_RIGHT, NULL, (APTR)fibcacheClicked
};

ULONG ixprefsGTags[] = {
	(GTCB_Scaled), TRUE, (TAG_DONE),
	(TAG_DONE),
	(TAG_DONE),
	(TAG_DONE),
	(GTCB_Scaled), TRUE, (TAG_DONE),
	(GTCB_Scaled), TRUE, (TAG_DONE),
	(GTCB_Scaled), TRUE, (TAG_DONE),
	(GTIN_Number), 0, (GTIN_MaxChars), 10, (TAG_DONE),
	(GTIN_Number), 0, (GTIN_MaxChars), 10, (TAG_DONE),
	(GTCB_Scaled), TRUE, (TAG_DONE),
	(GTIN_Number), 0, (GTIN_MaxChars), 10, (TAG_DONE),
	(GTCB_Scaled), TRUE, (TAG_DONE),
	(GTCB_Scaled), TRUE, (TAG_DONE),
	(GTCB_Scaled), TRUE, (TAG_DONE),
	(GTCB_Scaled), TRUE, (TAG_DONE),
	(GTCB_Scaled), TRUE, (TAG_DONE),
	(GTCB_Scaled), TRUE, (TAG_DONE)
};

static UWORD ComputeX( UWORD value )
{
	return(( UWORD )((( FontX * value ) + 4 ) / 8 ));
}

static UWORD ComputeY( UWORD value )
{
	return(( UWORD )((( FontY * value ) + 4 ) / 8 ));
}

static void ComputeFont( UWORD width, UWORD height )
{
	Forbid();
	Font = &Attr;
	Font->ta_Name = (STRPTR)GfxBase->DefaultFont->tf_Message.mn_Node.ln_Name;
	Font->ta_YSize = FontY = GfxBase->DefaultFont->tf_YSize;
	FontX = GfxBase->DefaultFont->tf_XSize;
	Permit();

	OffX = Scr->WBorLeft;
	OffY = Scr->RastPort.TxHeight + Scr->WBorTop + 1;

	if ( width && height ) {
		if (( ComputeX( width ) + OffX + Scr->WBorRight ) > Scr->Width )
			goto UseTopaz;
		if (( ComputeY( height ) + OffY + Scr->WBorBottom ) > Scr->Height )
			goto UseTopaz;
	}
	return;

UseTopaz:
	Font->ta_Name = (STRPTR)"topaz.font";
	FontX = FontY = Font->ta_YSize = 8;
}

int SetupScreen( void )
{
	if ( ! ( Scr = LockPubScreen( PubScreenName )))
		return( 1L );

	ComputeFont( 0, 0 );

	if ( ! ( VisualInfo = GetVisualInfo( Scr, TAG_DONE )))
		return( 2L );

	return( 0L );
}

void CloseDownScreen( void )
{
	if ( VisualInfo ) {
		FreeVisualInfo( VisualInfo );
		VisualInfo = NULL;
	}

	if ( Scr        ) {
		UnlockPubScreen( NULL, Scr );
		Scr = NULL;
	}
}

int HandleixprefsIDCMP( void )
{
	struct IntuiMessage	*m;
	struct MenuItem		*n;
	int			(*func)();
	BOOL			running = TRUE;

	while( m = GT_GetIMsg( ixprefsWnd->UserPort )) {

		CopyMem(( char * )m, ( char * )&ixprefsMsg, (long)sizeof( struct IntuiMessage ));

		GT_ReplyIMsg( m );

		switch ( ixprefsMsg.Class ) {

			case	IDCMP_REFRESHWINDOW:
				GT_BeginRefresh( ixprefsWnd );
				GT_EndRefresh( ixprefsWnd, TRUE );
				break;

			case	IDCMP_CLOSEWINDOW:
				running = ixprefsCloseWindow();
				break;

			case	IDCMP_GADGETUP:
				func = ( void * )(( struct Gadget * )ixprefsMsg.IAddress )->UserData;
				running = func();
				break;

			case	IDCMP_MENUPICK:
				while( ixprefsMsg.Code != MENUNULL ) {
					n = ItemAddress( ixprefsMenus, ixprefsMsg.Code );
					func = (void *)(GTMENUITEM_USERDATA( n ));
					running = func();
					ixprefsMsg.Code = n->NextSelect;
				}
				break;
		}
	}
	return( running );
}

int OpenixprefsWindow( void )
{
	struct NewGadget	ng;
	struct Gadget	*g;
	UWORD		lc, tc;
	UWORD		wleft = ixprefsLeft, wtop = ixprefsTop, ww, wh;

	ComputeFont( ixprefsWidth, ixprefsHeight );

	ww = ComputeX( ixprefsWidth );
	wh = ComputeY( ixprefsHeight );

	if (( wleft + ww + OffX + Scr->WBorRight ) > Scr->Width ) wleft = Scr->Width - ww;
	if (( wtop + wh + OffY + Scr->WBorBottom ) > Scr->Height ) wtop = Scr->Height - wh;

	if ( ! ( ixprefsFont = OpenFont( Font )))
		return( 5L );

	if ( ! ( g = CreateContext( &ixprefsGList )))
		return( 1L );

	for( lc = 0, tc = 0; lc < ixprefs_CNT; lc++ ) {

		CopyMem((char * )&ixprefsNGad[ lc ], (char * )&ng, (long)sizeof( struct NewGadget ));

		ng.ng_VisualInfo = VisualInfo;
		ng.ng_TextAttr   = Font;
		ng.ng_LeftEdge   = OffX + ComputeX( ng.ng_LeftEdge );
		ng.ng_TopEdge    = OffY + ComputeY( ng.ng_TopEdge );
		ng.ng_Width      = ComputeX( ng.ng_Width );
		ng.ng_Height     = ComputeY( ng.ng_Height);

		ixprefsGadgets[ lc ] = g = CreateGadgetA((ULONG)ixprefsGTypes[ lc ], g, &ng, ( struct TagItem * )&ixprefsGTags[ tc ] );

		while( ixprefsGTags[ tc ] ) tc += 2;
		tc++;

		if ( NOT g )
			return( 2L );
	}

	if ( ! ( ixprefsMenus = CreateMenusA( ixprefsNewMenu, NULL )))
		return( 3L );

	LayoutMenus( ixprefsMenus, VisualInfo, GTMN_NewLookMenus, TRUE, TAG_DONE );

	if ( ! ( ixprefsWnd = OpenWindowTags( NULL,
				WA_Left,	wleft,
				WA_Top,		wtop,
				WA_Width,	ww + OffX + Scr->WBorRight,
				WA_Height,	wh + OffY + Scr->WBorBottom,
				WA_IDCMP,	CHECKBOXIDCMP|BUTTONIDCMP|INTEGERIDCMP|IDCMP_MENUPICK|IDCMP_CLOSEWINDOW|IDCMP_REFRESHWINDOW,
				WA_Flags,	WFLG_DRAGBAR|WFLG_DEPTHGADGET|WFLG_CLOSEGADGET|WFLG_SMART_REFRESH|WFLG_ACTIVATE,
				WA_Gadgets,	ixprefsGList,
				WA_Title,	ixprefsWdt,
				WA_ScreenTitle,	"ixprefs",
				WA_PubScreen,	Scr,
				WA_AutoAdjust,	TRUE,
				WA_PubScreenFallBack,	TRUE,
				WA_NewLookMenus,	TRUE,
				TAG_DONE )))
	return( 4L );

	SetMenuStrip( ixprefsWnd, ixprefsMenus );
	GT_RefreshWindow( ixprefsWnd, NULL );

	return( 0L );
}

void CloseixprefsWindow( void )
{
	if ( ixprefsMenus      ) {
		ClearMenuStrip( ixprefsWnd );
		FreeMenus( ixprefsMenus );
		ixprefsMenus = NULL;	}

	if ( ixprefsWnd        ) {
		CloseWindow( ixprefsWnd );
		ixprefsWnd = NULL;
	}

	if ( ixprefsGList      ) {
		FreeGadgets( ixprefsGList );
		ixprefsGList = NULL;
	}

	if ( ixprefsFont ) {
		CloseFont( ixprefsFont );
		ixprefsFont = NULL;
	}
}

