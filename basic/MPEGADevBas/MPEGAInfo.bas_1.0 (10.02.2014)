' =====================================================================
'
'                             MPEGAInfo.bas
'                 by/de Copyright 2014 Dámaso D. Estévez
'                             {este, son, eu}
'           AmiSpaTra - http://www.xente.mundo-r.com/amispatra/
'
'             All rights reserved over this derivative work:
'                  my Hisoft Basic developpers package.
'        Forbidden to remove ALL legal/copyrights remarks included
'             in this package: if you create a derivate work,
'                  you MUST to include all legal notes.
'
'                        Shows some MPEG file info.
'
'                                  ----
'
'       Todos los derechos reservados sobre este trabajo derivado:
'     mi paquete para desarrolladores que programen con Hisoft Basic.
'           Está prohibido eliminar cualquier comentario o nota
'     de autoría/legal de este paquete: si crea un trabajo derivado
'         HA DE INCLUIR OBLIGATORIAMENTE TODAS LAS NOTAS LEGALES.
'
'               Muestra alguna información de un fichero MPEG.
'
' =====================================================================

REM $NOWINDOW
REM $NOLIBRARY
REM $NOBREAK

OPTION BASE 1

' ---------------------------------------------------------------------
'                Include files and external subroutines
'              Ficheros de inclusión y subrutinas externas
' ---------------------------------------------------------------------

'         OS / SO
' ------------------------
REM $include exec.bh
REM $include dos.bh
REM $include utility.bc

' MPEGA lib / Biblioteca MPEGA
' ----------------------------
REM $include mpega.bh

'  From/De:
'  http://aminet.net/package/dev/basic/AST_HBRoutines
' ---------------------------------------------------
REM $include BLib_AST/SGetArg.bas
REM $include BLib_AST/StrTo.bas

' --------------------------------------------------------------------
'    Opening the basic libraries / Abriendo las bibliotecas básicas
' --------------------------------------------------------------------
LIBRARY OPEN "exec.library",  36&
LIBRARY OPEN "dos.library",   36&
LIBRARY OPEN "mpega.library", MPEGA_VERSION&

' ---------------------------------------------------------------------
'                             Vars / Variables
' ---------------------------------------------------------------------

' Version / Versión
' -----------------
v$ = "$VER: MPEGA_Info 1.0 (10.02.2014) by Dámaso 'AmiSpaTra' Domínguez "+CHR$(0)

' AmigaDOS return value: Initial hypothese
' Valor de retorno del AmigaDOS: Hipótesis inicial
' ------------------------------------------------
ret& = RETURN_FAIL&

' Others / Otras
' --------------
arg$   = ""     ' Argument: MPEG filename / Argumento: Nombre del fichero MPEG
mpc$   = ""     ' Struct's pointer / Puntero a astructura: MPEGA_CTRL
mps&   = NULL&  ' Struct's pointer / Puntero a astructura: MPEGA_STREAM
dummy& = NULL&

DIM ly$(4)      ' Layer description / Descripción de la capa
ly$(1) = "---"
ly$(2) = "I"
ly$(3) = "II"
ly$(4) = "III"

' =====================================================================
'                        Main code / Código principal
' =====================================================================

'            Only from CLI/Shell
' Sólo desde la interfaz de línea de comandos
' -------------------------------------------
IF PEEKL(SYSTAB+8) <> 0 THEN
	BEEP
	GOTO salida
END IF

' Parsing the argument / Procesando el argumento
' ----------------------------------------------
arg$ = SGetArg$(1%,"FILE/A")
IF arg$ = "" THEN
	PRINT "A MPEG file is required as argument / Se exige un fichero MPEG como argumento"
	ret& = RETURN_WARN&
	BEEP
	GOTO salida
END IF

' (Break and error)'s traps
' Trampas de errores e interrupción del usuario
' ---------------------------------------------
ON ERROR GOTO salida
ON BREAK GOTO salida

' Creating a clean struct (filled with zeroes)
' Creación de una estructura limpia (rellena de ceros)
' ----------------------------------------------------
mpc& = AllocMem&(MPEGA_CTRL_sizeof%, MEMF_CLEAR& OR MEMF_PUBLIC&)

' Filling it with some values (only not zeroes)
' Rellenándola con algunos valores (sólo no nulos)
' ------------------------------------------------
POKEL (mpc& + mpc_bs_access%),                               NULL&
POKEW (mpc& + mpc_layer_1_2% + mpl_force_mono%),             CINT(FALSE&)

POKEW (mpc& + mpc_layer_1_2% + mpl_mono%   + mpo_freq_div%), 1%
POKEW (mpc& + mpc_layer_1_2% + mpl_mono%   + mpo_quality%),  CINT(MPEGA_QUALITY_HIGH&)
POKEL (mpc& + mpc_layer_1_2% + mpl_mono%   + mpo_freq_max%), 48000&
POKEW (mpc& + mpc_layer_1_2% + mpl_stereo% + mpo_freq_div%), 1%
POKEW (mpc& + mpc_layer_1_2% + mpl_stereo% + mpo_quality%),  CINT(MPEGA_QUALITY_HIGH&)
POKEL (mpc& + mpc_layer_1_2% + mpl_stereo% + mpo_freq_max%), 48000&

POKEW (mpc& + mpc_layer_3%   + mpl_force_mono%),             CINT(FALSE&)
POKEW (mpc& + mpc_layer_3%   + mpl_mono%   + mpo_freq_div%), 1%
POKEW (mpc& + mpc_layer_3%   + mpl_mono%   + mpo_quality%),  CINT(MPEGA_QUALITY_HIGH&)
POKEL (mpc& + mpc_layer_3%   + mpl_mono%   + mpo_freq_max%), 48000&
POKEW (mpc& + mpc_layer_3%   + mpl_stereo% + mpo_freq_div%), 1%
POKEW (mpc& + mpc_layer_3%   + mpl_stereo% + mpo_quality%),  CINT(MPEGA_QUALITY_HIGH&)
POKEL (mpc& + mpc_layer_3%   + mpl_stereo% + mpo_freq_max%), 48000&

POKEW (mpc& + mpc_check_mpeg%),                              CINT(TRUE&) '
POKEL (mpc& + mpc_stream_buffer_size%),                      32678&

' Opening the MPEG stream (file): No custom bitstream ;)
' Abriendo el flujo (fichero) MPEG: Nada de flujo de bits a medida ;)
' -------------------------------------------------------------------
mps& = MPEGA_open&(SADD(Str2C$(arg$)), mpc&)

IF mps& <> NULL& THEN

	' Info about the MPEG stream
	' Información sobre el flujo MPEG
	' --------------------------------
	PRINT
	PRINT "==============="
	PRINT "File / Fichero: "
	PRINT arg$
	PRINT STRING$(LEN(arg$),CHR$(61))
	PRINT

	PRINT "MPEG-";LTRIM$(STR$(PEEKW(mps&+mps_norm%)));CHR$(32);"Layer/Capa ";ly$(PEEKW(mps&+mps_layer%)+1%);

	dummy& = PEEKW(mps&+mps_original%)
	IF dummy& = 1& THEN 
		PRINT " - Original"	
	ELSE
		PRINT
	END IF

	dummy& = PEEKW(mps&+mps_copyright%)
	IF dummy& = 1& THEN 
		PRINT "Copyrighted - Protegido legalmente por derechos de autoría"
	END IF

	PRINT
		
	PRINT "Mode      / Modo      : ";
	dummy& = PEEKW(mps&+mps_mode%)
	SELECT CASE dummy&
		CASE = MPEGA_MODE_STEREO&
			PRINT "Stereo / Estéreo"
		CASE = MPEGA_MODE_J_STEREO&
			PRINT "Joint Stereo / Estéreo intensivo"
		CASE = MPEGA_MODE_DUAL&
			PRINT "Dual"
		CASE = MPEGA_MODE_MONO&
			PRINT "Mono"
		CASE ELSE
			PRINT "Unexpected value!!! / ¡¡¡Valor inesperado!!!"
	END SELECT

	PRINT "Channels  / Canales   :";PEEKW(mps&+mps_channels%)

	PRINT "Bitrate   / Resolución:";PEEKW(mps&+mps_bitrate%);"Kbps"

	PRINT "Frequency / Frecuencia:";
	PRINT USING "###.#";CSNG(PEEKL(mps&+mps_frequency%))/1000;
	PRINT " KHz"

	PRINT "Duration  / Duración  :";
	IF (PEEKL(mps&+mps_ms_duration%)/1000) >= 60 THEN
		PRINT USING "###.#";CSNG(PEEKL(mps&+mps_ms_duration%))/60000;
		PRINT " min"
	ELSE
		PRINT USING "###.#";CSNG(PEEKL(mps&+mps_ms_duration%))/1000;
		PRINT " s"
	END IF

	PRINT

ELSE

	PRINT "No MPEG stream in the file / No hay un flujo MPEG en el fichero"

END IF

ret& = RETURN_OK&

' ==========================
' The End / Fin del programa
' ==========================
salida:
'-----

' Disabling the user break
' Desactivando la interrupción del usuario
' ----------------------------------------
BREAK OFF
ON BREAK GOTO 0

' Closing the stream/file
' Cerrando el flujo/fichero
' -------------------------
IF mps& <> NULL& THEN MPEGA_close mps&

' Releasing the memory allocated by the struct
' Liberando la memoria reservada para la estructura
' -------------------------------------------------
IF mpc& <> NULL& THEN FreeMem mpc&, MPEGA_CTRL_sizeof%

LIBRARY CLOSE

' Disablig the error trap
' Desactivando la trampa de errores
' ---------------------------------
ON ERROR GOTO 0

STOP ret&

' =====================================================================
