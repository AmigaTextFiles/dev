' *********************************************************************
'                   Example2.bas v1.0a (30.12.2006)
'          based over Example2.c included in the dev package
'       basado en Example2.c incluido en el paquete de desarrollo
'
'       © 2006 Dámaso D. Estévez {correoamidde-hbcoding,yahoo,es}
'                        All rights reserved
'
'         AmiSpaTra - http://www.xente.mundo-r.com/amispatra/
'
'        Reproduce un módulo utilizando las bibliotecas #?MED
'   (las bibliotecas no parecen soportar los formatos más antiguos)
'                              ----
'              Plays a module using the #?MED libraries
'     (the libraries seems don't support the oldest MED formats)
' *********************************************************************

REM $NOWINDOW
REM $NOBREAK
REM $NOLIBRARY

REM $include proplayer.bh
REM $include exec.bh
REM $include dos.bh

	MEDPlayerBase&     = NULL&
	OctaPlayerBase&    = NULL&
	OctaMixPlayerBase& = NULL&

	sng&               = NULL& ' Pointer to MMD0 struct / Puntero a estructura MMD0
	play_routine&      = NULL&

	'       Quick argument parsing
	' Procesado simple y rápido del argumento
	' ---------------------------------------
	a$ = LTRIM$(RTRIM$(COMMAND$))

	WINDOW 1,"Example2.bas - A simple med player / un reproductor MED sencillo",(13,38)-(550,150),1+2+4+16
	w& = TRUE&

	LIBRARY OPEN "exec.library",0&		' OpenLibrary&, CloseLibrary&
	LIBRARY OPEN "dos.library",0&		' IoErr&, Delay


	BREAK OFF

	IF a$<>"" THEN

		'  Initial hypothesys (4-channel mode)
		' Hipótesis inicial (modo de 4 canales)
		' -------------------------------------
		MEDPlayerBase& = OpenLibrary&(SADD("medplayer.library"+CHR$(0)),7&)
		LIBRARY VARPTR "medplayer.library", MEDPlayerBase&

		IF MEDPlayerBase& <> 0& THEN

			LOCATE 2:PRINT "1. Loading module / Cargando módulo":PRINT

			sng& = LoadModule&(SADD(a$+CHR$(0)))

			IF sng& THEN

				LOCATE 4

				'     Checking the playing routine required
				' Comprobando la rutina de reproducción necesaria
				'------------------------------------------------
				play_routine& = RequiredPlayRoutine&(sng&)
				IF play_routine& > 2 THEN
					PRINT "Requires an unknown playing routine! / ¡Se requiere una rutina de reproducción desconocida!"
					GOTO Fin
				END IF

				SELECT CASE play_routine&

					CASE = 1
						OctaPlayerBase& = OpenLibrary&(SADD("octaplayer.library"+CHR$(0)),0&)
						LIBRARY VARPTR "octaplayer.library", OctaPlayerBase&

						IF OctaPlayerBase& = 0& THEN
							PRINT "Can't open octaplayer.library! / ¡Imposible abrir la biblioteca octaplayer.library!"
							GOTO Fin
						END IF

					CASE = 2
						OctaMixPlayerBase& = OpenLibrary&(SADD("octamixplayer.library"+CHR$(0)),0&)
						LIBRARY VARPTR "octamixplayer.library", OctaMixPlayerBase&


						IF OctaMixPlayerBase& = 0& THEN
							PRINT "Can't open octamixplayer.library! / ¡Imposible abrir la biblioteca octamixplayer.library!"
							GOTO Fin
						END IF

				END SELECT

				SELECT CASE play_routine&

					' Four channels / Cuatro canales
					' ------------------------------
					CASE = 0

						count& = 0&
						midi& =  0&

						'   This is a MIDI song? Checking the MIDI channel for each instrument
						' ¿Es una canción MIDI? Comprobando el canal MIDI para cada instrumento
						' ---------------------------------------------------------------------
						FOR count&=0 TO count&=63
								IF PEEKB(PEEKL(sng&+mmd0_song%)+mmd0s_sample%+8*count&+mmd0sm_midich%) = 1 THEN
									midi& = 1&
									EXIT FOR
								END IF
						NEXT count&

						IF GetPlayer&(midi&) THEN
							PRINT "Resource allocation failed / Reserva del recurso fallida."
							GOTO Fin
						ELSE
							PlayModule sng&
						END IF

					' 5-8 channels / 5-8 canales
					' --------------------------
					CASE = 1

						IF GetPlayer8& THEN
							PRINT "Resource allocation failed / Reserva del recurso fallida."
							GOTO Fin
						ELSE
							PlayModule8 sng&
						END IF

					' Mixing / Mezcla
					' ---------------
					CASE = 2

						IF GetPlayerM& THEN
							PRINT "Resource allocation failed / Reserva del recurso fallida."
							GOTO Fin
						ELSE
							PlayModuleM sng&
						END IF

				END SELECT

				PRINT "2. Playing / Reproduciendo"

			ELSE

				e$=LTRIM$(RTRIM$(STR$(IoErr&)))
				PRINT "Load error (DOS error #";e$;") / Error de carga (error del DOS nº ";e$;")"

			END IF

		ELSE

			LOCATE 2:PRINT "Can't open medplayer.library v7! / ¡Imposible abrir la biblioteca medplayer.library v7!"

		END IF

	ELSE

		LOCATE 2:PRINT "Usage/Uso: example2 <song/canción>"

	END IF

	' -----------------------------------------------------------------------
	Fin:

		LOCATE 12:PRINT "** Pulse ESC para salir / Press ESC key for to quit **"

		' Esperando que se presione la tecla ESC para terminar
		'              Press ESC key for to quit
		' ---------------------------------------------------
		DO
			SLEEP
		LOOP UNTIL INKEY$ = CHR$(27)

		IF OctaMixPlayerBase& <> 0& THEN
			FreePlayerM
			CloseLibrary OctaMixPlayerBase&
			LIBRARY VARPTR "octamixplayer.library", 0&
		END IF

		IF OctaPlayerBase& <> 0& THEN
			FreePlayer8
			CloseLibrary OctaPlayerBase&
			LIBRARY VARPTR "octaplayer.library", 0&
		END IF

		IF MEDPlayerBase& <> 0& THEN
			FreePlayer
			UnLoadModule sng&
			CloseLibrary MEDPlayerBase&
			LIBRARY VARPTR "medplayer.library", 0&
			IF e$ = "" THEN
				LOCATE 6
				PRINT "3. Stopping playing / Deteniendo reproducción"
			END IF
		END IF

		Delay 60

		LIBRARY CLOSE
		IF w& = TRUE& THEN WINDOW CLOSE 1

END

DATA "$VER: Example2.bas 1.0a (30.12.06) by Dámaso D. Estévez <correoamidde-hbcoding@yahoo.es> "
