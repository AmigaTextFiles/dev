' *********************************************************************
'            Add.c (BigNum package) - All rights reserved
'                    (C) Copyright Allenbrand Brice

'               C to HBASIC conversion 1.0 (30.05.2011)
'        by Dámaso D. Estévez {correoamidde-aminet000,yahoo,es}
'         AmiSpaTra - http://www.xente.mundo-r.com/amispatra/

'         Divide two big numbers / Divide dos grandes números
' *********************************************************************

REM $NOWINDOW

OPTION BASE 1

REM $include exec.bh
REM $include dos.bh
REM $include timer.bh
REM $include bignum.bh

LIBRARY OPEN "exec.library"
LIBRARY OPEN "dos.library", 37&

'       Easy dynamic structs (but dangerous)
' Estructuras dinámicas fáciles (pero peligrosas)
' -----------------------------------------------
aa$ = STRING$(timeval_sizeof%,CHR$(0))
bb$ = STRING$(timeval_sizeof%,CHR$(0))

'    Arguments array / Matriz para argumentos
' -----------------------------------------------
DIM opts&(3)
opt&(3) = 0&

' ---------------------------------------------------------------------
'      Don't open the BigNum library with LIBRARY OPEN command:
' this won't work, because the library name includes upper case chars.
'                      -------------------------
'      No abra la biblioteca BigNum con el comando LIBRARY OPEN:
'          no funcionará, porque el nombre de la biblioteca
'          incluye caracteres de caja alta (=mayúsculas ;).
' ---------------------------------------------------------------------

BigNumBase& = OpenLibrary&(SADD("BigNum.library"+CHR$(0)),37&)

IF BigNumBase& THEN

	LIBRARY VARPTR "BigNum.library", BigNumBase&

	tr& = AllocVec&(timerequest_sizeof%, MEMF_FAST& AND MEMF_CLEAR&)

	IF tr& THEN

		td& = OpenDevice&(SADD("timer.device"+CHR$(0)), UNIT_MICROHZ& ,tr& , 0)

		IF NOT td& THEN

			LIBRARY VARPTR "timer.device", PEEKL(tr& + tr_node% + IORequestio_device%)

			rdargs& = ReadArgs&(SADD("NUMBER1/A,NUMBER2/A"+CHR$(0)), VARPTR(opts&(1)), NULL&)

			IF rdargs& THEN

				'       Allocating the resources for the big nums
				'    Reserva de los recursos para los números grandes
				' ------------------------------------------------------
				x& = BigNumInit&
				y& = BigNumInit&
				z& = BigNumInit&

				'    Shell args conversion (strings to big numbers).
				'                        ------
				'     Conversión de los argumentos Shell (tratados
				'      como cadenas de texto) en números grandes.
				' -------------------------------------------------------
				BigNumStrToBigNum x&, opts&(1)
				BigNumStrToBigNum y&, opts&(2)

				'              Releasing the args resources
				'        Liberando los recursos de los argumentos
				' -------------------------------------------------------
				FreeArgs rdargs&

				'       Starting the chrono / Activando el cronómetro
				' -------------------------------------------------------
				GetSysTime SADD(aa$)

				'          The DIVISION !!! / ¡¡¡ La DIVISIÓN !!!
				' -------------------------------------------------------
				BigNumDiv x&, y&, z&

				'      Stopping the chrono / Deteniendo el cronómetro
				' -------------------------------------------------------
				GetSysTime SADD(bb$)

				'    Calculating the time lapse / Calculando el tiempo
				' -------------------------------------------------------
				SubTime SADD(bb$),SADD(aa$)

				'  This function seems don't work well (visual fault)...
				' Esta función parece no funcionar bien (fallo visual)...
				' -------------------------------------------------------
				'BigNumPrint z&

				'    ... and this is my alternative: 1 WORD (as for FFFF)
				'                is 5 CHARS (is 65535) aprox.
				'                           -----
				'   ... y ésta es mi alternativa: 1 PALABRA (como para
				'  FFFF) son 5 CARACTERES (sería 65535) aproximadamente.
				' -------------------------------------------------------
				finalbignum$ = STRING$(BigNumSize(z&)*5,CHR$(32))
				BigNumToStr z&, SADD(finalbignum$)
				PRINT LTRIM$(finalbignum$)

				'        Printing the time / Imprimiendo el tiempo
				' -------------------------------------------------------			
				PRINT CHR$(13);"(";
				PRINT LTRIM$(STR$(PEEKL(SADD(bb$)+tv_secs%)));".";
				PRINT RIGHT$("0000"+LTRIM$(STR$(PEEKL(SADD(bb$)+tv_micro%))),5);
				PRINT " s)";CHR$(13)

				'          Releasing the resources for big nums
				'  Liberando los recursos utilizandos por los nº grandes
				' -------------------------------------------------------
				BigNumFree 3
	
			ELSE
			
				PRINT "ReadArgs& has failed! / ¡Ha fracasado ReadArgs&!"
				PRINT "Two number as arguments! / ¡Se exigen dos números como argumento!"
				
			END IF

			LIBRARY VARPTR "timer.device", 0&
			CloseDevice tr&

		ELSE

			PRINT "OpenDevice has failed! / ¡Ha fracasado OpenDevice&!"

		END IF

		FreeVec tr&

	ELSE

		PRINT "AllocVec& has failed! / ¡Ha fracasado AllocVec&!"
		
	END IF

ELSE

	PRINT "Need BigNum.library v37!!"
	PRINT "¡Se exige la versión 37 de la biblioteca BigNum!!"

END IF

LIBRARY CLOSE

' Version string / Cadena de versión
' ----------------------------------
DATA "$VER: BigNum_Div 1.0 (30.05.2011) © Dámaso D. Estévez (Hisoft Basic conversion) "

