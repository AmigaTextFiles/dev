' *********************************************************************
'            Lucas.c (BigNum package) - All rights reserved
'                    (C) Copyright Allenbrand Brice

'               C to HBASIC conversion 1.0 (30.05.2011)
'        by Dámaso D. Estévez {correoamidde-aminet000,yahoo,es}
'         AmiSpaTra - http://www.xente.mundo-r.com/amispatra/
' *********************************************************************

REM $NOWINDOW

OPTION BASE 1

REM $include exec.bh
REM $include dos.bh
REM $include timer.bh
REM $include bignum.bh

LIBRARY OPEN "exec.library"
LIBRARY OPEN "dos.library", 37&

'       Easy dynamic structs (but dangerous)
' Estructuras dinámicas fáciles (pero peligrosas)
' -----------------------------------------------
aa$ = STRING$(timeval_sizeof%,CHR$(0))
bb$ = STRING$(timeval_sizeof%,CHR$(0))

'    Arguments array / Matriz para argumentos
' -----------------------------------------------
DIM opts&(2)
opt&(2) = 0&

' ---------------------------------------------------------------------
'      Don't open the BigNum library with LIBRARY OPEN command:
' this won't work, because the library name includes upper case chars.
'                      -------------------------
'      No abra la biblioteca BigNum con el comando LIBRARY OPEN:
'          no funcionará, porque el nombre de la biblioteca
'          incluye caracteres de caja alta (=mayúsculas ;).
' ---------------------------------------------------------------------

BigNumBase& = OpenLibrary&(SADD("BigNum.library"+CHR$(0)),37&)

IF BigNumBase& THEN

	LIBRARY VARPTR "BigNum.library", BigNumBase&

	tr& = AllocVec&(timerequest_sizeof%, MEMF_FAST& AND MEMF_CLEAR&)

	IF tr& THEN

		td& = OpenDevice&(SADD("timer.device"+CHR$(0)), UNIT_MICROHZ& ,tr& , 0)

		IF NOT td& THEN

			LIBRARY VARPTR "timer.device", PEEKL(tr& + tr_node% + IORequestio_device%)

			rdargs& = ReadArgs&(SADD("EXPONANT/A/N"+CHR$(0)), VARPTR(opts&(1)), NULL&)

			IF rdargs& THEN

				'       Starting the chrono / Activando el cronómetro
				' -------------------------------------------------------
				GetSysTime SADD(aa$)

				rt& = BigNumLucasLehmer&(PEEKL(opts&(1)))

				'      Stopping the chrono / Deteniendo el cronómetro
				' -------------------------------------------------------
				GetSysTime SADD(bb$)

				'              Releasing the args resources
				'        Liberando los recursos de los argumentos
				' -------------------------------------------------------
				FreeArgs rdargs&

				'    Calculating the time lapse / Calculando el tiempo
				' -------------------------------------------------------
				SubTime SADD(bb$),SADD(aa$)

				PRINT

				'        Printing the time / Imprimiendo el tiempo
				' -------------------------------------------------------
				PRINT "(";
				PRINT LTRIM$(STR$(PEEKL(SADD(bb$)+tv_secs%)));".";
				PRINT RIGHT$("0000"+LTRIM$(STR$(PEEKL(SADD(bb$)+tv_micro%))),5);
				PRINT " s)";CHR$(13)

				PRINT
				
				'     The number is prime? / ¿El número es primo?
				' -------------------------------------------------------
				IF rt& THEN
					PRINT "Prime / Primo"
				ELSE
					PRINT "Not Prime / No primo"
				END IF


			ELSE

				PRINT "ReadArgs& has failed! / ¡Ha fracasado ReadArgs&!"
				PRINT "I need an exponant (integer) ! / ¡Se necesita un exponente entero!"

			END IF

			LIBRARY VARPTR "timer.device", 0&
			CloseDevice tr&

		ELSE

			PRINT "OpenDevice has failed! / ¡Ha fracasado OpenDevice&!"

		END IF

		FreeVec tr&

	ELSE

		PRINT "AllocVec& has failed! / ¡Ha fracasado AllocVec&!"

	END IF

ELSE

	PRINT "Need BigNum.library v37!!"
	PRINT "¡Se exige la versión 37 de la biblioteca BigNum!!"

END IF

LIBRARY CLOSE

' Version string / Cadena de versión
' ----------------------------------
DATA "$VER: BigNum_Lucas 1.0 (30.05.2011) © Dámaso D. Estévez (Hisoft Basic conversion) "

