' *********************************************************************
'                        AHI_DetectPaulaAudio.bas
'                 by/de Copyright 2011 Dámaso D. Estévez
'                    {correoamidde-aminet000,yahoo,es}
'           AmiSpaTra - http://www.xente.mundo-r.com/amispatra/
'
'       Based over the DetectPaulaAudio.c code by Przemyslaw Gruchala.
'             All rights reserved over this derivative work:
'                  my Hisoft Basic developpers package.
'        Forbidden to remove ALL legal/copyrights remarks included
'             in this package: if you create a derivate work,
'                  you MUST to include all legal notes.
'
'                  Detect if Paula chip is present or not.
'                                  ----
'    Basado en el código de DetectPaulaAudio.c de Przemyslaw Gruchala.
'       Todos los derechos reservados sobre este trabajo derivado:
'     mi paquete para desarrolladores que programen con Hisoft Basic.
'           Está prohibido eliminar cualquier comentario o nota
'     de autoría/legal de este paquete: si crea un trabajo derivado
'         HA DE INCLUIR OBLIGATORIAMENTE TODAS LAS NOTAS LEGALES.
'
'       Detecta si el circuito integrado Paula está presente o no.
' *********************************************************************

OPTION BASE 1

' ---------------------------------------------------------------------
'        Compiler's metacommands (see the Hisoft Basic Manual)
' Metacomandos para el compilador (consulte el manual del Hisoft Basic)
' ---------------------------------------------------------------------
REM $NOWINDOW
REM $NOLIBRARY
REM $NOBREAK

' ---------------------------------------------------------------------
'                Include files / Ficheros de inclusión
' ---------------------------------------------------------------------

'         OS / SO
' ------------------------
REM $include exec.bh
REM $include dos.bh
REM $include utility.bc

' AHI system / Sistema AHI
' ------------------------
REM $include ahi.bh

' ---------------------------------------------------------------------
'              C= string version / Cadena de versión de C=
' ---------------------------------------------------------------------

vstring$ = "$VER: AHI_DetectPaulaAudio 1.0 (26.09.2011) by Dámaso 'AmiSpaTra' Domínguez based over the C code wrote by ® Przemyslaw 'SENSEI' Gruchala <sensei@box43.gnet.pl> "+CHR$(0)

' ---------------------------------------------------------------------
'                  Global vars / Variables globales
' ---------------------------------------------------------------------

AHIDevice% = -1%

result&    = RETURN_FAIL&

'     Pointers' table
'    Tabla de punteros
' ------------------------
DIM ptr&(3)

' Tags / Etiquetas
' ----------------
DIM tags&(6)

'  Constants for to identify the elements
' Constantes para identificar los elementos
' -----------------------------------------
CONST AHIDPA_AHIBASE% = 1%
CONST AHIDPA_MSGPORT% = 2%
CONST AHIDPA_IO%      = 3%

' ---------------------------------------------------------------------
'              Opening libraries / Abriendo bibliotecas
' ---------------------------------------------------------------------
LIBRARY OPEN "exec.library"
LIBRARY OPEN "dos.library", 36&

' *********************************************************************
'               Functions and subroutines's declarations
'                Declaración de funciones y subrutinas
' *********************************************************************

DECLARE SUB      clean(AHIDevice%, ptr&())

' *********************************************************************

SUB clean(AHIDevice%, ptr&())

	IF ptr&(AHIDPA_AHIBASE%) THEN
		LIBRARY VARPTR "ahi.device", NULL&
		ptr&(AHIDPA_AHIBASE%) = NULL&
	END IF

	IF AHIDevice% = 0% THEN
		CloseDevice ptr&(AHIDPA_IO%)
		AHIDevice%           =   -1%
	END IF

	IF ptr&(AHIDPA_IO%) THEN
		DeleteIORequest ptr&(AHIDPA_IO%)
		ptr&(AHIDPA_IO%)      = NULL&
	END IF

	IF ptr&(AHIDPA_MSGPORT%) THEN
		DeleteMsgPort ptr&(AHIDPA_MSGPORT%)
		ptr&(AHIDPA_MSGPORT%) = NULL&
	END IF

END SUB

' ********************************************************************
'                     Main code / Código principal
' ********************************************************************

'               Only from CLI
' Sólo desde la interfaz de línea de comandos
' -------------------------------------------
IF PEEKL(SYSTAB+8) <> 0 THEN
	BEEP
	GOTO mi_salida
END IF

' Creating the port / Creación del puerto
' ---------------------------------------
ptr&(AHIDPA_MSGPORT%) = CreateMsgPort&

IF ptr&(AHIDPA_MSGPORT%) = NULL& THEN
	PRINT "Could not create AHI reply port!"
	PRINT "¡Imposible ccrear el puerto de mensajes AHI!"
	GOTO mi_salida
END IF

' Creating the IORequest / Creación de la petición E/S
' ----------------------------------------------------
ptr&(AHIDPA_IO%) = CreateIORequest&(ptr&(AHIDPA_MSGPORT%), AHIRequest_sizeof%)

IF ptr&(AHIDPA_IO%) = NULL& THEN
	PRINT "Could not create AHI request"
	PRINT "¡Imposible crear la petición para AHI!"
	GOTO mi_salida
END IF

POKEW ptr&(AHIDPA_IO%)+ahir_Version%, 4%

' Opening the device / Apertura del dispositivo
' ---------------------------------------------
AHIDevice% = OpenDevice&(SADD("ahi.device"+CHR$(0)), AHI_NO_UNIT&, ptr&(AHIDPA_IO%), NULL&)

IF AHIDevice% <> 0& THEN
	PRINT "Could not open 'ahi.device' V";LTRIM$(STR$(PEEKB(ptr&(AHIDPA_IO%)+ahir_Version%)));"!"
	PRINT "¡Se ha fracasado al abrir el dispositivo 'ahi.device' v";LTRIM$(STR$(PEEKB(ptr&(AHIDPA_IO%)+ahir_Version%)));"!"
	GOTO mi_salida
END IF

'    I will use a function from the AHI device and
'   I need to inform to Hisoft Basic how access to it
'
'     Usaré una función del dispositivo AHI y
' necesito informar a Hisoft Basic cómo acceder a ésta
' -----------------------------------------------------
ptr&(AHIDPA_AHIBASE%) = PEEKL(ptr&(AHIDPA_IO%) + ahir_Std% + IORequestio_Device% + dd_Library%)
LIBRARY VARPTR "ahi.device", ptr&(AHIDPA_AHIBASE%)

' ------------------------------------------------------------------

drivername$ = STRING$(256, CHR$(0))

TAGLIST VARPTR(tags&(1)), _
	AHIDB_Driver&,		SADD(drivername$), _
	AHIDB_BufferLen&,	LEN(drivername$), _
	TAG_DONE&

IF AHI_GetAudioAttrsA&(AHI_DEFAULT_ID&, NULL&, VARPTR(tags&(1))) THEN

	tmp$ = PEEK$(SADD(drivername$))

	PRINT "Driver name (default)/Nombre del gestor (por defecto): ";tmp$;"."

	IF tmp$ = "paula" THEN

		PRINT "Paula detected!/¡Detectado el circuito integrado Paula!"
		result& = RETURN_OK&

	ELSE

		PRINT "Paula is not detected!/¡No se ha detectado el circuito integrado Paula!"
		result& = RETURN_WARN&

	END IF

ELSE

	PRINT "Could not get AHI driver name!/¡Imposible obtener el nombre del gestor AHI!"

END IF

' ------------------------------------------------------------------
mi_salida:
' --------

clean AHIDevice%, ptr&()

BREAK ON

LIBRARY CLOSE

STOP rc&

' ------------------------------------------------------------------
