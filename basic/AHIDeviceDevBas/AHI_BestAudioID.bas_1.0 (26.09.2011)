' *********************************************************************
'                          AHI_BestAudioID.bas
'                 by/de Copyright 2011 Dámaso D. Estévez
'                    {correoamidde-aminet000,yahoo,es}
'           AmiSpaTra - http://www.xente.mundo-r.com/amispatra/
'
'           Based over the BestAudioID.c code by Martin Blom.
'             All rights reserved over this derivative work:
'                  my Hisoft Basic developpers package.
'        Forbidden to remove ALL legal/copyrights remarks included
'             in this package: if you create a derivate work,
'                  you MUST to include all legal notes.
'
'                      Simple AHI_BestAudioID() example.
'                                  ----
'          Basado en el código de BestAudioID.c de Martin Blom.
'       Todos los derechos reservados sobre este trabajo derivado:
'     mi paquete para desarrolladores que programen con Hisoft Basic.
'           Está prohibido eliminar cualquier comentario o nota
'     de autoría/legal de este paquete: si crea un trabajo derivado
'         HA DE INCLUIR OBLIGATORIAMENTE TODAS LAS NOTAS LEGALES.
'
'               Ejemplo simple del uso de AHI_BestAudioID().
' *********************************************************************

OPTION BASE 1

' ---------------------------------------------------------------------
'        Compiler's metacommands (see the Hisoft Basic Manual)
' Metacomandos para el compilador (consulte el manual del Hisoft Basic)
' ---------------------------------------------------------------------
REM $NOWINDOW
REM $NOLIBRARY
REM $NOBREAK

' ---------------------------------------------------------------------
'                Include files / Ficheros de inclusión
' ---------------------------------------------------------------------

'         OS / SO
' ------------------------
REM $include exec.bh
REM $include dos.bh
REM $include utility.bc

' AHI system / Sistema AHI
' ------------------------
REM $include ahi.bh

' ---------------------------------------------------------------------
'    From/De:  http://aminet.net/package/dev/basic/AST_HBRoutines
' ---------------------------------------------------------------------
REM $include BLib_AST/StrTo.bas

' ---------------------------------------------------------------------
'              C= string version / Cadena de versión de C=
' ---------------------------------------------------------------------

vstring$ = "$VER: AHI_BestAudioID 1.0 (26.09.2011) by Dámaso 'AmiSpaTra' Domínguez based over the C code wrote by Martin Blom"+CHR$(0)

' ---------------------------------------------------------------------
'                  Global vars / Variables globales
' ---------------------------------------------------------------------

AHIDevice% = -1%

rc&        = RETURN_FAIL&

'     Pointers' table
'    Tabla de punteros
' ------------------------
DIM ptr&(3)

' Tags / Etiquetas
' ----------------
DIM tags1&(12)
DIM tags2&(8)

'  Constants for to identify the elements
' Constantes para identificar los elementos
' -----------------------------------------
CONST AHIBAID_AHIBASE% = 1%
CONST AHIBAID_MSGPORT% = 2%
CONST AHIBAID_IO%      = 3%

' ---------------------------------------------------------------------
'              Opening libraries / Abriendo bibliotecas
' ---------------------------------------------------------------------
LIBRARY OPEN "exec.library"
LIBRARY OPEN "dos.library", 36&

' *********************************************************************
'               Functions and subroutines's declarations
'                Declaración de funciones y subrutinas
' *********************************************************************

DECLARE SUB  clean(AHIDevice%, ptr&())
DECLARE SUB  printmode(BYVAL id&)

' *********************************************************************

SUB clean(AHIDevice%, ptr&())

	IF ptr&(AHIBAID_AHIBASE%) THEN
		LIBRARY VARPTR "ahi.device", NULL&
		ptr&(AHIBAID_AHIBASE%) = NULL&
	END IF

	IF AHIDevice% = 0% THEN
		CloseDevice ptr&(AHIBAID_IO%)
		AHIDevice%           =   -1%
	END IF

	IF ptr&(AHIBAID_IO%) THEN
		DeleteIORequest ptr&(AHIBAID_IO%)
		ptr&(AHIBAID_IO%)      = NULL&
	END IF

	IF ptr&(AHIBAID_MSGPORT%) THEN
		DeleteMsgPort ptr&(AHIBAID_MSGPORT%)
		ptr&(AHIBAID_MSGPORT%) = NULL&
	END IF

END SUB

' *********************************************************************

SUB printmode(BYVAL id&)
	LOCAL tags3&(3), name$, dummy&

	IF id& <> AHI_INVALID_ID& THEN

		name$ = STRING$(40,CHR$(0))

		TAGLIST VARPTR(tags3&(1)), _
			AHIDB_BufferLen&,	40&, _
        		AHIDB_Name&,	SADD(name$), _
       		TAG_DONE&

    		dummy& = AHI_GetAudioAttrsA&(id&, NULL&, VARPTR(tags3&(1)))

	ELSE

		name$ = "Non-existing mode!/¡No existe el modo!"+CHR$(0)

	END IF

	PRINT CHR$(10);
	PRINT "Mode/Modo 0x";
	PRINT RIGHT$("0000000"+HEX$(id&),8);
	PRINT " (";Str2B$(name$);"):"

END SUB

' ********************************************************************
'                     Main code / Código principal
' ********************************************************************

'               Only from CLI
' Sólo desde la interfaz de línea de comandos
' -------------------------------------------
IF PEEKL(SYSTAB+8) <> 0 THEN
	BEEP
	GOTO mi_salida
END IF

' Creating the port / Creación del puerto
' ---------------------------------------
ptr&(AHIBAID_MSGPORT%) = CreateMsgPort&

IF ptr&(AHIBAID_MSGPORT%) = NULL& THEN
	PRINT "Failed to create the MsgPort!"
	PRINT "¡Se ha fracasado el crear el puerto de mensajes!"
	GOTO mi_salida
END IF

' Creating the IORequest / Creación de la petición E/S
' ----------------------------------------------------
ptr&(AHIBAID_IO%) = CreateIORequest&(ptr&(AHIBAID_MSGPORT%), AHIRequest_sizeof%)

IF ptr&(AHIBAID_IO%) = NULL& THEN
	PRINT "Failed to create the IORequest!"
	PRINT "¡Se ha fracasado el crear la petición E/S!"
	GOTO mi_salida
END IF

POKEW ptr&(AHIBAID_IO%)+ahir_Version%, 4%

' Opening the device / Apertura del dispositivo
' ---------------------------------------------
AHIDevice% = OpenDevice&(SADD("ahi.device"+CHR$(0)), AHI_NO_UNIT&, ptr&(AHIBAID_IO%), NULL&)

IF AHIDevice% <> 0& THEN
	PRINT "Failed to open 'ahi.device' v4+!"
	PRINT "¡Se ha fracasado al abrir el dispositivo 'ahi.device' v4+!"
	GOTO mi_salida
END IF

'    I will use a function from the AHI device and
'   I need to inform to Hisoft Basic how access to it
'
'     Usaré una función del dispositivo AHI y
' necesito informar a Hisoft Basic cómo acceder a ésta
' -----------------------------------------------------
ptr&(AHIBAID_AHIBASE%) = PEEKL(ptr&(AHIBAID_IO%) + ahir_Std% + IOStdReqio_Device% + dd_Library%)
LIBRARY VARPTR "ahi.device", ptr&(AHIBAID_AHIBASE%)

' ------------------------------------------------------------------

TAGLIST VARPTR(tags1&(1)), _
	AHIDB_Stereo&,		TRUE&, _
	AHIDB_Volume&,		TRUE&, _
	AHIDB_Bits&,		8&, _
	AHIDB_MaxChannels&,	4&, _
	TAG_DONE&

mainid& = AHI_BestAudioIDA&(VARPTR(tags1&(1)))

printmode mainid&

PRINT "Stereo, Volume, >= 8 bits and >= 4 channels."
PRINT "Estéreo, volumen, >=8 bits y >= 4 canales."

' ------------------------------------------------------------------

TAGLIST VARPTR(tags2&(1)), _
	AHIDB_Bits&,		12&, _
	AHIDB_Panning&,		TRUE&, _
	AHIDB_HiFi&,		TRUE&, _
	TAG_DONE&

' Modifyng a taglist (overwriting the previous TAG_DONE&)
'
'           Modificando una lista de etiquetas
'         (sobreescribiendo el TAG_DONE& previo)
' -------------------------------------------------------
TAGLIST VARPTR(tags1&(9)), _
	AHIB_Dizzy&, 		VARPTR(tags2&(1)), _
	TAG_DONE&

id& = AHI_BestAudioIDA&(VARPTR(tags1&(1)))

printmode id&

PRINT "Same as/Igual que: 0x";
PRINT RIGHT$("0000000"+HEX$(mainid&),8)
PRINT "but also, if possible, >= 12 bits, free stereo panning and HiFi mixing."
PRINT "pero también, si es posible, >= 12 bits, balance estéreo libre y mezcla de alta fidelidad."

' ------------------------------------------------------------------

TAGLIST VARPTR(tags2&(1)), _
	AHIDB_Bits&,		16&, _
	AHIDB_Stereo&,		FALSE&, _
	TAG_DONE&

TAGLIST VARPTR(tags1&(1)), _
	AHIDB_AudioID&,		id&, _
	AHIB_Dizzy&,		VARPTR(tags2&(1)), _
	TAG_DONE&

id& = AHI_BestAudioIDA&(VARPTR(tags1&(1)))

printmode id&

PRINT "Using the same audio hardware at last mode, ";
PRINT "this modes may have >= 16 bit resolution and be mono. But ";
PRINT "I'm not sure."

PRINT "Utilizando la misma circuitería de sonido en el último modo, ";
PRINT "este modo puede tener >= 16 bits de resolución y ser mono. ";
PRINT "Pero no estoy seguro."

' ------------------------------------------------------------------

TAGLIST VARPTR(tags1&(1)), _
	AHIDB_Realtime&,	FALSE&, _
	AHIDB_MaxChannels&,	4&, _
	TAG_DONE&

id& = AHI_BestAudioIDA&(VARPTR(tags1&(1)))

printmode id&

PRINT "A non-realtime mode with 4 channels."
PRINT "Un modo (pero no en tiempo real) con cuatro canales."

rc& = RETURN_OK&

' ------------------------------------------------------------------
mi_salida:
' --------

clean AHIDevice%, ptr&()

BREAK ON

LIBRARY CLOSE

STOP rc&

' ------------------------------------------------------------------
