<*STANDARD-*>
MODULE OS2Eksempel;

IMPORT
  d:=Dos,
  e:=Exec,
  es:=ExecSupport,
  i:=Intuition,
  g:=Graphics,
  gt:=GadTools,
  u:=Utility,
  OS2,
  Kernel,
  SYS:=SYSTEM;


CONST
  Gad1=1;
  Gad2=2;
  Gad3=3;
  Gad4=4;
  Gad5=5;
  Gad6=6;

VAR
  skaerm:i.ScreenPtr;
  vindue:i.WindowPtr;
  skaermfont:g.TextFontPtr;
  visualinfo:gt.VisualInfo;

  (*Gadgets*)
  gl,g1,g2,g3,g4,g5,g6:i.GadgetPtr;
  ngad:gt.NewGadget;

  (*Vindue*)
  vbredde,vhoejde:INTEGER;

  (*Liste*)
  listeptr:e.ListPtr;
  listetekst:e.NodePtr;

PROCEDURE CleanUp(VAR rc:LONGINT);

VAR
  NILPtr:e.ListPtr;

BEGIN

  NILPtr:=NIL;
  d.PrintF("Cleaning Up...\n",NIL);

  IF listeptr # NIL THEN
    OS2.SetListViewList(vindue,g4,NIL,NILPtr);
    LOOP
      listetekst:=SYS.VAL(e.NodePtr,e.RemTail(listeptr^));
      IF listetekst=NIL THEN EXIT END;
      (*SYS.DISPOSE(listetekst.name);
      SYS.DISPOSE(listetekst);*)
    END;
    listetekst:=SYS.VAL(e.NodePtr,e.RemHead(listeptr^));
  END;

  IF vindue # NIL THEN
    i.CloseWindow(vindue);
  END;

  IF gl # NIL THEN
    gt.FreeGadgets(gl);
  END;

  IF visualinfo # NIL THEN
    gt.FreeVisualInfo(visualinfo);
  END;

  IF skaerm # NIL THEN
    i.UnlockPubScreen("",skaerm);
  END;

END CleanUp;


PROCEDURE Setup();

BEGIN

  skaerm:=i.LockPubScreen("");
  IF skaerm=NIL THEN HALT(10) END;

  IF OS2.InitOS2(skaerm,skaermfont,visualinfo)=FALSE THEN HALT(10) END;


  OS2.ComputeFont(skaermfont,300,155);

  (*Gadgets*)
  gl:=NIL; gl:=gt.CreateContext(gl);
  IF gl=NIL THEN HALT(10) END;

  OS2.MakeGadget(ngad,2,140,72,13,"Gemme",OS2.MyTattr,Gad1,{gt.placeTextIn},visualinfo,NIL);
  ngad.gadgetText:=SYS.ADR("Gemme");
  OS2.SensitivGadget(ngad);

  g1:=gt.CreateGadget(gt.buttonKind,gl,ngad,u.done);
  IF g1=NIL THEN HALT(10) END;

  OS2.MakeGadget(ngad,114,140,72,13,"Benytte",OS2.MyTattr,Gad2,{gt.placeTextIn},visualinfo,NIL);
  ngad.gadgetText:=SYS.ADR("Benytte");
  OS2.SensitivGadget(ngad);

  g2:=gt.CreateGadget(gt.buttonKind,g1,ngad,u.done);
  IF g2=NIL THEN HALT(10) END;

  OS2.MakeGadget(ngad,226,140,72,13,"Afbryde",OS2.MyTattr,Gad3,{gt.placeTextIn},visualinfo,NIL);
  ngad.gadgetText:=SYS.ADR("Afbryde");
  OS2.SensitivGadget(ngad);

  g3:=gt.CreateGadget(gt.buttonKind,g2,ngad,u.done);
  IF g3=NIL THEN HALT(10) END;

  OS2.MakeGadget(ngad,2,15,296,83,"ListView",OS2.MyTattr,Gad4,{},visualinfo,NIL);
  ngad.gadgetText:=SYS.ADR("ListView");
  OS2.SensitivGadget(ngad);

  g4:=gt.CreateGadget(gt.listViewKind,g3,ngad,
                      gt.lvShowSelected,NIL,
                      u.done);
  IF g4=NIL THEN HALT(10) END;

  OS2.MakeGadget(ngad,2,100,296,13,"String",OS2.MyTattr,Gad5,{},visualinfo,NIL);
  ngad.gadgetText:=SYS.ADR("String");
  OS2.SensitivGadget(ngad);

  g5:=gt.CreateGadget(gt.stringKind,g4,ngad,
                      u.done);
  IF g5=NIL THEN HALT(10) END;

  OS2.MakeGadget(ngad,2,120,296,13,"Slider",OS2.MyTattr,Gad6,{},visualinfo,NIL);
  ngad.gadgetText:=SYS.ADR("Slider");
  OS2.SensitivGadget(ngad);

  g6:=gt.CreateGadget(gt.sliderKind,g5,ngad,
                      gt.slMin,0,
                      gt.slMax,50,
                      u.done);
  IF g5=NIL THEN HALT(10) END;

  (*Vindue*)
  vbredde:=OS2.ComputeX(300);
  vhoejde:=OS2.ComputeY(155);

  vindue:=i.OpenWindowTagsA(NIL,
          i.waInnerWidth,vbredde,
          i.waInnerHeight,vhoejde,
          i.waGadgets,gl,
          i.waCloseGadget,TRUE,
          i.waActivate,TRUE,
          i.waDragBar,TRUE,
          i.waDepthGadget,TRUE,
          i.waSmartRefresh,TRUE,
          i.waTitle,SYS.ADR("OS2 Module - Eksempel"),
          i.waIDCMP,gt.listViewIDCMP+{i.closeWindow},
          u.done);

  IF vindue=NIL THEN HALT(10) END;

  (*Liste*)
  NEW(listeptr);
  es.NewList(listeptr^);
  NEW(listetekst);
  SYS.NEW(listetekst.name,5);
  listetekst.name:=SYS.ADR("Test1");
  e.AddTail(listeptr^,listetekst);
  NEW(listetekst);
  SYS.NEW(listetekst.name,5);
  listetekst.name:=SYS.ADR("Test2");
  e.AddTail(listeptr^,listetekst);
  NEW(listetekst);
  SYS.NEW(listetekst.name,5);
  listetekst.name:=SYS.ADR("Test3");
  e.AddTail(listeptr^,listetekst);
  NEW(listetekst);
  SYS.NEW(listetekst.name,5);
  listetekst.name:=SYS.ADR("Test4");
  e.AddTail(listeptr^,listetekst);
  NEW(listetekst);
  SYS.NEW(listetekst.name,5);
  listetekst.name:=SYS.ADR("Test5");
  e.AddTail(listeptr^,listetekst);
  NEW(listetekst);
  SYS.NEW(listetekst.name,5);
  listetekst.name:=SYS.ADR("Test6");
  e.AddTail(listeptr^,listetekst);
  NEW(listetekst);
  SYS.NEW(listetekst.name,5);
  listetekst.name:=SYS.ADR("Test7");
  e.AddTail(listeptr^,listetekst);
  NEW(listetekst);
  SYS.NEW(listetekst.name,5);
  listetekst.name:=SYS.ADR("Test8");
  e.AddTail(listeptr^,listetekst);
  NEW(listetekst);
  SYS.NEW(listetekst.name,5);
  listetekst.name:=SYS.ADR("Test9");
  e.AddTail(listeptr^,listetekst);
  NEW(listetekst);
  SYS.NEW(listetekst.name,6);
  listetekst.name:=SYS.ADR("Test10");
  e.AddTail(listeptr^,listetekst);
  NEW(listetekst);
  SYS.NEW(listetekst.name,6);
  listetekst.name:=SYS.ADR("Test11");
  e.AddTail(listeptr^,listetekst);
  OS2.SetListViewList(vindue,g4,NIL,listeptr);

END Setup;


PROCEDURE Main();

VAR
  slut:BOOLEAN;
  msg:i.IntuiMessagePtr;
  knaptryk:i.GadgetPtr;

BEGIN

  slut:=FALSE;

  WHILE slut=FALSE DO
    e.WaitPort(vindue.userPort);

    (*Der kan være mere end en besked derfor et loop*)
    LOOP
      IF slut=TRUE THEN EXIT END;
      msg:=gt.GetIMsg(vindue.userPort);
      IF msg=NIL THEN EXIT END;

      (*Der checkes om der blev trykket på en knap*)
      IF msg.class={i.gadgetUp} THEN
        knaptryk:=msg.iAddress;
        d.PrintF("Der blev trykket på knap nr. %ld.\n",knaptryk.gadgetID);
      END;
      IF msg.class={i.closeWindow} THEN
        slut:=TRUE;
      END;
      gt.ReplyIMsg(msg);
    END;
  END;
END Main;

BEGIN

  (*Initialiserer oprydnings procedure*)
  Kernel.SetCleanup(CleanUp);

  Setup();

  Main();

END OS2Eksempel.
